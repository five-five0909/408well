(()=>{var Wa=(it,Se)=>()=>(Se||it((Se={exports:{}}).exports,Se),Se.exports);var ja=Wa((gt,Ht)=>{(function(Se,he){typeof gt=="object"&&typeof Ht=="object"?Ht.exports=he():typeof define=="function"&&define.amd?define([],he):typeof gt=="object"?gt.Protyle=he():Se.Protyle=he()})(self,()=>(()=>{var it={680:function(ye){(function(X,oe){ye.exports=oe()})(this,function(){"use strict";var X=1e3,oe=6e4,Ge=36e5,ve="millisecond",ne="second",T="minute",I="hour",R="day",O="week",F="month",P="quarter",j="year",J="date",me="Invalid Date",ue=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,ae=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Oe={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},Ee=function(Y,N,H){var U=String(Y);return!U||U.length>=N?Y:""+Array(N+1-U.length).join(H)+Y},S={s:Ee,z:function(Y){var N=-Y.utcOffset(),H=Math.abs(N),U=Math.floor(H/60),D=H%60;return(N<=0?"+":"-")+Ee(U,2,"0")+":"+Ee(D,2,"0")},m:function Y(N,H){if(N.date()<H.date())return-Y(H,N);var U=12*(H.year()-N.year())+(H.month()-N.month()),D=N.clone().add(U,F),G=H-D<0,W=N.clone().add(U+(G?-1:1),F);return+(-(U+(H-D)/(G?D-W:W-D))||0)},a:function(Y){return Y<0?Math.ceil(Y)||0:Math.floor(Y)},p:function(Y){return{M:F,y:j,w:O,d:R,D:J,h:I,m:T,s:ne,ms:ve,Q:P}[Y]||String(Y||"").toLowerCase().replace(/s$/,"")},u:function(Y){return Y===void 0}},De="en",ke={};ke[De]=Oe;var lt=function(Y){return Y instanceof Ie},Ke=function Y(N,H,U){var D;if(!N)return De;if(typeof N=="string"){var G=N.toLowerCase();ke[G]&&(D=G),H&&(ke[G]=H,D=G);var W=N.split("-");if(!D&&W.length>1)return Y(W[0])}else{var te=N.name;ke[te]=N,D=te}return!U&&D&&(De=D),D||!U&&De},re=function(Y,N){if(lt(Y))return Y.clone();var H=typeof N=="object"?N:{};return H.date=Y,H.args=arguments,new Ie(H)},ee=S;ee.l=Ke,ee.i=lt,ee.w=function(Y,N){return re(Y,{locale:N.$L,utc:N.$u,x:N.$x,$offset:N.$offset})};var Ie=function(){function Y(H){this.$L=Ke(H.locale,null,!0),this.parse(H)}var N=Y.prototype;return N.parse=function(H){this.$d=function(U){var D=U.date,G=U.utc;if(D===null)return new Date(NaN);if(ee.u(D))return new Date;if(D instanceof Date)return new Date(D);if(typeof D=="string"&&!/Z$/i.test(D)){var W=D.match(ue);if(W){var te=W[2]-1||0,le=(W[7]||"0").substring(0,3);return G?new Date(Date.UTC(W[1],te,W[3]||1,W[4]||0,W[5]||0,W[6]||0,le)):new Date(W[1],te,W[3]||1,W[4]||0,W[5]||0,W[6]||0,le)}}return new Date(D)}(H),this.$x=H.x||{},this.init()},N.init=function(){var H=this.$d;this.$y=H.getFullYear(),this.$M=H.getMonth(),this.$D=H.getDate(),this.$W=H.getDay(),this.$H=H.getHours(),this.$m=H.getMinutes(),this.$s=H.getSeconds(),this.$ms=H.getMilliseconds()},N.$utils=function(){return ee},N.isValid=function(){return this.$d.toString()!==me},N.isSame=function(H,U){var D=re(H);return this.startOf(U)<=D&&D<=this.endOf(U)},N.isAfter=function(H,U){return re(H)<this.startOf(U)},N.isBefore=function(H,U){return this.endOf(U)<re(H)},N.$g=function(H,U,D){return ee.u(H)?this[U]:this.set(D,H)},N.unix=function(){return Math.floor(this.valueOf()/1e3)},N.valueOf=function(){return this.$d.getTime()},N.startOf=function(H,U){var D=this,G=!!ee.u(U)||U,W=ee.p(H),te=function(Be,fe){var be=ee.w(D.$u?Date.UTC(D.$y,fe,Be):new Date(D.$y,fe,Be),D);return G?be:be.endOf(R)},le=function(Be,fe){return ee.w(D.toDate()[Be].apply(D.toDate("s"),(G?[0,0,0,0]:[23,59,59,999]).slice(fe)),D)},se=this.$W,ce=this.$M,Ce=this.$D,Le="set"+(this.$u?"UTC":"");switch(W){case j:return G?te(1,0):te(31,11);case F:return G?te(1,ce):te(0,ce+1);case O:var qe=this.$locale().weekStart||0,He=(se<qe?se+7:se)-qe;return te(G?Ce-He:Ce+(6-He),ce);case R:case J:return le(Le+"Hours",0);case I:return le(Le+"Minutes",1);case T:return le(Le+"Seconds",2);case ne:return le(Le+"Milliseconds",3);default:return this.clone()}},N.endOf=function(H){return this.startOf(H,!1)},N.$set=function(H,U){var D,G=ee.p(H),W="set"+(this.$u?"UTC":""),te=(D={},D[R]=W+"Date",D[J]=W+"Date",D[F]=W+"Month",D[j]=W+"FullYear",D[I]=W+"Hours",D[T]=W+"Minutes",D[ne]=W+"Seconds",D[ve]=W+"Milliseconds",D)[G],le=G===R?this.$D+(U-this.$W):U;if(G===F||G===j){var se=this.clone().set(J,1);se.$d[te](le),se.init(),this.$d=se.set(J,Math.min(this.$D,se.daysInMonth())).$d}else te&&this.$d[te](le);return this.init(),this},N.set=function(H,U){return this.clone().$set(H,U)},N.get=function(H){return this[ee.p(H)]()},N.add=function(H,U){var D,G=this;H=Number(H);var W=ee.p(U),te=function(ce){var Ce=re(G);return ee.w(Ce.date(Ce.date()+Math.round(ce*H)),G)};if(W===F)return this.set(F,this.$M+H);if(W===j)return this.set(j,this.$y+H);if(W===R)return te(1);if(W===O)return te(7);var le=(D={},D[T]=oe,D[I]=Ge,D[ne]=X,D)[W]||1,se=this.$d.getTime()+H*le;return ee.w(se,this)},N.subtract=function(H,U){return this.add(-1*H,U)},N.format=function(H){var U=this,D=this.$locale();if(!this.isValid())return D.invalidDate||me;var G=H||"YYYY-MM-DDTHH:mm:ssZ",W=ee.z(this),te=this.$H,le=this.$m,se=this.$M,ce=D.weekdays,Ce=D.months,Le=function(fe,be,Ze,Fe){return fe&&(fe[be]||fe(U,G))||Ze[be].slice(0,Fe)},qe=function(fe){return ee.s(te%12||12,fe,"0")},He=D.meridiem||function(fe,be,Ze){var Fe=fe<12?"AM":"PM";return Ze?Fe.toLowerCase():Fe},Be={YY:String(this.$y).slice(-2),YYYY:this.$y,M:se+1,MM:ee.s(se+1,2,"0"),MMM:Le(D.monthsShort,se,Ce,3),MMMM:Le(Ce,se),D:this.$D,DD:ee.s(this.$D,2,"0"),d:String(this.$W),dd:Le(D.weekdaysMin,this.$W,ce,2),ddd:Le(D.weekdaysShort,this.$W,ce,3),dddd:ce[this.$W],H:String(te),HH:ee.s(te,2,"0"),h:qe(1),hh:qe(2),a:He(te,le,!0),A:He(te,le,!1),m:String(le),mm:ee.s(le,2,"0"),s:String(this.$s),ss:ee.s(this.$s,2,"0"),SSS:ee.s(this.$ms,3,"0"),Z:W};return G.replace(ae,function(fe,be){return be||Be[fe]||W.replace(":","")})},N.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},N.diff=function(H,U,D){var G,W=ee.p(U),te=re(H),le=(te.utcOffset()-this.utcOffset())*oe,se=this-te,ce=ee.m(this,te);return ce=(G={},G[j]=ce/12,G[F]=ce,G[P]=ce/3,G[O]=(se-le)/6048e5,G[R]=(se-le)/864e5,G[I]=se/Ge,G[T]=se/oe,G[ne]=se/X,G)[W]||se,D?ce:ee.a(ce)},N.daysInMonth=function(){return this.endOf(F).$D},N.$locale=function(){return ke[this.$L]},N.locale=function(H,U){if(!H)return this.$L;var D=this.clone(),G=Ke(H,U,!0);return G&&(D.$L=G),D},N.clone=function(){return ee.w(this.$d,this)},N.toDate=function(){return new Date(this.valueOf())},N.toJSON=function(){return this.isValid()?this.toISOString():null},N.toISOString=function(){return this.$d.toISOString()},N.toString=function(){return this.$d.toUTCString()},Y}(),mt=Ie.prototype;return re.prototype=mt,[["$ms",ve],["$s",ne],["$m",T],["$H",I],["$W",R],["$M",F],["$y",j],["$D",J]].forEach(function(Y){mt[Y[1]]=function(N){return this.$g(N,Y[0],Y[1])}}),re.extend=function(Y,N){return Y.$i||(Y(N,Ie,re),Y.$i=!0),re},re.locale=Ke,re.isDayjs=lt,re.unix=function(Y){return re(1e3*Y)},re.en=ke[De],re.Ls=ke,re.p={},re})},5:ye=>{"use strict";function X(ne){if(typeof ne!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(ne))}function oe(ne,T){for(var I="",R=0,O=-1,F=0,P,j=0;j<=ne.length;++j){if(j<ne.length)P=ne.charCodeAt(j);else{if(P===47)break;P=47}if(P===47){if(!(O===j-1||F===1))if(O!==j-1&&F===2){if(I.length<2||R!==2||I.charCodeAt(I.length-1)!==46||I.charCodeAt(I.length-2)!==46){if(I.length>2){var J=I.lastIndexOf("/");if(J!==I.length-1){J===-1?(I="",R=0):(I=I.slice(0,J),R=I.length-1-I.lastIndexOf("/")),O=j,F=0;continue}}else if(I.length===2||I.length===1){I="",R=0,O=j,F=0;continue}}T&&(I.length>0?I+="/..":I="..",R=2)}else I.length>0?I+="/"+ne.slice(O+1,j):I=ne.slice(O+1,j),R=j-O-1;O=j,F=0}else P===46&&F!==-1?++F:F=-1}return I}function Ge(ne,T){var I=T.dir||T.root,R=T.base||(T.name||"")+(T.ext||"");return I?I===T.root?I+R:I+ne+R:R}var ve={resolve:function(){for(var T="",I=!1,R,O=arguments.length-1;O>=-1&&!I;O--){var F;O>=0?F=arguments[O]:(R===void 0&&(R=process.cwd()),F=R),X(F),F.length!==0&&(T=F+"/"+T,I=F.charCodeAt(0)===47)}return T=oe(T,!I),I?T.length>0?"/"+T:"/":T.length>0?T:"."},normalize:function(T){if(X(T),T.length===0)return".";var I=T.charCodeAt(0)===47,R=T.charCodeAt(T.length-1)===47;return T=oe(T,!I),T.length===0&&!I&&(T="."),T.length>0&&R&&(T+="/"),I?"/"+T:T},isAbsolute:function(T){return X(T),T.length>0&&T.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var T,I=0;I<arguments.length;++I){var R=arguments[I];X(R),R.length>0&&(T===void 0?T=R:T+="/"+R)}return T===void 0?".":ve.normalize(T)},relative:function(T,I){if(X(T),X(I),T===I||(T=ve.resolve(T),I=ve.resolve(I),T===I))return"";for(var R=1;R<T.length&&T.charCodeAt(R)===47;++R);for(var O=T.length,F=O-R,P=1;P<I.length&&I.charCodeAt(P)===47;++P);for(var j=I.length,J=j-P,me=F<J?F:J,ue=-1,ae=0;ae<=me;++ae){if(ae===me){if(J>me){if(I.charCodeAt(P+ae)===47)return I.slice(P+ae+1);if(ae===0)return I.slice(P+ae)}else F>me&&(T.charCodeAt(R+ae)===47?ue=ae:ae===0&&(ue=0));break}var Oe=T.charCodeAt(R+ae),Ee=I.charCodeAt(P+ae);if(Oe!==Ee)break;Oe===47&&(ue=ae)}var S="";for(ae=R+ue+1;ae<=O;++ae)(ae===O||T.charCodeAt(ae)===47)&&(S.length===0?S+="..":S+="/..");return S.length>0?S+I.slice(P+ue):(P+=ue,I.charCodeAt(P)===47&&++P,I.slice(P))},_makeLong:function(T){return T},dirname:function(T){if(X(T),T.length===0)return".";for(var I=T.charCodeAt(0),R=I===47,O=-1,F=!0,P=T.length-1;P>=1;--P)if(I=T.charCodeAt(P),I===47){if(!F){O=P;break}}else F=!1;return O===-1?R?"/":".":R&&O===1?"//":T.slice(0,O)},basename:function(T,I){if(I!==void 0&&typeof I!="string")throw new TypeError('"ext" argument must be a string');X(T);var R=0,O=-1,F=!0,P;if(I!==void 0&&I.length>0&&I.length<=T.length){if(I.length===T.length&&I===T)return"";var j=I.length-1,J=-1;for(P=T.length-1;P>=0;--P){var me=T.charCodeAt(P);if(me===47){if(!F){R=P+1;break}}else J===-1&&(F=!1,J=P+1),j>=0&&(me===I.charCodeAt(j)?--j===-1&&(O=P):(j=-1,O=J))}return R===O?O=J:O===-1&&(O=T.length),T.slice(R,O)}else{for(P=T.length-1;P>=0;--P)if(T.charCodeAt(P)===47){if(!F){R=P+1;break}}else O===-1&&(F=!1,O=P+1);return O===-1?"":T.slice(R,O)}},extname:function(T){X(T);for(var I=-1,R=0,O=-1,F=!0,P=0,j=T.length-1;j>=0;--j){var J=T.charCodeAt(j);if(J===47){if(!F){R=j+1;break}continue}O===-1&&(F=!1,O=j+1),J===46?I===-1?I=j:P!==1&&(P=1):I!==-1&&(P=-1)}return I===-1||O===-1||P===0||P===1&&I===O-1&&I===R+1?"":T.slice(I,O)},format:function(T){if(T===null||typeof T!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof T);return Ge("/",T)},parse:function(T){X(T);var I={root:"",dir:"",base:"",ext:"",name:""};if(T.length===0)return I;var R=T.charCodeAt(0),O=R===47,F;O?(I.root="/",F=1):F=0;for(var P=-1,j=0,J=-1,me=!0,ue=T.length-1,ae=0;ue>=F;--ue){if(R=T.charCodeAt(ue),R===47){if(!me){j=ue+1;break}continue}J===-1&&(me=!1,J=ue+1),R===46?P===-1?P=ue:ae!==1&&(ae=1):P!==-1&&(ae=-1)}return P===-1||J===-1||ae===0||ae===1&&P===J-1&&P===j+1?J!==-1&&(j===0&&O?I.base=I.name=T.slice(1,J):I.base=I.name=T.slice(j,J)):(j===0&&O?(I.name=T.slice(1,P),I.base=T.slice(1,J)):(I.name=T.slice(j,P),I.base=T.slice(j,J)),I.ext=T.slice(P,J)),j>0?I.dir=T.slice(0,j-1):O&&(I.dir="/"),I},sep:"/",delimiter:":",win32:null,posix:null};ve.posix=ve,ye.exports=ve}},Se={};function he(ye){var X=Se[ye];if(X!==void 0)return X.exports;var oe=Se[ye]={exports:{}};return it[ye].call(oe.exports,oe,oe.exports,he),oe.exports}he.d=(ye,X)=>{for(var oe in X)he.o(X,oe)&&!he.o(ye,oe)&&Object.defineProperty(ye,oe,{enumerable:!0,get:X[oe]})},he.o=(ye,X)=>Object.prototype.hasOwnProperty.call(ye,X);var ot={};return(()=>{"use strict";he.d(ot,{default:()=>Fa});const ye=(t,e)=>{if(document.getElementById(e))return!1;const n=new XMLHttpRequest;n.open("GET",t,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=e,document.head.appendChild(a)},X=(t,e)=>new Promise(n=>{if(document.getElementById(e))return n(!1),!1;const a=document.createElement("script");a.src=t,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(e))return a.remove(),n(!1),!1;a.id=e,n(!0)}}),oe=()=>!!document.getElementById("sidebar"),Ge=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,ve=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",ne=()=>!document.getElementById("toolbar"),T=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,I=(t,e)=>t.length===e.length&&t.every(n=>e.includes(n)),R=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,O=(t,e=window.location.search)=>{const n=e.substring(e.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(t)},F=()=>!0,P=t=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(t),j=t=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(t),J=t=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(t),me=t=>Function(`"use strict";return (${t})`)(),ue=(t,e)=>{if(t===e)return!0;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(!t||!e||typeof t!="object"&&typeof e!="object")return t===e;if(t.prototype!==e.prototype)return!1;const n=Object.keys(t);return n.length!==Object.keys(e).length?!1:n.every(a=>ue(t[a],e[a]))},ae="2.9.1",Oe="production",Ee=class{};let S=Ee;S.SIYUAN_VERSION=ae,S.NODE_ENV=Oe,S.SIYUAN_APPID=Math.random().toString(36).substring(8),S.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",S.PROTYLE_CDN="/stage/protyle",S.UPLOAD_ADDRESS="/upload",S.SERVICE_WORKER_PATH="/service-worker.js",S.SIYUAN_DROP_FILE="application/siyuan-file",S.SIYUAN_DROP_GUTTER="application/siyuan-gutter",S.SIYUAN_DROP_TAB="application/siyuan-tab",S.SIYUAN_DROP_EDITOR="application/siyuan-editor",S.SIYUAN_SHOW="siyuan-show",S.SIYUAN_CONFIG_TRAY="siyuan-config-tray",S.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",S.SIYUAN_QUIT="siyuan-quit",S.SIYUAN_HOTKEY="siyuan-hotkey",S.SIYUAN_INIT="siyuan-init",S.SIYUAN_OPENURL="siyuan-openurl",S.SIYUAN_OPENWINDOW="siyuan-openwindow",S.SIYUAN_SEND_WINDOWS="siyuan-send_windows",S.SIYUAN_SAVE_CLOSE="siyuan-save-close",S.SIYUAN_EXPORT_PDF="siyuan-export-pdf",S.SIYUAN_EXPORT_CLOSE="siyuan-export-close",S.SIYUAN_EXPORT_PREVENT="siyuan-export-prevent",S.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",S.SIZE_LINK_TEXT_MAX=24,S.SIZE_TOOLBAR_HEIGHT=oe()?0:32,S.SIZE_GET_MAX=102400,S.SIZE_UNDO=64,S.SIZE_TITLE=512,S.SIZE_EDITOR_WIDTH=760,S.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],S.CB_MOVE_NOLIST="cb-move-nolist",S.CB_MOUNT_REMOVE="cb-mount-remove",S.CB_GET_APPEND="cb-get-append",S.CB_GET_BEFORE="cb-get-before",S.CB_GET_UNCHANGEID="cb-get-unchangeid",S.CB_GET_HL="cb-get-hl",S.CB_GET_FOCUS="cb-get-focus",S.CB_GET_FOCUSFIRST="cb-get-focusfirst",S.CB_GET_SETID="cb-get-setid",S.CB_GET_ALL="cb-get-all",S.CB_GET_BACKLINK="cb-get-backlink",S.CB_GET_UNUNDO="cb-get-unundo",S.CB_GET_SCROLL="cb-get-scroll",S.CB_GET_CONTEXT="cb-get-context",S.CB_GET_HTML="cb-get-html",S.CB_GET_HISTORY="cb-get-history",S.LOCAL_ZOOM="local-zoom",S.LOCAL_SEARCHDATA="local-searchdata",S.LOCAL_SEARCHKEYS="local-searchkeys",S.LOCAL_DOCINFO="local-docinfo",S.LOCAL_DAILYNOTEID="local-dailynoteid",S.LOCAL_HISTORYNOTEID="local-historynoteid",S.LOCAL_CODELANG="local-codelang",S.LOCAL_FONTSTYLES="local-fontstyles",S.LOCAL_EXPORTPDF="local-exportpdf",S.LOCAL_EXPORTWORD="local-exportword",S.LOCAL_EXPORTIMG="local-exportimg",S.LOCAL_BAZAAR="local-bazaar",S.LOCAL_PDFTHEME="local-pdftheme",S.LOCAL_LAYOUTS="local-layouts",S.LOCAL_AI="local-ai",S.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",S.TIMEOUT_DBLCLICK=190,S.TIMEOUT_INPUT=256,S.TIMEOUT_LOAD=300,S.TIMEOUT_TRANSITION=300,S.TIMEOUT_COUNT=1e3,S.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},S.QUICK_DECK_ID="20230218211946-2kw8jgx",S.KEYCODE={186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"']},S.SIYUAN_KEYMAP={general:{editMode:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:"\u23251",custom:"\u23251"},outline:{default:"\u23252",custom:"\u23252"},bookmark:{default:"\u23253",custom:"\u23253"},tag:{default:"\u23254",custom:"\u23254"},dailyNote:{default:"\u23255",custom:"\u23255"},inbox:{default:"\u23256",custom:"\u23256"},backlinks:{default:"\u23257",custom:"\u23257"},graphView:{default:"\u23258",custom:"\u23258"},globalGraph:{default:"\u23259",custom:"\u23259"},riffCard:{default:"\u23250",custom:"\u23250"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318>",custom:"\u21E7\u2318>"},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},clearFontStyle:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318_",custom:"\u21E7\u2318_"}}},plugin:{}},S.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:227,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:227,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:227,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:227,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},S.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,S.SIYUAN_IMAGE_FILE="1f4c4",S.SIYUAN_IMAGE_NOTE="1f5c3",S.SIYUAN_IMAGE_FOLDER="1f4d1",S.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],S.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],S.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],S.SIYUAN_ASSETS_EXTS=[".pdf"].concat(Ee.SIYUAN_ASSETS_IMAGE).concat(Ee.SIYUAN_ASSETS_AUDIO).concat(Ee.SIYUAN_ASSETS_VIDEO),S.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],S.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],S.ZWSP="\u200B",S.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo"],S.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],S.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},S.CODE_LANGUAGES=["js","ts","html","toml","c#","bat","bash","c","csharp","cpp","css","diff","go","xml","json","java","javascript","kotlin","less","lua","makefile","markdown","objectivec","php","php-template","perl","plaintext","python","python-repl","r","ruby","rust","scss","sql","shell","swift","ini","typescript","vbnet","yaml","properties","1c","armasm","avrasm","actionscript","ada","angelscript","accesslog","apache","applescript","arcade","arduino","asciidoc","aspectj","abnf","autohotkey","autoit","awk","basic","bnf","dos","brainfuck","cal","cmake","csp","cos","capnproto","ceylon","clean","clojure","clojure-repl","coffeescript","coq","crystal","d","dns","dart","delphi","dts","django","dockerfile","dust","erb","elixir","elm","erlang","erlang-repl","excel","ebnf","fsharp","fix","flix","fortran","gcode","gams","gauss","glsl","gml","gherkin","golo","gradle","groovy","haml","hsp","http","handlebars","haskell","haxe","hy","irpf90","isbl","inform7","x86asm","jboss-cli","julia","julia-repl","ldif","llvm","lsl","latex","lasso","leaf","lisp","livecodeserver","livescript","mel","mipsasm","matlab","maxima","mercury","axapta","routeros","mizar","mojolicious","monkey","moonscript","n1ql","nsis","nestedtext","nginx","nim","nix","node-repl","ocaml","openscad","ruleslanguage","oxygene","pf","parser3","pony","pgsql","powershell","processing","prolog","protobuf","puppet","purebasic","profile","q","qml","reasonml","rib","rsl","roboconf","sas","sml","sqf","step21","scala","scheme","scilab","smali","smalltalk","stan","stata","stylus","subunit","tp","taggerscript","tcl","tap","thrift","twig","vbscript","vbscript-html","vhdl","vala","verilog","vim","wasm","mathematica","wren","xl","xquery","zephir","crmsh","dsconfig","graphql","yul","solidity","abap"],S.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const De=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="graphviz"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&X(`${e}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const s=a.firstElementChild.nextElementSibling;try{const i=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),l=(window.URL||window.webkitURL).createObjectURL(i),r=new Worker(l);new Viz({worker:r}).renderSVGElement(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).then(d=>{s.innerHTML=d.outerHTML,s.classList.remove("ft__error"),s.setAttribute("contenteditable","false"),a.textContent.endsWith(S.ZWSP)||a.insertAdjacentHTML("beforeend",`<span style="position: absolute">${S.ZWSP}</span>`)}).catch(d=>{s.innerHTML=`graphviz render error: <br>${d}`,s.classList.add("ft__error")})}catch(i){console.error("Graphviz error",i)}a.setAttribute("data-render","true")})})},ke=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("b3-typography");)n.nodeName.indexOf(e)===0?a=!0:n=n.parentElement;return a&&n},lt=(t,e,n=!1)=>{let a=Y(t,e,n),s=!1,i=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!i;)s=Y(a.parentElement,e,n),s?a=s:i=!0;return a||!1},Ke=(t,e)=>{let n=ke(t,e),a=!1,s=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!s;)a=ke(n.parentElement,e),a?n=a:s=!0;return n||!1},re=(t,e,n,a=!1)=>{let s=ee(t,e,n,a),i=!1,o=!1;for(;s&&!s.classList.contains("protyle-wysiwyg")&&!o;)i=ee(s.parentElement,e,n,a),i?s=i:o=!0;return s||!1},ee=(t,e,n,a=!1)=>{var s;if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let i=t,o=!1;for(;i&&!o&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((s=i.getAttribute(e))!=null&&s.split(" ").includes(n))||typeof n!="string"&&i.hasAttribute(e)?o=!0:i=i.parentElement;return o&&i},Ie=t=>{var e;const n=ee(t,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((e=n.getAttribute("data-type"))!=null&&e.startsWith("Node"))?n:!1},mt=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===e?a=!0:n=n.parentElement;return a&&n},Y=(t,e,n=!1)=>{var a;if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let s=t,i=!1;for(;s&&!i&&(n?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)(a=s.classList)!=null&&a.contains(e)?i=!0:s=s.parentElement;return i&&s},N=t=>{let e=t;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const n=Ie(e.parentElement);if(n)e=n;else return!1}},H=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!hasClosestByAttribute(n.parentElement,"data-type","NodeBlockQueryEmbed"))return e=n,!0}),e||t},U=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!hasClosestByAttribute(n.parentElement,"data-type","NodeBlockQueryEmbed")&&!n.classList.contains("li"))return e=n,!0}),e||t},D=t=>{let e=t;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const n=Ie(e.parentElement);if(n)e=n;else return!1}return!1},G=t=>{let e=t;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},W=t=>!t||t.getAttribute("contenteditable")==="true"&&!t.classList.contains("protyle-wysiwyg")?t:t.querySelector('[contenteditable="true"]'),te=t=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(t.getAttribute("data-type"))||t.getAttribute("data-type")==="NodeCodeBlock"&&t.classList.contains("render-node"),le=t=>{var e,n;let a=t;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let s=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(i=>{if(i.textContent.replace(Constants.ZWSP,"").replace(`
`,"")!=="")return s=!0,!0}),s||(e=a.previousElementSibling)!=null&&e.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},se=t=>{if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=se(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=se(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=se(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else{t=se(t);break}return t},ce=t=>{let e=t.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},Ce=t=>{let e=t.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},Le=t=>{let e=t.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},qe=t=>{let e=t.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const n=e.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},He=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16)),Be=()=>{const t=document.getElementById("message");t.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button--cancel b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,t.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(t);){if(n.classList.contains("b3-snackbar__close")){be(n.parentElement.getAttribute("data-id")),e.preventDefault();break}else if(n.isSameNode(t.lastElementChild)){n.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{n.parentElement.firstElementChild.innerHTML=""},Constants.TIMEOUT_INPUT),e.preventDefault();break}n=n.parentElement}})},fe=(t,e=6e3,n="info",a)=>{const s=t+(n==="error"?" v"+S.SIYUAN_VERSION:""),i=a||He(),o=document.getElementById("message").firstElementChild,l=o.querySelector(`.b3-snackbar[data-id="${i}"]`);if(l){if(window.clearTimeout(parseInt(l.getAttribute("data-timeoutid"))),l.innerHTML=`<div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${s}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),e>0){const d=window.setTimeout(()=>{be(i)},e);l.setAttribute("data-timeoutid",d.toString())}return}let r=`<div data-id="${i}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${s}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const d=window.setTimeout(()=>{be(i)},e);r=r.replace("<div data-id",`<div data-timeoutid="${d}" data-id`)}return o.parentElement.classList.add("b3-snackbars--show"),o.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{o.querySelectorAll(".b3-snackbar--hide").forEach(d=>{d.classList.remove("b3-snackbar--hide")})}),o.firstElementChild.nextElementSibling&&o.firstElementChild.nextElementSibling.innerHTML===o.firstElementChild.innerHTML&&o.firstElementChild.nextElementSibling.remove(),o.scrollTo({top:0,behavior:"smooth"}),i},be=t=>{const e=document.getElementById("message").firstElementChild;if(t){const n=e.querySelector(`[data-id="${t}"]`);n&&(n.classList.add("b3-snackbar--hide"),setTimeout(()=>{n.remove(),e.childElementCount===0&&be()},S.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(s=>{if(!s.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},S.TIMEOUT_INPUT)},Ze=t=>{if(t.cmd==="msg")return fe(t.msg,t.data.closeTimeout,t.code===0?"info":"error",t.data.id),!1;if(t.cmd==="cmsg")return be(t.data.id),!1;if(t.cmd==="cprogress"){const e=document.getElementById("progress");return e&&e.remove(),!1}return t.cmd==="reloadui"?(window.location.reload(),!1):t.code<0?(fe(t.msg,t.data&&t.data.closeTimeout||0,t.code===-1?"error":"info"),!1):t};class Fe{constructor(e){this.disableClose=e.disableClose,this.id=He(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div"),this.element.innerHTML=`<div class="b3-dialog">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${e.width||"auto"};height:${e.height||"auto"}">
  <svg ${oe()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",n=>{this.disableClose||this.destroy(),n.preventDefault(),n.stopPropagation(),window.siyuan.menus.menu.remove()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",n=>{this.destroy(),n.preventDefault(),n.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(e){this.element.remove(),window.siyuan.menus.menu.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((n,a)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(a,1),!0})}bindInput(e,n){e.focus(),e.addEventListener("keydown",a=>{if(a.isComposing){a.preventDefault();return}if(a.key==="Escape"){this.destroy(),a.preventDefault(),a.stopPropagation();return}a.key==="Enter"&&n&&(n(),a.preventDefault())})}}const Ya=t=>{const e=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${t}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()});const a=e.element.querySelector("input");e.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{fetchPost("/api/tag/renameTag",{oldLabel:t,newLabel:a.value})})},Ua=()=>window.siyuan.config.system.workspaceDir.replace(/^.*[\\\/]/,""),za=(t=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(t&&(t===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?showMessage(window.siyuan.languages._kernel[122]):showMessage(t)),!0);var Ga=he(5);const kn=()=>{const t=window.siyuan.emojis[getRandom(0,window.siyuan.emojis.length-1)];return typeof t.items[getRandom(0,t.items.length-1)]=="undefined"?"1f600":t.items[getRandom(0,t.items.length-1)].unicode},de=(t,e="",n=!1,a=!1)=>{if(!t)return"";let s="";if(t.indexOf(".")>-1)s=`<img class="${e}" ${a?"data-":""}src="/emojis/${t}"/>`;else try{t.split("-").forEach(i=>{i.length<5?s+=String.fromCodePoint(parseInt("0"+i,16)):s+=String.fromCodePoint(parseInt(i,16))}),n&&(s=`<span class="${e}">${s}</span>`)}catch(i){}return s},pt=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s){let i="";window.siyuan.emojis[parseInt(s)].items.forEach(o=>{i+=`<button data-unicode="${o.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?o.description_zh_cn:o.description}">
${de(o.unicode)}</button>`}),a.target.innerHTML=i,a.target.removeAttribute("data-index")}})});t.querySelectorAll(".emojis__content").forEach(n=>{e.observe(n)})},bt=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s&&(a.target.src=s,a.target.removeAttribute("data-src"))})});t.querySelectorAll("img").forEach(n=>{e.observe(n)})},ht=(t="",e)=>{let n="";const a=[];t&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let s=0,i="";const o=[];window.siyuan.emojis.forEach((r,d)=>{t||(n+=`<div class="emojis__title" data-type="${d+1}">${window.siyuan.config.lang==="zh_CN"?r.title_zh_cn:r.title}</div><div style="min-height:${d===0?"28px":"336px"}" class="emojis__content"${d>1?' data-index="'+d+'"':""}>`),r.items.length===0&&d===0&&!t&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(c=>{if(t){if(window.siyuan.config.editor.emoji.includes(c.unicode)&&(de(c.unicode)===t||c.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||c.description.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&a.push(c),e&&s>e)return;(de(c.unicode)===t||c.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||c.description.toLowerCase().indexOf(t.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&(r.id==="custom"?o.push(c):i+=`<button data-unicode="${c.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?c.description_zh_cn:c.description}">
${de(c.unicode,void 0,!1,!0)}</button>`,s++)}else window.siyuan.config.editor.emoji.includes(c.unicode)&&a.push(c),d<2&&(n+=`<button data-unicode="${c.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?c.description_zh_cn:c.description}">
${de(c.unicode,void 0,!1,!0)}</button>`)}),t||(n+="</div>")}),t&&(o.sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(t.toLowerCase())<f[f.length-1].toLowerCase().indexOf(t.toLowerCase())?-1:0}).sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(t.toLowerCase())===f[f.length-1].toLowerCase().indexOf(t.toLowerCase())&&c[c.length-1].length<f[f.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?r.description_zh_cn:r.description}">
${de(r.unicode,void 0,!1,!0)}</button>`}),n=n+i+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const d=a.filter(c=>c.unicode===r);d[0]&&(l+=`<button data-unicode="${d[0].unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?d[0].description_zh_cn:d[0].description}">
${de(d[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+n},rt=t=>{window.siyuan.config.editor.emoji.unshift(t),window.siyuan.config.editor.emoji.length>Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),fetchPost("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Ka=(t,e,n=!1)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="emojis" style="width: ${isMobile()?"80vw":"360px"}">
<div class="fn__flex">
    <span class="fn__space"></span>
    <label class="b3-form__icon fn__flex-1">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
    </label>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    <span class="fn__space"></span>
</div>
<div class="emojis__panel">${ht()}</div>
<div class="fn__flex">
    <div data-type="0" class="emojis__type" aria-label="${window.siyuan.languages.recentEmoji}">${de("2b50")}</div>
    <div data-type="1" class="emojis__type" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f527")}</div>
    <div data-type="2" class="emojis__type" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f60d")}</div>
    <div data-type="3" class="emojis__type" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f433")}</div>
    <div data-type="4" class="emojis__type" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f96a")}</div>
    <div data-type="5" class="emojis__type" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f3a8")}</div>
    <div data-type="6" class="emojis__type" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f3dd")}</div>
    <div data-type="7" class="emojis__type" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f52e")}</div>
    <div data-type="8" class="emojis__type" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("267e")}</div>
    <div data-type="9" class="emojis__type" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${de("1f6a9")}</div>
</div>
</div>`,window.siyuan.menus.menu.element.querySelector(".emojis__item").classList.add("emojis__item--current");const a=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:a.left,y:a.top+a.height});const s=window.siyuan.menus.menu.element.querySelector(".b3-text-field"),i=window.siyuan.menus.menu.element.querySelector(".emojis__panel");s.addEventListener("compositionend",()=>{var o;i.innerHTML=ht(s.value),s.value?i.nextElementSibling.classList.add("fn__none"):i.nextElementSibling.classList.remove("fn__none"),i.scrollTop=0,(o=window.siyuan.menus.menu.element.querySelector(".emojis__item"))==null||o.classList.add("emojis__item--current"),s.value===""&&pt(window.siyuan.menus.menu.element),bt(window.siyuan.menus.menu.element)}),s.addEventListener("input",o=>{var l;o.isComposing||(i.innerHTML=ht(s.value),s.value?i.nextElementSibling.classList.add("fn__none"):i.nextElementSibling.classList.remove("fn__none"),i.scrollTop=0,(l=window.siyuan.menus.menu.element.querySelector(".emojis__item"))==null||l.classList.add("emojis__item--current"),s.value===""&&pt(window.siyuan.menus.menu.element),bt(window.siyuan.menus.menu.element))}),s.addEventListener("keydown",o=>{var l,r;if(o.isComposing||o.key.indexOf("Arrow")===-1&&o.key!=="Enter")return;const d=window.siyuan.menus.menu.element.querySelector(".emojis__item--current");if(!d)return;if(o.key==="Enter"){const f=d.getAttribute("data-unicode");n?fetchPost("/api/notebook/setNotebookIcon",{notebook:t,icon:f},()=>{window.siyuan.menus.menu.remove(),rt(f),We(f,t,"iconFilesRoot")}):fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{icon:f}},()=>{window.siyuan.menus.menu.remove(),rt(f),We(f,t),yt(f,t)}),o.preventDefault(),o.stopPropagation();return}let c;if(o.key==="ArrowLeft"||o.key==="ArrowUp"?d.previousElementSibling?(d.classList.remove("emojis__item--current"),c=d.previousElementSibling,o.preventDefault(),o.stopPropagation()):(l=d.parentElement.previousElementSibling)!=null&&l.previousElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.previousElementSibling.previousElementSibling.lastElementChild,o.preventDefault(),o.stopPropagation()):(o.key==="ArrowRight"||o.key==="ArrowDown")&&(d.nextElementSibling?(d.classList.remove("emojis__item--current"),c=d.nextElementSibling,o.preventDefault(),o.stopPropagation()):(r=d.parentElement.nextElementSibling)!=null&&r.nextElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.nextElementSibling.nextElementSibling.firstElementChild,o.preventDefault(),o.stopPropagation())),c){c.classList.add("emojis__item--current");const f=s.clientHeight+6;c.offsetTop-f<i.scrollTop?i.scrollTop=c.offsetTop-f:c.offsetTop-f-i.clientHeight+c.clientHeight>i.scrollTop&&(i.scrollTop=c.offsetTop-f-i.clientHeight+c.clientHeight)}}),isMobile()||s.focus(),pt(window.siyuan.menus.menu.element),bt(window.siyuan.menus.menu.element),window.siyuan.menus.menu.element.lastElementChild.firstElementChild.addEventListener("click",o=>{const l=o.target,r=hasClosestByClassName(l,"emojis__type");if(r){const f=i.querySelector(`[data-type="${r.getAttribute("data-type")}"]`);if(f){const u=f.nextElementSibling.getAttribute("data-index");if(u){let g="";window.siyuan.emojis[parseInt(u)].items.forEach(m=>{g+=`<button data-unicode="${m.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?m.description_zh_cn:m.description}">
${de(m.unicode)}</button>`}),f.nextElementSibling.innerHTML=g,f.nextElementSibling.removeAttribute("data-index")}i.scrollTo({top:f.offsetTop-34})}return}const d=hasClosestByClassName(l,"block__icon");if(d&&d.getAttribute("aria-label")===window.siyuan.languages.remove){n?fetchPost("/api/notebook/setNotebookIcon",{notebook:t,icon:""},()=>{window.siyuan.menus.menu.remove(),We("",t,"iconFilesRoot")}):fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{icon:""}},()=>{window.siyuan.menus.menu.remove(),We("",t),yt("",t)});return}const c=hasClosestByClassName(l,"emojis__item");if(c||d){let f="";c?(f=c.getAttribute("data-unicode"),window.siyuan.menus.menu.remove()):f=kn(),n?fetchPost("/api/notebook/setNotebookIcon",{notebook:t,icon:f},()=>{rt(f),We(f,t,"iconFilesRoot")}):fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{icon:f}},()=>{rt(f),We(f,t),yt(f,t)});return}})},yt=(t,e)=>{},We=(t,e,n="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${e}"] .b3-list-item__icon`),a&&(a.innerHTML=de(t||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER:Constants.SIYUAN_IMAGE_NOTE))),n!=="iconFile"&&setNoteBook()},Za=()=>{const t=new URLSearchParams(window.location.search),e=t.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))n=e.substring(20,20+22),a=getSearch("focus",e)==="1";else if(window.JSAndroid){const s=window.JSAndroid.getBlockURL();n=Cn(s),a=getSearch("focus",s)==="1"}else n=t.get("id"),a=t.get("focus")==="1";return{id:n,isZoomIn:a}},Va=t=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t),Cn=t=>t.substring(16,16+22),Xa=(t=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",t),window.location.href=e.href},Qa=()=>{let t=document.getElementById("baseURL");t||(t=document.createElement("base"),t.id="baseURL"),t.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(t)},Dt=(t,e=!0,n=!1)=>{let a=t;return e&&(a=Bt().basename(t)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},Ja=t=>t.substring(7,t.length-Bt().extname(t).length-23),es=t=>!t||(t=t.trim(),1>t.length)?!1:(t=t.toLowerCase(),t.startsWith("assets/")||t.startsWith("file://")||t.startsWith("\\\\")?!0:t.indexOf(":")===1),Bt=()=>path.posix?path.posix:path,ts=()=>path,ns=t=>{const e=[];return t.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");e.find(i=>{if(a.startsWith(i.replace(".sy","")))return!0})||e.push(a)}}),e},as=(t,e,n)=>{fetchPost("/api/filetree/moveDocs",{toNotebook:e,fromPaths:t,toPath:n})},ss=(t,e,n,a,s=!1)=>{if(window.siyuan.dialogs.find(u=>{if(u.element.querySelector("#foldList"))return u.destroy(),!0}))return;const o=new Dialog({title:`${a||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"50vw",height:isMobile()?"80vh":"70vh",destroyCallback(){n&&focusByRange(n)}});o.element.style.zIndex="203",e&&e.length>0&&fetchPost("/api/filetree/getHPathsByPaths",{paths:e},u=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=escapeHtml(u.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");Ln(u=>{let g="";u.forEach(m=>{if(!m.closed){let p="";s&&(p=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${m.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(m.icon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${escapeHtml(m.name)}</span>
    ${p}
</li></ul>`}}),r.innerHTML=g},s);const d=o.element.querySelector(".b3-text-field");d.focus();const c=u=>{if(!(u&&u.isComposing)){if(d.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),fetchPost("/api/filetree/searchDocs",{k:d.value,flashcard:s},g=>{let m="";g.data.forEach(p=>{let b="";s&&(b=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${p.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${p.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${p.flashcardCount}</span>`),m+=`<li style="padding: 4px" class="b3-list-item${m===""?" b3-list-item--focus":""}" data-path="${p.path}" data-box="${p.box}">
    ${unicode2Emoji(p.boxIcon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall">${escapeHtml(p.hPath)}</span>
    ${b}
</li>`}),l.innerHTML=m})}};c(),d.addEventListener("compositionend",u=>{c(u)}),d.addEventListener("input",u=>{c(u)});const f=28;d.addEventListener("keydown",u=>{if(u.isComposing)return;const g=l.classList.contains("fn__none")?r:l,m=g.querySelectorAll(".b3-list-item--focus");if(m.length===0)return;let p=m[0];if(u.key.startsWith("Arrow")&&m.forEach((b,v)=>{v!==0&&b.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(u.key==="ArrowRight"&&!p.querySelector(".b3-list-item__arrow--open")&&!p.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||u.key==="ArrowLeft"&&p.querySelector(".b3-list-item__arrow--open")){wt(p,s),u.preventDefault();return}if(u.key==="ArrowLeft"){let b=p.parentElement.previousElementSibling;if(b){b.tagName!=="LI"&&(b=g.querySelector(".b3-list-item")),p.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const v=b.getBoundingClientRect(),h=g.getBoundingClientRect();(v.top<h.top||v.bottom>h.bottom)&&b.scrollIntoView(v.top<h.top)}return u.preventDefault(),!0}if(u.key==="ArrowDown"||u.key==="ArrowRight"){let b=p;for(;b;)if(b.nextElementSibling)if(b.nextElementSibling.classList.contains("fn__none"))b=b.nextElementSibling;else{b.nextElementSibling.tagName==="UL"?b=b.nextElementSibling.firstElementChild:b=b.nextElementSibling;break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){p.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const v=b.getBoundingClientRect(),h=r.getBoundingClientRect();(v.top<h.top||v.bottom>h.bottom)&&b.scrollIntoView(v.top<h.top)}return u.preventDefault(),!0}if(u.key==="ArrowUp"){let b=p;for(;b;)if(b.previousElementSibling)if(b.previousElementSibling.classList.contains("fn__none"))b=b.previousElementSibling;else{if(b.previousElementSibling.tagName==="LI")b=b.previousElementSibling;else{const v=b.previousElementSibling.querySelectorAll(".b3-list-item");b=v[v.length-1]}break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){p.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const v=b.getBoundingClientRect(),h=r.getBoundingClientRect();(v.top<h.top||v.bottom>h.bottom)&&b.scrollIntoView(v.top<h.top)}u.preventDefault()}}else{if(u.key==="ArrowDown"){p.classList.remove("b3-list-item--focus"),p.nextElementSibling?p.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),p=g.querySelector(".b3-list-item--focus"),(g.scrollTop<p.offsetTop-g.clientHeight+f||g.scrollTop>p.offsetTop)&&(g.scrollTop=p.offsetTop-g.clientHeight+f),u.preventDefault();return}if(u.key==="ArrowUp"){if(p.classList.remove("b3-list-item--focus"),p.previousElementSibling)p.previousElementSibling.classList.add("b3-list-item--focus");else{const b=g.children.length;g.children[b-1].classList.add("b3-list-item--focus")}p=g.querySelector(".b3-list-item--focus"),(g.scrollTop<p.offsetTop-g.clientHeight+f||g.scrollTop>p.offsetTop-f*2)&&(g.scrollTop=p.offsetTop-f*2),u.preventDefault();return}}if(u.key==="Enter"){const b=g.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const v=[],h=[];b.forEach(_=>{v.push(_.getAttribute("data-path")),h.push(_.getAttribute("data-box"))}),t(v,h),o.destroy(),u.preventDefault()}}),o.element.addEventListener("click",u=>{let g=u.target;for(;g&&!g.isEqualNode(o.element);){if(g.classList.contains("b3-list-item__toggle")){wt(g.parentElement,s),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const p=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(p.length===0)return;const b=[],v=[];p.forEach(h=>{b.push(h.getAttribute("data-path")),v.push(h.getAttribute("data-box"))}),t(b,v),o.destroy(),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){o.destroy(),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const p=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(p.length===0)return;a===window.siyuan.languages.specifyPath&&(u.ctrlKey||u.metaKey)?p.length===1&&p[0].isSameNode(g)||g.classList.toggle("b3-list-item--focus"):(p[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&wt(g,s),u.preventDefault(),u.stopPropagation();break}g=g.parentElement}d.focus()})},wt=(t,e)=>{const n=t.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.classList.add("fn__none");return}if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none");return}const a=t.getAttribute("data-box");fetchPost("/api/filetree/listDocsByPath",{notebook:a,path:t.getAttribute("data-path"),flashcard:e},s=>{if(s.data.path==="/"&&s.data.files.length===0){showMessage(window.siyuan.languages.emptyContent);return}let i="";if(s.data.files.forEach(l=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),i+=`<li title="${Dt(l.name,!0,!0)} ${l.hSize}${l.bookmark?`
`+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?`
`+window.siyuan.languages.name+" "+l.name1:""}${l.alias?`
`+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?`
`+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}
${window.siyuan.languages.modifiedAt} ${l.hMtime}
${window.siyuan.languages.createdAt} ${l.hCtime}" 
data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${(l.path.split("/").length-2)*18+22}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(l.icon||(l.subFileCount===0?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${Dt(l.name,!0,!0)}</span>
    ${r}
</li>`}),i==="")return;n.classList.add("b3-list-item__arrow--open"),t.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`);const o=t.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*t.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},is=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.name,!0}),e},os=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.icon,!0}),e},ls=(t,e)=>{window.siyuan.notebooks.find(n=>{if(n.id===t)return n.name=e,!0})},rs=()=>{let t=0;return window.siyuan.notebooks.forEach(e=>{e.closed||t++}),t},Ln=(t,e=!1)=>{fetchPost("/api/notebook/lsNotebooks",{flashcard:e},n=>{e||(window.siyuan.notebooks=n.data.notebooks),t&&t(n.data.notebooks)})},ds=(t,e)=>{var n,a,s,i;if(e==="preview"){if(!t.preview.element.classList.contains("fn__none"))return;t.preview.element.classList.remove("fn__none"),t.contentElement.classList.add("fn__none"),(n=t.scroll)==null||n.element.classList.add("fn__none"),t.options.render.breadcrumb&&((a=t.breadcrumb)==null||a.element.classList.add("fn__none"),t.breadcrumb.toggleExit(!0)),t.preview.render(t)}else if(e==="wysiwyg"){if(setPadding(t),!t.contentElement.classList.contains("fn__none"))return;t.preview.element.classList.add("fn__none"),t.contentElement.classList.remove("fn__none"),t.options.render.scroll&&((s=t.scroll)==null||s.element.classList.remove("fn__none")),t.options.render.breadcrumb&&((i=t.breadcrumb)==null||i.element.classList.remove("fn__none"),t.breadcrumb.toggleExit(!t.block.showAll))}hideElements(["gutter","toolbar","select","hint","util"],t)},An=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="abc"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&X(`${e}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>'),a.childElementCount<4&&a.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${S.ZWSP}</span>`);const s=a.firstElementChild.nextElementSibling;ABCJS.renderAbc(s,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")),{responsive:"resize"}),s.setAttribute("contenteditable","false"),a.setAttribute("data-render","true")})})};var xn=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const Sn=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="echarts"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&X(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{X(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const s=Y(n[0],"layout-tab-container",!0);s&&Array.from(s.children).find(i=>{if(i.classList.contains("protyle")&&!i.classList.contains("fn__none"))return a=i.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(s=>xn(void 0,null,function*(){if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const i=s.firstElementChild.nextElementSibling;try{i.style.height=s.style.height;const o=yield me(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));echarts.init(i,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption(o),s.setAttribute("data-render","true"),i.classList.remove("ft__error"),i.textContent.endsWith(S.ZWSP)||i.firstElementChild.insertAdjacentText("beforeend",S.ZWSP)}catch(o){echarts.dispose(i),i.classList.add("ft__error"),i.innerHTML=`echarts render error: <br>${o}`}}))})})},_t=(t,e)=>{if(!document.getElementById(e)){const n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href=t,document.getElementsByTagName("head")[0].appendChild(n)}},Tn=(t,e=S.PROTYLE_CDN,n=!1)=>{let a=[];t.getAttribute("data-subtype")==="math"?a=[t]:a=Array.from(t.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(_t(`${e}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),X(`${e}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then(()=>{X(`${e}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then(()=>{a.forEach(s=>{var i,o;if(s.getAttribute("data-render")==="true")return;s.setAttribute("data-render","true");let l=s;s.tagName==="DIV"&&(l=s.firstElementChild);let r={};try{r=JSON.parse(window.siyuan.config.editor.katexMacros||"{}")}catch(d){console.warn("KaTex macros is not JSON",d)}try{l.innerHTML=katex.renderToString(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")),{displayMode:s.tagName==="DIV",output:"html",macros:r}),l.classList.remove("ft__error");const d=Ie(s);if(s.tagName==="DIV"){l.firstElementChild.setAttribute("contenteditable","false"),l.childElementCount<2&&l.insertAdjacentHTML("beforeend",`<span style="position: absolute">${S.ZWSP}</span>`);const c=l.querySelectorAll(".base");c.length>0&&c[c.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const f=l.querySelector(".katex-html > .newline");f&&(f.parentElement.style.display="block")}else{d&&s.getBoundingClientRect().width>d.clientWidth?(s.style.maxWidth="100%",s.style.overflowX="auto",s.style.overflowY="hidden",s.style.display="inline-block"):(s.style.maxWidth="",s.style.overflowX="",s.style.overflowY="",s.style.display="");const c=ce(s);c?c&&c.nodeType!==3&&((i=c.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1?s.after(document.createTextNode(S.ZWSP)):c&&!c.textContent.startsWith(`
`)&&c.textContent!==S.ZWSP&&s.insertAdjacentHTML("beforeend","&#xFEFF;"):s.parentElement.tagName!=="TH"&&s.parentElement.tagName!=="TD"?s.insertAdjacentText("afterend",`
`):s.insertAdjacentText("afterend",S.ZWSP),(o=s.previousSibling)!=null&&o.textContent.endsWith(`
`)?s.insertAdjacentText("beforebegin",S.ZWSP):!Ce(s)&&["TH","TD"].includes(s.parentElement.tagName)&&s.insertAdjacentText("afterbegin",S.ZWSP)}n&&setTimeout(()=>{if(s.tagName==="DIV"){const c=s.querySelector(".katex-display");c.clientWidth<c.scrollWidth&&c.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/c.scrollWidth}%`)}else d&&s.offsetWidth>d.clientWidth&&s.firstElementChild.setAttribute("style",`font-size:${d.clientWidth*100/s.offsetWidth}%`)})}catch(d){l.innerHTML=d.message,l.classList.add("ft__error")}})})}))},Mn=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mermaid"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&X(`${e}/js/mermaid/mermaid.min.js?v=9.4.3`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const s=ee(n[0],"fold","1");if(!s)return;const i=new MutationObserver(()=>{Nt(n),i.disconnect()});i.observe(s,{attributeFilter:["fold"]})}else Nt(n)})},Nt=t=>{t.forEach((e,n)=>{if(e.getAttribute("data-render")==="true")return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const a=e.firstElementChild.nextElementSibling;a.removeAttribute("data-processed"),a.textContent=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),setTimeout(()=>{mermaid.init(void 0,a)},S.TIMEOUT_LOAD*n),e.setAttribute("data-render","true"),a.setAttribute("contenteditable","false"),e.textContent.endsWith(S.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${S.ZWSP}</span>`)})},In=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mindmap"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&X(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const s=Y(n[0],"layout-tab-container",!0);s&&Array.from(s.children).find(i=>{if(i.classList.contains("protyle")&&!i.classList.contains("fn__none")&&i.querySelector(".protyle-wysiwyg").firstElementChild)return a=i.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const i=s.firstElementChild.nextElementSibling;try{i.style.height=s.style.height,echarts.init(i,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:5,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(o,l)=>{var r;return(r=l==null?void 0:l.data)!=null&&r.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),s.setAttribute("data-render","true"),i.textContent.endsWith(S.ZWSP)||i.firstElementChild.insertAdjacentText("beforeend",S.ZWSP),i.classList.remove("ft__error")}catch(o){i.classList.add("ft__error"),i.innerHTML=`Mindmap render error: <br>${o}`}})})},Hn=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="flowchart"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&X(`${e}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=ee(n[0],"fold","1");if(!a)return;const s=new MutationObserver(()=>{$t(n),s.disconnect()});s.observe(a,{attributeFilter:["fold"]})}else $t(n)})},$t=t=>{t.forEach(e=>{if(e.getAttribute("data-render")==="true")return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>'),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${S.ZWSP}</span>`);const n=e.firstElementChild.nextElementSibling,a=flowchart.parse(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")));n.innerHTML="";try{a.drawSVG(n)}catch(s){n.classList.add("ft__error"),n.innerHTML=`Flow Chart render error: <br>${s}`}n.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")})},Dn=(t,e=S.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="plantuml"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&X(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",'<div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div>');const s=a.firstElementChild.nextElementSibling;try{s.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${plantumlEncoder.encode(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")))}">`,s.classList.remove("ft__error"),a.setAttribute("data-render","true")}catch(i){s.classList.add("ft__error"),s.innerHTML=`plantuml render error: <br>${i}`}})})},cs=(t,e)=>{const n=document.createElement("div");n.innerHTML=t;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||t.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let s=e||t;return/\n/.test(s)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span class="protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span class="protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${s.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:(s=s.replace("<","&lt;").replace(">","&gt;"),"`"+s+"`")}return!1},us=t=>{const e=t.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(e)){abcRender(t),plantumlRender(t),mermaidRender(t),flowchartRender(t),chartRender(t),mindmapRender(t),graphvizRender(t),mathRender(t);return}e==="abc"?abcRender(t):e==="plantuml"?plantumlRender(t):e==="mermaid"?mermaidRender(t):e==="flowchart"?flowchartRender(t):e==="echarts"?chartRender(t):e==="mindmap"?mindmapRender(t):e==="graphviz"?graphvizRender(t):e==="math"&&mathRender(t)},Bn=t=>{switch(t){case"text":return"iconAlignLeft";case"block":return"iconParagraph"}};var Nn=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const fs=t=>{t&&(window.siyuan.config.system.container==="ios"?window.location.href=t:window.siyuan.config.system.container==="android"&&window.JSAndroid?window.JSAndroid.openExternal(t):window.open(t))},gs=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid?window.JSAndroid.readClipboard():navigator.clipboard.readText(),$n=t=>{var e,n;let a;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0).cloneRange());try{if(window.siyuan.config.system.container==="android"&&window.JSAndroid){window.JSAndroid.writeClipboard(t);return}if(window.siyuan.config.system.container==="ios"&&((e=window.webkit)!=null&&e.messageHandlers)){window.webkit.messageHandlers.setClipboard.postMessage(t);return}navigator.clipboard.writeText(t)}catch(s){if(window.siyuan.config.system.container==="ios"&&((n=window.webkit)!=null&&n.messageHandlers))window.webkit.messageHandlers.setClipboard.postMessage(t);else if(window.siyuan.config.system.container==="android"&&window.JSAndroid)window.JSAndroid.writeClipboard(t);else{const i=document.createElement("textarea");i.value=t,i.style.position="fixed",document.body.appendChild(i),i.focus(),i.select(),document.execCommand("copy"),document.body.removeChild(i),a&&focusByRange(a)}}},ms=t=>Nn(void 0,null,function*(){t=t.replace(new RegExp(Constants.ZWSP,"g"),""),yield $n(t)}),ps=()=>navigator.userAgent.indexOf("iPhone")>-1?"touchstart":"click",bs=t=>Pn()?!!(t.metaKey&&!t.ctrlKey):!!(!t.metaKey&&t.ctrlKey),Pn=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,hs=t=>{if(/Mac/.test(navigator.platform)||navigator.platform==="iPhone")return t;const e=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];t.indexOf("\u2318")>-1&&n.push(e.get("\u2318")),t.indexOf("\u21E7")>-1&&n.push(e.get("\u21E7")),t.indexOf("\u2325")>-1&&n.push(e.get("\u2325"));const a=t.replace(/⌘|⇧|⌥/g,"");return a&&n.push(e.get(a)||a),n.join("+")},ys=t=>{let e="";return t.indexOf("\u2318")>-1&&(e+="CommandOrControl+"),t.indexOf("\u21E7")>-1&&(e+="Shift+"),t.indexOf("\u2325")>-1&&(e+="Alt+"),e+t.substr(t.length-1)},ws=t=>{fetchPost("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const n={};n[Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[Constants.LOCAL_LAYOUTS]=[],n[Constants.LOCAL_AI]=[],n[Constants.LOCAL_PLUGINTOPUNPIN]=[],n[Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1},n[Constants.LOCAL_EXPORTIMG]={keepFold:!1},n[Constants.LOCAL_DOCINFO]={id:"",action:[]},n[Constants.LOCAL_FONTSTYLES]=[],n[Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock}},n[Constants.LOCAL_ZOOM]=1,[Constants.LOCAL_EXPORTIMG,Constants.LOCAL_SEARCHKEYS,Constants.LOCAL_PDFTHEME,Constants.LOCAL_BAZAAR,Constants.LOCAL_EXPORTWORD,Constants.LOCAL_EXPORTPDF,Constants.LOCAL_DOCINFO,Constants.LOCAL_FONTSTYLES,Constants.LOCAL_SEARCHDATA,Constants.LOCAL_ZOOM,Constants.LOCAL_LAYOUTS,Constants.LOCAL_AI,Constants.LOCAL_PLUGINTOPUNPIN].forEach(a=>{if(typeof e.data[a]=="string")try{window.siyuan.storage[a]=Object.assign(n[a],JSON.parse(e.data[a]))}catch(s){window.siyuan.storage[a]=n[a]}else typeof e.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),t(),fetchPost("/api/storage/removeLocalStorageVals",{app:Constants.SIYUAN_APPID,keys:["leftColumn","local-searchkey","local-searchedata","local-searchekeys","local-searchetabdata","rightColumn","topBar"]})})},_s=(t,e)=>{fetchPost("/api/storage/setLocalStorageVal",{app:Constants.SIYUAN_APPID,key:t,val:e})},vs=(t,e,n,a=0,s=0)=>{t.style.top=n+"px",t.style.left=e+"px";const i=t.getBoundingClientRect();if(i.bottom>window.innerHeight||i.top<Constants.SIZE_TOOLBAR_HEIGHT){const o=n-i.height-a;o>Constants.SIZE_TOOLBAR_HEIGHT&&o+i.height<window.innerHeight?t.style.top=o+"px":o<=Constants.SIZE_TOOLBAR_HEIGHT?t.style.top=Constants.SIZE_TOOLBAR_HEIGHT+"px":t.style.top=Math.max(Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-i.height)+"px"}i.right>window.innerWidth?t.style.left=`${window.innerWidth-i.width-s}px`:i.left<0&&(t.style.left="0")};class Es{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(isMobile()?"click":"mouseover",e=>{const n=e.target;if(isMobile()&&(hasClosestByClassName(n,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const a=hasClosestByClassName(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const s=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(i=>{!i.contains(a)&&!i.isSameNode(a)&&!a.contains(i)&&i.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(i=>{i.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),s&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(s))})}showSubMenu(e){const n=e.parentElement.getBoundingClientRect();e.style.top=n.top-8+"px",e.style.left=n.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?e.style.left=n.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!hasClosestByClassName(e.target,"b3-menu")&&!hasClosestByClassName(e.target,"keyboard__bar")&&e.preventDefault()}addSeparator(e){this.addItem({type:"separator",index:e})}addItem(e){const n=new vt(e);return this.append(n.element,e.index),n.element}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),isMobile()?window.removeEventListener("touchmove",this.preventDefault,!1):window.removeEventListener(this.wheelEvent,this.preventDefault,!1),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),window.siyuan.menus.menu.element.removeAttribute("data-name")}append(e,n){if(e){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e,n=!1){this.element.lastElementChild.innerHTML!==""&&(isMobile()?window.addEventListener("touchmove",this.preventDefault,{passive:!1}):window.addEventListener(this.wheelEvent,this.preventDefault,{passive:!1}),this.element.classList.remove("fn__none"),setPosition(this.element,e.x-(n?window.siyuan.menus.menu.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.classList.add("b3-menu--fullscreen"),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0}}class vt{constructor(e){if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",n=>{this.element.getAttribute("disabled")||(e.click(this.element),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&window.siyuan.menus.menu.remove())}),e.id&&this.element.setAttribute("data-id",e.id),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),e.element)this.element.append(e.element);else{let n=`<span class="b3-menu__label">${e.label}</span>`;typeof e.iconHTML=="string"?n=e.iconHTML+n:n=`<svg class="b3-menu__icon${["HTML (SiYuan)",window.siyuan.languages.template].includes(e.label)?" ft__error":""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${n}`,e.accelerator&&(n+=`<span class="b3-menu__accelerator">${updateHotkeyTip(e.accelerator)}</span>`),e.action&&(n+=`<svg class="b3-menu__action"><use xlink:href="#${e.action}"></use></svg>`),this.element.innerHTML=n}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),e.submenu.forEach(a=>{n.append(new vt(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}const Ne=(t,e)=>{let n=t;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly"));)e?n=n.nextElementSibling:n=n.previousElementSibling;return n},ks=t=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||t.altKey||t.shiftKey||isCtrl(t))return!1;if(t.code==="ArrowDown"||t.code==="ArrowUp"){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let n;if(e?(e.classList.remove("b3-menu__item--current","b3-menu__item--show"),t.code==="ArrowUp"?(n=Ne(e.previousElementSibling,!1),n||(n=Ne(e.parentElement.lastElementChild,!1))):(n=Ne(e.nextElementSibling,!0),n||(n=Ne(e.parentElement.firstElementChild,!0)))):t.code==="ArrowUp"?n=Ne(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):n=Ne(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),n){n.classList.add("b3-menu__item--current"),n.classList.remove("b3-menu__item--show");const a=n.parentElement.getBoundingClientRect(),s=n.getBoundingClientRect();(a.top>s.top||a.bottom<s.bottom)&&n.scrollIntoView(a.top>s.top)}return!0}else if(t.code==="ArrowRight"){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!e)return!0;const n=e.querySelector(".b3-menu__submenu");if(!n)return!0;e.classList.remove("b3-menu__item--current"),e.classList.add("b3-menu__item--show");const a=Ne(n.firstElementChild,!0);return a&&a.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(n),!0}else if(t.code==="ArrowLeft"){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");return e&&(e.parentElement.parentElement.classList.remove("b3-menu__item--show"),e.parentElement.parentElement.classList.add("b3-menu__item--current"),e.classList.remove("b3-menu__item--current")),!0}else if(t.code==="Enter"){const e=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(e){const n=e.querySelector(".b3-text-field"),a=e.querySelector(".b3-switch");if(n)return n.focus(),!0;a?a.click():e.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.remove()}else return!1;return!0}};class Cs{constructor(){this.menus=[]}addSeparator(e){typeof e=="number"?this.menus.splice(e,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}const Ls=(t,e)=>{if(t==="")return!1;if(t.indexOf("\u21E7")===-1&&t.indexOf("\u2318")===-1&&t.indexOf("\u2325")===-1&&t.indexOf("\u2303")===-1)return t==="\u21E5"&&(t="Tab"),!e.ctrlKey&&!isCtrl(e)&&!e.altKey&&!e.shiftKey&&e.code===t;const n=t.split("");if((t.endsWith("\u2191")||t.endsWith("\u2193")||t.endsWith("\u2192")||t.endsWith("\u2190")||t.endsWith("\u21A9")||t.endsWith("\u21E5")||t.indexOf("F")>-1)&&n.forEach((s,i)=>{s==="\u2191"?n[i]="ArrowUp":s==="\u2193"?n[i]="ArrowDown":s==="\u2190"?n[i]="ArrowLeft":s==="\u2192"?n[i]="ArrowRight":s==="\u21E5"?n[i]="Tab":s==="\u21A9"?n[i]="Enter":s==="F"&&(n[i]="F"+n.splice(i+1,1),n[i+1]&&(n[i+1]+=n.splice(i+1,1)))}),t.startsWith("\u21E7")&&n.length===2){if(!e.ctrlKey&&!isCtrl(e)&&!e.altKey&&e.shiftKey){if(e.code.startsWith("Digit")||e.code.startsWith("Numpad")){if(n[1]===e.code.slice(-1)||e.key===n[1])return!0}else if(e.key===n[1])return!0}return!1}if(t.startsWith("\u2325")){let s=n.length===3?n[2]:n[1];n.length===4&&(s=n[3]);let i=(/^[0-9]$/.test(s)?e.code==="Digit"+s||e.code==="Numpad"+s:e.code==="Key"+s)||e.code===s||e.key===s;return Constants.KEYCODE[e.keyCode]&&(e.shiftKey?i=Constants.KEYCODE[e.keyCode][1]===s:i=Constants.KEYCODE[e.keyCode][0]===s),!!(i&&e.altKey&&!e.shiftKey&&(n.length===3?isCtrl(e)&&t.startsWith("\u2325\u2318"):!isCtrl(e))||i&&t.startsWith("\u2325\u21E7\u2318")&&n.length===4&&e.altKey&&e.shiftKey&&isCtrl(e)||i&&t.startsWith("\u2325\u21E7")&&n.length===3&&e.altKey&&e.shiftKey&&!isCtrl(e))}if(t.startsWith("\u2303")){let s=n.length===3?n[2]:n[1];n.length===4&&(s=n[3]);let i=(/^[0-9]$/.test(s)?e.code==="Digit"+s||e.code==="Numpad"+s:e.code==="Key"+s)||e.code===s||e.key===s;return Constants.KEYCODE[e.keyCode]&&(e.shiftKey?i=Constants.KEYCODE[e.keyCode][1]===s:i=Constants.KEYCODE[e.keyCode][0]===s),!!(i&&n.length===2&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&!e.metaKey||i&&t.startsWith("\u2303\u21E7")&&n.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||i&&t.startsWith("\u2303\u2325")&&n.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||i&&t.startsWith("\u2303\u2325\u21E7")&&n.length===4&&e.ctrlKey&&e.altKey&&e.shiftKey&&!e.metaKey)}const a=n.length>2&&n[0]==="\u21E7";if(isCtrl(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)){const s=a?n[2]:n[1];let i=(/^[0-9]$/.test(s)?e.code==="Digit"+s||e.code==="Numpad"+s:e.code==="Key"+s)||e.code===s||e.key.toLowerCase()===s.toLowerCase();return Constants.KEYCODE[e.keyCode]&&(e.shiftKey?i=Constants.KEYCODE[e.keyCode][1]===s:i=Constants.KEYCODE[e.keyCode][0]===s),i}return!1},Et=t=>{t.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){t.classList.remove("protyle-wysiwyg--hl")},1024)},As=(t,e,n=!1)=>{let a;const s=t.wysiwyg.element;if(!t.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(t.preview.element.scrollTop=a.offsetTop,Et(a));return}if(Array.from(s.querySelectorAll(`[data-node-id="${e}"]`)).find(i=>{if(!hasClosestByAttribute(i,"data-type","block-render",!0))return a=i,!0}),a)return Rn(t,a,n),Et(a),a;if(e===t.block.rootID&&t.options.render.title)return Et(t.title.editElement),t.title.editElement},Rn=(t,e,n=!1,a="auto")=>{if(!n&&getSelection().rangeCount>0&&hasClosestBlock(getSelection().getRangeAt(0).startContainer)){const o=t.contentElement,l=getSelectionPosition(o).top-o.getBoundingClientRect().top;let r=0;l<0?r=o.scrollTop+l:l>o.clientHeight-74&&(r=o.scrollTop+(l+74-o.clientHeight)),r!==0&&o.scroll({top:r,behavior:a});return}if(e||(e=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer)),!e)return;let s=0,i=e;for(;!i.classList.contains("protyle-wysiwyg");)s+=i.offsetTop,i=i.parentElement;if(n){t.contentElement.scroll({top:s-32,behavior:a});return}t.contentElement.scrollTop>s-32?t.contentElement.scroll({top:s-32,behavior:a}):t.contentElement.scrollTop+t.contentElement.clientHeight<s+e.clientHeight-32&&t.contentElement.scroll({top:s+e.clientHeight-32-t.contentElement.clientHeight,behavior:a})};var xs=he(680);const Ae=(t,e)=>{if(t.getAttribute("data-subtype")!=="o")return;let n;Array.from(t.children).forEach((a,s)=>{s===0?e?(n=e,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},Ss=(t,e=0,n=!1)=>{const a=document.createElement("template"),s=t.getAttribute("data-subtype");if(s==="o"){const i=parseInt(t.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${i+1}." data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${i+1}.</div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else s==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},Ts=(t,e,n)=>{const a=e[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr")),e.forEach(i=>{i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end")});const s=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const i=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let d=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((c,f)=>{o.push({action:"move",id:c.getAttribute("data-node-id"),previousID:d}),l.push({action:"move",id:c.getAttribute("data-node-id"),previousID:f===0?a.getAttribute("data-node-id"):d}),d=c.getAttribute("data-node-id"),c.setAttribute("data-subtype",r);const u=c.querySelector(".protyle-action");r==="o"?(u.classList.add("protyle-action--order"),u.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):r==="t"?(c.setAttribute("data-marker","*"),u.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',u.classList.remove("protyle-action--order"),u.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):(c.setAttribute("data-marker","*"),u.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',u.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c))}),r==="o"?(Ae(a.lastElementChild.previousElementSibling),Ae(a.parentElement)):a.getAttribute("data-subtype")==="o"&&Ae(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:i,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),transaction(t,o,l))}else{const i=a.outerHTML,o=e[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const d=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const c=[];let f;e.forEach((u,g)=>{d.push({action:"move",id:u.getAttribute("data-node-id"),parentID:r,previousID:f}),c.push({action:"move",id:u.getAttribute("data-node-id"),previousID:g===0?a.getAttribute("data-node-id"):f}),f=u.getAttribute("data-node-id"),l.lastElementChild.before(u)}),c.push({action:"delete",id:r}),o==="o"&&(Ae(l,1),Ae(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(d.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),c.push({action:"update",data:i,id:a.getAttribute("data-node-id")}),transaction(t,d,c))}a.parentElement.classList.contains("protyle-wysiwyg")||updateTransaction(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,s),focusByWbr(a,n)},Ms=(t,e,n)=>{var a,s;const i=e.parentElement,o=i.getAttribute("data-node-id"),l=[],r=[];n.insertNode(document.createElement("wbr"));const d=Lute.NewNodeID();let c="",f=0;Array.from(i.parentElement.children).forEach(g=>{!f&&g.isSameNode(i)?f=1:f&&!g.classList.contains("protyle-attr")&&(r.push({id:g.getAttribute("data-node-id"),action:"move",previousID:o}),l.push({id:g.getAttribute("data-node-id"),action:"delete"}),g.getAttribute("data-subtype")==="o"&&(r.push({id:g.getAttribute("data-node-id"),action:"update",data:g.outerHTML}),g.setAttribute("data-marker",f+"."),g.firstElementChild.innerHTML=f+"."),c+=g.outerHTML,g.remove(),f++)}),r.reverse(),c=`<div data-subtype="${i.getAttribute("data-subtype")}" data-node-id="${d}" data-type="NodeList" class="list" updated="${dayjs().format("YYYYMMDDHHmmss")}">${c}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,i.parentElement.insertAdjacentHTML("afterend",c),l.push({id:d,action:"insert",previousID:i.parentElement.getAttribute("data-node-id"),data:c}),r.push({id:d,action:"delete"}),Array.from(i.children).reverse().forEach(g=>{!g.classList.contains("protyle-action")&&!g.classList.contains("protyle-attr")&&(l.push({id:g.getAttribute("data-node-id"),action:"move",previousID:i.parentElement.getAttribute("data-node-id")}),r.push({id:g.getAttribute("data-node-id"),action:"move",parentID:o}),i.parentElement.after(g))});const u=i.parentElement.getAttribute("data-node-id");i.parentElement.childElementCount===2?(r.splice(0,0,{id:u,action:"insert",data:i.parentElement.outerHTML,previousID:(a=i.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:i.parentElement.parentElement.getAttribute("data-node-id")||t.block.rootID}),i.parentElement.remove(),l.push({id:u,action:"delete"})):(r.splice(0,0,{id:o,action:"insert",data:i.outerHTML,previousID:(s=i.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:u}),i.remove(),l.push({id:o,action:"delete"})),transaction(t,l,r),focusByWbr(t.wysiwyg.element,n)},Is=(t,e,n)=>{var a,s,i,o,l,r;const d=e[0].parentElement,c=d.getAttribute("data-node-id");if(!c)return;const f=d.parentElement;if(f.classList.contains("protyle-wysiwyg")||f.classList.contains("sb")||f.classList.contains("bq")){const _=[],C=[];n.collapse(!1),n.insertNode(document.createElement("wbr"));let k;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(k=parseInt(e[0].getAttribute("data-marker")));let E=c,L=d,w=e[e.length-1].nextElementSibling,y=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach(M=>{M.classList.remove("protyle-wysiwyg--select"),M.removeAttribute("select-start"),M.removeAttribute("select-end"),Array.from(M.children).forEach((x,B)=>{const K=x.getAttribute("data-node-id");K&&(_.push({action:"move",id:K,previousID:E,parentID:f.getAttribute("data-node-id")||t.block.parentID}),C.push({action:"move",id:K,previousID:B===1?void 0:E,parentID:M.getAttribute("data-node-id"),data:x.contains(n.startContainer)?"focus":""}),E=K,L.after(x),L=x)})}),!window.siyuan.config.editor.listLogicalOutdent&&!w.classList.contains("protyle-attr")){let M;y.getAttribute("data-subtype")!==w.getAttribute("data-subtype")&&(M=Lute.NewNodeID(),y=document.createElement("div"),y.classList.add("list"),y.setAttribute("data-subtype",w.getAttribute("data-subtype")),y.setAttribute("data-node-id",M),y.setAttribute("data-type","NodeList"),y.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),y.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,L.after(y),_.push({action:"insert",id:M,data:y.outerHTML,previousID:L.getAttribute("data-node-id")}));let x;for(;w&&!w.classList.contains("protyle-attr");){_.push({action:"move",id:w.getAttribute("data-node-id"),previousID:x||((a=y.lastElementChild.previousElementSibling)==null?void 0:a.getAttribute("data-node-id")),parentID:y.getAttribute("data-node-id")}),C.push({action:"move",id:w.getAttribute("data-node-id"),parentID:y.getAttribute("data-node-id"),previousID:x||((s=w.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"))}),x=w.getAttribute("data-node-id");const B=w;w=w.nextElementSibling,y.lastElementChild.before(B)}y.getAttribute("data-subtype")==="o"&&(Array.from(y.children).forEach(B=>{const K=B.getAttribute("data-node-id");K&&C.push({action:"update",id:K,data:B.outerHTML})}),Ae(y,1),Array.from(y.children).forEach(B=>{const K=B.getAttribute("data-node-id");K&&_.push({action:"update",id:K,data:B.outerHTML})})),M&&C.push({action:"delete",id:M})}const A=d.outerHTML;e.forEach(M=>{M.remove()}),d.childElementCount===1?(_.push({action:"delete",id:c}),c===t.block.id&&(t.block.id=t.block.parentID),C.splice(0,0,{action:"insert",data:A,id:c,previousID:(i=d.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")||t.block.parentID}),d.remove()):(d.getAttribute("data-subtype")==="o"&&Ae(d,k),_.push({action:"update",id:c,data:d.outerHTML}),C.splice(0,0,{action:"update",id:c,data:A})),transaction(t,_,C),focusByWbr(f,n);return}if(d.childElementCount===2&&f.childElementCount===3){n.collapse(!1),n.insertNode(document.createElement("wbr"));const _=f.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),d.outerHTML=e[0].innerHTML,updateTransaction(t,f.getAttribute("data-node-id"),f.outerHTML,_),focusByWbr(f,n);return}n.collapse(!1),n.insertNode(document.createElement("wbr"));const u=[],g=[],m=(o=e[0].previousElementSibling)==null?void 0:o.getAttribute("data-node-id");e.forEach(_=>{_.classList.remove("protyle-wysiwyg--select"),_.removeAttribute("select-start"),_.removeAttribute("select-end")});let p;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(p=parseInt(e[0].getAttribute("data-marker")));const b=f.parentElement.outerHTML;let v=e[e.length-1].nextElementSibling,h=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(_=>{const C=_.getAttribute("data-node-id");u.push({action:"move",id:C,previousID:f.getAttribute("data-node-id")}),g.push({action:"move",id:C,previousID:m,parentID:d.getAttribute("data-node-id")}),f.after(_),(_.getAttribute("data-subtype")==="o"||_.getAttribute("data-subtype")==="t")&&f.getAttribute("data-subtype")==="u"?(g.push({action:"update",id:C,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',_.setAttribute("data-subtype","u"),_.setAttribute("data-marker","*"),u.push({action:"update",id:C,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="t")&&f.getAttribute("data-subtype")==="o"?(g.push({action:"update",id:C,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',_.setAttribute("data-subtype","o"),_.setAttribute("data-marker","1."),u.push({action:"update",id:C,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="0")&&f.getAttribute("data-subtype")==="t"&&(g.push({action:"update",id:C,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',_.setAttribute("data-subtype","t"),_.setAttribute("data-marker","*"),u.push({action:"update",id:C,data:_.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!v.classList.contains("protyle-attr")){let _;h.classList.contains("list")||(_=Lute.NewNodeID(),h=document.createElement("div"),h.classList.add("list"),h.setAttribute("data-subtype",v.getAttribute("data-subtype")),h.setAttribute("data-node-id",_),h.setAttribute("data-type","NodeList"),h.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),h.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,u.push({action:"insert",id:_,data:h.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(h));let C;for(;v&&!v.classList.contains("protyle-attr");){const k=v.getAttribute("data-node-id");v.getAttribute("data-subtype")!==h.getAttribute("data-subtype")&&(g.push({action:"update",id:k,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML=h.querySelector(".protyle-action").outerHTML,v.setAttribute("data-subtype",h.getAttribute("data-subtype")),v.setAttribute("data-marker",h.getAttribute("data-marker")),u.push({action:"update",id:k,data:v.outerHTML})),u.push({action:"move",id:k,previousID:C||((l=h.lastElementChild.previousElementSibling)==null?void 0:l.getAttribute("data-node-id")),parentID:h.getAttribute("data-node-id")}),g.push({action:"move",id:k,previousID:C||((r=h.parentElement)==null?void 0:r.getAttribute("data-node-id"))}),C=k;const E=v;v=v.nextElementSibling,h.lastElementChild.before(E)}h.getAttribute("data-subtype")==="o"&&(Array.from(h.children).forEach(k=>{const E=k.getAttribute("data-node-id");E&&g.push({action:"update",id:E,data:k.outerHTML})}),Ae(h,1),Array.from(h.children).forEach(k=>{const E=k.getAttribute("data-node-id");E&&u.push({action:"update",id:E,data:k.outerHTML})})),_&&g.push({action:"delete",id:_})}d.childElementCount===1?(u.push({action:"delete",id:d.getAttribute("data-node-id")}),g.splice(0,0,{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:d.previousElementSibling.getAttribute("data-node-id")}),d.remove()):d.getAttribute("data-subtype")==="o"&&(g.splice(0,0,{action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")}),Ae(d,p),u.push({action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")})),f.parentElement.classList.contains("protyle-wysiwyg")?transaction(t,u,g):(f.getAttribute("data-subtype")==="o"&&Ae(f.parentElement),updateTransaction(t,f.parentElement.getAttribute("data-node-id"),f.parentElement.outerHTML,b)),focusByWbr(f.parentElement,n)},Hs=(t,e)=>{const n=[],a=[];let s=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const i=e.getAttribute("data-node-id"),o=e.cloneNode();return o.innerHTML=e.lastElementChild.outerHTML,a.push({action:"insert",id:i,data:o.outerHTML,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),Array.from(e.children).forEach((l,r)=>{if(r===e.childElementCount-1){n.push({action:"delete",id:i}),e.lastElementChild.remove(),e.outerHTML=e.innerHTML;return}n.push({action:"move",id:l.getAttribute("data-node-id"),previousID:s,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:i}),s=l.getAttribute("data-node-id")}),n.forEach(l=>{const r=t.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(t,r))}),{doOperations:n,undoOperations:a,previousId:s}},Ds=(t,e,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",t),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,a},Bs=(t,e)=>{const n=getTopAloneElement(e);if(n){const a=hasClosestByClassName(n,"list")||hasClosestByClassName(n,"bq")||hasClosestByClassName(n,"sb")||n,s=getNextBlock(a);s&&(focusBlock(s),scrollCenter(t,s))}},Ns=(t,e,n)=>{const a=getEditorRange(t.wysiwyg.element);let s;if(n)s=t.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const d=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");d.length>0?(e==="beforebegin"?s=d[0]:s=d[d.length-1],hideElements(["select"],t)):(s=hasClosestBlock(a.startContainer),s=getTopAloneElement(s))}if(!s)return;let i=On(!1,!0),o=1;s.getAttribute("data-type")==="NodeListItem"&&(i=genListItemElement(s,0,!0),o=parseInt(s.parentElement.firstElementChild.getAttribute("data-marker")));const l=s.parentElement.outerHTML,r=i.getAttribute("data-node-id");if(s.insertAdjacentElement(e,i),s.getAttribute("data-type")==="NodeListItem"&&s.getAttribute("data-subtype")==="o"&&!i.parentElement.classList.contains("protyle-wysiwyg"))updateListOrder(i.parentElement,o),updateTransaction(t,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,l);else{let d;e==="beforebegin"?d=[{action:"insert",data:i.outerHTML,id:r,nextID:s.getAttribute("data-node-id")}]:d=[{action:"insert",data:i.outerHTML,id:r,previousID:s.getAttribute("data-node-id")}],transaction(t,d,[{action:"delete",id:r}])}focusByWbr(t.wysiwyg.element,a),scrollCenter(t)},$s=(t=!0,e=!0,n)=>{let a="";return t&&(a=Constants.ZWSP),e&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${Constants.ZWSP}</div></div>`},On=(t=!0,e=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${t?Constants.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,a},Te=t=>{let e=t.previousElementSibling,n=0;for(;e;)n++,e=e.previousElementSibling;return n},Pt=(t,e,n=!0)=>{let a=t.previousElementSibling;return a||(t.parentElement.previousElementSibling?a=t.parentElement.previousElementSibling.lastElementChild:t.parentElement.parentElement.tagName==="TBODY"&&t.parentElement.parentElement.previousElementSibling?a=t.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),n||e.collapse(!1),focusByRange(e)),a},kt=(t,e,n,a,s)=>{s.insertNode(document.createElement("wbr"));const i=n.outerHTML,o=n.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,d=[];for(let c=0;c<r;c++){for(let f=0;f<l;f++)o.rows[c].cells[f].isSameNode(e[d.length])&&d.push(f);if(d.length>0)break}for(let c=0;c<r;c++)d.forEach(f=>{o.rows[c].cells[f].setAttribute("align",a)});updateTransaction(t,n.getAttribute("data-node-id"),n.outerHTML,i),focusByWbr(o,s)},Rt=(t,e,n,a)=>{const s=document.createElement("wbr");e.insertNode(s);const i=a.outerHTML;s.remove();let o="";for(let r=0;r<n.parentElement.childElementCount;r++)o+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=n.parentElement.nextElementSibling;e.selectNodeContents(l.cells[Te(n)]),e.collapse(!0),focusByRange(e),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,i),scrollCenter(t,l)},qn=(t,e,n,a)=>{const s=document.createElement("wbr");e.insertNode(s);const i=a.outerHTML;s.remove();let o="",l=!1;for(let d=0;d<n.parentElement.childElementCount;d++){const c=n.parentElement.children[d];c.className==="fn__none"&&(l=!0),n.tagName==="TH"?o+=`<th class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></th>`:o+=`<td class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></td>`}if(l){let d=n.parentElement.previousElementSibling,c=1;for(;d;)c++,Array.from(d.children).forEach(f=>{f.rowSpan>=c&&f.rowSpan>1&&(f.rowSpan=f.rowSpan+1)}),d=d.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=n.parentElement.previousElementSibling),e.selectNodeContents(r.cells[Te(n)]),e.collapse(!0),focusByRange(e),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,i),scrollCenter(t,r)},Ot=(t,e,n,a,s)=>{const i=document.createElement("wbr");s.insertNode(i);const o=e.outerHTML;i.remove();const l=Te(n),r=e.querySelector("table");for(let d=0;d<r.rows.length;d++){const c=r.rows[d].cells[l],f=document.createElement(c.tagName);c.insertAdjacentElement(a,f),c.isSameNode(n)?(f.innerHTML="<wbr> ",f.offsetLeft+f.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=f.offsetLeft+f.clientWidth-e.firstElementChild.clientWidth)):f.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col>"),focusByWbr(e,s),updateTransaction(t,e.getAttribute("data-node-id"),e.outerHTML,o)},Fn=(t,e,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const s=document.createElement("wbr");e.insertNode(s);const i=a.outerHTML;s.remove();const o=Te(n),l=n.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),l.childElementCount===1?l.remove():n.parentElement.remove(),e.selectNodeContents(r.cells[o]),e.collapse(!0),focusByRange(e),scrollCenter(t,r),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,i)}},Wn=(t,e,n,a)=>{var s;const i=document.createElement("wbr");e.insertNode(i);const o=n.outerHTML;i.remove();const l=Te(a),r=a.previousElementSibling||a.nextElementSibling;r&&(e.selectNodeContents(r),e.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth));const d=n.querySelector("table");for(let c=0;c<d.rows.length;c++){const f=d.rows[c].cells;if(f.length===1){d.remove();break}f[l].remove()}(s=n.querySelectorAll("col")[l])==null||s.remove(),updateTransaction(t,n.getAttribute("data-node-id"),n.outerHTML,o),focusByRange(e)},jn=(t,e,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.previousElementSibling)s.after(s.previousElementSibling);else{const o=s.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.after(o),s.parentElement.previousElementSibling.append(s)}updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,i),focusByWbr(a,e),scrollCenter(t,s)},Yn=(t,e,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="TBODY"&&!s.nextElementSibling||s.parentElement.tagName==="THEAD"&&!s.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.nextElementSibling)s.before(s.nextElementSibling);else{const o=s.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.after(o),s.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",s)}updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,i),focusByWbr(a,e),scrollCenter(t,s)},Un=(t,e,n,a)=>{if(!n.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return i=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[i].after(l.cells[i-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const o=a.querySelectorAll("col");o[i].after(o[i-1]),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,s),focusByWbr(a,e)},zn=(t,e,n,a)=>{if(!n.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return i=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[i].before(l.cells[i+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[i].before(o[i+1]),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,s),focusByWbr(a,e)},Ps=(t,e,n)=>{var a,s,i;const o=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH"),l=hasClosestBlock(n.startContainer);if(!o||!l||l.classList.contains("protyle-wysiwyg--select"))return!1;if(e.key==="Enter"&&e.shiftKey&&!isCtrl(e)&&!e.altKey){const w=document.createElement("wbr");n.insertNode(w);const y=l.outerHTML;if(w.remove(),o&&!o.innerHTML.endsWith("<br>")&&o.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),t.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const M=document.createElement("br");n.startContainer.after(M),n.setStartAfter(M)}else n.insertNode(document.createElement("br"));return n.collapse(!1),scrollCenter(t),updateTransaction(t,l.getAttribute("data-node-id"),l.outerHTML,y),e.preventDefault(),!0}if(!isCtrl(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const w=o.parentElement;if(!w.nextElementSibling&&w.parentElement.tagName==="TBODY"||w.parentElement.tagName==="THEAD"&&!w.parentElement.nextElementSibling)return!0;let y=w.nextElementSibling;return y||(y=w.parentElement.nextElementSibling.firstChild),y&&(n.selectNodeContents(y.cells[Te(o)]),n.collapse(!0),scrollCenter(t)),!0}if(e.key==="ArrowRight"&&n.toString()===""&&!l.nextElementSibling&&o.isSameNode(l.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&getSelectionOffset(o,t.wysiwyg.element,n).start===o.textContent.length)return e.preventDefault(),insertEmptyBlock(t,"afterend",l.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&!e.ctrlKey){if(e.shiftKey)return Pt(o,n),e.preventDefault(),!0;let w=o.nextElementSibling;return w||(o.parentElement.nextElementSibling?w=o.parentElement.nextElementSibling.firstElementChild:o.parentElement.parentElement.tagName==="THEAD"&&o.parentElement.parentElement.nextElementSibling?w=o.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:w=null),w?n.selectNodeContents(w):(Rt(t,n,o,l),n.selectNodeContents(l.querySelector("tbody").lastElementChild.firstElementChild)),e.preventDefault(),!0}if(e.key==="ArrowUp"&&!isCtrl(e)&&!e.shiftKey&&!e.altKey){const w=n.startContainer;let y;for(w.nodeType!==3&&(w.tagName==="TH"||w.tagName==="TD")?y=(a=w.childNodes[Math.max(0,n.startOffset-1)])==null?void 0:a.previousElementSibling:w.parentElement.tagName==="SPAN"?y=w.parentElement.previousElementSibling:y=w.previousElementSibling;y;){if(y.tagName==="BR")return!1;y=y.previousElementSibling}const A=o.parentElement;let M=A.previousElementSibling;return M||(M=A.parentElement.previousElementSibling.lastElementChild),!M||(M==null?void 0:M.tagName)==="COL"?!1:(n.selectNodeContents(M.cells[Te(o)]),n.collapse(!1),scrollCenter(t),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&!isCtrl(e)&&!e.shiftKey&&!e.altKey){const w=n.endContainer;let y;for(w.nodeType!==3&&(w.tagName==="TH"||w.tagName==="TD")?y=(s=w.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:s.nextElementSibling:w.parentElement.tagName==="SPAN"?y=w.parentElement.nextElementSibling:y=w.nextElementSibling;y;){if(y.tagName==="BR"&&y.nextSibling)return!1;y=y.nextElementSibling}const A=o.parentElement;if(!A.nextElementSibling&&A.parentElement.tagName==="TBODY"||A.parentElement.tagName==="THEAD"&&!A.parentElement.nextElementSibling)return!1;let M=A.nextElementSibling;return M||(M=A.parentElement.nextElementSibling.firstChild),M?(n.selectNodeContents(M.cells[Te(o)]),n.collapse(!0),scrollCenter(t),e.preventDefault(),!0):!1}if(!isCtrl(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&getSelectionOffset(o,t.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&o.querySelectorAll("br").length===1))return!Pt(o,n,!1)&&l.previousElementSibling&&focusBlock(l.previousElementSibling,void 0,!1),scrollCenter(t),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return kt(t,[o],l,"left",n),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return kt(t,[o],l,"center",n),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return kt(t,[o],l,"right",n),e.preventDefault(),!0;const r=l.querySelector("table"),d=o.parentElement.querySelector(".fn__none");let c=!1,f=!1;Array.from(o.parentElement.children).forEach(w=>{w.colSpan>1&&(c=!0),w.rowSpan>1&&(f=!0)});let u=!1,g=!1,m=!1,p=o.parentElement.previousElementSibling;!p&&o.parentElement.parentElement.tagName==="TBODY"&&(p=r.querySelector("thead").lastElementChild),p&&(u=p.querySelector(".fn__none"),Array.from(p.children).forEach(w=>{w.colSpan>1&&(g=!0),w.rowSpan>1&&(m=!0)}));let b=!1,v=!1,h=!1,_=o.parentElement.nextElementSibling;!_&&o.parentElement.parentElement.tagName==="THEAD"&&(_=(i=r.querySelector("tbody"))==null?void 0:i.firstElementChild),_&&(b=_.querySelector(".fn__none"),Array.from(_.children).forEach(w=>{w.colSpan>1&&(v=!0),w.rowSpan>1&&(h=!0)}));const C=Te(o);let k=!0;Array.from(r.rows).find(w=>{const y=w.cells[C];if(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1)return k=!1,!0});let E=!0;Array.from(r.rows).find(w=>{const y=w.cells[C+1];if(y&&(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1))return E=!1,!0});let L=!0;if(Array.from(r.rows).find(w=>{const y=w.cells[C-1];if(y&&(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1))return L=!1,!0}),matchHotKey(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!d||d&&!f&&c)&&(!u||u&&!m&&g)&&jn(t,n,o,l),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!d||d&&!f&&c)&&(!b||b&&!h&&v)&&Yn(t,n,o,l),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return k&&L&&Un(t,n,o,l),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return k&&E&&zn(t,n,o,l),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return qn(t,n,o,l),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!b||b&&!h&&v)&&Rt(t,n,o,l),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(k||L)&&Ot(t,l,o,"beforebegin",n),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(k||E)&&Ot(t,l,o,"afterend",n),e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!d&&!f||d&&!f&&c)&&Fn(t,n,o,l),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return k&&Wn(t,n,l,o),e.preventDefault(),!0},Rs=(t,e,n=!1)=>{if(isMobile())return;const a=e.getBoundingClientRect();if(a.height===0||!t){Gn();return}let s=document.getElementById("tooltip");s?s.innerHTML=t:(document.body.insertAdjacentHTML("beforeend",`<div class="tooltip" id="tooltip">${t}</div>`),s=document.getElementById("tooltip")),n?s.classList.add("tooltip--error"):s.classList.remove("tooltip--error"),e.getAttribute("data-inline-memo-content")&&s.classList.add("tooltip--memo");let i=a.left;const o=e.getAttribute("data-position");o==="right"?i=a.right-s.clientWidth:o==="center"&&(i=a.left+(a.width-s.clientWidth)/2),setPosition(s,i,a.top+a.height+8,a.height*2+8)},Gn=()=>{const t=document.getElementById("tooltip");t&&t.remove()},Kn=(t,e)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(t)?(e?showTooltip(window.siyuan.languages.fileNameRule,e,!0):showMessage(window.siyuan.languages.fileNameRule),!1):t.length>Constants.SIZE_TITLE?(e?showTooltip(window.siyuan.languages._kernel[106],e,!0):showMessage(window.siyuan.languages._kernel[106]),!1):!0,qt=t=>t.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,Constants.SIZE_TITLE),Os=t=>t.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),qs=t=>{if(window.siyuan.config.editor.readOnly||window.siyuan.config.readonly)return;const e=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",destroyCallback(){t.range&&focusByRange(t.range)}}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(t.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!Kn(n.value))return!1;if(n.value===t.name)return e.destroy(),!1;n.value.trim()===""?n.value="Untitled":n.value=qt(n.value),t.type==="notebook"?fetchPost("/api/notebook/renameNotebook",{notebook:t.notebookId,name:n.value},()=>{setNotebookName(t.notebookId,n.value)}):fetchPost("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n.value}),e.destroy()})},Fs=t=>{const e=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()});const s=getAssetName(t);n.value=s,n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(n.value===s||!n.value)return e.destroy(),!1;fetchPost("/api/asset/renameAsset",{oldPath:t,newName:n.value})})},Ws=t=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),n=hasClosestBlock(e.startContainer);if(!n)return;let a=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let s="",i=e.toString();if(i===""){if(i=a[0].textContent,a.forEach(o=>{s+=removeEmbed(o)}),!i)return}else{const o=document.createElement("div");o.appendChild(e.cloneContents()),s=o.innerHTML}i.length>10&&(i=i.substr(0,10)+"..."),i=qt(i),fetchPost("/api/filetree/createDoc",{notebook:t.notebookId,path:pathPosix().join(getDisplayName(t.path,!1,!0),Lute.NewNodeID()+".sy"),title:i,md:t.lute.BlockDOM2StdMd(s)})},js=(t,e)=>{},Ys=t=>{const e=new Dialog({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${isMobile()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${isMobile()?"padding: 16px;margin: 16px 0":"padding: 48px;margin: 8px 0 24px"};border: 1px solid var(--b3-border-color);border-radius: 10px;" class="export-img protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}" id="preview"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <span class="fn__flex-1"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:isMobile()?"92vw":"990px",height:"70vh"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{const o=showMessage(window.siyuan.languages.exporting,0);e.element.querySelector(".b3-dialog__container").style.height="",setStorageVal(Constants.LOCAL_EXPORTIMG,window.siyuan.storage[Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{addScript("stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(a.parentElement,{useCORS:!0}).then(l=>{l.toBlob(r=>{const d=new FormData;d.append("file",r,n[1].getAttribute("data-title")),d.append("type","image/png"),fetchPost("/api/export/exportAsFile",d,c=>{openByMobile(c.data.file)}),hideMessage(o),e.destroy()})})})},Constants.TIMEOUT_LOAD)});const a=e.element.querySelector("#preview"),s=e.element.querySelector("#keepFold");s.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold=s.checked,fetchPost("/api/export/exportPreviewHTML",{id:t,keepFold:s.checked,image:!0},o=>{i(o)})});const i=o=>{a.innerHTML=o.data.content,processRender(a),highlightRender(a),a.querySelectorAll("table").forEach(l=>{l.clientWidth>l.parentElement.clientWidth&&(l.setAttribute("style",`margin-bottom:${l.parentElement.clientWidth*l.clientHeight/l.clientWidth-l.parentElement.clientHeight+1}px;transform: scale(${l.parentElement.clientWidth/l.clientWidth});transform-origin: top left;`),l.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(l=>{const r=l.firstElementChild.getAttribute("xlink:href"),d=document.querySelectorAll(r);let c="0 0 32 32";r==="#iconDot"&&(c="0 0 20 20"),l.setAttribute("viewBox",c),l.innerHTML=d[d.length-1].innerHTML}),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};fetchPost("/api/export/exportPreviewHTML",{id:t,keepFold:s.checked,image:!0},o=>{i(o),n[1].setAttribute("data-title",o.data.name+".png")})};var Zn=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const Ct=(t,e)=>{t.addEventListener("keydown",n=>{n.isComposing||matchHotKey("\u2318\u21A9",n)&&(e.dispatchEvent(new CustomEvent("click")),n.stopPropagation(),n.preventDefault())})},Us=t=>{const e=t.getAttribute("data-node-id"),n=getEditorRange(t),a=t.getAttribute("custom-reminder-wechat");let s="";a&&(s=dayjs(a).format("YYYY-MM-DDTHH:mm"));const i=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${s}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(n)}}),o=i.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),fetchPost("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{t.removeAttribute("custom-reminder-wechat"),i.destroy()}))}),o[2].addEventListener("click",()=>{const l=i.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=dayjs(l).format("YYYYMMDDHHmmss");fetchPost("/api/block/setBlockReminder",{id:e,timed:r},()=>{t.setAttribute("custom-reminder-wechat",r),i.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})},zs=t=>{fetchPost("/api/block/getDocInfo",{id:t.block.rootID},e=>{const n=e.data.ial["custom-reminder-wechat"];let a="";n&&(a=dayjs(n).format("YYYY-MM-DDTHH:mm"));const s=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),i=s.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{s.destroy()}),i[1].addEventListener("click",()=>{fetchPost("/api/block/setBlockReminder",{id:t.block.rootID,timed:"0"},()=>{s.destroy()})}),i[2].addEventListener("click",()=>{const o=s.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}fetchPost("/api/block/setBlockReminder",{id:t.block.rootID,timed:dayjs(o).format("YYYYMMDDHHmmss")},()=>{s.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})})},Ft=(t,e="bookmark",n)=>{let a="",s="";const i=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(t).forEach(d=>{d!=="custom-riff-decks"&&(d==="custom-reminder-wechat"?s=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" readonly data-name="${d}" value="${dayjs(t[d]).format("YYYY-MM-DDTHH:mm")}">
</label>`:d.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${d.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" data-name="${d}">${t[d]}</textarea>
</label>`))});const o=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.attr,content:`<div class="custom-attr" style="max-height: calc(100vh - 166px);overflow: auto;">
    <label class="b3-label b3-label--noborder">
        <div class="fn__flex">
            <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
            <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
        </div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
    </label>
    <label class="b3-label b3-label--noborder">
        ${window.siyuan.languages.name}
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
    </label>
    <label class="b3-label b3-label--noborder">
        ${window.siyuan.languages.alias}
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
    </label>
    <label class="b3-label b3-label--noborder">
        ${window.siyuan.languages.memo}
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${t.memo||""}</textarea>
    </label>
    ${s}
    ${a}
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--outline">
        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
    </button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(i)}});o.element.querySelector('.b3-text-field[data-name="bookmark"]').value=t.bookmark||"",o.element.querySelector('.b3-text-field[data-name="name"]').value=t.name||"",o.element.querySelector('.b3-text-field[data-name="alias"]').value=t.alias||"";const l=[];o.element.addEventListener("click",d=>{const c=d.target,f=hasClosestByClassName(c,"block__icon");if(f)switch(f.getAttribute("data-action")){case"remove":f.previousElementSibling.tagName==="SPAN"&&l.push(f.parentElement.parentElement.querySelector("textarea").getAttribute("data-name")),f.parentElement.parentElement.remove();break;case"bookmark":fetchPost("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(g=>{window.siyuan.menus.menu.append(new MenuItem({label:g,click(){f.parentElement.parentElement.querySelector("input").value=g}}).element)}),window.siyuan.menus.menu.element.style.zIndex="310",window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:d.clientX,y:d.clientY+16,w:16})});break}});const r=o.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{o.element.querySelector(".custom-attr").insertAdjacentHTML("beforeend",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <input placeholder="${window.siyuan.languages.attrName}" class="b3-text-field">
        <span class="fn__flex-1"></span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const d=o.element.querySelectorAll(".b3-text-field");d[d.length-2].focus(),Ct(d[d.length-1],r[2]),Ct(d[d.length-2],r[2])}),r[1].addEventListener("click",()=>{o.destroy()}),r[2].addEventListener("click",()=>{n(o,l)}),o.element.querySelectorAll(".b3-text-field").forEach(d=>{e===d.getAttribute("data-name")&&d.focus(),Ct(d,r[2])})},Gs=(t,e,n="bookmark")=>{Ft(t,n,a=>{let s="",i="";const o={};a.element.querySelectorAll(".b3-text-field").forEach(l=>{let r=l.getAttribute("data-name");if(!r){if(l.tagName==="INPUT")return;r="custom-"+l.parentElement.querySelector(".b3-text-field").value}if(l.value.trim()){if(!isValidAttrName(r)){i+=r.replace(/^custom-/,"")+", ";return}o[r]=l.value;const d=Lute.EscapeHTMLStr(l.value);r==="bookmark"?s+=`<div class="protyle-attr--bookmark">${d}</div>`:r==="name"?s+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${d}</div>`:r==="alias"?s+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${d}</div>`:r==="memo"&&(s+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${d}"><svg><use xlink:href="#iconM"></use></svg></div>`)}}),i&&showMessage(i.substr(0,i.length-2)+" "+window.siyuan.languages.invalid),fetchPost("/api/attr/resetBlockAttrs",{id:e,attrs:o},()=>{}),a.destroy()})},Ks=(t,e,n="bookmark")=>{if(t.getAttribute("data-type")==="NodeThematicBreak")return;const a=t.getAttribute("data-node-id");fetchPost("/api/attr/getBlockAttrs",{id:a},s=>{Ft(s.data,n,(i,o)=>{let l="";const r=t.outerHTML;let d="";i.element.querySelectorAll(".b3-text-field").forEach(f=>{let u=f.getAttribute("data-name");if(!u){if(f.tagName==="INPUT")return;u="custom-"+f.parentElement.querySelector(".b3-text-field").value}if(f.value.trim()){if(!isValidAttrName(u)){d+=u.replace(/^custom-/,"")+", ";return}o.includes(u)&&o.find((m,p)=>{if(m===u)return o.splice(p,1),!0});const g=Lute.EscapeHTMLStr(f.value);t.setAttribute(u,g),u==="bookmark"?l+=`<div class="protyle-attr--bookmark">${g}</div>`:u==="name"?l+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${g}</div>`:u==="alias"?l+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${g}</div>`:u==="memo"&&(l+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${g}"><svg><use xlink:href="#iconM"></use></svg></div>`)}else t.removeAttribute(u)}),o.forEach(f=>{t.removeAttribute(f)}),d&&showMessage(d.substr(0,d.length-2)+" "+window.siyuan.languages.invalid);const c=t.lastElementChild.querySelector(".protyle-attr--refcount");c&&(l+=c.outerHTML),t.lastElementChild.innerHTML=l+Constants.ZWSP,t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,t.outerHTML,r),i.destroy()})})},Zs=(t,e=!0,n)=>[{icon:"iconRef",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{fetchPost("/api/block/getRefText",{id:t},a=>{writeText(`((${t} '${a.data}'))`)}),n&&focusBlock(n)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{writeText(`{{select * from blocks where id='${t}'}}`),n&&focusBlock(n)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{writeText(`siyuan://blocks/${t}`),n&&focusBlock(n)}},{label:window.siyuan.languages.copyProtocolInMd,click:()=>{fetchPost("/api/block/getRefText",{id:t},a=>{writeText(`[${a.data}](siyuan://blocks/${t})`)}),n&&focusBlock(n)}},{label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:t},a=>{writeText(a.data)})}},{label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{writeText(t),n&&focusBlock(n)}}],Vs=t=>new MenuItem({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,icon:"iconMarkdown",click:()=>Zn(void 0,null,function*(){const e=yield fetchSyncPost("/api/block/getRefText",{id:t}),n=new Dialog({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),a=n.element.querySelector("input"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()});let i=replaceFileName(e.data);const o=32;i.length>o&&(i=i.substring(0,o)),a.value=i,a.focus(),a.select(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{a.value.trim()===""?a.value="Untitled":a.value=replaceFileName(a.value),i.length>o&&(i=i.substring(0,o)),fetchPost("/api/template/docSaveAsTemplate",{id:t,name:i,overwrite:!1},l=>{if(l.code===1){confirmDialog(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{fetchPost("/api/template/docSaveAsTemplate",{id:t,name:i,overwrite:!0},r=>{r.code===0&&showMessage(window.siyuan.languages.exportTplSucc)})});return}showMessage(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{label:"Markdown",icon:"iconMarkdown",click:()=>{const e=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportMd",{id:t},n=>{hideMessage(e),openByMobile(n.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportSY",{id:t},n=>{hideMessage(e),openByMobile(n.data.zip)})}},{label:window.siyuan.languages.image,icon:"iconImage",click:()=>{exportImage(t)}}]}).element,Xs=(t,e,n,a)=>{const s=[];if(isLocalPath(e)&&Constants.SIYUAN_ASSETS_EXTS.includes(pathPosix().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&e.startsWith("file://")),s.push({label:window.siyuan.languages.useBrowserView,accelerator:a?"Click":"",click:()=>{openByMobile(e)}}),n)return s;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.openBy,submenu:s}).element)},Qs=t=>new MenuItem({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,label:window.siyuan.languages.rename,click:()=>{rename(t)}}).element,Js=t=>new MenuItem({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){movePathTo((e,n)=>{moveToPath(t,n[0],e[0])},t)}}).element,ei=(t,e,n=!1,a=!1)=>{var s,i;if(t==="")return;const o=a?e.toolbar.range:getEditorRange(e.wysiwyg.element);fixTableRange(o),hasClosestByAttribute(o.startContainer,"data-type","NodeTable")&&!n&&(t=e.lute.BlockDOM2InlineBlockDOM(t));let l=hasClosestBlock(o.startContainer);if(l||(e.toolbar.range?l=hasClosestBlock(e.toolbar.range.startContainer):l=e.wysiwyg.element.firstElementChild),!l)return;let r=l.getAttribute("data-node-id");o.insertNode(document.createElement("wbr"));let d=l.outerHTML;const c=l.getAttribute("data-type")==="NodeCodeBlock";if(!n&&(c||e.toolbar.getCurrentType(o).includes("code"))){o.deleteContents(),o.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),o.collapse(!1),o.insertNode(document.createElement("wbr")),c?(getContenteditableElement(l).removeAttribute("data-render"),highlightRender(l)):focusByWbr(l,o),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,r,l.outerHTML,d),setTimeout(()=>{scrollCenter(e,l,!1,"smooth")},Constants.TIMEOUT_LOAD);return}const f=[],u=[];if(o.toString()!==""){const h=hasClosestByAttribute(o.commonAncestorContainer,"data-type","inline-math");h?h.remove():(o.startContainer.nodeType===3&&((s=o.startContainer.parentElement.getAttribute("data-type"))==null?void 0:s.indexOf("block-ref"))>-1&&o.startContainer.parentElement.remove(),o.deleteContents()),o.insertNode(document.createElement("wbr")),f.push({action:"update",id:r,data:d}),u.push({action:"update",id:r,data:l.outerHTML})}const g=document.createElement("template");g.innerHTML=e.lute.SpinBlockDOM(t)||t;const m=getContenteditableElement(l);if(!n&&(g.content.firstChild.nodeType===3||g.content.firstChild.nodeType!==3&&(g.content.firstElementChild.classList.contains("p")&&g.content.childElementCount===1||g.content.firstElementChild.tagName!=="DIV"))){g.content.firstChild.nodeType!==3&&g.content.firstElementChild.classList.contains("p")&&(g.innerHTML=g.content.firstElementChild.firstElementChild.innerHTML.trim());const h=o.startContainer.nodeType===3?o.startContainer.parentElement:o.startContainer;if(h.tagName==="SPAN"&&h.isSameNode(o.endContainer.nodeType===3?o.endContainer.parentElement:o.endContainer)&&g.content.querySelector("span")){const C=document.createElement("span"),k=h.attributes;for(let E=0;E<k.length;E++)C.setAttribute(k[E].name,k[E].value);o.setEnd(h.lastChild,h.lastChild.textContent.length),C.append(o.extractContents()),h.after(C),o.setStartBefore(C),o.collapse(!0)}o.insertNode(g.content.cloneNode(!0)),o.collapse(!1),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const _=m?m.innerHTML.trimStart():"";if(m&&(_.startsWith("```")||_.startsWith("~~~")||_.startsWith("\xB7\xB7\xB7")||_.indexOf("\n```")>-1||_.indexOf(`
~~~`)>-1||_.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(_.indexOf(`
`)===-1&&_.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let C=m.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();C.endsWith("\n```")||(C+="\n```");const k=C.indexOf("```")+3;C=C.substring(0,k)+(localStorage["local-codelang"]||"")+C.substring(k),m.innerHTML=C}mathRender(l),updateTransaction(e,r,l.outerHTML,d),focusByWbr(e.wysiwyg.element,o);return}const p=hasClosestByClassName(l,"li");if(((i=g.content.children[0])==null?void 0:i.getAttribute("data-type"))==="NodeListItem")if(p)l=p,r=l.getAttribute("data-node-id"),d=l.outerHTML;else{const _=g.content.children[0].getAttribute("data-subtype");g.innerHTML=`<div${_==="o"?' data-marker="1."':""} data-subtype="${_}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${t}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`}let b;Array.from(g.content.children).reverse().forEach(h=>{let _=h.getAttribute("data-node-id");if(_===r)u.push({action:"update",data:h.outerHTML,id:_}),f.push({action:"update",id:_,data:d});else{if(h.classList.contains("li")&&!l.parentElement.classList.contains("list")){_=Lute.NewNodeID();const C=document.createElement("div");C.setAttribute("data-subtype",h.getAttribute("data-subtype")),C.setAttribute("data-node-id",_),C.setAttribute("data-type","NodeList"),C.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),C.classList.add("list"),C.append(h),h=C}u.push({action:"insert",data:h.outerHTML,id:_,previousID:r}),f.push({action:"delete",id:_})}l.after(h),b||(b=h)}),m&&m.textContent===""&&l.classList.contains("p")&&(u.find((h,_)=>{if(h.id===r)return u.splice(_,1),!0}),u.push({action:"delete",id:r}),f.find((h,_)=>{if(h.id===r&&h.action==="update")return f.splice(_,1),!0}),f.push({action:"insert",data:d,id:r,previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):"",parentID:l.parentElement.getAttribute("data-node-id")||e.block.parentID}),l.remove()),b&&focusBlock(b,void 0,!1);const v=e.wysiwyg.element.querySelector("wbr");v&&v.remove(),transaction(e,u,f)},ti=t=>{if(!t)return"";const e=pathPosix().extname(t).toLowerCase();return Constants.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${t}">`:Constants.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${t}"></audio>`:Constants.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${t}"></video>`:t},ni=()=>{},ai=(t,e,n,a)=>{let s="";if(Constants.SIYUAN_ASSETS_AUDIO.includes(t))s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}" data-src="${e}"></audio>${Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;else if(Constants.SIYUAN_ASSETS_IMAGE.includes(t)){let i="";e.startsWith("assets/")||(i='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),s=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg class="svg"><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${n}" /><span class="protyle-action__drag"></span>${i}<span class="protyle-action__title"></span></span><span> </span></span>`}else Constants.SIYUAN_ASSETS_VIDEO.includes(t)?s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${Constants.ZWSP}<video controls="controls" src="${e}" data-src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:s=`<span data-type="a" data-href="${e}">${a}</span>`;return s};class si{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Vn=(t,e)=>{const n=[];let a="",s="";for(let o=e.length,l=0;l<o;l++){const r=e[l];let d=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,d=!1),r.size>t.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${t.options.upload.max/1024/1024}M</li>`,d=!1);const c=r.name.lastIndexOf("."),f=c===-1?"":r.name.substr(c),u=c===-1?r.name:t.options.upload.filename(r.name.substr(0,c))+f;t.options.upload.accept&&(t.options.upload.accept.split(",").some(m=>{const p=m.trim();if(p.indexOf(".")===0){if(f.toLowerCase()===p.toLowerCase())return!0}else if(r.type.split("/")[0]===p.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,d=!1)),d&&(n.push(r),s+=`<li>${u} ${window.siyuan.languages.uploading}</li>`)}let i;return(a!==""||s!=="")&&(i=showMessage(`<ul>${a}${s}</ul>`,-1)),{files:n,msgId:i}},Wt=(t,e)=>{const n=JSON.parse(t);let a="";n.code===1&&(a=`${n.msg}`),n.data.errFiles&&n.data.errFiles.length>0&&(a=`<ul><li>${a}</li>`,n.data.errFiles.forEach(d=>{const c=d.lastIndexOf("."),f=c===-1?d:e.options.upload.filename(d.substr(0,c))+d.substr(c);a+=`<li>${f} ${window.siyuan.languages.uploadError}</li>`}),a+="</ul>"),a&&showMessage(a);let s=!0;const i=getEditorRange(e.wysiwyg.element);i.toString()===""&&i.startContainer.nodeType===3&&e.toolbar.getCurrentType(i).length>0&&(i.setEndAfter(i.startContainer.parentElement),i.collapse(!1));const o=hasClosestBlock(i.startContainer);if(o)if(o.classList.contains("table"))s=!1;else{const d=getContenteditableElement(o);d&&d.textContent!==""&&o.classList.contains("p")&&(s=!1)}let l="";const r=Object.keys(n.data.succMap);r.forEach((d,c)=>{const f=n.data.succMap[d],u=pathPosix().extname(d).toLowerCase(),g=e.options.upload.filename(d);l+=genAssetHTML(u,f,g.substring(0,g.length-u.length),g),!Constants.SIYUAN_ASSETS_AUDIO.includes(u)&&!Constants.SIYUAN_ASSETS_VIDEO.includes(u)&&r.length-1!==c&&(s?l+=`

`:l+=`
`)}),insertHTML(l,e,s)},Xn=(t,e,n)=>{const a=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:n,id:e.block.rootID},s=>{hideMessage(a),Wt(JSON.stringify(s),e)})},ii=(t,e,n,a)=>{let s=[];for(let c=0;c<e.length;c++){let f=e[c];f instanceof DataTransferItem&&(f=f.getAsFile()),f.size===0&&f.type===""&&f.name.indexOf(".")===-1?Xn([f.path],t,!1):s.push(f)}if(t.options.upload.handler){const c=t.options.upload.handler(s);if(typeof c=="string"){showMessage(c);return}return}if(!t.options.upload.url||!t.upload){n&&(n.value=""),showMessage("please config: options.upload.url");return}if(t.options.upload.file&&(s=t.options.upload.file(s)),t.options.upload.validate){const c=t.options.upload.validate(s);if(typeof c=="string"){showMessage(c);return}}const i=t.wysiwyg.element,o=Vn(t,s);if(o.files.length===0){n&&(n.value="");return}const l=new FormData,r=t.options.upload.extraData;for(const c of Object.keys(r))l.append(c,r[c]);for(let c=0,f=o.files.length;c<f;c++)l.append(t.options.upload.fieldName,o.files[c]);l.append("id",t.block.rootID);const d=new XMLHttpRequest;d.open("POST",t.options.upload.url),t.options.upload.token&&d.setRequestHeader("X-Upload-Token",t.options.upload.token),t.options.upload.withCredentials&&(d.withCredentials=!0),t.upload.isUploading=!0,d.onreadystatechange=()=>{if(d.readyState===XMLHttpRequest.DONE){if(t.upload.isUploading=!1,!document.body.contains(t.element)){destroy(t);return}if(d.status===200)if(hideMessage(o.msgId),t.options.upload.success)t.options.upload.success(i,d.responseText);else if(a)a(d.responseText);else{let c=d.responseText;t.options.upload.format&&(c=t.options.upload.format(e,d.responseText)),Wt(c,t)}else d.status===0?showMessage(window.siyuan.languages.fileTypeError):t.options.upload.error?t.options.upload.error(d.responseText):showMessage(d.responseText);n&&(n.value=""),t.upload.element.style.display="none"}},d.upload.onprogress=c=>{if(!c.lengthComputable)return;const f=c.loaded/c.total*100;t.upload.element.style.display="block";const u=t.upload.element;u.style.width=f+"%"},d.send(l)};var jt=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const Ve=(t,e)=>{let n=!0;t.options.hint.extend.find(a=>{if(a.key===e)return n=!1,!0}),n&&t.hint.render(t)},oi=t=>jt(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(n=>{insertHTML(t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(n)),t),Ve(t,n)})}),li=(t,e,n)=>{const a=getEditorRange(t.wysiwyg.element);if(n.getAttribute("data-type")==="NodeCodeBlock"){insertHTML(e,t);return}a.toString()!==""&&(isDynamicRef(e)?e=e.replace(/'.+'\)\)$/,` "${a.toString()}"))`):isFileAnnotation(e)?e=e.replace(/".+">>$/,`"${a.toString()}">>`):t.lute.IsValidLinkDest(e)&&(e=`[${a.toString()}](${e})`)),insertHTML(t.lute.Md2BlockDOM(e),t),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),Ve(t,e),scrollCenter(t,void 0,!1,"smooth")},ri=(t,e)=>jt(void 0,null,function*(){e.stopPropagation(),e.preventDefault();let n,a,s,i;if("clipboardData"in e?(n=e.clipboardData.getData("text/html"),a=e.clipboardData.getData("text/plain"),s=e.clipboardData.getData("text/siyuan"),i=e.clipboardData.files):(n=e.dataTransfer.getData("text/html"),a=e.dataTransfer.getData("text/plain"),s=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(i=e.dataTransfer.items)),(n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(n=""),a.endsWith(Constants.ZWSP)&&!n&&!s&&(s=a.substr(0,a.length-1)),!s){const d=new DOMParser().parseFromString(n,"text/html");d.body&&d.body.innerHTML&&(n=d.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=d.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}const o=hasClosestBlock(e.target);if(!o){i&&i.length>0&&uploadFiles(t,i);return}hideElements(["select"],t),t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(d=>{d.classList.remove("protyle-wysiwyg--hl")});const l=processPasteCode(n,a),r=getEditorRange(t.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||t.toolbar.getCurrentType(r).includes("code")){insertHTML(a,t);return}else if(s){const d=document.createElement("div");d.innerHTML=s;let c=!1;d.querySelectorAll("[data-node-id]").forEach(u=>{const g=Lute.NewNodeID();u.setAttribute("data-node-id",g),u.removeAttribute("custom-riff-decks"),u.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),u.setAttribute("updated",g.split("-")[0]),c=!0}),o.classList.contains("table")&&(c=!1),d.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(u=>{u.setAttribute("contenteditable","true")});const f=d.innerHTML;insertHTML(f,t,c),Ve(t,t.lute.BlockDOM2StdMd(f)),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element)}else if(l)l.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(insertHTML(l,t,!0),highlightRender(t.wysiwyg.element)):insertHTML(l,t),hideElements(["hint"],t);else{let d=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),i&&i.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?d=!1:d=!0),d){const c=document.createElement("div");c.innerHTML=n,c.querySelectorAll("[style]").forEach(f=>{f.removeAttribute("style")}),c.querySelectorAll("a").forEach(f=>{f.innerHTML.trim()===""&&f.remove()}),fetchPost("/api/lute/html2BlockDOM",{dom:c.innerHTML},f=>{insertHTML(f.data,t),t.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&fetchPost("/api/block/getRefText",{id:u.getAttribute("data-id")},g=>{u.innerHTML=g.data})}),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),Ve(t,f.data),scrollCenter(t,void 0,!1,"smooth")});return}else if(i&&i.length>0)uploadFiles(t,i);else if(a.trim()!==""&&i&&i.length===0){if(r.toString()!==""){if(isDynamicRef(a)){t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${Constants.ZWSP}s${Constants.ZWSP}${r.toString()}`});return}else if(isFileAnnotation(a)){t.toolbar.setInlineMark(t,"file-annotation-ref","range",{type:"file-annotation-ref",color:a.substring(2).replace(/ ".+">>$/,"")});return}else if(t.lute.IsValidLinkDest(a)){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:a});return}}const c=t.lute.Md2BlockDOM(a);insertHTML(c,t),Ve(t,a)}blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element)}scrollCenter(t,void 0,!1,"smooth")});class di{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();this.render(e,n,!1),this.hasUndo=!0,this.redoStack.push(n)}redo(e){if(e.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();this.render(e,n,!0),this.undoStack.push(n)}render(e,n,a){hideElements(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(s=>{onTransaction(e,s,!0)}),transaction(e,n.doOperations)):(n.undoOperations.forEach(s=>{onTransaction(e,s,!0)}),transaction(e,n.undoOperations)),preventScroll(e),scrollCenter(e)}replace(e){this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,n){this.undoStack.push({undoOperations:n,doOperations:e}),this.undoStack.length>Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}}const ci=t=>!1,ui=(t,e,n)=>{var a,s,i,o,l,r,d,c,f;let u,g="",m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){let b=getTopAloneElement(e);const v=hasClosestByAttribute(b,"fold","1");v&&(b=v),(a=b.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(b=getTopAloneElement(b.parentElement)),m=[b]}const p=m[0].getAttribute("data-type");if(p==="NodeListItem"&&!m[0].previousElementSibling&&((i=(s=m[0].parentElement.previousElementSibling)==null?void 0:s.previousElementSibling)!=null&&i.classList.contains("protyle-action")))if((o=m[0].parentElement.parentElement.previousElementSibling)!=null&&o.classList.contains("li")){if(u=m[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.parentElement.outerHTML,!u){const b=Lute.NewNodeID();m[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=m[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(p==="NodeList"&&((r=(l=m[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((d=m[0].parentElement.previousElementSibling)!=null&&d.classList.contains("li")){if(u=m[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=m[0].parentElement.parentElement.outerHTML,!u){const b=Lute.NewNodeID();m[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=m[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(u){u=u.lastElementChild.previousElementSibling;const b=m[0].classList.contains("list")?m[0]:m[0].parentElement;m.reverse().forEach(v=>{v.classList.contains("list")?u.after(v.firstElementChild):u.after(v)}),u.id==="moveTempLi"&&(u=u.nextElementSibling,u.previousElementSibling.remove()),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&updateListOrder(b,1),u.getAttribute("data-subtype")==="o"&&updateListOrder(u.parentElement),updateTransaction(t,u.parentElement.parentElement.parentElement.getAttribute("data-node-id"),u.parentElement.parentElement.parentElement.outerHTML,g),preventScroll(t),scrollCenter(t),focusByWbr(u.parentElement,n);return}if(!(!m[0].previousElementSibling||(c=m[0].previousElementSibling)!=null&&c.classList.contains("protyle-action"))){if(u=m[0].previousElementSibling,m[0].getAttribute("data-subtype")==="o"&&p==="NodeListItem"){const b=m[0].parentElement.outerHTML;m[m.length-1].after(u),updateListOrder(m[0].parentElement,1),updateTransaction(t,m[0].parentElement.getAttribute("data-node-id"),m[0].parentElement.outerHTML,b)}else{const b=u.getAttribute("data-node-id");transaction(t,[{action:"move",id:b,previousID:m[m.length-1].getAttribute("data-node-id")}],[{action:"move",id:b,previousID:(f=u.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}]),m[m.length-1].after(u)}preventScroll(t),scrollCenter(t)}},fi=(t,e,n)=>{var a,s,i,o,l,r,d;let c,f="",u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(u.length===0){let m=getTopAloneElement(e);const p=hasClosestByAttribute(m,"fold","1");p&&(m=p),(a=m.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(m=getTopAloneElement(m.parentElement)),u=[m]}const g=u[0].getAttribute("data-type");if(g==="NodeListItem"&&u[u.length-1].nextElementSibling.classList.contains("protyle-attr")&&((s=u[0].parentElement.parentElement)!=null&&s.classList.contains("li")))if((i=u[0].parentElement.parentElement.nextElementSibling)!=null&&i.classList.contains("li")){if(c=u[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),f=u[0].parentElement.parentElement.parentElement.outerHTML,!c){const m=Lute.NewNodeID();u[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${u[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=u[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(g==="NodeList"&&u[u.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=u[0].parentElement)!=null&&o.classList.contains("li")))if((l=u[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(c=u[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),f=u[0].parentElement.parentElement.outerHTML,!c){const m=Lute.NewNodeID();u[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${u[0].getAttribute("data-subtype")}" data-node-id="${m}" data-type="NodeList" class="list" updated="${m.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=u[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(c){const m=u[0].classList.contains("list")?u[0]:u[0].parentElement;u.forEach(p=>{p.classList.contains("list")?c.before(p.firstElementChild):c.before(p)}),m.childElementCount===1?m.remove():m.getAttribute("data-subtype")==="o"&&m.classList.contains("list")&&updateListOrder(m,1),c.getAttribute("data-subtype")==="o"&&updateListOrder(c.parentElement,1),updateTransaction(t,c.parentElement.parentElement.parentElement.getAttribute("data-node-id"),c.parentElement.parentElement.parentElement.outerHTML,f),preventScroll(t),scrollCenter(t),focusByWbr(c.parentElement,n);return}if(!(!u[u.length-1].nextElementSibling||(r=u[u.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(c=u[u.length-1].nextElementSibling,c.getAttribute("data-subtype")==="o"&&c.getAttribute("data-type")==="NodeListItem"){const m=c.parentElement.outerHTML;u[0].before(c),updateListOrder(c.parentElement,1),updateTransaction(t,c.parentElement.getAttribute("data-node-id"),c.parentElement.outerHTML,m)}else{const m=c.getAttribute("data-node-id");transaction(t,[{action:"move",id:m,previousID:(d=u[0].previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:c.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:m,previousID:u[u.length-1].getAttribute("data-node-id")}]),u[0].before(c)}preventScroll(t),scrollCenter(t)}};let Yt,Xe=!1;const q=(t,e,n,a="false")=>{let s;return e&&e.startsWith("icon")?s=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:s=e,`<div class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(t)}">
    ${s}
    <span class="keyboard__slash-text">${n}</span>
</div>`},Qn=(t,e)=>{t.hint.splitChar="/",t.hint.lastIndex=-1;const n=e.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${q(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
</div>
<div class="keyboard__slash-block">
    ${q(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${q("((","iconRef",window.siyuan.languages.ref,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${q(Constants.ZWSP+5,"iconSparkles","AI Chat")}
</div>
<div class="keyboard__slash-block">
    ${q(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newFile)}
    <div class="keyboard__slash-empty"></div>
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${q("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${q("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${q("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${q("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
</div>
<div class="keyboard__slash-block">
    ${q("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${q("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("```","iconCode",window.siyuan.languages.code,"true")}
    ${q(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("---","iconLine",window.siyuan.languages.line,"true")}
    ${q("$$","iconMath",window.siyuan.languages.math)}
</div>
<div class="keyboard__slash-block">
    ${q("<div>","iconHTML5","HTML")}
    <div class="keyboard__slash-empty"></div>
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
    ${q("a","iconLink",window.siyuan.languages.link)}
</div>
<div class="keyboard__slash-block">
    ${q("strong","iconBold",window.siyuan.languages.bold,"true")}
    ${q("em","iconItalic",window.siyuan.languages.italic,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("u","iconUnderline",window.siyuan.languages.underline,"true")}
    ${q("s","iconStrike",window.siyuan.languages.strike,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("mark","iconMark",window.siyuan.languages.mark,"true")}
    ${q("sup","iconSup",window.siyuan.languages.sup,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("sub","iconSub",window.siyuan.languages.sub,"true")}
    ${q("tag","iconTags",window.siyuan.languages.tag,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("code","iconInlineCode",window.siyuan.languages["inline-code"],"true")}
    ${q("inline-math","iconMath",window.siyuan.languages["inline-math"])}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true")}
    ${q('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${q('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
</div>
<div class="keyboard__slash-block">
    ${q('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    <div class="keyboard__slash-empty"></div>
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${q("```echarts\n```","",window.siyuan.languages.chart,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("```flowchart\n```","","Flow Chart","true")}
    ${q("```graphviz\n```","","Graph","true")}
</div>
<div class="keyboard__slash-block">
    ${q("```mermaid\n```","","Mermaid","true")}
    ${q("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
</div>
<div class="keyboard__slash-block">
    ${q("```plantuml\n```","","UML","true")}
    <div class="keyboard__slash-empty"></div>
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${q(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${q(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
</div>
<div class="keyboard__slash-block">
    ${q(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${q(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
</div>
<div class="keyboard__slash-block">
    ${q(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
    <div class="keyboard__slash-empty"></div>
</div>`,t.hint.bindUploadEvent(t,n)},Jn=t=>{window.siyuan.menus.menu.remove(),Xe=!0;const e=document.getElementById("keyboardToolbar");let n=e.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.innerHeight/2)+"px";const a=getCurrentEditor();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=t),setTimeout(()=>{e.style.height=n},Constants.TIMEOUT_TRANSITION),setTimeout(()=>{Xe=!1},1e3)},dt=()=>{const t=document.getElementById("keyboardToolbar");t.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),t.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},ea=()=>{clearTimeout(Yt),Yt=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.editor.readOnly||window.siyuan.config.readonly||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){Qe();return}if(document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){Qe();return}Xe||dt(),ta();const t=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!hasClosestByClassName(e.startContainer,"protyle-wysiwyg",!0)){t[0].classList.add("fn__none"),t[1].classList.add("fn__none");return}e.toString()||t[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(t[0].classList.add("fn__none"),t[1].classList.remove("fn__none")):(t[0].classList.remove("fn__none"),t[1].classList.add("fn__none"));const s=getCurrentEditor().protyle;if(!t[0].classList.contains("fn__none")){s.undo.undoStack.length===0?t[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),s.undo.redoStack.length===0?t[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const i=hasClosestBlock(e.startContainer);if(i){const o=t[0].querySelector('[data-type="indent"]');i.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none"),o.nextElementSibling.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"),o.nextElementSibling.nextElementSibling.classList.add("fn__none"))}}t[1].classList.contains("fn__none")||(t[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),s.toolbar.getCurrentType(e).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=t[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},ta=()=>{Xe||dt();const t=document.getElementById("keyboardToolbar");if(!t.classList.contains("fn__none"))return;t.classList.remove("fn__none");const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),setTimeout(()=>{const s=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(s){const i=getSelectionPosition(s).top-s.getBoundingClientRect().top;if(i<window.innerHeight-96)return;s.scroll({top:s.scrollTop+i-((window.outerHeight-65)/2-30),left:s.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},Qe=()=>{if(Xe)return;const t=document.getElementById("keyboardToolbar");t.classList.add("fn__none"),t.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom="")},Lt=()=>{document.activeElement.blur()},gi=()=>{let t=!1;document.addEventListener("selectionchange",()=>{t||ea()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="more"><svg><use xlink:href="#iconMore"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,e.addEventListener("click",n=>{const a=n.target,s=hasClosestByClassName(n.target,"keyboard__slash-item"),i=getCurrentEditor().protyle;if(s){const c=decodeURIComponent(s.getAttribute("data-value"));i.hint.fill(c,i,!1),c!==Constants.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),s.getAttribute("data-focus")==="true"&&focusByRange(i.toolbar.range);return}const o=hasClosestByMatchTag(a,"BUTTON");if(!o||o.getAttribute("disabled")||getSelection().rangeCount===0)return;n.preventDefault(),n.stopPropagation();const l=getSelection().getRangeAt(0),r=o.getAttribute("data-type");if(r==="done"){e.clientHeight>100?(dt(),focusByRange(l)):(Lt(),Qe());return}if(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly||!getCurrentEditor())return;if(r==="undo"){i.undo.undo(i);return}else if(r==="redo"){i.undo.redo(i);return}if(getSelection().rangeCount===0)return;const d=hasClosestBlock(l.startContainer);if(d)if(r==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const c=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");c[0].classList.remove("fn__none"),c[1].classList.add("fn__none"),focusByRange(l),t=!0,setTimeout(()=>{t=!1},1e3);return}else if(r==="goinline"){o.classList.add("protyle-toolbar__item--current");const c=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");c[1].classList.remove("fn__none"),c[0].classList.add("fn__none"),focusByRange(l);return}else if(["a","block-ref","inline-math","inline-memo","text"].includes(r)){i.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click"));return}else if(["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){i.toolbar.setInlineMark(i,r,"toolbar");return}else if(r==="moveup"){moveToUp(i,d,l),focusByRange(l);return}else if(r==="movedown"){moveToDown(i,d,l),focusByRange(l);return}else if(r==="add"){if(o.classList.contains("protyle-toolbar__item--current"))dt(),focusByRange(l);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const c=i.contentElement.scrollTop;Qn(i,e),Jn(c)}return}else if(r==="more"){i.breadcrumb.showMenu(i,{x:0,y:0}),Lt(),Qe();return}else if(r==="block"){i.gutter.renderMenu(i,d),window.siyuan.menus.menu.fullscreen(),Lt(),Qe();return}else if(r==="outdent"){listOutdent(i,[d.parentElement],l),focusByRange(l);return}else r==="indent"&&(listIndent(i,[d.parentElement],l),focusByRange(l))})},mi=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const t=document.querySelector(".side-mask");t.classList.add("fn__none"),t.style.opacity="",window.siyuan.menus.menu.remove()},pi=()=>{document.getElementById("model").style.transform="",activeBlur(),hideKeyboardToolbar()},At=null,na=t=>{const e=getCurrentEditor().protyle;if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t.id,action:t.callback},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],e),e.contentElement.classList.contains("fn__none")&&setEditMode(e,"wysiwyg"),e.notebookId=t.data.notebookId,e.path=t.data.path,t.data.startId===e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&t.data.endId===e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){e.contentElement.scrollTo({top:t.scrollTop,behavior:"smooth"});return}if(t.id!==e.block.rootID&&fetchPost("/api/block/getDocInfo",{id:t.id},n=>{document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name,e.background.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial)}),t.zoomId){t.zoomId!==e.block.id?fetchPost("/api/block/checkBlockExist",{id:t.id},n=>{n.data&&zoomOut({protyle:e,id:t.id,isPushBack:!1,callback:()=>{e.contentElement.scrollTop=t.scrollTop}})}):e.contentElement.scrollTop=t.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:t.id,startID:t.data.startId,endID:t.data.endId},n=>{var a;e.block.parentID=n.data.parentID,e.block.parent2ID=n.data.parent2ID,e.block.rootID=n.data.rootID,e.block.showAll=!1,e.block.mode=n.data.mode,e.block.blockCount=n.data.blockCount,e.block.id=n.data.id,e.block.action=t.callback,e.wysiwyg.element.setAttribute("data-doc-type",n.data.type),e.wysiwyg.element.innerHTML=n.data.content,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element),blockRender(e,e.wysiwyg.element,t.scrollTop),n.data.isSyncing?disabledForeverProtyle(e):e.disabled?disabledProtyle(e):enableProtyle(e),e.contentElement.scrollTop=t.scrollTop,(a=e.breadcrumb)==null||a.render(e)})},bi=()=>{const t=getCurrentEditor().protyle;window.siyuan.backStack.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})},hi=()=>{const t=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){document.getElementById("model").style.transform="";return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(t&&!t.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],t.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(At.length===0&&t){const n=t.protyle;At.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const e=window.siyuan.backStack.pop();At.push(e),na(e)};class yi{constructor(e,n){this.element=document.createElement("button");const a=n.hotkey?` ${updateHotkeyTip(n.hotkey)}`:"",s=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",s+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(getEventName(),i=>{i.preventDefault(),e.toolbar.setInlineMark(e,n.name,"toolbar")})}}var aa=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});class wi extends null{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>aa(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=e.toolbar.range;if(!hasClosestBlock(s.startContainer))return;const o=hasClosestByAttribute(s.startContainer,"data-type","a");if(o){linkMenu(e,o);return}const l=s.toString().trim().replace(Constants.ZWSP,"");let r="",d="";try{const c=yield readText();if(e.lute.IsValidLinkDest(l))r=l;else if(e.lute.IsValidLinkDest(c))r=c;else{const f=c.lastIndexOf(" ");f>-1&&e.lute.IsValidLinkDest(c.substring(f))&&(r=c.substring(f),d=c.substring(0,f))}}catch(c){console.log(c)}e.toolbar.setInlineMark(e,"a","range",{type:"a",color:r+(d?Constants.ZWSP+d:"")})}))}}const _i=(t,e)=>{const n=t.getAttribute("data-type").split(" ");if(n.length===1){const a=t.parentElement;t.outerHTML=t.innerHTML.replace(Constants.ZWSP,"")+"<wbr>",e&&focusByWbr(a,e)}else n.find((a,s)=>{if(a==="a")return n.splice(s,1),!0}),t.setAttribute("data-type",n.join(" ")),t.removeAttribute("data-href"),e&&(e.selectNodeContents(t),e.collapse(!1),focusByRange(e))},vi=t=>{t.element.querySelector(".wysiwygLoading")||(addLoading(t),hideElements(["toolbar"],t),fetchPost("/api/format/netImg2LocalAssets",{id:t.block.rootID},()=>{reloadProtyle(t,!1)}))},Ei=(t,e)=>{var n,a;setTimeout(()=>{hideAllElements(["gutter"])},Constants.TIMEOUT_TRANSITION);const s=t.className.includes("fullscreen");if(s?(t.classList.remove("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden"))):(t.classList.add("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((a=document.getElementById("drag"))==null||a.classList.add("fn__hidden"))),e){s?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const i=hasClosestByClassName(t,"layout--float");i&&(s?(i.setAttribute("data-temp",i.style.transform),i.style.transform="none"):(i.style.transform=i.getAttribute("data-temp"),i.removeAttribute("data-temp")));return}},ki=(t,e)=>{const n=e.target;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return fetchPost("/api/filetree/getHPathByID",{id:t.block.rootID},a=>{writeText(a.data)}),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return netImg2LocalAssets(t),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)||matchHotKey(window.siyuan.config.keymap.general.dailyNote.custom,e))return e.preventDefault(),!0},Ci=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(getSelectionOffset(t.nodeElement,t.editorElement,t.range).start!==0){const a=getContenteditableElement(t.nodeElement);if(a.tagName==="TABLE"){const s=hasClosestByMatchTag(t.range.startContainer,"TH")||hasClosestByMatchTag(t.range.startContainer,"TD")||a.querySelector("th, td");if(getSelectionOffset(s,s,t.range).start!==0){setFirstNodeRange(s,t.range),t.event.stopPropagation(),t.event.preventDefault();return}}else return}t.range.collapse(!0),hideElements(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),countBlockWord(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Li=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(getSelectionOffset(t.nodeElement,t.editorElement,t.range).end<getContenteditableElement(t.nodeElement).textContent.length)return;t.range.collapse(!1),hideElements(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),countBlockWord(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Ai=t=>{let e,n;return t.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(n=a)}),e||(e=t[0],e.setAttribute("select-start","true")),n||(n=t[t.length-1],n.setAttribute("select-end","true")),{startElement:e,endElement:n}},xi=(t,e)=>{let n;const a=[],s=[];t.reverse().forEach((i,o)=>{const l=i.cloneNode(!0);o===0&&(n=l);const r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.querySelectorAll("[data-node-id]").forEach(d=>{d.setAttribute("data-node-id",Lute.NewNodeID())}),i.classList.remove("protyle-wysiwyg--select"),t[0].after(l),a.push({action:"insert",data:l.outerHTML,id:r,previousID:t[0].getAttribute("data-node-id")}),s.push({action:"delete",id:r})}),transaction(e,a,s),focusBlock(n),scrollCenter(e)},Si=t=>{t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.options.backlinkData?(focusBlock(t.wysiwyg.element.firstElementChild),t.contentElement.scrollTop=0,t.scroll.lastScrollTop=1):fetchPost("/api/filetree/getDoc",{id:t.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{onGet({data:e,protyle:t,action:[Constants.CB_GET_FOCUS]})})},Ti=t=>{!t.scroll.element.classList.contains("fn__none")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?fetchPost("/api/filetree/getDoc",{id:t.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{onGet({data:e,protyle:t,action:[Constants.CB_GET_FOCUS]})}):(t.contentElement.scrollTop=t.contentElement.scrollHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop,focusBlock(t.wysiwyg.element.lastElementChild,void 0,!1))},Mi=(t,e,n,a,s)=>{e.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.display="block";let o=i.nextSibling;for(;o;)if(o.textContent==="")o=o.nextSibling;else if(o.textContent===Constants.ZWSP){o.textContent="";break}else break;let l=i.previousSibling;for(;l;)if(l.textContent==="")l=l.previousSibling;else if(l.textContent===Constants.ZWSP){l.textContent="";break}else break}),updateTransaction(t,a,e.outerHTML,s)},Ii=(t,e,n,a,s)=>{e.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.display="",hasNextSibling(i)||i.insertAdjacentText("afterend",Constants.ZWSP),hasPreviousSibling(i)||i.insertAdjacentText("beforebegin",Constants.ZWSP)}),updateTransaction(t,a,e.outerHTML,s)};var Ut=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const Hi=(t,e)=>{const n=hasClosestBlock(e);if(!n)return;hideElements(["util","toolbar","hint"],t);const a=e.getAttribute("data-id"),s=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const d=r.querySelector("input");d.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,d.addEventListener("input",()=>{d.value?e.innerHTML=Lute.EscapeHTMLStr(d.value):fetchPost("/api/block/getRefText",{id:a},c=>{e.innerHTML=c.data}),e.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",c=>{if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(c))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);let o=[];e.getAttribute("data-subtype")==="s"?o.push({label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),fetchPost("/api/block/getRefText",{id:a},r=>{e.innerHTML=r.data,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i)}),focusByRange(t.toolbar.range)}}):o.push({label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByRange(t.toolbar.range)}}),o=o.concat([{label:window.siyuan.languages.text,click(){e.outerHTML=`${e.innerHTML}<wbr>`,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByWbr(n,t.toolbar.range)}},{label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByRange(t.toolbar.range)}},{label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByRange(t.toolbar.range)}},{label:window.siyuan.languages.link,icon:"iconLink",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByWbr(n,t.toolbar.range)}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&o.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const r=`<div data-content="select * from blocks where id='${a}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${dayjs().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=r,updateTransaction(t,s,r,i),blockRender(t,t.wysiwyg.element)}}),o.push({label:window.siyuan.languages.defBlock,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:a,includeChildren:!1})}}),o.push({label:window.siyuan.languages.defBlockChildren,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:a,includeChildren:!0})}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=e.getAttribute("data-subtype")==="s"?'"':"'";writeText(`((${a} ${r}${e.textContent}${r}))`)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),focusByWbr(n,t.toolbar.range)}}).element);const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26}),window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==i&&(n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,n.outerHTML,i),i=n.outerHTML);const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!t.element.contains(r.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),focusByRange(t.toolbar.range))}},Di=(t,e)=>{var n,a;const s=getEditorRange(e);if(window.siyuan.menus.menu.remove(),s.toString()!==""||(a=(n=s.cloneContents().childNodes[0])==null?void 0:n.classList)!=null&&a.contains("emoji")){if(window.siyuan.menus.menu.append(new MenuItem({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){focusByRange(getEditorRange(e)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){focusByRange(getEditorRange(e));const i=getSelection().getRangeAt(0).cloneContents();i.querySelectorAll('[data-type="backslash"]').forEach(o=>{o.firstElementChild.remove()}),copyPlainText(i.textContent)}}).element),t.disabled)return;window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){focusByRange(getEditorRange(e)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click(){const i=getEditorRange(e);i.insertNode(document.createElement("wbr"));const o=e.outerHTML;i.extractContents(),focusByWbr(e,i),focusByRange(i),updateTransaction(t,e.getAttribute("data-node-id"),e.outerHTML,o)}}).element)}if(!t.disabled){let i,o;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.paste,accelerator:"\u2318V",click(){return Ut(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const l=yield readText();pasteText(t,l,e)}catch(l){console.log(l)}})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.pasteEscaped,click(){return Ut(this,null,function*(){try{let l=yield readText();l=l.replace(/\\/g,"\\\\\\\\").replace(/\*/g,"\\\\\\*").replace(/\_/g,"\\\\\\_").replace(/\[/g,"\\\\\\[").replace(/\]/g,"\\\\\\]").replace(/\!/g,"\\\\\\!").replace(/\`/g,"\\\\\\`").replace(/\</g,"\\\\\\<").replace(/\>/g,"\\\\\\>").replace(/\&/g,"\\\\\\&").replace(/\~/g,"\\\\\\~").replace(/\{/g,"\\\\\\{").replace(/\}/g,"\\\\\\}").replace(/\(/g,"\\\\\\(").replace(/\)/g,"\\\\\\)").replace(/\=/g,"\\\\\\=").replace(/\#/g,"\\\\\\#").replace(/\$/g,"\\\\\\$").replace(/\^/g,"\\\\\\^").replace(/\|/g,"\\\\\\|"),pasteText(t,l,e)}catch(l){console.log(l)}})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.selectAll,accelerator:"\u2318A",click(){selectAll(t,e,s)}}).element),e.classList.contains("table")){const i=hasClosestByMatchTag(s.startContainer,"TD")||hasClosestByMatchTag(s.startContainer,"TH");i&&window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:sa(t,e,i,s)}).element)}},Bi=t=>{var e,n;if(t.protyle.options.backlinkData)return;typeof t.isPushBack=="undefined"&&(t.isPushBack=!0),typeof t.reload=="undefined"&&(t.reload=!1);const a=(e=t.protyle.breadcrumb)==null?void 0:e.element.querySelector(".protyle-breadcrumb__item--active");if(!t.reload&&a&&a.getAttribute("data-node-id")===t.id){if(t.id===t.protyle.block.rootID)return;const s=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`);if(s){focusBlock(s),s.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t.id,action:t.id===t.protyle.block.rootID?[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT]:[Constants.CB_GET_ALL]},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),t.isPushBack&&pushBack()),fetchPost("/api/filetree/getDoc",{id:t.id,size:t.id===t.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:Constants.SIZE_GET_MAX},s=>{if(t.isPushBack?onGet({data:s,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_HTML]}):onGet({data:s,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML,Constants.CB_GET_UNUNDO]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO,Constants.CB_GET_HTML]}),t.focusId){const i=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`);if(i)focusBlock(i),i.scrollIntoView();else if(t.id===t.protyle.block.rootID){fetchPost("/api/filetree/getDoc",{id:t.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{onGet({data:o,protyle:t.protyle,action:t.isPushBack?[Constants.CB_GET_FOCUS]:[Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO]})});return}}t.callback&&t.callback()})},Ni=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const s=hasClosestBlock(n);if(!s)return;hideElements(["util","toolbar","hint"],t);const i=s.getAttribute("data-node-id"),o=n.querySelector("img"),l=n.querySelector(".protyle-action__title"),r=s.outerHTML;window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.imageURL}">${o.getAttribute("src")}</textarea><div class="fn__hr--small"></div>`,bind(g){g.querySelector("textarea").addEventListener("change",m=>{const p=m.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(o.setAttribute("src",p),o.setAttribute("data-src",p),p.startsWith("assets/")){const b=n.querySelector(".img__net");b&&b.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.title}"></textarea><div class="fn__hr--small"></div>`,bind(g){const m=g.querySelector("textarea");m.value=l.textContent,m.addEventListener("input",p=>{const b=p.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");o.setAttribute("title",b),l.textContent=b,mathRender(l),n.style.maxWidth=o.clientWidth+10+"px"})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.tooltipText}"></textarea><div class="fn__hr--small"></div>`,bind(g){g.querySelector("textarea").value=o.getAttribute("alt")||""}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){writeText(t.lute.BlockDOM2StdMd(n.outerHTML))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy+" PNG",icon:"iconImage",click(){if(window.siyuan.config.system.container==="android"&&window.JSAndroid){window.JSAndroid.writeImageClipboard(o.getAttribute("src"));return}else{const g=document.createElement("canvas"),m=document.createElement("img");m.onload=p=>{g.width=p.target.width,g.height=p.target.height,g.getContext("2d").drawImage(p.target,0,0,p.target.width,p.target.height),g.toBlob(b=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:b})])},"image/png",1)},m.src=o.getAttribute("src")}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){writeText(t.lute.BlockDOM2StdMd(n.outerHTML)),n.outerHTML="<wbr>",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,i,s.outerHTML,r),focusByWbr(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,i,s.outerHTML,r),focusByWbr(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const d=o.getAttribute("data-src");d.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,click(){renameAsset(d)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){alignImgCenter(t,s,[n],i,r)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){alignImgLeft(t,s,[n],i,r)}}).element);const c=parseInt(n.style.width||"0");window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.width,submenu:[$e("25%",n,o,t,i,s,r),$e("33%",n,o,t,i,s,r),$e("50%",n,o,t,i,s,r),$e("67%",n,o,t,i,s,r),$e("75%",n,o,t,i,s,r),$e("100%",n,o,t,i,s,r),{type:"separator"},{label:`<div aria-label="${c===0?window.siyuan.languages.default:c+"%"}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${c}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(g){const m=g.querySelector("input");m.addEventListener("input",()=>{n.style.width=m.value+"%",o.style.width="10000px",n.style.maxWidth="",m.parentElement.setAttribute("aria-label",`${m.value}%`)}),m.addEventListener("change",()=>{s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,i,s.outerHTML,r),window.siyuan.menus.menu.remove(),focusBlock(s)})}},{type:"separator"},$e(window.siyuan.languages.default,n,o,t,i,s,r)]}).element);const f=o.getAttribute("src");f&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),openMenu(t.app,f,!1,!1)),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const u=window.siyuan.menus.menu.element.querySelectorAll("textarea");u[0].focus(),window.siyuan.menus.menu.removeCB=()=>{const g=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');g&&fetchPost("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:g.value}),o.setAttribute("alt",u[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),s.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,i,s.outerHTML,r)}},$i=(t,e,n=!1)=>{window.siyuan.menus.menu.remove();const a=hasClosestBlock(e);if(!a)return;hideElements(["util","toolbar","hint"],t);const s=a.getAttribute("data-node-id"),i=a.outerHTML,o=e.getAttribute("data-href");window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea rows="1" style="width: ${isMobile()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea><div class="fn__hr--small"></div>`,bind(d){const c=d.querySelector("textarea");c.value=Lute.UnEscapeHTMLStr(o)||"",c.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),d.nextElementSibling.querySelector("textarea").focus();else if(electronUndo(f))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea style="width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.anchor}"></textarea><div class="fn__hr--small"></div>`,bind(d){const c=d.querySelector("textarea");let f=e.textContent.replace(Constants.ZWSP,"");!f&&o&&(f=o.replace("https://","").replace("http://",""),f.length>24&&(f=f.substring(0,Constants.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(f)),c.value=f,c.addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(c.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"")}),c.addEventListener("input",u=>{u.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(c.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"")}),c.addEventListener("keydown",u=>{if((u.key==="Enter"||u.key==="Escape")&&!u.isComposing)u.preventDefault(),u.stopPropagation(),window.siyuan.menus.menu.remove();else if(u.key==="Tab"&&!u.isComposing)u.preventDefault(),u.stopPropagation(),u.shiftKey?d.previousElementSibling.querySelector("textarea").focus():d.nextElementSibling.querySelector("textarea").focus();else if(electronUndo(u))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><textarea style="width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea><div class="fn__hr--small"></div>`,bind(d){const c=d.querySelector("textarea");c.value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),c.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&f.shiftKey&&!f.isComposing)f.preventDefault(),f.stopPropagation(),d.previousElementSibling.querySelector("textarea").focus();else if(electronUndo(f))return})}}).element),o&&openMenu(t.app,o,!1,!0),o!=null&&o.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const d=e.getAttribute("data-type").split(" ");d.push("block-ref"),d.splice(d.indexOf("a"),1),e.setAttribute("data-type",d.join(" ")),e.setAttribute("data-id",o==null?void 0:o.replace("siyuan://blocks/","")),e.removeAttribute("data-href"),e.removeAttribute("data-title"),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,a.outerHTML,i),t.toolbar.range.selectNode(e),t.toolbar.range.collapse(!1),focusByRange(t.toolbar.range)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){removeLink(e,t.toolbar.range),updateTransaction(t,s,a.outerHTML,i)}}).element),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,click(){renameAsset(o)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const d=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,a.outerHTML,d),focusByWbr(a,t.toolbar.range)}}).element);const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const r=window.siyuan.menus.menu.element.querySelectorAll("textarea");n||t.lute.IsValidLinkDest(o)?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")));const d=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);e.textContent===""||e.textContent===Constants.ZWSP?removeLink(e,d&&!t.element.contains(d.startContainer)?t.toolbar.range:void 0):d&&!t.element.contains(d.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),focusByRange(t.toolbar.range)),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,s,a.outerHTML,i)}},Pi=(t,e)=>{window.siyuan.menus.menu.remove();const n=hasClosestBlock(e);if(!n)return;hideElements(["util","toolbar","hint"],t);const a=n.getAttribute("data-node-id");let s=n.outerHTML;window.siyuan.menus.menu.append(new MenuItem({label:`<div class="fn__hr--small"></div><input class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.tag}"><div class="fn__hr--small"></div>`,bind(o){const l=o.querySelector("input");l.value=e.textContent.replace(Constants.ZWSP,""),l.addEventListener("change",()=>{updateTransaction(t,a,n.outerHTML,s),s=n.outerHTML}),l.addEventListener("compositionend",()=>{e.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(l.value||"")}),l.addEventListener("input",r=>{r.isComposing||(e.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(l.value||""))}),l.addEventListener("keydown",r=>{if((r.key==="Enter"||r.key==="Escape")&&!r.isComposing){if(r.preventDefault(),r.stopPropagation(),l.value)t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),focusByRange(t.toolbar.range);else{const d=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,a,n.outerHTML,d),focusByWbr(n,t.toolbar.range)}window.siyuan.menus.menu.remove()}else if(electronUndo(r))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){t.toolbar.range.setStart(e.firstChild,0),t.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.toolbar.setInlineMark(t,"tag","range")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,click(){renameTag(e.textContent.replace(Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const o=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,a,n.outerHTML,o),focusByWbr(n,t.toolbar.range)}}).element);const i=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.left,y:i.top+26,h:26}),window.siyuan.menus.menu.element.querySelector("input").select()},$e=(t,e,n,a,s,i,o)=>({label:t,click(){i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),t===window.siyuan.languages.default?(e.style.display==="block"?(e.style.width="",e.style.maxWidth=""):e.removeAttribute("style"),n.removeAttribute("style")):(e.style.width=t,e.style.maxWidth="",n.style.width="10000px"),updateTransaction(a,s,i.outerHTML,o),focusBlock(i)}}),Ri=(t,e)=>{const n=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let s=e.outerHTML;const i=[{label:`<div class="fn__hr--small"></div><textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}">${a.getAttribute("src")||""}</textarea><div class="fn__hr--small"></div>`,bind(l){l.querySelector("textarea").addEventListener("change",r=>{const d=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),c=d.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(d.indexOf("bilibili.com")>-1&&(d.indexOf("bvid=")>-1||c&&c[1])){const f={bvid:getSearch("bvid",d)||c&&c[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};d.indexOf("player.bilibili.com/player.html")>-1&&new URL(d.startsWith("http")?d:"https:"+d).search.split("&").forEach((m,p)=>{p===0&&(m=m.substr(1));const b=m.split("=");f[b[0]]=b[1]});let u="https://player.bilibili.com/player.html?";const g=Object.keys(f);g.forEach((m,p)=>{u+=`${m}=${f[m]}`,p<g.length-1&&(u+="&")}),a.setAttribute("src",u),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",d);updateTransaction(t,n,e.outerHTML,s),s=e.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(i.push({type:"separator"}),i.concat(openMenu(t.app,o,!0,!1))):i},Oi=(t,e,n)=>{const a=e.getAttribute("data-node-id"),s=e.querySelector(n==="NodeVideo"?"video":"audio");let i=e.outerHTML;const o=[{label:`<div class="fn__hr--small"></div><textarea rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${s.getAttribute("src")}</textarea><div class="fn__hr--small"></div>`,bind(d){d.querySelector("textarea").addEventListener("change",c=>{s.setAttribute("src",c.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),updateTransaction(t,a,e.outerHTML,i),i=e.outerHTML,c.stopPropagation()})}}],l=s.getAttribute("src");l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({label:window.siyuan.languages.rename,click(){renameAsset(l)}}));const r=s.getAttribute("src");return r?o.concat(openMenu(t.app,r,!0,!1)):o},sa=(t,e,n,a)=>{var s;const i=[],o=getColIndex(n);(n.rowSpan>1||n.colSpan>1)&&i.push({label:window.siyuan.languages.cancelMerged,click:()=>{const w=e.outerHTML;let y=n.rowSpan,A=n.parentElement;const M=n.colSpan;for(;y>0&&A;){let x=A.children[o],B=M;for(;B>0&&x;)x.classList.remove("fn__none"),x.colSpan=1,x.rowSpan=1,x=x.nextElementSibling,B--;A=A.nextElementSibling,y--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let x;if(Array.from(e.querySelectorAll("thead tr")).find(B=>{if(x=B,Array.from(B.children).forEach(K=>{(K.rowSpan!==1||K.classList.contains("fn__none"))&&(x=void 0)}),x)return!0}),x){const B=e.querySelector("tbody"),K=e.querySelector("thead");for(;!x.isSameNode(K.lastElementChild);)B.insertAdjacentElement("afterbegin",K.lastElementChild)}}focusByRange(a),updateTransaction(t,e.getAttribute("data-node-id"),e.outerHTML,w)}});const l=e.querySelectorAll("col")[o];(l.style.width||l.style.minWidth)&&i.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const w=e.outerHTML;l.style.width="",l.style.minWidth="",updateTransaction(t,e.getAttribute("data-node-id"),e.outerHTML,w)}});const r=e.getAttribute("custom-pinthead");i.push({icon:"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const w=e.outerHTML;r?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),updateTransaction(t,e.getAttribute("data-node-id"),e.outerHTML,w)}}),i.push({type:"separator"}),i.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{setTableAlign(t,[n],e,"left",a)}}),i.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{setTableAlign(t,[n],e,"center",a)}}),i.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{setTableAlign(t,[n],e,"right",a)}}),i.push({type:"separator"});const d=e.querySelector("table"),c=n.parentElement.querySelector(".fn__none");let f=!1,u=!1;Array.from(n.parentElement.children).forEach(w=>{w.colSpan>1&&(f=!0),w.rowSpan>1&&(u=!0)});let g=!1,m=!1,p=!1,b=n.parentElement.previousElementSibling;!b&&n.parentElement.parentElement.tagName==="TBODY"&&(b=d.querySelector("thead").lastElementChild),b&&(g=b.querySelector(".fn__none"),Array.from(b.children).forEach(w=>{w.colSpan>1&&(m=!0),w.rowSpan>1&&(p=!0)}));let v=!1,h=!1,_=!1,C=n.parentElement.nextElementSibling;!C&&n.parentElement.parentElement.tagName==="THEAD"&&(C=(s=d.querySelector("tbody"))==null?void 0:s.firstElementChild),C&&(v=C.querySelector(".fn__none"),Array.from(C.children).forEach(w=>{w.colSpan>1&&(h=!0),w.rowSpan>1&&(_=!0)}));let k=!0;Array.from(d.rows).find(w=>{const y=w.cells[o];if(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1)return k=!1,!0});let E=!0;Array.from(d.rows).find(w=>{const y=w.cells[o+1];if(y&&(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1))return E=!1,!0});let L=!0;return Array.from(d.rows).find(w=>{const y=w.cells[o-1];if(y&&(y.classList.contains("fn__none")||y.colSpan>1||y.rowSpan>1))return L=!1,!0}),i.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{insertRowAbove(t,a,n,e)}}),(!v||v&&!_&&h)&&i.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{insertRow(t,a,n,e)}}),(k||L)&&i.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{insertColumn(t,e,n,"beforebegin",a)}}),(k||E)&&i.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{insertColumn(t,e,n,"afterend",a)}}),((!c||c&&!u&&f)&&(!g||g&&!p&&m)||(!c||c&&!u&&f)&&(!v||v&&!_&&h)||k&&L||k&&E)&&i.push({type:"separator"}),(!c||c&&!u&&f)&&(!g||g&&!p&&m)&&i.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{moveRowToUp(t,a,n,e)}}),(!c||c&&!u&&f)&&(!v||v&&!_&&h)&&i.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{moveRowToDown(t,a,n,e)}}),k&&L&&i.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{moveColumnToLeft(t,a,n,e)}}),k&&E&&i.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{moveColumnToRight(t,a,n,e)}}),(n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!u||c&&!u&&f)||k)&&i.push({type:"separator"}),n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!u||c&&!u&&f)&&i.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{deleteRow(t,a,n,e)}}),k&&i.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{deleteColumn(t,a,e,n)}}),i},qi=(t,e,n,a)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4||e.getAttribute("data-type")==="NodeThematicBreak")return-1;let s="0";if(e.getAttribute("fold")==="1"){if(typeof n=="boolean"&&!n)return-1;e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber").forEach(o=>{lineNumberRender(o)})}else{if(typeof n=="boolean"&&n)return-1;if(s="1",e.setAttribute("fold","1"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0),l=hasClosestBlock(o.startContainer);l&&l.getBoundingClientRect().width===0&&focusBlock(e,void 0,!1)}e.querySelectorAll(".img--select").forEach(o=>{o.classList.remove("img--select")})}const i=e.getAttribute("data-node-id");return e.getAttribute("data-type")==="NodeHeading"?s==="0"?(e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),transaction(t,[{action:"unfoldHeading",id:i,data:a?"remove":void 0}],[{action:"foldHeading",id:i}])):(transaction(t,[{action:"foldHeading",id:i}],[{action:"unfoldHeading",id:i}]),removeFoldHeading(e)):transaction(t,[{action:"setAttrs",id:i,data:JSON.stringify({fold:s})}],[{action:"setAttrs",id:i,data:JSON.stringify({fold:s==="0"?"1":"0"})}]),preventScroll(t),s},zt=(t,e)=>{const n=getTopAloneElement(t),a=[];if(n.isSameNode(t)||(t.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),e.block.rootID===e.block.id&&e.wysiwyg.element.childElementCount===0){const s=Lute.NewNodeID(),i=genEmptyElement(!1,!1,s);a.push({action:"insert",data:i.outerHTML,id:s,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=i.outerHTML}a.length>0&&et(e,a,[])},Gt=()=>{if(window.siyuan.transactions.length===0)return;const t=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),fetchPost("/api/transactions",{session:t.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},a=>{if(window.siyuan.transactions.length===0?countBlockWord([],t.block.rootID,!0):Gt(),(window.siyuan.config.sync.provider!==0||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),a.data[0].doOperations[0].action==="setAttrs"){const i=t.gutter.element.querySelector('[data-type="fold"]');i&&i.removeAttribute("disabled"),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${a.data[0].doOperations[0].id}"]`)&&(o.removeAttribute("data-render"),blockRender(t,o))});return}let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(i=>{if(i.action==="unfoldHeading"||i.action==="foldHeading"){const o=t.gutter.element.querySelector('[data-type="fold"]');if(o&&o.removeAttribute("disabled"),i.action==="unfoldHeading"){const l=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(r=>{if(r.lastElementChild.classList.contains("protyle-attr")||r.lastElementChild.remove(),Zt(i.retData,t),r.insertAdjacentHTML("afterend",i.retData),i.data==="remove"){const d=getSelection();d.rangeCount>0&&r.contains(d.getRangeAt(0).startContainer)&&focusBlock(r.nextElementSibling,void 0,!0),r.remove()}}),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),blockRender(t,t.wysiwyg.element),t.contentElement.scrollTop=l,t.scroll.lastScrollTop=l;return}t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{onGet({data:l,protyle:t,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})});return}if(i.action==="update"){t.options.backlinkData&&(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(o=>{(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(o,"data-type","NodeBlockQueryEmbed"))&&(s&&(o.isSameNode(s.startContainer)||o.contains(s.startContainer))||(o.outerHTML=i.data.replace("<wbr>","")))}),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),blockRender(t,t.wysiwyg.element)),Kt(t,i),Je(t,i.id);return}if(i.action==="delete"||i.action==="append"){t.options.backlinkData&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(o=>{hasClosestByAttribute(o,"data-type","NodeBlockQueryEmbed")||o.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${i.id}"]`)&&(o.removeAttribute("data-render"),blockRender(t,o))});return}if(i.action==="move"){if(t.options.backlinkData){const o=[];Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(r=>{if(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r,"data-type","NodeBlockQueryEmbed")){o.push(r);return}});let l=!1;i.previousID&&o.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.after(o[0].cloneNode(!0)),l=!0)}):o.length>0&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(r=>{var d;(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&((d=r.firstElementChild)!=null&&d.classList.contains("protyle-action")?r.firstElementChild.after(o[0].cloneNode(!0)):r.prepend(o[0].cloneNode(!0)),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&zt(r,t)})}t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${i.id}"]`)&&(o.removeAttribute("data-render"),blockRender(t,o))});return}if(i.action==="insert"){if(t.options.backlinkData){const o=[];i.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==i.id&&!hasClosestByAttribute(l,"data-node-id",i.id)&&(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.insertAdjacentHTML("afterend",i.data),o.push(l.nextElementSibling))}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(l=>{(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==i.id?(l.firstElementChild.insertAdjacentHTML("afterend",i.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==i.id&&(l.insertAdjacentHTML("afterbegin",i.data),o.push(l.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{processRender(l),highlightRender(l),avRender(l),blockRender(t,l);const r=l.querySelector("wbr");r&&r.remove()})}Je(t,i.id)}else["addAttrViewCol","insertAttrViewBlock"].includes(i.action)&&refreshAV(t,i)})})},Kt=(t,e)=>{let n=!1;t.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${e.id}"]`).forEach(a=>{const s=document.createElement("div");s.innerHTML=e.data,s.querySelectorAll('[contenteditable="true"]').forEach(o=>{o.setAttribute("contenteditable","false")});const i=s.querySelector("wbr");i&&i.remove(),a.outerHTML=s.innerHTML,n=!0}),n&&(processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element))},Fi=(t,e,n)=>{const a=[];if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(s=>{hasClosestByAttribute(s.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(s)}),e.action==="setAttrs"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{JSON.parse(e.data).fold==="1"?s.setAttribute("fold","1"):s.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const s=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{e.retData&&(Zt(e.retData,t),i.insertAdjacentHTML("afterend",e.retData)),i.removeAttribute("fold"),e.data==="remove"&&i.remove()}),e.retData&&(processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),blockRender(t,t.wysiwyg.element),t.contentElement.scrollTop=s,t.scroll.lastScrollTop=s);return}if(e.action==="foldHeading"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{s.setAttribute("fold","1"),e.retData||removeFoldHeading(s)}),e.retData&&e.retData.forEach(s=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`).forEach(i=>{i.remove()})});return}if(e.action==="delete"){a.length>0&&(n&&focusSideBlock(a[0]),a.forEach(s=>{s.remove()})),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{s.querySelector(`[data-node-id="${e.id}"]`)&&(s.removeAttribute("data-render"),blockRender(t,s))});return}if(e.action==="update"){if(a.length>0){a.forEach(i=>{i.outerHTML=e.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(i.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(i,"data-type","NodeBlockQueryEmbed"))return a[0]=i,!0});const s=a[0].querySelector("wbr");if(n){const i=getEditorRange(a[0]);s?focusByWbr(a[0],i):focusBlock(a[0])}else s&&s.remove();processRender(a.length===1?a[0]:t.wysiwyg.element),highlightRender(a.length===1?a[0]:t.wysiwyg.element),avRender(a.length===1?a[0]:t.wysiwyg.element),blockRender(t,a.length===1?a[0]:t.wysiwyg.element)}Kt(t,e),Je(t,e.id);return}if(e.action==="updateAttrs"){const s=e.data,i={};let o="",l="",r="",d="";Object.keys(s.new).forEach(f=>{i[f]=s.new[f];const u=Lute.EscapeHTMLStr(s.new[f]);f==="bookmark"?o=`<div class="protyle-attr--bookmark">${u}</div>`:f==="name"?l=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${u}</div>`:f==="alias"?r=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${u}</div>`:f==="memo"&&(d=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${u}"><svg><use xlink:href="#iconM"></use></svg></div>`)});let c=o+l+r+d;if(t.block.rootID===e.id){if(t.title){const f=t.title.element.querySelector(".protyle-attr--refcount");f&&(c+=f.outerHTML),s.new["custom-riff-decks"]?(t.title.element.style.animation="addCard 450ms linear",t.title.element.setAttribute("custom-riff-decks",s.new["custom-riff-decks"]),setTimeout(()=>{t.title.element.style.animation=""},450)):t.title.element.removeAttribute("custom-riff-decks"),t.title.element.querySelector(".protyle-attr").innerHTML=c}t.wysiwyg.renderCustom(i),s.new.icon!==s.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==s.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=s.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(f=>{if(f.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(s.old).forEach(g=>{f.removeAttribute(g)}),s.new.style&&s.new["custom-riff-decks"]&&(s.new.style+=";animation:addCard 450ms linear"),Object.keys(s.new).forEach(g=>{f.setAttribute(g,s.new[g]),g==="custom-riff-decks"&&(f.style.animation="addCard 450ms linear",setTimeout(()=>{f.style.animation=""},450))});const u=f.lastElementChild.querySelector(".protyle-attr--refcount");u&&(c+=u.outerHTML),f.lastElementChild.innerHTML=c+Constants.ZWSP});return}if(e.action==="move"){let s;n&&getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),s.insertNode(document.createElement("wbr")));let i=!1;e.previousID&&a.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(o=>{hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")||(o.after(a[0].cloneNode(!0)),i=!0)}):a.length>0&&(!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.prepend(a[0].cloneNode(!0)),i=!0):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(o=>{var l;hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")||((l=o.firstElementChild)!=null&&l.classList.contains("protyle-action")?o.firstElementChild.after(a[0].cloneNode(!0)):o.prepend(a[0].cloneNode(!0)),i=!0)})),a.forEach(o=>{i?o.remove():!i&&o.parentElement&&zt(o,t)}),n&&s&&(e.data==="focus"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(o=>{if(!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed"))return focusBlock(o),!0}):focusByWbr(t.wysiwyg.element,s)),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(o.removeAttribute("data-render"),blockRender(t,o))});return}if(e.action==="insert"){const s=[];if(e.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(i=>{const o=hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed");o?(o.removeAttribute("data-render"),blockRender(t,o)):(i.insertAdjacentHTML("afterend",e.data),s.push(i.nextElementSibling))}):!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),s.push(t.wysiwyg.element.firstElementChild)):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(i=>{var o;hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed")||((o=i.firstElementChild)!=null&&o.classList.contains("protyle-action")?(i.firstElementChild.insertAdjacentHTML("afterend",e.data),s.push(i.firstElementChild.nextElementSibling)):(i.insertAdjacentHTML("afterbegin",e.data),s.push(i.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(i=>{i.lastElementChild.getAttribute("spin")==="1"&&i.lastElementChild.remove()}),s.length===0)return;s.forEach(i=>{processRender(i),highlightRender(i),avRender(i),blockRender(t,i);const o=i.querySelector("wbr");if(n){const l=getEditorRange(i);o?focusByWbr(i,l):focusBlock(i)}else o&&o.remove()}),Je(t,e.id)}else e.action==="append"?reloadProtyle(t,!1):["addAttrViewCol","insertAttrViewBlock"].includes(e.action)&&refreshAV(t,e)},Wi=t=>{let e;const n=Lute.NewNodeID();if(t.type==="BlocksMergeSuperBlock")e=genSBElement(t.level,n);else if(t.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(t.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeList"),t.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):t.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";t.selectsElement.forEach((d,c)=>{t.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:t.type==="Blocks2OLs"?r+=`<div data-marker="${c+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${c+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=t.selectsElement[0].getAttribute("data-node-id"),s=t.selectsElement[0].parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,i=[{action:"insert",id:n,data:e.outerHTML,nextID:a,parentID:s}],o=[];t.selectsElement[0].previousElementSibling?t.selectsElement[0].before(e):t.selectsElement[0].parentElement.prepend(e);let l;t.selectsElement.forEach((r,d)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const c=r.getAttribute("data-node-id");o.push({action:"move",id:c,previousID:l||n,parentID:s}),t.type.endsWith("Ls")?(i.push({action:"move",id:c,parentID:e.children[d].getAttribute("data-node-id")}),e.children[d].firstElementChild.after(r)):(i.push({action:"move",id:c,previousID:l,parentID:n}),e.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),d===t.selectsElement.length-1&&o.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(t.protyle,r))}),et(t.protyle,i,o),focusBlock(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.selectsElement[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],t.protyle)},Zt=(t,e)=>{const n=document.createElement("template");n.innerHTML=t,Array.from(n.content.children).forEach(a=>{var s;(s=e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||s.remove()})},ji=t=>{let e=t.selectsElement,n;if(t.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),e=Array.from(t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0&&(e=[t.nodeElement]);let o=!1,l=!1,r=!1;if(e.find((d,c)=>{if(d.classList.contains("li"))return r=!0,!0;if((d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("p"))&&(l=!0),d.nextElementSibling&&e[c+1]&&d.nextElementSibling.isSameNode(e[c+1]))o=!0;else if(c!==e.length-1)return o=!1,!0}),r||l&&t.type==="Blocks2Ps")return;e.length===1&&t.type==="Blocks2Hs"&&e[0].getAttribute("data-type")==="NodeHeading"&&t.level===parseInt(e[0].getAttribute("data-subtype").substr(1))&&(t.type="Blocks2Ps"),t.isContinue=o}let a="";const s=[],i=[];e.forEach((o,l)=>{(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"&&setFold(t.protyle,o),o.classList.remove("protyle-wysiwyg--select"),o.removeAttribute("select-start"),o.removeAttribute("select-end"),a+=o.outerHTML;const r=o.getAttribute("data-node-id");if(i.push({action:"update",id:r,data:o.outerHTML}),(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&!t.isContinue)o.outerHTML=t.protyle.lute[t.type](o.outerHTML,t.level);else if(l===e.length-1){const d=document.createElement("div");d.innerHTML=t.protyle.lute[t.type](a,t.level),o.outerHTML=d.innerHTML}else o.remove()}),i.forEach(o=>{const l=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);s.push({action:"update",id:o.id,data:l.outerHTML})}),et(t.protyle,s,i),processRender(t.protyle.wysiwyg.element),highlightRender(t.protyle.wysiwyg.element),avRender(t.protyle.wysiwyg.element),blockRender(t.protyle,t.protyle.wysiwyg.element),n?focusByWbr(t.protyle.wysiwyg.element,n):focusBlock(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${e[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],t.protyle)},Je=(t,e,n=0)=>{n>6||t.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${e}"]`).forEach(a=>{a.getAttribute("data-subtype")==="d"&&fetchPost("/api/block/getRefText",{id:e},s=>{a.innerHTML=s.data;const i=hasClosestBlock(a);i&&Je(t,i.getAttribute("data-node-id"),n+1)})})};let Vt;const et=(t,e,n)=>{const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let s=!1;const i=new Date().getTime();a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&t.transactionTime-i<Constants.TIMEOUT_INPUT&&(s=!0),t.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.model&&t.model.headElement.classList.remove("item--unupdate"),t.updated=!0,s?t.undo.replace(e):t.undo.add(e,n)),s?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=t,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:t,doOperations:e,undoOperations:n}),t.transactionTime=i,window.clearTimeout(Vt),Vt=window.setTimeout(()=>{Gt()},Constants.TIMEOUT_INPUT*2)},Yi=(t,e,n,a)=>{n!==a&&et(t,[{id:e,data:n,action:"update"}],[{id:e,data:a,action:"update"}])},Ui=(t,e,n)=>{const a=[],s=[];t.forEach(i=>{const o=i.getAttribute("data-node-id");i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end"),s.push({action:"update",id:o,data:i.outerHTML}),n(i),a.push({action:"update",id:o,data:i.outerHTML})}),et(e,a,s)},zi=(t,e)=>{const n=e.parentElement.parentElement.firstElementChild.children[parseInt(e.getAttribute("data-index"))+1].getAttribute("data-dtype"),a=e.getBoundingClientRect();let s="";(n==="block"||n==="text")&&(s=`<textarea style="position:absolute;left: ${a.left}px;top: ${a.top}px;width:${Math.max(a.width,200)}px" class="b3-text-field">${e.textContent}</textarea>`),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask">
    ${s}
</div>`);const i=document.querySelector(".av__mask"),o=i.querySelector(".b3-text-field");o&&(o.select(),o.addEventListener("blur",()=>{Xt(t,e,n)}),o.addEventListener("keydown",l=>{l.isComposing||(l.key==="Escape"||l.key==="Enter")&&(Xt(t,e,n),l.preventDefault(),l.stopPropagation())})),i.addEventListener("click",l=>{l.target.classList.contains("av__mask")&&(i==null||i.remove())})},Xt=(t,e,n)=>{const a=document.querySelector(".av__mask"),s=a.querySelector(".b3-text-field"),i=hasClosestBlock(e);i&&(transaction(t,[{action:"updateAttrViewCell",id:i.getAttribute("data-node-id"),rowID:i.getAttribute("data-av-id"),type:n,data:s.value}],[{action:"updateAttrViewCell",id:i.getAttribute("data-node-id"),rowID:i.getAttribute("data-av-id"),type:n,data:e.textContent.trim()}]),e.textContent=s.value,setTimeout(()=>{a.remove()}))},ia=t=>{const e=t.getAttribute("data-index"),n=hasClosestBlock(t);if(!n)return!1;n.querySelectorAll(".av__row").forEach(a=>{a.querySelector(`[data-index="${e}"]`).remove()})},Gi=(t,e,n)=>{var a;const s=n.getAttribute("data-dtype"),i=new Menu("av-header-cell");i.addItem({icon:getColIconByType(s),label:`<input style="margin: 4px 0" class="b3-text-field" type="text" value="${n.innerText.trim()}">`,bind(){}}),s!=="block"&&i.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){}}),i.addSeparator(),i.addItem({icon:"iconUp",label:window.siyuan.languages.fileNameNatASC,click(){}}),i.addItem({icon:"iconDown",label:window.siyuan.languages.fileNameNatDESC,click(){}}),i.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){}}),i.addSeparator(),s!=="block"&&(i.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){}}),i.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){}}),i.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){const l=n.getAttribute("data-id");transaction(t,[{action:"removeAttrViewCol",id:l,parentID:e.getAttribute("data-av-id")}],[{action:"addAttrViewCol",name:n.textContent.trim(),parentID:e.getAttribute("data-av-id"),type:s,id:l}]),ia(n)}}),i.addSeparator()),i.addItem({label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${n.getAttribute("data-wrap")==="true"?" checked":""}></div>`,click(){}});const o=n.getBoundingClientRect();i.open({x:o.left,y:o.bottom,h:o.height}),(a=window.siyuan.menus.menu.element.querySelector(".b3-text-field"))==null||a.select()},xt=(t,e)=>{let n=[];t.getAttribute("data-type")==="NodeAttributeView"?n=[t]:n=Array.from(t.querySelectorAll('[data-type="NodeAttributeView"]')),n.length!==0&&n.length>0&&n.forEach(a=>{a.getAttribute("data-render")!=="true"&&Ea("/api/av/renderAttributeView",{id:a.getAttribute("data-av-id")},s=>{const i=s.data.av;let o='<div class="av__row av__row--header"><div class="av__firstcol"><svg style="height: 42px"><use xlink:href="#iconUncheck"></use></svg></div>',l=0;i.columns.forEach(c=>{c.hidden||(o+=`<div class="av__cell" data-index="${l}" data-id="${c.id}" data-dtype="${c.type}" data-wrap="${c.wrap}" style="width: ${c.width||200}px;">
    <svg><use xlink:href="#${c.icon||Bn(c.type)}"></use></svg>
    <span>${c.name}</span>
</div>`,l++)}),o+=`<div class="block__icons">
    <div class="block__icon block__icon--show" data-type="av-header-add"><svg><use xlink:href="#iconAdd"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show"  data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
</div>
</div>`,i.rows.forEach(c=>{o+=`<div class="av__row" data-id="${c.id}">
<div class="av__gutters">
    <button><svg><use xlink:href="#iconLine"></use></svg></button>
</div>
<div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>`,c.cells.forEach((f,u)=>{var g;o+=`<div class="av__cell" data-index="${u}" style="width: ${i.columns[u].width||200}px;${f.bgColor?`background-color:${f.bgColor};`:""}${f.color?`color:${f.color};`:""}">${((g=f.renderValue)==null?void 0:g.content)||""}</div>`}),o+="<div></div></div>"});const r=a.parentElement.style.paddingLeft,d=a.parentElement.style.paddingRight;a.style.width=a.parentElement.clientWidth+"px",a.style.alignSelf="center",a.firstElementChild.outerHTML=`<div>
    <div style="padding-left: ${r};padding-right: ${d};">
        <div>
            <div>tab1</div>
        </div>
        <div contenteditable="true">
            ${i.title}
        </div>
    </div>
    <div class="av__scroll">
        <div style="padding-left: ${r};padding-right: ${d};float: left;">
            ${o}
            <div class="block__icon block__icon--show">
                <div class="fn__space"></div>
                <svg><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>
                ${window.siyuan.languages.addAttr}
            </div>
            <div class="av__row--footer">Calculate</div>
        </div>
    </div>
</div>`,a.setAttribute("data-render","true"),e&&e()})})},Ki=(t,e)=>{e.action==="addAttrViewCol"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.parentID}"]`)).forEach(n=>{n.removeAttribute("data-render"),xt(n,()=>{showHeaderCellMenu(t,n,n.querySelector(".av__row--header").lastElementChild.previousElementSibling)})}):e.action==="insertAttrViewBlock"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(n=>{n.removeAttribute("data-render"),xt(n)})},Zi=(t,e)=>{t.block.showAll=!0;let n="";e.forEach(a=>{n+=la(a.blockPaths)+Qt(a.dom,a.expand)}),t.wysiwyg.element.innerHTML=n,processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element),blockRender(t,t.wysiwyg.element),removeLoading(t),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(t)},oa=(t,e)=>{e.firstElementChild.classList.contains("li")?t?e.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((n,a)=>{(t&&a>2||!t&&a>1)&&((t&&a===3||!t&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Qt=(t,e)=>{const n=document.createElement("template");return n.innerHTML=t,oa(e,n.content),n.innerHTML},Vi=(t,e)=>{fetchPost("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},n=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const s=a;a=a.nextElementSibling,s.remove()}e.parentElement.insertAdjacentHTML("afterend",Qt(n.data.content,!0)),processRender(e.parentElement.parentElement),avRender(e.parentElement.parentElement),blockRender(t,e.parentElement.parentElement),n.data.isSyncing?disabledForeverProtyle(t):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(t):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(s=>{s.setAttribute("contenteditable","false")})})},Xi=t=>{let e=t.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;t.remove()},la=(t,e=!1)=>{let n="";return t.forEach((a,s)=>{s===0&&!e||(n+=`<span class="protyle-breadcrumb__item${s===t.length-1?" protyle-breadcrumb__item--active":""}" data-id="${a.id}">
    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${getIconByType(a.type,a.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${a.name}">${a.name}</span>
</span>`,s!==t.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},ra=(t,e,n)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.setAttribute("data-render","true"),s.style.height=s.clientHeight-8+"px",s.innerHTML=`<div class="protyle-icons${hasClosestByAttribute(s.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">
    <span class="protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${s.lastElementChild.outerHTML}`;const i=Lute.UnEscapeHTMLStr(s.getAttribute("data-content"));let o=s.getAttribute("breadcrumb");o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,hasTopClosestByClassName(s,"sb")&&(o=!1),fetchPost("/api/search/searchEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),stmt:i,headingMode:s.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[s.getAttribute("data-node-id"),t.block.rootID],breadcrumb:o},r=>{const d=s.querySelector(".fn__rotate");d&&d.classList.remove("fn__rotate");let c="";r.data.blocks.forEach(g=>{let m="";g.blockPaths.length!==0&&(m=genBreadcrumb(g.blockPaths,!0)),c+=`<div class="protyle-wysiwyg__embed" data-id="${g.block.id}">${m}${g.block.content}</div>`}),r.data.blocks.length>0?s.lastElementChild.insertAdjacentHTML("beforebegin",c+`<div style="position: absolute;">${Constants.ZWSP}</div>`):s.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${Constants.ZWSP}</div>`),processRender(s),highlightRender(s),avRender(s),n&&(t.contentElement.scrollTop=n);let f=0,u=s;for(;f<4&&u;)u=hasClosestByAttribute(u.parentElement,"data-type","NodeBlockQueryEmbed"),f++;f<4&&s.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(g=>{ra(t,g)}),s.style.height=""})})},da=t=>{if(t.action||(t.action=[]),t.protyle.wysiwyg.element.removeAttribute("data-top"),t.data.code===1){t.protyle.model?t.protyle.model.parent.parent.removeTab(t.protyle.model.parent.id,!1,!1):t.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`;return}if(t.data.code!==3&&(t.protyle.notebookId=t.data.data.box,t.protyle.path=t.data.data.path,!(t.data.data.eof&&!t.scrollAttr&&(t.action.includes(Constants.CB_GET_BEFORE)?t.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):t.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),t.data.data.mode!==4)))){if(hideElements(["gutter"],t.protyle),t.protyle.block.parentID=t.data.data.parentID,t.protyle.block.parent2ID=t.data.data.parent2ID,t.protyle.block.rootID=t.data.data.rootID,t.protyle.block.showAll=!1,t.protyle.block.mode=t.data.data.mode,t.protyle.block.blockCount=t.data.data.blockCount,t.protyle.block.scroll=t.data.data.scroll,t.protyle.block.action=t.action,t.action.includes(Constants.CB_GET_UNCHANGEID)||(t.protyle.block.id=t.data.data.id,t.protyle.scroll.lastScrollTop=0,t.protyle.contentElement.scrollTop=0,t.protyle.wysiwyg.element.setAttribute("data-doc-type",t.data.data.type)),t.action.includes(Constants.CB_GET_APPEND)||t.action.includes(Constants.CB_GET_BEFORE)||t.action.includes(Constants.CB_GET_HTML)){Jt({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing},t.protyle),removeLoading(t.protyle);return}fetchPost("/api/block/getDocInfo",{id:t.protyle.block.rootID},e=>{t.protyle.options.render.title?t.protyle.title.render(t.protyle,e):t.protyle.options.render.background&&(t.protyle.background.render(e.data.ial,t.protyle.block.rootID),t.protyle.wysiwyg.renderCustom(e.data.ial)),Jt({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing},t.protyle),setTitle(e.data.ial.title),removeLoading(t.protyle)})}},Jt=(t,e)=>{if(e.contentElement.classList.contains("fn__none"))return;e.block.showAll=t.action.includes(Constants.CB_GET_ALL);const n=e.contentElement.clientHeight*8;if(t.action.includes(Constants.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>n){let a=e.wysiwyg.element.firstElementChild;const s=[];for(;e.wysiwyg.element.childElementCount>2&&s&&!e.wysiwyg.element.lastElementChild.isSameNode(a)&&e.contentElement.scrollHeight-a.offsetTop>n;){s.push(a);a=a.nextElementSibling}const i=a.getBoundingClientRect().top;s.forEach(o=>{o.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-i),e.scroll.lastScrollTop=e.contentElement.scrollTop,hideElements(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",t.content)}else if(t.action.includes(Constants.CB_GET_BEFORE)){const a=e.wysiwyg.element.firstElementChild,s=a.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-s),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){for(;e.wysiwyg.element.childElementCount>2&&e.contentElement.scrollHeight>n&&e.wysiwyg.element.lastElementChild.getBoundingClientRect().top>window.innerHeight;)e.wysiwyg.element.lastElementChild.remove();hideElements(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=t.content;if(t.action.includes(Constants.CB_GET_BACKLINK)&&foldPassiveType(t.expand,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element),blockRender(e,e.wysiwyg.element),!t.action.includes(Constants.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),t.scrollAttr){if(e.contentElement.scrollTop=t.scrollAttr.scrollTop,t.action.includes(Constants.CB_GET_HL))highlightById(e,t.scrollAttr.focusId,!0);else if(t.action.includes(Constants.CB_GET_FOCUS))if(t.scrollAttr.focusId){const a=focusByOffset(e.wysiwyg.element.querySelector(`[data-node-id="${t.scrollAttr.focusId}"]`),t.scrollAttr.focusStart,t.scrollAttr.focusEnd)}else tn(e,t.action);if(!e.scroll.element.classList.contains("fn__none")){e.scroll.updateIndex(e,t.scrollAttr.startId);const a=e.contentElement.getBoundingClientRect();e.wysiwyg.element.clientHeight-parseInt(e.wysiwyg.element.style.paddingBottom)<e.contentElement.clientHeight&&e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom<a.bottom&&e.wysiwyg.element.firstElementChild.getBoundingClientRect().top>a.top&&showMessage(window.siyuan.languages.scrollGetMore)}}else if(t.action.includes(Constants.CB_GET_HL)){preventScroll(e);const a=highlightById(e,e.block.id,!0)}else if(t.action.includes(Constants.CB_GET_FOCUS))tn(e,t.action);else if(t.action.includes(Constants.CB_GET_FOCUSFIRST)){const a=e.wysiwyg.element.offsetTop-16;preventScroll(e,a,256),e.contentElement.scrollTop=a,focusBlock(e.wysiwyg.element.firstElementChild)}t.isSyncing?ca(e):(e.breadcrumb.element.nextElementSibling.textContent="",e.element.removeAttribute("disabled-forever"),window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?en(e):ua(e)),t.action.includes(Constants.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),e.options.defId&&(e.wysiwyg.element.querySelectorAll(`[data-id="${e.options.defId}"]`).forEach(a=>{a.classList.add("def--mark")}),e.options.defId=void 0),e.element.classList.contains("block__edit")&&((e.element.nextElementSibling||e.element.previousElementSibling)&&(e.element.style.minHeight=Math.min(30+e.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),e.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(e.contentElement.clientHeight-49,200)}px;${isMobile()?"":"right:10px"}`)),!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!t.action.includes(Constants.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{da({data:a,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})}),!(t.action.includes(Constants.CB_GET_APPEND)||t.action.includes(Constants.CB_GET_BEFORE))&&(e.options.render.breadcrumb&&e.breadcrumb.render(e),e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle",e)}))}},ca=t=>{en(t),t.breadcrumb&&!isMobile()?t.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:showMessage(window.siyuan.languages._kernel[81]),t.element.setAttribute("disabled-forever","true")},en=t=>{if(window.siyuan.menus.menu.remove(),hideElements(["gutter","toolbar","select","hint","util"],t),t.disabled=!0,t.title){const e=t.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","false"),e.style.userSelect="text"}t.background&&(t.background.element.classList.remove("protyle-background--enable"),t.background.element.classList.remove("protyle-background--mobileshow")),t.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),t.wysiwyg.element.style.userSelect="text",t.wysiwyg.element.setAttribute("contenteditable","false"),t.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")})},ua=t=>{if(t.element.getAttribute("disabled-forever")!=="true"){if(t.disabled=!1,navigator&&navigator.maxTouchPoints>1&&["MacIntel","iPhone"].includes(navigator.platform)||(t.wysiwyg.element.setAttribute("contenteditable","true"),t.wysiwyg.element.style.userSelect=""),t.title){const e=t.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","true"),e.style.userSelect=""}t.background&&t.background.element.classList.add("protyle-background--enable"),t.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(e=>{hasClosestByClassName(e,"protyle-wysiwyg__embed")||e.setAttribute("contenteditable","true")})}},tn=(t,e)=>{let n;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${t.block.id}"]`)).find(a=>{if(!hasClosestByAttribute(a,"data-type","block-render",!0))return n=a,!0}),t.block.mode===4&&(preventScroll(t),n=t.wysiwyg.element.lastElementChild),n&&!t.wysiwyg.element.firstElementChild.isSameNode(n)?(focusBlock(n),n.scrollIntoView(),setTimeout(()=>{n.scrollIntoView()},Constants.TIMEOUT_LOAD)):focusBlock(t.wysiwyg.element.firstElementChild)};let nn;const Qi=(t,e)=>{let n=e.getBoundingClientRect();e.addEventListener("scroll",()=>{if(!t.toolbar.element.classList.contains("fn__none")){const a=t.toolbar.element.getAttribute("data-inity").split(Constants.ZWSP),s=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);n.width===0&&(n=e.getBoundingClientRect());const i=29;s<n.top-i||s>n.bottom-i?t.toolbar.element.style.display="none":(t.toolbar.element.style.top=s+"px",t.toolbar.element.style.display="")}t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{if(a.parentElement.classList.contains("protyle-wysiwyg")){const s=a.offsetTop-30+56,i=a.querySelector(".av__row--header");i&&(s<e.scrollTop&&s+i.parentElement.clientHeight>e.scrollTop?i.style.transform=`translateY(${e.scrollTop-s}px)`:i.style.transform="");const o=a.querySelector(".av__row--footer");if(o){const l=s+o.parentElement.clientHeight,r=e.scrollTop+e.clientHeight;s+42+36*2<r&&l>r?o.style.transform=`translateY(${r-l}px)`:o.style.transform=""}}}),!t.element.classList.contains("block__edit")&&!isMobile()&&t.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||hideElements(["gutter"],t),t.scroll&&!t.scroll.element.classList.contains("fn__none")&&(clearTimeout(nn),nn=window.setTimeout(()=>{n=e.getBoundingClientRect();const a=document.elementFromPoint(n.left+n.width/2,n.top+10),s=hasClosestBlock(a);if(!s){if(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"&&(hasClosestByClassName(a,"protyle-background")||hasClosestByClassName(a,"protyle-title"))){const i=t.scroll.element.querySelector(".b3-slider");i.value="1",t.scroll.element.setAttribute("aria-label",`Blocks 1/${t.block.blockCount}`)}return}t.scroll.updateIndex(t,s.getAttribute("data-node-id"))},Constants.TIMEOUT_LOAD)),!(t.wysiwyg.element.getAttribute("data-top")||t.block.showAll||t.scroll&&t.scroll.element.classList.contains("fn__none")||!t.scroll||t.scroll.lastScrollTop===e.scrollTop||t.scroll.lastScrollTop===-1)&&(t.scroll.lastScrollTop-e.scrollTop>0?e.scrollTop<e.clientHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(t.contentElement.style.width=t.contentElement.clientWidth+"px",t.contentElement.style.overflow="hidden",t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{t.contentElement.style.overflow="",t.contentElement.style.width="",onGet({data:a,protyle:t,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})})):e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&t.wysiwyg.element.lastElementChild&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:t,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})})),t.scroll.lastScrollTop=Math.max(e.scrollTop,0))},{capture:!1,passive:!0,once:!1})},an=(t,e)=>{addScript(t,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(e.icon)){const n=document.getElementById("iconScript");n&&n.remove(),addScript(`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`,"iconScript")}})},fa=t=>{const e=document.getElementsByTagName("html")[0];e.setAttribute("lang",window.siyuan.config.appearance.lang),e.setAttribute("data-theme-mode",ga()),e.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),e.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const a=document.getElementById("themeDefaultStyle");let s=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`;(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight")&&(s=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`),a?a.getAttribute("href").startsWith(s)||(a.remove(),addStyle(s,"themeDefaultStyle")):addStyle(s,"themeDefaultStyle");const i=document.getElementById("themeStyle");if(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight"){const c=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.css?v=${t.themeVer}`;i?i.getAttribute("href").startsWith(c)||(i.remove(),addStyle(c,"themeStyle")):addStyle(c,"themeStyle")}else i&&i.remove();sn();const o=document.getElementById("themeScript"),l=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.js?v=${t.themeVer}`;o?o.getAttribute("src").startsWith(l)||(o.remove(),addScript(l,"themeScript")):addScript(l,"themeScript");const r=document.getElementById("iconDefaultScript"),d=`/appearance/icons/${["ant","material"].includes(t.icon)?t.icon:"material"}/icon.js?v=${Constants.SIYUAN_VERSION}`;if(r){r.remove();let c=document.body.firstElementChild;for(;c.tagName==="svg";){const f=c;c=c.nextElementSibling,f.getAttribute("data-name")||f.remove()}an(d,t)}else an(d,t)},Ji=()=>{const t=document.getElementById("loading");t&&setTimeout(()=>{t.remove()},160),on(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const n=e.matches?"dark":"light";on(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>{if(window.siyuan.config.appearance.themeJS){window.location.reload();return}window.siyuan.config.appearance=a.data.appearance,fa(a.data.appearance)}))})},eo=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){addScript("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const t=function(...n){window.dataLayer.push(arguments)};t("js",new Date),t("config","G-L7WEXVQCR9",{send_page_view:!1});const e={version:Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(e.isLoggedIn=!0,e.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,e.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,e.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType),window.siyuan.config.sync&&(e.syncEnabled=window.siyuan.config.sync.enabled,e.syncProvider=window.siyuan.config.sync.provider),t("event",Constants.ANALYTICS_EVT_ON_GET_CONFIG,e)}},to=(t=!0)=>{const e=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${e+8}px;line-height: ${e+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${e+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${e+8}px);top:${e+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${e}px;}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${e+8}px}
.protyle-gutters button svg {height:${e}px}
.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${e-8}px}
.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.75*1.25)}px}
.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.55*1.25)}px}
.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.38*1.25)}px}
.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25*1.25)}px}
.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.13*1.25)}px}
.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25)}px}`;return window.siyuan.config.editor.fontFamily&&(n+=`.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title, .protyle-title__input{font-family: "${window.siyuan.config.editor.fontFamily}", "Helvetica Neue", "Luxi Sans", "DejaVu Sans", "Hiragino Sans GB", "Microsoft Yahei", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", "Android Emoji", "EmojiSymbols" !important;}`),t&&(document.getElementById("editorFontSize").innerHTML=n),n},sn=(t=S.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,S.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,S.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${t}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;e?e.href.includes(a)||(e.remove(),_t(a,"protyleHljsStyle")):_t(a,"protyleHljsStyle")},no=t=>{},on=t=>{var e;(window.siyuan.config.system.container==="ios"&&((e=window.webkit)!=null&&e.messageHandlers)||window.siyuan.config.system.container==="android"&&window.JSAndroid)&&setTimeout(()=>{var n;const a=getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim();let s=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(t==="dark"?s=1:s=0),window.siyuan.config.system.container==="ios"&&((n=window.webkit)!=null&&n.messageHandlers)?window.webkit.messageHandlers.changeStatusBar.postMessage((a||(s===0?"#fff":"#1e1f22"))+" "+s):window.siyuan.config.system.container==="android"&&window.JSAndroid&&window.JSAndroid.changeStatusBarColor(a,s)},500)},ga=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?t:window.siyuan.config.appearance.mode===0?"light":"dark"},ao=t=>{t.contentElement=document.createElement("div"),t.contentElement.className="protyle-content",window.siyuan.config.editor.fullWidth?t.contentElement.setAttribute("data-fullwidth","true"):t.contentElement.removeAttribute("data-fullwidth"),t.options.render.background&&t.contentElement.appendChild(t.background.element),t.options.render.title&&t.contentElement.appendChild(t.title.element),t.contentElement.appendChild(t.wysiwyg.element),t.options.action.includes(Constants.CB_GET_HISTORY)||scrollEvent(t,t.contentElement),t.element.append(t.contentElement),t.element.appendChild(t.preview.element),t.upload&&t.element.appendChild(t.upload.element),t.options.render.scroll&&t.element.appendChild(t.scroll.element.parentElement),t.gutter&&t.element.appendChild(t.gutter.element),t.element.appendChild(t.hint.element),t.selectElement=document.createElement("div"),t.selectElement.className="protyle-select fn__none",t.element.appendChild(t.selectElement),t.element.appendChild(t.toolbar.element),t.element.appendChild(t.toolbar.subElement),ma(t),setEditMode(t,t.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p"),t.contentElement.addEventListener("touchstart",a=>{if(t.disabled)return;const s=a.target;if(hasClosestByClassName(s,"protyle-icons")||hasClosestByClassName(s,"item")||s.classList.contains("protyle-background__icon"))return;if(hasClosestByClassName(s,"protyle-background")){t.background.element.classList.toggle("protyle-background--mobileshow");return}const i=hasClosestByAttribute(s,"data-type","NodeBlockQueryEmbed");i&&i.firstElementChild.classList.toggle("protyle-icons--show")});let e;const n=isMac();t.contentElement.addEventListener("mousewheel",a=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!a.metaKey||!n&&!a.ctrlKey||a.deltaX!==0)){if(a.preventDefault(),a.stopPropagation(),a.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(a.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;setInlineStyle(),clearTimeout(e),e=window.setTimeout(()=>{fetchPost("/api/setting/setEditor",window.siyuan.config.editor)},Constants.TIMEOUT_LOAD)}},{passive:!1})},ma=(t,e)=>{t.element.removeAttribute("data-loading"),setTimeout(()=>{t.element.getAttribute("data-loading")!=="finished"&&t.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},Constants.TIMEOUT_LOAD)},so=t=>{t.element.setAttribute("data-loading","finished"),t.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},io=t=>{if(t.options.action.includes(Constants.CB_GET_HISTORY))return;let e=16,n=24;if(!isMobile()){let s=(t.element.clientWidth-Constants.SIZE_EDITOR_WIDTH)/2;!window.siyuan.config.editor.fullWidth&&s>96?(s>Constants.SIZE_EDITOR_WIDTH&&(s=t.element.clientWidth*.382/1.382),e=s,n=s):t.element.clientWidth>Constants.SIZE_EDITOR_WIDTH&&(e=96,n=96)}t.options.render.background&&t.options.render.title?(t.background.element.lastElementChild.setAttribute("style",`left:${e}px`),t.title.element.style.margin=`16px ${e}px 0 ${n}px`):t.options.render.background&&!t.options.render.title?t.background.element.lastElementChild.setAttribute("style",`left:${e}px`):!t.options.render.background&&t.options.render.title&&(t.title.element.style.margin=`16px ${e}px 0 ${n}px`);let a="16px";if(t.options.typewriterMode&&(isMobile()?a=window.innerHeight/5+"px":a=t.element.clientHeight/2+"px"),t.options.backlinkData?t.wysiwyg.element.style.padding=`4px ${e}px 4px ${n}px`:t.wysiwyg.element.style.padding=`16px ${e}px ${a} ${n}px`,window.siyuan.config.editor.codeSyntaxHighlightLineNum&&setTimeout(()=>{t.wysiwyg.element.querySelectorAll('.code-block [contenteditable="true"]').forEach(s=>{lineNumberRender(s)})},300),window.siyuan.config.editor.displayBookmarkIcon){const s=document.getElementById("editorAttr");s&&(s.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${t.wysiwyg.element.clientWidth-e-n}px; }`)}},oo=(t,e=!1)=>{if(!t.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:t.block.rootID,startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:t.contentElement.scrollTop||parseInt(t.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!t.wysiwyg.element.contains(a.startContainer))&&(a=t.toolbar.range),a&&t.wysiwyg.element.contains(a.startContainer)){const i=hasClosestBlock(a.startContainer);if(i){const o=getSelectionOffset(i,void 0,a);n.focusId=i.getAttribute("data-node-id"),n.focusStart=o.start,n.focusEnd=o.end}}if(t.block.showAll&&(n.zoomInId=t.block.id),e)return n;const s=JSON.stringify(n);fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{scroll:s}},()=>{t.wysiwyg.element.setAttribute("scroll",s)})},lo=t=>{var e,n;let a=[];if(t.mergedOptions?a=t.mergedOptions.action:t.focus?a=[Constants.CB_GET_UNUNDO,Constants.CB_GET_FOCUS]:a=[Constants.CB_GET_UNUNDO],t.scrollAttr.zoomInId){fetchPost("/api/filetree/getDoc",{id:t.scrollAttr.zoomInId,size:Constants.SIZE_GET_MAX},s=>{var i;a.push(Constants.CB_GET_ALL),(i=t.protyle.breadcrumb)==null||i.toggleExit(!1),onGet({data:s,protyle:t.protyle,action:a,scrollAttr:t.scrollAttr}),t.cb&&t.cb()});return}fetchPost("/api/filetree/getDoc",{id:t.scrollAttr.rootId||((e=t.mergedOptions)==null?void 0:e.blockId)||((n=t.protyle.block)==null?void 0:n.rootID)||t.scrollAttr.startId,startID:t.scrollAttr.startId,endID:t.scrollAttr.endId},s=>{var i;(i=t.protyle.breadcrumb)==null||i.toggleExit(!0),onGet({data:s,protyle:t.protyle,action:a,scrollAttr:t.scrollAttr}),t.cb&&t.cb()})},ro=(t,e)=>{if(window.siyuan.config.editor.displayBookmarkIcon?t.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):t.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),t.title&&(t.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?t.title.element.classList.add("protyle-wysiwyg--attr"):t.title.element.classList.remove("protyle-wysiwyg--attr")),t.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),addLoading(t),t.options.backlinkData){const n=t.element.getAttribute("data-ismention")==="true",a=hasClosestByClassName(t.element,"sy__backlink");if(a){const s=a.querySelectorAll(".b3-form__icon-input");fetchPost(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:t.element.getAttribute("data-defid"),refTreeID:t.block.rootID,keyword:n?s[1].value:s[0].value},i=>{t.options.backlinkData=n?i.data.backmentions:i.data.backlinks,renderBacklink(t,t.options.backlinkData)})}}else preventScroll(t),getDocByScroll({protyle:t,focus:e,scrollAttr:saveScroll(t,!0)})},co=()=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===window.siyuan.config.keymap.general.dailyNote.custom)return s.destroy(),!0}))return;const e=getOpenNotebookCount();if(e===0){showMessage(window.siyuan.languages.newFileTip);return}if(e===1){let s="";window.siyuan.notebooks.find(i=>{i.closed||(s=i.id)}),fetchPost("/api/filetree/createDailyNote",{notebook:s,app:Constants.SIYUAN_APPID});return}const n=window.siyuan.storage[Constants.LOCAL_DAILYNOTEID],a=window.siyuan.notebooks.find(s=>{if(s.id===n&&!s.closed)return!0});if(n&&a&&!isMobile())fetchPost("/api/filetree/createDailyNote",{notebook:n,app:Constants.SIYUAN_APPID});else{let s="";window.siyuan.notebooks.forEach(r=>{r.closed||(s+=`<option value="${r.id}">${r.name}</option>`)});const i=new Dialog({title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});i.element.setAttribute("data-key",window.siyuan.config.keymap.general.dailyNote.custom);const o=i.element.querySelectorAll(".b3-button"),l=i.element.querySelector(".b3-select");l.value=n,o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{const r=l.value;window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]=r,setStorageVal(Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]),fetchPost("/api/filetree/createDailyNote",{notebook:r,app:Constants.SIYUAN_APPID}),i.destroy()})}},uo=()=>{const t=Constants.HELP_PATH[window.siyuan.config.appearance.lang];fetchPost("/api/notebook/removeNotebook",{notebook:t,callback:Constants.CB_MOUNT_REMOVE},()=>{fetchPost("/api/notebook/openNotebook",{notebook:t})})},fo=()=>{const t=new Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");t.bindInput(t.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input").value;if(!validateName(n))return!1;fetchPost("/api/notebook/createNotebook",{name:n}),t.destroy()})},ln=t=>{let e="",n="";return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,n="/",!0}),{notebookId:e,currentPath:n}},go=(t,e,n,a,s=!1)=>{if(getOpenNotebookCount()===0){showMessage(window.siyuan.languages.newFileTip);return}if(!e){const i=ln(s);e=i.notebookId,n=i.currentPath}fetchPost("/api/filetree/getDocCreateSavePath",{notebook:e},i=>{if(i.data.path.indexOf("/")>-1&&s)i.data.path.startsWith("/")||n==="/"?fetchPost("/api/filetree/createDocWithMd",{notebook:e,path:i.data.path,markdown:""},o=>{openMobileFileById(t,o.data,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])}):fetchPost("/api/filetree/getHPathByPath",{notebook:e,path:n.endsWith(".sy")?n:n+".sy"},o=>{fetchPost("/api/filetree/createDocWithMd",{notebook:e,path:pathPosix().join(o.data,i.data.path),markdown:""},l=>{openMobileFileById(t,l.data,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])})});else{let o=i.data.path||"Untitled";if(o=o.substring(o.lastIndexOf("/")+1),!validateName(o))return;const l=Lute.NewNodeID(),r=pathPosix().join(getDisplayName(n,!1,!0),l+".sy");a&&(a[a.indexOf(void 0)]=r),fetchPost("/api/filetree/createDoc",{notebook:e,path:r,title:o,md:"",sorts:a},()=>{openMobileFileById(t,l,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])})}})},mo=(t,e,n)=>{fetchPost("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{a.data.path?a.data.path.startsWith("/")?n(getDisplayName(a.data.path,!1,!0)):fetchPost("/api/filetree/getHPathByPath",{notebook:e,path:t},s=>{n(getDisplayName(pathPosix().join(s.data,a.data.path),!1,!0))}):fetchPost("/api/filetree/getHPathByPath",{notebook:e,path:t},s=>{n(getDisplayName(s.data,!1,!0))})})},po=(t,e)=>{const n=ln(!0);fetchPost("/api/filetree/getHPathByPath",{notebook:n.notebookId,path:n.currentPath},a=>{fetchPost("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:pathPosix().join(a.data,replaceFileName(e.trim())||"Untitled"),markdown:""},s=>{hideElements(["dialog"]),openMobileFileById(t,s.data,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])})})};var pa=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const bo=(t,e)=>{const n=new Dialog({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${t.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="table" type="checkbox"${t.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${t.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${t.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${t.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="document" type="checkbox"${t.types.document?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${t.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="list" type="checkbox"${t.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${t.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${t.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${t.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${t.types.embedBlock?" checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{t.types[s.getAttribute("data-type")]=s.checked}),e(),n.destroy()})},ho=(t,e)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:"SQL",current:t.method===2,click(){t.method=2,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,e()}}).element)},yo=(t,e,n,a,s,i)=>pa(void 0,null,function*(){window.siyuan.menus.menu.remove();const o=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.type,current:t.sort===0,click(){t.sort=0,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.createdASC,current:t.sort===1,click(){t.sort=1,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.createdDESC,current:t.sort===2,click(){t.sort=2,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.modifiedASC,current:t.sort===3,click(){t.sort=3,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.modifiedDESC,current:t.sort===4,click(){t.sort=4,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.sortByRankAsc,current:t.sort===6,click(){t.sort=6,a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.sortByRankDesc,current:t.sort===7,click(){t.sort=7,a()}}];t.group===1&&o.push({iconHTML:Constants.ZWSP,label:window.siyuan.languages.sortByContent,current:t.sort===5,click(){t.sort=5,a()}}),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.noGroupBy,current:t.group===0,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),t.group=0,t.sort===5&&(t.sort=0),a()}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.groupByDoc,current:t.group===1,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),t.group=1,a()}}]}).element),i&&i(),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.saveCriterion,iconHTML:Constants.ZWSP,click(){const l=new Dialog({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),r=l.element.querySelectorAll(".b3-button");l.bindInput(l.element.querySelector("input"),()=>{r[1].dispatchEvent(new CustomEvent("click"))}),r[0].addEventListener("click",()=>{l.destroy()}),r[1].addEventListener("click",()=>{const d=l.element.querySelector("input").value;if(!d){showMessage(window.siyuan.languages._kernel[142]);return}isMobile()?(t.k=document.querySelector("#toolbarSearch").value,t.r=n.querySelector("#toolbarReplace").value):(t.k=n.querySelector("#searchInput").value,t.r=n.querySelector("#replaceInput").value),t.removed=!1;const c=t;c.name=d,e.push(Object.assign({},c)),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},t),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),fetchPost("/api/storage/setCriterion",{criterion:c},()=>{l.destroy();const f=n.querySelector("#criteria");f.classList.remove("fn__none"),f.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][f.childElementCount%7]}">${c.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,label:window.siyuan.languages.removeCriterion,click(){s()}}).element)}),wo=(t,e)=>{fetchPost("/api/storage/getCriteria",{},n=>{let a="";n.data.forEach((s,i)=>{e.push(s),a+=`<div data-type="set-criteria" class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][i%7]}">${escapeHtml(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),t.innerHTML=a,a===""?t.classList.add("fn__none"):t.classList.remove("fn__none")})},_o=t=>{const e=[];return t.querySelectorAll("mark").forEach(n=>{e.push(n.textContent)}),[...new Set(e)].join(" ")},rn=(t,e,n)=>{if(e.method===1||e.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=t.querySelector("#searchList"),s=t.querySelector("#toolbarReplace"),i=s.nextElementSibling;if(!i.classList.contains("fn__none"))return;let o=a.querySelector(".b3-list-item--focus");if(!o)return;i.classList.remove("fn__none"),i.nextElementSibling.classList.add("fn__none"),a.previousElementSibling.innerHTML="";let l=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[o.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:e.method===0?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:s.value,ids:l,types:e.types,method:e.method},r=>{var d;if(i.classList.add("fn__none"),i.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),o.nextElementSibling?o.nextElementSibling.classList.add("b3-list-item--focus"):o.previousElementSibling&&o.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(o.nextElementSibling||o.previousElementSibling)o.remove();else{const c=o.parentElement.nextElementSibling||((d=o.parentElement.previousElementSibling.previousElementSibling)==null?void 0:d.previousElementSibling);c&&(c.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),c.nextElementSibling.classList.remove("fn__none"),c.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),o.parentElement.previousElementSibling.remove(),o.parentElement.remove()}else o.remove();if(o=a.querySelector(".b3-list-item--focus"),!o){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<o.offsetTop-a.clientHeight+30||a.scrollTop>o.offsetTop)&&(a.scrollTop=o.offsetTop-a.clientHeight+30)}})},dn=(t,e,n)=>{n.hasReplace!==e.hasReplace&&(e.hasReplace?(t.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),t.querySelector(".toolbar").classList.remove("fn__none")):(t.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),t.querySelector(".toolbar").classList.add("fn__none")));const a=t.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==e.group&&(e.group===0?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")));let s=!0,i=!1;e.idPath.forEach(l=>{l.endsWith(".sy")&&(s=!1),l.split("/").length>1&&(i=!0)});const o=t.querySelector('[data-type="include"]');s?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),i?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,t.querySelector("#toolbarReplace").value=e.r,Object.assign(n,e),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),we(n,t),window.siyuan.menus.menu.remove()},cn=(t,e,n)=>{const a=document.querySelector("#searchList");let s="";t.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);o.children?(s+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(o.box)||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,o.children.forEach((d,c)=>{s+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${c===0&&l===0?" b3-list-item--focus":""}" data-node-id="${d.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(d.type)}"></use></svg>
${unicode2Emoji(d.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${d.content}</span>
</div>`}),s+="</div>"):s+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta" style="margin-top: -4px">${escapeGreat(r)}</span>
</div>`}),a.innerHTML=s||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let i="";n&&(i=`${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}
<span class="fn__flex-1"></span>
${e.page}/${n.data.pageCount||1}`),a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=i};let un=0;const we=(t,e)=>{clearTimeout(un),un=window.setTimeout(()=>{const n=e.querySelector(".fn__loading--top");n.classList.remove("fn__none");const a=e.querySelector('[data-type="previous"]'),s=e.querySelector('[data-type="next"]'),i=document.getElementById("toolbarSearch");i.value===""&&(!t.idPath||t.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},o=>{cn(o.data,t),n.classList.add("fn__none"),a.setAttribute("disabled","true"),s.setAttribute("disabled","true")}):(t.page||(t.page=1),t.page>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:i.value,method:t.method,types:t.types,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},o=>{cn(o.data.blocks,t,o),n.classList.add("fn__none"),t.page<o.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},ba=(t,e,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",l=>{l&&l.isComposing||(n.page=1,we(n,e))}),a.addEventListener("input",l=>{l&&l.isComposing||(n.page=1,we(n,e))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]))});const s=e.querySelector(".toolbar .b3-text-field");s.value=n.r||"";const i=[];initCriteriaMenu(e.querySelector("#criteria"),i);const o=e.querySelector("#searchList");e.addEventListener("click",l=>{let r=l.target;for(;r&&!r.isSameNode(e);){const d=r.getAttribute("data-type");if(d==="previous"){r.getAttribute("disabled")||(n.page--,we(n,e)),l.stopPropagation(),l.preventDefault();break}else if(d==="next"){r.getAttribute("disabled")||(n.page++,we(n,e)),l.stopPropagation(),l.preventDefault();break}else if(d==="set-criteria"){n.removed=!1,i.find(c=>{if(c.name===r.innerText.trim())return dn(e,c,n),!0}),l.stopPropagation(),l.preventDefault();break}else if(d==="remove-criteria"){const c=r.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:c}),i.find((f,u)=>{if(f.name===c)return i.splice(u,1),!0}),r.parentElement.parentElement.childElementCount===1&&r.parentElement.parentElement.classList.add("fn__none"),r.parentElement.remove(),l.stopPropagation(),l.preventDefault();break}else if(d==="remove-path"){n.idPath=[],n.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),n.page=1,we(n,e);const c=e.querySelector('[data-type="include"]');c.classList.remove("toolbar__icon--active"),c.setAttribute("disabled","disabled"),l.stopPropagation(),l.preventDefault();break}else if(d==="expand"){Array.from(o.children).forEach(c=>{c.classList.contains("b3-list-item")&&(c.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),c.nextElementSibling.classList.remove("fn__none"))}),l.stopPropagation(),l.preventDefault();break}else if(d==="contract"){Array.from(o.children).forEach(c=>{c.classList.contains("b3-list-item")&&(c.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),c.nextElementSibling.classList.add("fn__none"))}),l.stopPropagation(),l.preventDefault();break}else if(d==="path"){movePathTo((c,f)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:c},u=>{n.idPath=[];const g=[];let m=!1;c.forEach((v,h)=>{v==="/"?(n.idPath.push(f[h]),g.push(getNotebookName(f[h]))):(m=!0,n.idPath.push(pathPosix().join(f[h],v.replace(".sy",""))))}),u.data&&g.push(...u.data),n.hPath=g.join(" "),e.querySelector("#searchPath").classList.remove("fn__none"),e.querySelector("#searchPath").innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const b=e.querySelector('[data-type="include"]');b.classList.add("toolbar__icon--active"),m?b.removeAttribute("disabled"):b.setAttribute("disabled","disabled"),n.page=1,we(n,e)})},[],void 0,window.siyuan.languages.specifyPath),l.stopPropagation(),l.preventDefault();break}else if(d==="include"&&!r.hasAttribute("disabled")){r.classList.toggle("toolbar__icon--active"),r.classList.contains("toolbar__icon--active")?n.idPath.forEach((c,f)=>{c.endsWith(".sy")&&(n.idPath[f]=c.replace(".sy",""))}):n.idPath.forEach((c,f)=>{!c.endsWith(".sy")&&c.split("/").length>1&&(n.idPath[f]=c+".sy")}),n.page=1,we(n,e),l.stopPropagation(),l.preventDefault();break}else if(d==="toggle-replace"){n.hasReplace=!n.hasReplace,s.parentElement.classList.toggle("fn__none"),r.classList.toggle("toolbar__icon--active"),l.stopPropagation(),l.preventDefault();break}else if(d==="more"){moreMenu(n,i,e,()=>{n.page=1,we(n,e)},()=>{dn(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock}},n)}),window.siyuan.menus.menu.element.style.zIndex="220",window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();break}else if(d==="filter"){filterMenu(n,()=>{we(n,e)}),l.stopPropagation(),l.preventDefault();break}else if(d==="query"){queryMenu(n,()=>{n.page=1,we(n,e)}),window.siyuan.menus.menu.element.style.zIndex="220",window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();break}else if(d==="replace-all"){rn(e,n,!0),l.stopPropagation(),l.preventDefault();break}else if(d==="replace"){rn(e,n,!1),l.stopPropagation(),l.preventDefault();break}else if(r.classList.contains("b3-list-item__toggle")){r.parentElement.nextElementSibling.classList.toggle("fn__none"),r.firstElementChild.classList.toggle("b3-list-item__arrow--open"),l.stopPropagation(),l.preventDefault();break}else if(r.classList.contains("b3-list-item")){if(r.getAttribute("data-type")==="search-new")newFileByName(t,a.value);else if(r.getAttribute("data-type")==="search-item"){const c=r.getAttribute("data-node-id");window.siyuan.mobile.editor.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),fetchPost("/api/block/checkBlockFold",{id:c},f=>{openMobileFileById(t,c,f.data?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])}),closePanel()}else r.querySelector(".b3-list-item__toggle")&&(r.nextElementSibling.classList.toggle("fn__none"),r.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));l.stopPropagation(),l.preventDefault();break}r=r.parentElement}},!1)},vo=(t,e=window.siyuan.storage[Constants.LOCAL_SEARCHDATA])=>{activeBlur(),hideKeyboardToolbar();let n=!0,a=!1;e.idPath.forEach(s=>{s.endsWith(".sy")&&(n=!1),s.split("/").length>1&&(a=!0)}),openModel({title:`<input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${e.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" style="font-size: 17px" class="b3-text-field fn__flex-1">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);" class="b3-chips"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${e.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(e.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${e.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg data-type="query" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
        <svg data-type="filter" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
        <svg ${a?"":"disabled"} data-type="include" class="toolbar__icon${n?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg data-type="expand" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(s){ba(t,s.firstElementChild,e),we(e,s)}})},Eo=t=>{fetchPost("/api/storage/getRecentDocs",{},e=>{let n="";e.data.forEach((a,s)=>{n+=`<li data-index="${s}" data-node-id="${a.rootID}" class="b3-list-item${s===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",s=>{const i=hasClosestByClassName(s.target,"b3-list-item");i&&openMobileFileById(t,i.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},St=(t,e)=>{if(!t||t.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return t.forEach((a,s)=>{let i="";e&&(i=`data-id2="${e[s].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${i} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${escapeAttr(a.path)} ${a.hSize}">${escapeHtml(a.title)}</span>
</li>`}),n};let je,tt;const ha=(t,e)=>{const n=hasClosestByClassName(e,"history__diff");if(!n)return;const a=n.nextElementSibling.firstElementChild,s=n.nextElementSibling.lastElementChild;je||(je=new Protyle(t,a.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(je.protyle),tt=new Protyle(t,s.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(tt.protyle)),fetchPost("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},o=>{a.classList.remove("fn__none");const l=a.querySelector("textarea"),r=pathPosix().extname(o.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(r)?(l.previousElementSibling.innerHTML=renderAssetsPreview(o.data.content),l.previousElementSibling.classList.remove("fn__none"),l.classList.add("fn__none"),a.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(l.value=o.data.content,l.classList.remove("fn__none"),a.lastElementChild.classList.add("fn__none"),l.previousElementSibling.classList.add("fn__none")):(l.classList.add("fn__none"),a.lastElementChild.classList.remove("fn__none"),l.previousElementSibling.classList.add("fn__none"),onGet({data:o,protyle:je.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),a.querySelector(".history__date").textContent=dayjs(o.data.updated).format("YYYY-MM-DD HH:mm")});const i=e.getAttribute("data-id2");i?(s.classList.remove("fn__none"),fetchPost("/api/repo/openRepoSnapshotDoc",{id:i},o=>{const l=s.querySelector("textarea"),r=pathPosix().extname(o.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(r)?(l.previousElementSibling.innerHTML=renderAssetsPreview(o.data.content),l.previousElementSibling.classList.remove("fn__none"),l.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(l.value=o.data.content,l.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),l.previousElementSibling.classList.add("fn__none")):(l.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),l.previousElementSibling.classList.add("fn__none"),onGet({data:o,protyle:tt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),s.querySelector(".history__date").textContent=dayjs(o.data.updated).format("YYYY-MM-DD HH:mm")})):s.classList.add("fn__none")},ko=(t,e)=>{if(e.length!==2)return;let n,a;e[0].time>e[1].time?(n=e[1].id,a=e[0].id):(n=e[0].id,a=e[1].id);const s=new Dialog({title:window.siyuan.languages.compare,content:"",width:isMobile()?"92vw":"90vw",height:"80vh",destroyCallback(){je=void 0,tt=void 0}});s.element.addEventListener("click",i=>{var o;let l=i.target;for(;l&&l!==s.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(o=s.element.querySelector(".history__diff .b3-list-item--focus"))==null||o.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),ha(t,l),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),Tt(a,n,s,"right")):(l.setAttribute("data-direct","left"),Tt(n,a,s,"left")),i.preventDefault(),i.stopPropagation();break}l=l.parentElement}}),Tt(n,a,s,"left")},Tt=(t,e,n,a)=>{je=void 0,tt=void 0;const s=isMobile();fetchPost("/api/repo/diffRepoSnapshots",{left:t,right:e},i=>{const o=n.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${s?" fn__none":""}">${t.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${s?" fn__none":""}">${e.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${i.data.updatesLeft.length===0?" fn__none":""}">${i.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${St(i.data.updatesLeft,i.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${i.data.addsLeft.length===0?" fn__none":""}">${i.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${St(i.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${i.data.removesRight.length===0?" fn__none":""}">${i.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${St(i.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${dayjs(i.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${dayjs(i.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})};let nt;const at=(t,e)=>{const n=t.querySelector('[data-type="docprevious"]'),a=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const s=t.querySelector(".b3-text-field"),i=t.querySelector('.b3-select[data-type="opselect"]'),o=t.querySelector('.b3-select[data-type="typeselect"]'),l=t.querySelector('.b3-select[data-type="notebookselect"]');window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]=l.value,setStorageVal(Constants.LOCAL_HISTORYNOTEID,window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]);const r=t.querySelector('.history__text[data-type="docPanel"]'),d=t.querySelector('.history__text[data-type="assetPanel"]'),c=t.querySelector('.history__text[data-type="mdPanel"]');r.classList.add("fn__none"),c.classList.add("fn__none"),o.value==="0"||o.value==="1"?(i.removeAttribute("disabled"),l.removeAttribute("disabled"),d.classList.add("fn__none")):(i.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),d.classList.remove("fn__none")),fetchPost("/api/history/searchHistory",{notebook:l.value,query:s.value,page:e,op:i.value,type:parseInt(o.value)},f=>{if(e<f.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),a.nextElementSibling.nextElementSibling.textContent=`${e}/${f.data.pageCount||1}`,f.data.histories.length===0){t.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),t.lastElementChild.lastElementChild.classList.add("fn__none"),t.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let u="";f.data.histories.forEach(g=>{u+=`<li class="b3-list-item" data-type="toggle" data-created="${g}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${dayjs(parseInt(g)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),t.lastElementChild.firstElementChild.innerHTML=u})},fn=(t,e,n)=>{if(t.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let s="";const i=isMobile();t.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${i?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(d=>{l+=`${d.type} ${d.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${i?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${i?" fn__none":""}">
    ${escapeHtml(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;s+=`<li class="b3-list-item" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${o.id}" data-tag="${o.tag}">
        ${a}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),e.lastElementChild.innerHTML=`${s}`},Pe=(t,e)=>{const n=t.querySelector(".b3-select").value;t.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const a=t.querySelector('[data-type="previous"]'),s=t.querySelector('[data-type="next"]'),i=s.nextElementSibling.nextElementSibling;t.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(fetchPost(`/api/repo/${n}`,{},o=>{fn(o,t,n)}),a.classList.add("fn__none"),s.classList.add("fn__none"),i.classList.add("fn__none")):(a.classList.remove("fn__none"),s.classList.remove("fn__none"),i.classList.remove("fn__none"),t.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),s.setAttribute("disabled","disabled"),fetchPost(`/api/repo/${n}`,{page:e},o=>{e<o.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),i.textContent=`${e}/${o.data.pageCount||1}`,fn(o,t,n)}))},ya=t=>{t.setAttribute("data-init","true"),fetchPost("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";e.data.histories.forEach((a,s)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${s===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${s===0?"":"fn__none"}">`,a.items.forEach(i=>{n+=`<li data-type="notebook" data-path="${i.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${escapeHtml(i.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),t.innerHTML=n})},Co=t=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(s=>{if(s.element.querySelector("#historyContainer"))return s.destroy(),!0}))return;let n="";window.siyuan.notebooks.forEach(s=>{s.closed||(n+=` <option value="${s.id}"${s.id===window.siyuan.storage[Constants.LOCAL_HISTORYNOTEID]?" selected":""}>${escapeHtml(s.name)}</option>`)});const a=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: 4px 4px 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${isMobile()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="0" selected>${window.siyuan.languages.docName}</option>
                        <option value="1">${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2">${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${isMobile()?" fn__size96":""}">
                        <option value="all" selected>${window.siyuan.languages.allOp}</option>
                        <option value="clean">clean</option>
                        <option value="update">update</option>
                        <option value="delete">delete</option>
                        <option value="format">format</option>
                        <option value="sync">sync</option>
                        <option value="replace">replace</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(isMobile())openModel({html:a,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(s){gn(t,s.firstElementChild)}});else{const s=new Dialog({content:a,width:"90vw",height:"80vh",destroyCallback(){nt=void 0}});gn(t,s.element,s)}},gn=(t,e,n)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(d=>{d.addEventListener("change",()=>{at(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",d=>{d.isComposing||at(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{at(a,1)});const s=a.querySelector('.history__text[data-type="docPanel"]'),i=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]');at(a,1),nt=new Protyle(t,s,{blockId:"",action:[Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(nt.protyle);const l=e.querySelector('#historyContainer [data-type="repo"]'),r=l.querySelector(".b3-select");r.addEventListener("change",()=>{Pe(l,1);const d=e.querySelector(".b3-button[data-type='compare']");d.setAttribute("disabled","disabled"),d.removeAttribute("data-ids")}),e.addEventListener("click",d=>{var c;let f=d.target;for(;f&&!f.isEqualNode(e);){const u=f.getAttribute("data-type");if(f.classList.contains("item")){f.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(g=>{g.getAttribute("data-type")===u?(g.classList.remove("fn__none"),g.classList.add("fn__block"),f.classList.add("item--focus"),g.getAttribute("data-init")!=="true"&&(u==="notebook"?ya(g):u==="repo"&&Pe(g,1))):(g.classList.add("fn__none"),g.classList.remove("fn__block"))}),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item__action")&&u==="rollback"&&!window.siyuan.config.readonly){confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",f.parentElement.textContent.trim())}`,()=>{const g=f.parentElement.getAttribute("data-type");g==="assets"?fetchPost("/api/history/rollbackAssetsHistory",{historyPath:f.parentElement.getAttribute("data-path")}):g==="doc"?fetchPost("/api/history/rollbackDocHistory",{notebook:a.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:f.parentElement.getAttribute("data-path")}):g==="notebook"?fetchPost("/api/history/rollbackNotebookHistory",{historyPath:f.parentElement.getAttribute("data-path")}):fetchPost("/api/repo/checkoutRepo",{id:f.parentElement.getAttribute("data-id")})}),d.stopPropagation(),d.preventDefault();break}else if(u==="more"){f.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(g=>{g.classList.toggle("fn__none")}),d.stopPropagation(),d.preventDefault();break}else if(u==="toggle"){const g=f.firstElementChild.firstElementChild;if(g.classList.contains("b3-list-item__arrow--open"))f.nextElementSibling.classList.add("fn__none"),g.classList.remove("b3-list-item__arrow--open");else if(f.nextElementSibling&&f.nextElementSibling.tagName==="UL")f.nextElementSibling.classList.remove("fn__none"),g.classList.add("b3-list-item__arrow--open");else{const m=a.querySelector(".b3-text-field"),p=a.querySelector('.b3-select[data-type="opselect"]'),b=a.querySelector('.b3-select[data-type="typeselect"]'),v=a.querySelector('.b3-select[data-type="notebookselect"]');fetchPost("/api/history/getHistoryItems",{notebook:v.value,query:m.value,op:p.value,type:parseInt(b.value),created:f.getAttribute("data-created")},h=>{g.classList.add("b3-list-item__arrow--open");let _="";h.data.items.forEach(C=>{_+=`<li title="${escapeAttr(C.title)}" data-type="${b.value==="2"?"assets":"doc"}" data-path="${C.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 40px">
    <span class="b3-list-item__text">${escapeHtml(C.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),f.insertAdjacentHTML("afterend",`<ul>${_}</ul>`)})}d.stopPropagation(),d.preventDefault();break}else if(u==="rmtoggle"){f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item")&&u==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(r.value)){const g=e.querySelector(".b3-button[data-type='compare']"),m=JSON.parse(g.getAttribute("data-ids")||"[]"),p=f.getAttribute("data-id");if(f.classList.contains("b3-list-item--focus"))f.classList.remove("b3-list-item--focus"),m.forEach((b,v)=>{p===b.id&&m.splice(v,1)});else{for(f.classList.add("b3-list-item--focus");m.length>1;)m[0].id!==p&&((c=f.parentElement.querySelector(`.b3-list-item[data-id="${m.splice(0,1)[0].id}"]`))==null||c.classList.remove("b3-list-item--focus"));m.push({id:p,time:f.querySelector('[data-type="hCreated"]').textContent})}m.length===2?g.removeAttribute("disabled"):g.setAttribute("disabled","disabled"),g.setAttribute("data-ids",JSON.stringify(m)),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item")&&(u==="assets"||u==="doc")){const g=f.getAttribute("data-path");u==="assets"?i.innerHTML=renderAssetsPreview(g):u==="doc"&&fetchPost("/api/history/getDocHistoryContent",{historyPath:g,k:a.querySelector(".b3-text-field").value},p=>{p.data.isLargeDoc?(o.value=p.data.content,o.classList.remove("fn__none"),s.classList.add("fn__none")):(o.classList.add("fn__none"),s.classList.remove("fn__none"),onGet({data:p,protyle:nt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]}))});let m=hasClosestByClassName(f,"b3-list");m&&(m=m.querySelector(".b3-list-item--focus"),m&&m.classList.remove("b3-list-item--focus")),f.classList.add("b3-list-item--focus"),d.stopPropagation(),d.preventDefault();break}else if(u==="genRepo"){const g=new Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),m=g.element.querySelector("textarea");m.focus();const p=g.element.querySelectorAll(".b3-button");g.bindInput(m,()=>{p[1].click()}),p[0].addEventListener("click",()=>{g.destroy()}),p[1].addEventListener("click",()=>{fetchPost("/api/repo/createSnapshot",{memo:m.value},()=>{Pe(l,1)}),g.destroy()}),d.stopPropagation(),d.preventDefault();break}else if(u==="removeRepoTagSnapshot"||u==="removeCloudRepoTagSnapshot"){const g=f.parentElement.getAttribute("data-tag");confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${g}</i>?`,()=>{fetchPost("/api/repo/"+u,{tag:g},()=>{Pe(l,1)})}),d.stopPropagation(),d.preventDefault();break}else if(u==="uploadSnapshot"){fetchPost("/api/repo/uploadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),d.stopPropagation(),d.preventDefault();break}else if(u==="downloadSnapshot"){fetchPost("/api/repo/downloadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),d.stopPropagation(),d.preventDefault();break}else if(u==="genTag"){const g=new Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${dayjs().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:isMobile()?"92vw":"520px"}),m=g.element.querySelector(".b3-text-field");m.select();const p=g.element.querySelectorAll(".b3-button");p[0].addEventListener("click",()=>{g.destroy()}),p[2].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:m.value},()=>{fetchPost("/api/repo/uploadCloudSnapshot",{tag:m.value,id:f.parentElement.getAttribute("data-id")},()=>{Pe(l,1)})}),g.destroy()}),p[1].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:m.value},()=>{Pe(l,1)}),g.destroy()}),d.stopPropagation(),d.preventDefault();break}else if((u==="previous"||u==="next")&&f.getAttribute("disabled")!=="disabled"){const g=parseInt(l.getAttribute("data-page"));Pe(l,u==="previous"?g-1:g+1),d.stopPropagation(),d.preventDefault();break}else if((u==="docprevious"||u==="docnext")&&f.getAttribute("disabled")!=="disabled"){const g=parseInt(a.getAttribute("data-page"));at(a,u==="docprevious"?g-1:g+1),d.stopPropagation(),d.preventDefault();break}else if(u==="rebuildIndex"){fetchPost("/api/history/reindexHistory"),n?n.destroy():(closeModel(),nt=void 0),d.stopPropagation(),d.preventDefault();break}else if(u==="compare"&&!f.getAttribute("disabled")){showDiff(t,JSON.parse(f.getAttribute("data-ids")||"[]")),d.stopPropagation(),d.preventDefault();break}f=f.parentElement}})},Lo=t=>{document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("toolbarEdit").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`
<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.help}</span>
</div>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){popSearch(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){window.siyuan.mobile.editor?newFile(t,window.siyuan.mobile.editor.protyle.notebookId,window.siyuan.mobile.editor.protyle.path,void 0,!0):window.siyuan.notebooks.find(s=>{if(!s.closed)return newFile(t,s.id,"/",void 0,!0),!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},Ao=()=>{document.getElementById("toolbarName").classList.remove("fn__hidden"),document.getElementById("toolbarEdit").classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},xo=(t,e)=>{fetchPost("/api/block/getDocInfo",{id:t},n=>{e.updateTitle(n.data.name)})},So=(t,e)=>{hideMessage(),window.siyuan.mobile.popEditor&&(e.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?hideElements(["dialog"]):(reloadProtyle(window.siyuan.mobile.popEditor.protyle,!1),window.siyuan.mobile.popEditor.protyle.breadcrumb.render(window.siyuan.mobile.popEditor.protyle,!0))),window.siyuan.mobile.editor&&(e.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?setEmpty(t):(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),fetchPost("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},n=>{document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name}))),setNoteBook(()=>{window.siyuan.mobile.files.init(!1)})},To=()=>{window.siyuan.config.readonly||fetchPost("/api/system/logoutAuth",{},()=>{redirectToCheckAuth()})},wa=()=>{var t;if(document.querySelector("#errorLog"))return;let e="";window.siyuan.config.system.container==="ios"&&((t=window.webkit)!=null&&t.messageHandlers)&&(e=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const n=new Fe({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${S.SIYUAN_VERSION}</small>`,width:oe()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${e}
</div>
</div>`});n.element.id="errorLog";const a=n.element.querySelector(".b3-button");a&&a.addEventListener("click",()=>{n.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},_a=()=>{fetchPost("/api/system/exit",{force:!1},t=>{var e;if(t.code===1){const n=showMessage(t.msg,t.data.closeTimeout,"error"),a=document.querySelector(`#message [data-id="${n}"] button`);a&&a.addEventListener("click",()=>{fetchPost("/api/system/exit",{force:!0},()=>{var s;["ios","android"].includes(window.siyuan.config.system.container)&&((s=window.webkit)!=null&&s.messageHandlers||window.JSAndroid)&&(window.location.href="siyuan://api/system/exit")})})}else t.code===2?(hideMessage(),confirmDialog(window.siyuan.languages.tip,t.msg,()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):["ios","android"].includes(window.siyuan.config.system.container)&&((e=window.webkit)!=null&&e.messageHandlers||window.JSAndroid)&&(window.location.href="siyuan://api/system/exit")})},Mo=()=>{if(document.getElementById("transactionError"))return;const t=new Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:isMobile()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{_a()}),e[1].addEventListener("click",()=>{fetchPost("/api/filetree/refreshFiletree",{}),t.destroy()})},Io=t=>{const e=document.querySelector("#status");if(!e)return;if(isMobile()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;e.innerHTML=t.msg,e.classList.remove("status--hide"),e.style.bottom="0";return}const n=e.querySelector(".status__msg");n&&(n.innerHTML=t.msg)},Ho=t=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",'<div id="progress"></div>'),e=document.getElementById("progress")),t.code===2){e.remove();return}t.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="z-index:400;opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:#fff;z-index:400;">
    <div style="text-align: right">${t.data.current}/${t.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: 4px;overflow: hidden;background-color:#fff;"><div style="width: ${t.data.current/t.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${t.msg}</div>
</div>`:t.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=t.msg:e.innerHTML=`<div class="b3-dialog__scrim" style="z-index:400;opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:#fff;z-index:400;">
    <div style="margin: 8px 0;height: 8px;border-radius: 4px;overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${t.msg}</div>
</div>`)},Do=t=>{const e=document.querySelector(".status__backgroundtask");e&&(t.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(t)),e.innerHTML=t[0].action+"<div><div></div></div>"))},Bo=()=>{fetchPost("/api/sync/getBootSync",{},t=>{if(t.code===1){const e=new Dialog({width:isMobile()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${t.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),fetchPost("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),n[1].removeAttribute("disabled")}))})}})},No=t=>{const e=document.getElementById("drag"),n=getWorkspaceName();if(t===window.siyuan.languages.siyuanNote){const a=`${t} - ${n} - v${Constants.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(t=t||"Untitled",document.title=`${t} - ${n} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",t),e.innerHTML=escapeHtml(t)}},$o=t=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||t.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const n=e.querySelector('[data-type="install"]');n&&(t.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${t.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${t.percent*100}%"></span>`))},Po=t=>{const e=document.querySelector("#menuSyncNow use"),n=document.querySelector("#toolbarSync use");if(!t){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&needSubscribe("")?(e==null||e.setAttribute("xlink:href","#iconCloudOff"),n.setAttribute("xlink:href","#iconCloudOff")):(e==null||e.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"));return}e==null||e.parentElement.classList.remove("fn__rotate"),n.parentElement.classList.remove("fn__rotate"),t.code===0?(e==null||e.parentElement.classList.add("fn__rotate"),n.parentElement.classList.add("fn__rotate"),e==null||e.setAttribute("xlink:href","#iconRefresh"),n.setAttribute("xlink:href","#iconRefresh")):t.code===2?(e==null||e.setAttribute("xlink:href","#iconCloudError"),n.setAttribute("xlink:href","#iconCloudError")):t.code===1&&(e==null||e.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"))};var va=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const Ea=(t,e,n,a)=>{const s={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&(window.siyuan.reqIds[t]=new Date().getTime(),e.type==="local"&&t==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[t])),e instanceof FormData?s.body=e:s.body=JSON.stringify(e)),a&&(s.headers=a),fetch(t,s).then(i=>{var o;return i.status===404?{data:null,msg:i.statusText,code:i.status}:((o=i.headers.get("content-type"))==null?void 0:o.indexOf("application/json"))>-1?i.json():i.text()}).then(i=>{if(typeof i=="string"){n&&n(i);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&i.data.reqId&&window.siyuan.reqIds[t]&&window.siyuan.reqIds[t]>i.data.reqId||(typeof i=="object"&&typeof i.msg=="string"&&typeof i.code=="number"?Ze(i)&&n&&n(i):n&&n(i))}).catch(i=>{if(console.warn("fetch post error",i),t==="/api/transactions"&&(i.message==="Failed to fetch"||i.message==="Unexpected end of JSON input")){wa();return}})},Ro=(t,e)=>va(void 0,null,function*(){const n={method:"POST"};e&&(n.body=JSON.stringify(e));const s=yield(yield fetch(t,n)).json();return processMessage(s),s}),Oo=(t,e)=>{fetch(t).then(n=>n.json()).then(n=>{e(n)})},qo=(t,e)=>{const n=[{filter:["\u6A21\u7248","moban","mb","template"],value:Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],value:Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],value:Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5F15\u7528\u5757","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["ai chat"],value:Constants.ZWSP+5,html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI Chat</span></div>'},{filter:["\u6587\u6863","\u5B50\u6587\u6863","wendang","wd","ziwendang","zwd","xjwd"],value:Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-list-item__meta">*&nbsp;</span></div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-list-item__meta">1.&nbsp;</span></div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-list-item__meta">&gt;</span></div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-list-item__meta">\`\`\`Enter</span></div>`},{filter:["\u8868\u683C","biaoge","bg","table"],value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","fengexian","fgx","divider"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],value:Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],value:`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],value:`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],value:`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],value:`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u79FB\u9664\u6837\u5F0F","yichuyangshi","ycys","remove style"],value:`style${Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}];return t===""?n:n.filter(a=>a.filter?!!a.filter.find(i=>{if(i.indexOf(t.toLowerCase())>-1)return!0}):!1)},Fo=(t,e)=>(e.hint.genLoading(e),fetchPost("/api/search/searchTag",{k:t},n=>{const a=[];let s=!1;n.data.tags.forEach(i=>{const o=i.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`#${o}#`,html:i}),o===n.data.k&&(s=!0)}),n.data.k&&!s&&(a.splice(0,0,{value:`#${n.data.k}#`,html:`${window.siyuan.languages.new} <mark>${escapeHtml(n.data.k)}</mark>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0)}),[]),Wo=(t,e,n=!1)=>{const a=hasClosestBlock(getEditorRange(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),fetchPost("/api/search/searchRefBlock",{k:t,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID,isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},s=>{const i=[];if(s.data.newDoc){const o=Lute.UnEscapeHTMLStr(replaceFileName(s.data.k));i.push({value:n?`((newFile "${o}"${Constants.ZWSP}'${o}${Lute.Caret}'))`:`((newFile '${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div>`})}s.data.blocks.forEach(o=>{let l;o.type==="NodeDocument"&&o.ial.icon?(l=unicode2Emoji(o.ial.icon,"b3-list-item__graphic popover__block",!0),l=l.replace('popover__block"',`popover__block" data-id="${o.id}"`)):l=`<svg class="b3-list-item__graphic popover__block" data-id="${o.id}"><use xlink:href="#${getIconByType(o.type)}"></use></svg>`;let r="";o.name&&(r+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${o.name}</span></span><span class="fn__space"></span>`),o.alias&&(r+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${o.alias}</span></span><span class="fn__space"></span>`),o.memo&&(r+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${o.memo}</span></span>`),r&&(r=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${r}</div>`);let d=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText}</span>`;n&&(d=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${t}</span>`),i.push({value:d,html:`${r}<div class="b3-list-item__first">
    ${l}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${o.hPath}</div>`})}),n&&(e.hint.splitChar="((",e.hint.lastIndex=-1),i.length===0?i.push({value:"",html:window.siyuan.languages.emptyContent}):s.data.newDoc&&i.length>1&&(i[1].focus=!0),e.hint.genHTML(i,e,!0,n)}),[]},jo=(t,e)=>{if(t.endsWith("}}")||t.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const n=hasClosestBlock(getEditorRange(e.wysiwyg.element).startContainer);return fetchPost("/api/search/searchRefBlock",{k:t,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const s=[];a.data.blocks.forEach(i=>{let o;i.type==="NodeDocument"&&i.ial.icon?(o=unicode2Emoji(i.ial.icon,"b3-list-item__graphic popover__block",!0),o=o.replace('popover__block"',`popover__block" data-id="${i.id}"`)):o=`<svg class="b3-list-item__graphic popover__block" data-id="${i.id}"><use xlink:href="#${getIconByType(i.type)}"></use></svg>`;let l="";i.name&&(l+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg>${i.name}</span><span class="fn__space"></span>`),i.alias&&(l+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg>${i.alias}</span><span class="fn__space"></span>`),i.memo&&(l+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg>${i.memo}</span>`),l&&(l=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${l}</div>`),s.push({value:`{{select * from blocks where id='${i.id}'}}`,html:`${l}<div class="b3-list-item__first">
    ${o}
    <span class="b3-list-item__text">${i.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${i.hPath}</div>`})}),s.length===0&&s.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(s,e,!0)}),[]},Yo=(t,e,n)=>{fetchPost("/api/template/render",{id:e.block.parentID,path:t},a=>{focusByRange(e.toolbar.range);const s=getContenteditableElement(n);s&&s.textContent.trim()===""?insertHTML(a.data.content,e,!0):insertHTML(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(i=>{i.remove()}),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element),hideElements(["util"],e)})},Uo=(t,e)=>{focusByRange(e.toolbar.range),insertHTML(e.lute.SpinBlockDOM(`<iframe src="/widgets/${t}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),hideElements(["util"],e)},zo=(t,e)=>{focusByRange(e.toolbar.range);const n=pathPosix().extname(t).toLowerCase(),a=t.startsWith("assets/")?getAssetName(t):t;insertHTML(genAssetHTML(n,t,a,t.startsWith("assets/")?a+n:t),e),hideElements(["util"],e)},Go=(t,e,n)=>{if(t==="/")return;const a=getDisplayName(t,!0,!0);if(n.block.rootID===a)return;const s=[];let i;const o=e[0].parentElement;let l;if(e.forEach((r,d)=>{d===e.length-1&&r.parentElement&&(i=getTopAloneElement(r),l=i.nextElementSibling||i.previousElementSibling,i.isSameNode(r)&&(i=void 0)),s.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),i)s.push({action:"delete",id:i.getAttribute("data-node-id")}),i.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)updateListOrder(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||s.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{zoomOut({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!hasClosestByClassName(o,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),d=genEmptyElement(!1,!1,r);s.splice(0,0,{action:"insert",id:r,data:d.outerHTML,parentID:n.block.parentID}),o.innerHTML=d.outerHTML,focusBlock(d)}else l&&focusBlock(l);transaction(n,s)},pe=(t,e,n)=>{e&&(setLastNodeRange(getContenteditableElement(n[n.length-1]),t.toolbar.range),t.toolbar.range.collapse(!0),insertHTML(e,t,!0,!0),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element))},Ko=(t,e)=>{const n=[];t.forEach(s=>{n.push(s.getAttribute("data-node-id"))});const a=[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiCustomAction,click(){const s=new Dialog({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),i=s.element.querySelector("textarea"),o=s.element.querySelectorAll(".b3-button");s.bindInput(i,()=>{o[1].click()}),i.focus(),o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:i.value},l=>{s.destroy(),pe(e,l.data,t)})})}},{iconHTML:Constants.ZWSP,label:`${window.siyuan.languages.aiCustomAction} & ${window.siyuan.languages.save}`,click(){const s=new Dialog({title:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),i=s.element.querySelector("input"),o=s.element.querySelectorAll(".b3-button");s.bindInput(i,()=>{o[1].click()}),i.focus(),o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=s.element.querySelector("textarea").value;window.siyuan.storage[Constants.LOCAL_AI].push({name:i.value,memo:l}),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:l},r=>{s.destroy(),pe(e,r.data,t)}),s.destroy()})}}];window.siyuan.storage[Constants.LOCAL_AI].forEach(s=>{a.push({iconHTML:Constants.ZWSP,action:"iconCloseRound",label:`<div aria-label="${escapeAttr(s.memo)}" data-type="a">${escapeHtml(s.name)}</div>`,bind:i=>{i.addEventListener("click",o=>{hasClosestByClassName(o.target,"b3-menu__action")?window.siyuan.storage[Constants.LOCAL_AI].find((l,r)=>{if(i.querySelector(".b3-menu__label").textContent.trim()===l.name)return window.siyuan.storage[Constants.LOCAL_AI].splice(r,1),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),i.remove(),!0}):(fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:s.memo},l=>{pe(e,l.data,t)}),window.siyuan.menus.menu.remove()),o.preventDefault(),o.stopPropagation()})}})}),window.siyuan.menus.menu.append(new MenuItem({icon:"iconSparkles",label:window.siyuan.languages.ai,type:"submenu",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiContinueWrite,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Continue writing"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate,type:"submenu",submenu:[{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hans,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hans]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hant,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hant]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ja_JP,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ja-JP]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ko_KR,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ko-KR]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_en_US,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [en-US]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_es_ES,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [es-ES]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_fr_FR,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [fr-FR]"},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiTranslate_de_DE,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [de-DE]"},s=>{pe(e,s.data,t)})}}]},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiExtractSummary,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiExtractSummary},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiBrainStorm,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiBrainStorm},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.aiFixGrammarSpell,click(){fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiFixGrammarSpell},s=>{pe(e,s.data,t)})}},{iconHTML:Constants.ZWSP,label:window.siyuan.languages.custom,type:"submenu",submenu:a}]}).element)},Zo=(t,e)=>{const n=new Dialog({title:"AI Chat",content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),a=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()}),a.focus(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{fetchPost("/api/ai/chatGPT",{msg:a.value},i=>{n.destroy();let o="";i.data&&i.data!==""&&(o=`

`+i.data),fillContent(t,`${a.value}${o}`,[e])})})};class Vo{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(e.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const s=n.target;if(s.tagName==="INPUT"){n.stopPropagation();return}const i=hasClosestByMatchTag(s,"BUTTON");if(i&&!i.classList.contains("emojis__item")){i.parentElement.classList.contains("b3-list")?this.fill(decodeURIComponent(i.getAttribute("data-value")),e,!0,isCtrl(n)):(setTimeout(()=>{this.fill(decodeURIComponent(i.getAttribute("data-value")),e)},148),focusByRange(e.toolbar.range)),n.preventDefault(),n.stopPropagation();return}const o=this.element.querySelector(".emojis__panel"),l=hasClosestByClassName(s,"emojis__type");if(l){const d=o.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(d){const c=d.nextElementSibling.getAttribute("data-index");if(c){let f="";window.siyuan.emojis[parseInt(c)].items.forEach(u=>{f+=`<button data-unicode="${u.unicode}" class="emojis__item" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${unicode2Emoji(u.unicode)}</button>`}),d.nextElementSibling.innerHTML=f,d.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:d.offsetTop})}return}const r=hasClosestByClassName(s,"emojis__item");if(r){const d=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3&&((a=c.endContainer.childNodes[c.endOffset-1])==null||a.remove()),addEmoji(d);let f;d.indexOf(".")>-1?f=`:${d.split(".")[0]}: `:f=unicode2Emoji(d)+" ",insertHTML(e.lute.SpinBlockDOM(f),e),this.element.classList.add("fn__none")}else this.fill(d,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const i=hasPreviousSibling(e.toolbar.range.startContainer);if(i&&i.nodeType===3){if(i.wholeText!==i.textContent){let o=i.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{i.textContent=o.textContent+i.textContent,o.remove();break}}e.toolbar.range.setStart(i,i.textContent.length),e.toolbar.range.collapse(!0)}}const n=getSelectionOffset(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,n)||"",s=this.getKey(a,e.options.hint.extend);if(typeof s=="undefined"||this.splitChar!==":"&&hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const i=hasClosestBlock(e.toolbar.range.startContainer);if(i&&i.getAttribute("data-type")==="NodeHeading"){const o=getSelectionOffset(e.toolbar.range.startContainer,i).start;if(i.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),s?this.genEmojiHTML(e,s):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!isMobile()&&this.genHTML(hintSlash(s,e),e);return}e.options.hint.extend.forEach(i=>{i.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(i.hint(s,e),e)},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=getSelectionPosition(e.wysiwyg.element);setPosition(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,n){const a=n.querySelector('input[type="file"]');a&&a.addEventListener("change",s=>{if(s.target.files.length===0)return;const i=getEditorRange(e.wysiwyg.element);this.lastIndex>-1&&i.setStart(i.startContainer,this.lastIndex),i.deleteContents(),uploadFiles(e,s.target.files,s.target),hideElements(["hint","toolbar"],e)})}getHTMLByData(e,n=!1){let a="";return n?(a='<input style="margin: 0 4px 4px 4px" class="b3-text-field"><div style="flex: 1;overflow:auto;">',this.element.style.display="flex",this.element.style.flexDirection="column"):this.element.style.display="",e.forEach((s,i)=>{let o="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(o=" b3-list-item--focus"),s.html==="separator"?a+='<div class="b3-menu__separator"></div>':a+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${o}" data-value="${encodeURIComponent(s.value)}">${s.html}</button>`}),n&&(a=a+"</div>"),a}genHTML(e,n,a=!1,s=!1){var i;if(e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}this.element.innerHTML=this.getHTMLByData(e,s),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(n.element.clientWidth/2,320)+"px";const o=getSelectionPosition(n.wysiwyg.element);if(setPosition(this.element,o.left,o.top+26,30),this.element.scrollTop=0,this.bindUploadEvent(n,this.element),s){const l=this.element.querySelector("input.b3-text-field"),r=((i=this.element.querySelector("mark"))==null?void 0:i.textContent)||"";l.value=r,l.select(),l.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(upDownHint(this.element.lastElementChild,c),c.key==="Enter"?(setTimeout(()=>{this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n)},148),focusByRange(n.toolbar.range),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),focusByRange(n.toolbar.range)))});const d=hasClosestBlock(n.toolbar.range.startContainer);l.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(n,l,d,r))}),l.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(n,l,d,r)})}}genSearchHTML(e,n,a,s){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',fetchPost("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID},i=>{let o="";if(i.data.newDoc){const l=`((newFile "${s}"${Constants.ZWSP}'${i.data.k}${Lute.Caret}'))`;o+=`<button class="b3-list-item b3-list-item--two fn__block${i.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(l)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div></button>`}i.data.blocks.forEach((l,r)=>{let d;l.type==="NodeDocument"&&l.ial.icon?(d=unicode2Emoji(l.ial.icon,"b3-list-item__graphic popover__block",!0),d=d.replace('popover__block"',`popover__block" data-id="${l.id}"`)):d=`<svg class="b3-list-item__graphic popover__block" data-id="${l.id}"><use xlink:href="#${getIconByType(l.type)}"></use></svg>`;let c="";l.name&&(c+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${l.name}</span></span><span class="fn__space"></span>`),l.alias&&(c+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${l.alias}</span></span><span class="fn__space"></span>`),l.memo&&(c+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${l.memo}</span></span>`),c&&(c=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${c}</div>`);const f=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${s}</span>`;o+=`<button class="b3-list-item b3-list-item--two fn__block${r===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(f)}">${c}<div class="b3-list-item__first">
    ${d}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${l.hPath}</div></button>`}),o===""&&(o=`<button class="b3-list-item b3-list-item--two fn__block" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=o})}genEmojiHTML(e,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=filterEmoji(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),lazyLoadEmojiImg(a)):(this.element.innerHTML=`<div class="emojis">
<div class="emojis__panel">${filterEmoji(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    <div data-type="0" class="emojis__type" aria-label="${window.siyuan.languages.recentEmoji}">${unicode2Emoji("2b50")}</div>
    <div data-type="1" class="emojis__type" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f527")}</div>
    <div data-type="2" class="emojis__type" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f60d")}</div>
    <div data-type="3" class="emojis__type" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f433")}</div>
    <div data-type="4" class="emojis__type" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f96a")}</div>
    <div data-type="5" class="emojis__type" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f3a8")}</div>
    <div data-type="6" class="emojis__type" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f3dd")}</div>
    <div data-type="7" class="emojis__type" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f52e")}</div>
    <div data-type="8" class="emojis__type" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("267e")}</div>
    <div data-type="9" class="emojis__type" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${unicode2Emoji("1f6a9")}</div>
</div>
</div>`,lazyLoadEmoji(this.element),lazyLoadEmojiImg(this.element));const s=this.element.querySelector(".emojis__item");if(s){s.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(e.element.clientWidth/2,320)+"px";const i=getSelectionPosition(e.wysiwyg.element);setPosition(this.element,i.left,i.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,n,a=!0,s=!1){var i;hideElements(["hint","toolbar"],n),a&&(n.toolbar.range=getEditorRange(n.wysiwyg.element));const o=n.toolbar.range;let l=hasClosestBlock(n.toolbar.range.startContainer);if(!l)return;this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const d=l.outerHTML,c=Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&c&&o.startContainer.nodeType===3&&o.startContainer.wholeText.indexOf(c)>-1&&o.startContainer.wholeText.indexOf(this.splitChar)>-1){let f=0,u=o.startContainer;for(;u&&f<2;){const g=u.textContent.indexOf(c),m=u.textContent.indexOf(this.splitChar);if(g>-1&&(g<m||m<0)){f=2,o.setEnd(u,g+2);break}const p=u.textContent.indexOf(c.substr(1));if(p>-1&&(f+=1),f===2){o.setEnd(u,p+1);break}u=u.nextSibling}}if(this.lastIndex>-1&&o.setStart(o.startContainer,this.lastIndex),Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){focusByRange(o);const f=e.substring(11,e.length-4).split(`"${Constants.ZWSP}'`),u=f.length===1?f[0]:f[1];getSavePath(n.path,n.notebookId,g=>{fetchPost("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:pathPosix().join(g,u),parentID:n.block.rootID,markdown:""},m=>{n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${m.data}${Constants.ZWSP}${f.length===2||s?"s":"d"}${Constants.ZWSP}${(f.length===2?f[0]:u).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const u=getContenteditableElement(l);u.textContent===""&&(u.innerHTML="<wbr>",focusByWbr(u,o));return}let f=document.createElement("div");if(f.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),f=f.firstElementChild,s){const u=o.toString().replace(this.splitChar,"");u&&(f.setAttribute("data-subtype","s"),f.innerText=u)}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${f.getAttribute("data-id")}${Constants.ZWSP}${f.getAttribute("data-subtype")}${Constants.ZWSP}${f.textContent}`});return}else if(this.splitChar===":"){addEmoji(e);let f;e.indexOf(".")>-1?f=`:${e.split(".")[0]}: `:f=unicode2Emoji(e)+" ",insertHTML(n.lute.SpinBlockDOM(f),n)}else if(["\u300C\u300C","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const f=getContenteditableElement(l);f.textContent===""&&(f.innerHTML="<wbr>",focusByWbr(f,o));return}insertHTML(n.lute.SpinBlockDOM(e),n,!1,isMobile()),blockRender(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?hintRef("",n):hintEmbed("",n),this.splitChar=e,this.lastIndex=0,o.deleteContents();const f=document.createTextNode(e);o.insertNode(f),o.setEnd(f,e.length),o.collapse(!1);return}else if(e===Constants.ZWSP){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showTpl(n,l,o),updateTransaction(n,r,l.outerHTML,d);return}else if(e===Constants.ZWSP+1){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showWidget(n,l,o),updateTransaction(n,r,l.outerHTML,d);return}else if(e===Constants.ZWSP+2){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showAssets(n,l,o),updateTransaction(n,r,l.outerHTML,d);return}else if(e===Constants.ZWSP+3){o.deleteContents();return}else if(e===Constants.ZWSP+4){const f=Lute.NewNodeID();fetchPost("/api/filetree/createDoc",{notebook:n.notebookId,path:pathPosix().join(getDisplayName(n.path,!1,!0),f+".sy"),title:"Untitled",md:""},()=>{insertHTML(`<span data-type="block-ref" data-id="${f}" data-subtype="d">Untitled</span>`,n),openMobileFileById(n.app,f,[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT])});return}else if(e===Constants.ZWSP+5){o.deleteContents(),AIChat(n,l);return}else if(Constants.INLINE_TYPE.includes(e)){if(o.deleteContents(),focusByRange(o),["a","block-ref","inline-math","inline-memo","text"].includes(e)){n.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,e,"range");return}else if(e==="emoji"){o.deleteContents(),o.insertNode(document.createTextNode(":")),o.collapse(!1),this.genEmojiHTML(n);return}else if(e.indexOf("style")>-1){o.deleteContents(),this.fixImageCursor(o),l.setAttribute("style",e.split(Constants.ZWSP)[1]||""),updateTransaction(n,r,l.outerHTML,d);return}else{o.deleteContents(),e!=="![]()"&&this.fixImageCursor(o);let f=e;e==="```"&&(f=e+window.siyuan.storage[Constants.LOCAL_CODELANG]+Lute.Caret+"\n```");const u=getContenteditableElement(l);if(e==="![]()"){let g="";o.insertNode(document.createElement("wbr")),o.insertNode(document.createTextNode(e)),g=n.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=g,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),focusByWbr(l,o),updateTransaction(n,r,l.outerHTML,d);let m=o.startContainer.childNodes[o.startOffset-1]||o.startContainer;m&&m.nodeType!==3&&m.classList.contains("img")||(((i=m.previousSibling)==null?void 0:i.nodeType)!==3&&m.previousSibling.classList.contains("img")?m=m.previousSibling:Array.from(l.querySelectorAll(".img")).find(b=>{if(b.querySelector("img").getAttribute("data-src")==="")return m=b,!0}));const p=m.getBoundingClientRect();imgMenu(n,o,m,{clientX:p.left,clientY:p.top});return}else if(u.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let g="";e==="<div>"?g=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block"><div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div><div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(u.textContent=f,g=n.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=g,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(m=>{m.style.minWidth="60px"}),g=l.outerHTML),updateTransaction(n,r,g,d)}else{let g=n.lute.SpinBlockDOM(f);e==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block"><div class="protyle-icons"><span class="protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span><span class="protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span></div><div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),l.insertAdjacentHTML("afterend",g);const m=l.outerHTML,p=g.substr(g.indexOf('data-node-id="')+14,22);l=n.wysiwyg.element.querySelector(`[data-node-id="${p}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(b=>{b.style.minWidth="60px"}),transaction(n,[{data:m,id:r,action:"update"},{data:l.outerHTML,id:p,previousID:r,action:"insert"}],[{id:p,action:"delete"},{data:d,id:r,action:"update"}])}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&e.length>3)n.toolbar.showRender(n,l),processRender(l);else if(e.startsWith("```"))highlightRender(l);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){n.gutter.renderMenu(n,l);const g=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top},!0);const m=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');m.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(m.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelectorAll("input")[0].focus()}else e==="---"?focusBlock(l):l.classList.contains("av")?avRender(l):focusByWbr(l,o)}}select(e,n){var a,s,i;const o=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!o)return!1;if(e.key==="Enter"){if(o){const l=this.element.querySelector(".emojis__item--current");if(!l)return!1;const r=l.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const d=getSelection().getRangeAt(0);d.endContainer.nodeType!==3&&((a=d.endContainer.childNodes[d.endOffset-1])==null||a.remove()),addEmoji(r);let c;r.indexOf(".")>-1?c=`:${r.split(".")[0]}: `:c=unicode2Emoji(r)+" ",insertHTML(n.lute.SpinBlockDOM(c),n),this.element.classList.add("fn__none")}else this.fill(r,n)}else{const l=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));l===Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(l,n,!0,isCtrl(e))}return e.preventDefault(),e.stopPropagation(),!0}if(o){const l=this.element.querySelector(".emojis__item--current");if(!l)return!1;let r;if(e.key==="ArrowLeft"||e.key==="ArrowUp"?l.previousElementSibling?(l.classList.remove("emojis__item--current"),r=l.previousElementSibling):(s=l.parentElement.previousElementSibling)!=null&&s.previousElementSibling&&(l.classList.remove("emojis__item--current"),r=l.parentElement.previousElementSibling.previousElementSibling.lastElementChild):(e.key==="ArrowRight"||e.key==="ArrowDown")&&(l.nextElementSibling?(l.classList.remove("emojis__item--current"),r=l.nextElementSibling):(i=l.parentElement.nextElementSibling)!=null&&i.nextElementSibling&&(l.classList.remove("emojis__item--current"),r=l.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),r){r.classList.add("emojis__item--current");const d=4,c=this.element.querySelector(".emojis__panel");r.offsetTop-d<c.scrollTop?c.scrollTop=r.offsetTop-d:r.offsetTop-d-c.clientHeight+r.clientHeight>c.scrollTop&&(c.scrollTop=r.offsetTop-d-c.clientHeight+r.clientHeight)}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return upDownHint(this.element,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(hideElements(["hint"],n),e.preventDefault(),e.stopPropagation(),!0):!1}fixImageCursor(e){const n=hasPreviousSibling(e.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(hasNextSibling(n)||(e.insertNode(document.createTextNode(Constants.ZWSP)),e.collapse(!1)))}getKey(e,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(i=>{const o=e.lastIndexOf(i.key);this.lastIndex<o&&(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(i.key===":"||i.key==="#"||i.key==="/"||i.key==="\u3001")||this.splitChar==="#"&&(i.key==="/"||i.key==="\u3001")||(this.splitChar=i.key,this.lastIndex=o))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const a=e.split(this.splitChar),s=a[a.length-1];if(a.length>1&&s.trim()===s&&s.length<Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":s}}const Xo=(t,e)=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{fetchPost("/api/asset/getDocImageAssets",{id:e},n=>{const a=document.createElement("ul");let s="",i=-1;n.data.forEach((o,l)=>{o&&(s+=`<li><img src="${o}"></li>`,i===-1&&(t.endsWith(encodeURI(o))||t.endsWith(o))&&(i=l))}),a.innerHTML=s,window.siyuan.viewer=new Viewer(a,{title:[1,(o,l)=>{let r=o.alt;return r||(r=o.src.substring(o.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:i,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},Qo=(t,e)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let s=document.querySelector(".protyle-speech");if(!s){s=document.createElement("div"),s.className="protyle-speech",document.body.insertAdjacentElement("beforeend",s);const i=()=>{const l=speechSynthesis.getVoices();let r,d;return l.forEach(c=>{c.lang===e.replace("_","-")&&(r=c),c.default&&(d=c)}),r||(r=d),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=i);const o=i();s.onclick=()=>{if(s.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(s.getAttribute("data-text"));l.voice=o,l.onend=()=>{s.className="protyle-speech",speechSynthesis.cancel(),s.innerHTML=n},speechSynthesis.speak(l),s.className="protyle-speech protyle-speech--current",s.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),s.innerHTML=a):(speechSynthesis.pause(),s.innerHTML=n));focusByRange(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&s.style.display==="block"&&(s.className="protyle-speech",speechSynthesis.cancel(),s.style.display="none")})}t.addEventListener("mouseup",i=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){s.style.display==="block"&&(s.className="protyle-speech",s.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();s.innerHTML=n,s.style.display="block",s.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",s.style.left=i.screenX+2+"px",s.setAttribute("data-text",o)})};class Jo{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",e.options.classes.preview&&n.classList.add(e.options.classes.preview),n.style.padding=e.wysiwyg.element.style.padding,n.addEventListener("click",o=>{if(o.target.tagName==="A"){const l=o.target.getAttribute("href");if(l.startsWith("#")){n.querySelector(l).scrollIntoView(),o.stopPropagation(),o.preventDefault();return}if(isMobile()){openByMobile(l),o.stopPropagation(),o.preventDefault();return}o.stopPropagation(),o.preventDefault(),isLocalPath(l)||window.open(l);return}o.target.tagName==="IMG"&&previewImage(o.target.src,e.block.rootID)});const a=e.options.preview.actions,s=document.createElement("div");s.className="protyle-preview__action";const i=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){i.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":i.push('<button type="button" class="protyle-preview__action--current" data-type="desktop">Desktop</button>');break;case"tablet":i.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":i.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":i.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u516C\u4F17\u53F7"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":i.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u77E5\u4E4E"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":i.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u8BED\u96C0"><svg><use xlink:href="#iconYuque"></use></svg></button>');break}}s.innerHTML=i.join(""),this.element.appendChild(s),this.element.appendChild(n),s.addEventListener(getEventName(),o=>{const l=hasClosestByTag(o.target,"BUTTON");if(!l)return;const r=l.getAttribute("data-type"),d=a.find(c=>(c==null?void 0:c.key)===r);if(d){d.click(r);return}if(r==="mp-wechat"||r==="zhihu"||r==="yuque"){this.copyToX(this.element.lastElementChild.cloneNode(!0),e,r);return}r==="desktop"?(n.style.width="",n.style.padding=e.wysiwyg.element.style.padding):r==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),this.render(e),s.querySelectorAll("button").forEach(c=>{c.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current")}),this.previewElement=n}render(e){this.element.style.display!=="none"&&(this.mdTimeoutId=window.setTimeout(()=>{fetchPost("/api/export/preview",{id:e.block.parentID||e.options.blockId},n=>{e.preview.previewElement.innerHTML=n.data.html,processRender(e.preview.previewElement),highlightRender(e.preview.previewElement),avRender(e.preview.previewElement),speechRender(e.preview.previewElement,e.options.lang)})},e.options.preview.delay))}link2online(e){needSubscribe("")||e.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const s=Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",s):n.setAttribute("src",s)}})}copyToX(e,n,a){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}\\" style="display: block; margin: 0 auto; max-width: 100%;">`}),e.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(e);else if(a==="yuque"){fetchPost("/api/lute/copyStdMarkdown",{id:n.block.rootID},o=>{writeText(o.data),showMessage("\u5DF2\u590D\u5236\uFF0C\u53EF\u5230\u8BED\u96C0\u8FDB\u884C\u7C98\u8D34")});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(e);const s=getSelection().getRangeAt(0).cloneRange(),i=e.ownerDocument.createRange();i.selectNodeContents(e),focusByRange(i),document.execCommand("copy"),this.element.lastElementChild.remove(),focusByRange(s),a&&showMessage(`\u5DF2\u590D\u5236\uFF0C\u53EF\u5230${a==="zhihu"?"\u77E5\u4E4E":"\u5FAE\u4FE1\u516C\u4F17\u53F7\u5E73\u53F0"}\u8FDB\u884C\u7C98\u8D34`)}processZHBlockquote(e,n){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const s=n[n.length-1];(!s||s&&s.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const s=n.querySelector("tbody");s?s.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}class el{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:Constants.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:hintRef},{key:"\u3010\u3010",hint:hintRef},{key:"\uFF08\uFF08",hint:hintRef},{key:"[[",hint:hintRef},{key:"{{",hint:hintEmbed},{key:"\u300C\u300C",hint:hintEmbed},{key:"#",hint:hintTag},{key:"/",hint:hintSlash},{key:"\u3001",hint:hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:1e3,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:isMobile()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){var e;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(e=this.options.hint)!=null&&e.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),merge(this.defaultOptions,this.options)}mergeToolbar(e){const n=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearFontStyle",hotkey:window.siyuan.config.keymap.editor.insert.clearFontStyle.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(s=>{let i=s;n.find(o=>{if(typeof s=="string"&&o.name===s)return i=o,!0;if(typeof s=="object"&&o.name===s.name)return i=Object.assign({},o,s),!0}),a.push(i)}),a}}class tl{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),isMobile()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="b3-tooltips b3-tooltips__w protyle-scroll__up" aria-label="${updateHotkeyTip("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar b3-tooltips b3-tooltips__s" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="b3-tooltips b3-tooltips__w protyle-scroll__down" aria-label="${updateHotkeyTip("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)}),this.inputElement.addEventListener("change",()=>{this.setIndex(e)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(e)}),this.parentElement.addEventListener("click",n=>{const a=n.target;hasClosestByClassName(a,"protyle-scroll__up")?goHome(e):hasClosestByClassName(a,"protyle-scroll__down")?goEnd(e):a.classList.contains("b3-slider")&&this.setIndex(e)})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:e,action:[Constants.CB_GET_FOCUSFIRST,Constants.CB_GET_UNCHANGEID]})}))}updateIndex(e,n){fetchPost("/api/block/getBlockIndex",{id:n},a=>{if(!a.data)return;const s=e.scroll.element.querySelector(".b3-slider");s.value=a.data,e.scroll.element.setAttribute("aria-label",`Blocks ${a.data}/${e.block.blockCount}`)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class nl{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${Constants.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(reloadSync(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(i=>{if(i.element.id==="errorLog")return i.destroy(),!0}))},a.onmessage=s=>{if(e.msgCallback){const i=processMessage(JSON.parse(s.data));e.msgCallback.call(this,i)}},a.onclose=s=>{0<=s.reason.indexOf("unauthenticated")||0>s.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",s),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=s=>{s.target.url.endsWith("&type=main")&&s.target.readyState===3&&kernelError()},this.ws=a}send(e,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:n})))}}var ct=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const mn=(t,e,n,a,s,i,o)=>{let l;const r=n.getAttribute("data-node-id"),d=a.getAttribute("data-node-id"),c=[],f=[];return n.insertAdjacentElement(i?"afterend":"beforebegin",a),i?c.push({action:"insert",data:a.outerHTML,id:d,previousID:r}):c.push({action:"insert",data:a.outerHTML,id:d,nextID:r}),e.reverse().forEach((u,g)=>{var m;const p=u.getAttribute("data-node-id");g===e.length-1&&(l=getTopAloneElement(u),l.isSameNode(u)&&(l=void 0));const b=Lute.NewNodeID();if(o?f.push({action:"delete",id:b}):f.push({action:"move",id:p,previousID:(m=u.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||t.block.rootID}),!s&&!o){const v=t.wysiwyg.element.querySelector(`[data-node-id="${p}"]`);v&&v.remove()}if(o){const v=u.cloneNode(!0);v.setAttribute("data-node-id",b),v.querySelectorAll("[data-node-id]").forEach(h=>{const _=Lute.NewNodeID();h.setAttribute("data-node-id",_),h.setAttribute("updated",_.split("-")[0])}),a.insertAdjacentElement("afterbegin",v),c.push({action:"insert",id:b,data:v.outerHTML,parentID:d})}else a.insertAdjacentElement("afterbegin",u),c.push({action:"move",id:p,parentID:d})}),f.reverse(),a.getAttribute("data-subtype")==="o"&&(f.splice(0,0,{action:"update",id:d,data:a.outerHTML}),updateListOrder(a,1),c.push({action:"update",id:d,data:a.outerHTML})),f.push({action:"delete",id:d}),{doOperations:c,undoOperations:f,topSourceElement:l}},pn=(t,e,n,a,s,i)=>ct(void 0,null,function*(){let o;const l=[],r=[],d=[],c=n.getAttribute("data-node-id");let f=n;e.reverse().forEach((u,g)=>{var m,p,b,v,h;const _=u.getAttribute("data-node-id"),C=u.parentElement.getAttribute("data-node-id")||t.block.rootID;g===e.length-1&&(o=getTopAloneElement(u),o.isSameNode(u)?o=void 0:o.contains(u)&&o.contains(n)&&(o=n)),i&&u.getAttribute("data-type")==="NodeHeading"&&u.getAttribute("fold")==="1"&&(u.removeAttribute("fold"),d.push({id:_,parentID:C}));let k,E;if(i?(k=Lute.NewNodeID(),r.push({action:"delete",id:k})):r.push({action:"move",id:_,previousID:(m=u.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:C}),!a&&!i){const L=t.wysiwyg.element.querySelector(`[data-node-id="${_}"]`);L&&L.remove()}i?(E=u.cloneNode(!0),E.setAttribute("data-node-id",k),E.querySelectorAll("[data-node-id]").forEach(L=>{const w=Lute.NewNodeID();L.setAttribute("data-node-id",w),L.setAttribute("updated",w.split("-")[0])}),f.insertAdjacentElement(s,E),l.push({action:"insert",id:k,data:E.outerHTML,previousID:s==="afterend"?c:(p=E.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:((b=E.parentElement)==null?void 0:b.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID})):(f.insertAdjacentElement(s,u),l.push({action:"move",id:_,previousID:s==="afterend"?c:(v=u.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"),parentID:((h=u.parentElement)==null?void 0:h.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID})),s!=="afterend"&&(f=i?E:u)}),r.reverse();for(let u=0;u<d.length;u++){const g=d[u];(yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(p=>{r.push({action:"move",id:p,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),l.push({action:"unfoldHeading",id:g.id})}return{doOperations:l,undoOperations:r,topSourceElement:o}}),bn=(t,e,n,a,s,i)=>ct(void 0,null,function*(){var o,l,r,d,c,f;const u=t.element.contains(e[0]);let g;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(g=document.createElement("div"),g.setAttribute("data-node-id",Lute.NewNodeID()),g.setAttribute("data-type","NodeList"),g.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),g.className="list",g.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));const m=[{action:"move",id:n.getAttribute("data-node-id"),previousID:(o=n.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:((l=n.parentElement)==null?void 0:l.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}];let p,b=e[0].parentElement;const v=genSBElement(s);n.parentElement.replaceChild(v,n);const h=[{action:"insert",data:v.outerHTML,id:v.getAttribute("data-node-id"),nextID:(r=v.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(d=v.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:v.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];if(g){const _=g.getAttribute("data-node-id");v.insertAdjacentElement("afterbegin",n),h.push({action:"move",id:n.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",g),h.push({action:"insert",data:g.outerHTML,id:_,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",g),h.push({action:"insert",data:g.outerHTML,id:_,nextID:n.getAttribute("data-node-id")})),e.reverse().forEach((C,k)=>{var E;k===e.length-1&&(p=getTopAloneElement(C),p.isSameNode(C)&&(p=void 0));const L=Lute.NewNodeID();if(i?m.push({action:"delete",id:L}):m.push({action:"move",id:C.getAttribute("data-node-id"),previousID:(E=C.previousElementSibling)==null?void 0:E.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")||t.block.rootID}),!u&&!i){const w=t.wysiwyg.element.querySelector(`[data-node-id="${C.getAttribute("data-node-id")}"]`);w&&w.remove()}if(i){const w=C.cloneNode(!0);w.setAttribute("data-node-id",L),w.querySelectorAll("[data-node-id]").forEach(y=>{const A=Lute.NewNodeID();y.setAttribute("data-node-id",A),y.setAttribute("updated",A.split("-")[0])}),g.insertAdjacentElement("afterbegin",w),h.push({action:"insert",id:L,data:w.outerHTML,parentID:_})}else g.insertAdjacentElement("afterbegin",C),h.push({action:"move",id:C.getAttribute("data-node-id"),parentID:_})}),m.reverse(),m.push({action:"delete",id:_})}else{const _=[];let C;e.reverse().forEach((k,E)=>{var L;const w=k.getAttribute("data-node-id"),y=k.parentElement.getAttribute("data-node-id")||t.block.rootID;E===e.length-1&&(p=getTopAloneElement(k),p.isSameNode(k)&&(p=void 0));const A=Lute.NewNodeID();if(E===0&&(C=i?A:w),i&&k.getAttribute("data-type")==="NodeHeading"&&k.getAttribute("fold")==="1"&&(k.removeAttribute("fold"),_.push({id:w,parentID:y})),i?m.push({action:"delete",id:A}):m.push({action:"move",id:w,previousID:(L=k.previousElementSibling)==null?void 0:L.getAttribute("data-node-id"),parentID:y}),!u&&!i){const M=t.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);M&&M.remove()}if(i){const M=k.cloneNode(!0);M.setAttribute("data-node-id",A),M.querySelectorAll("[data-node-id]").forEach(x=>{const B=Lute.NewNodeID();x.setAttribute("data-node-id",B),x.setAttribute("updated",B.split("-")[0])}),v.insertAdjacentElement("afterbegin",M),h.push({action:"insert",id:A,data:M.outerHTML,parentID:v.getAttribute("data-node-id")})}else v.insertAdjacentElement("afterbegin",k),h.push({action:"move",id:w,parentID:v.getAttribute("data-node-id")})}),m.reverse();for(let k=0;k<_.length;k++){const E=_[k],L=yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:E.id});L.data.reverse().forEach(w=>{m.push({action:"move",id:w,previousID:E.id,parentID:E.parentID})}),k===0&&(C=L.data[0]),m.push({action:"foldHeading",id:E.id,data:"remove"}),h.push({action:"unfoldHeading",id:E.id})}a?(v.insertAdjacentElement("afterbegin",n),h.push({action:"move",id:n.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")})):(v.lastElementChild.insertAdjacentElement("beforebegin",n),h.push({action:"move",id:n.getAttribute("data-node-id"),previousID:C}))}if(m.push({action:"delete",id:v.getAttribute("data-node-id")}),!i&&b&&b.classList.contains("list")&&b.getAttribute("data-subtype")==="o"&&!b.isSameNode(e[0].parentElement)&&b.childElementCount>1&&(Array.from(b.children).forEach(_=>{_.classList.contains("protyle-attr")||m.splice(0,0,{action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML})}),updateListOrder(b,1),Array.from(b.children).forEach(_=>{_.classList.contains("protyle-attr")||h.push({action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML})})),!i&&p){if(h.push({action:"delete",id:p.getAttribute("data-node-id")}),m.splice(0,0,{action:"insert",data:p.outerHTML,id:p.getAttribute("data-node-id"),previousID:(c=p.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:((f=p.parentElement)==null?void 0:f.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),!u){const _=t.wysiwyg.element.querySelector(`[data-node-id="${p.getAttribute("data-node-id")}"]`);_&&_.remove()}b=p.parentElement,p.remove()}if(!i&&b&&b.classList.contains("sb")&&b.childElementCount===2){const _=cancelSB(t,b);h.push(_.doOperations[0],_.doOperations[1]),m.splice(0,0,_.undoOperations[0],_.undoOperations[1])}else!i&&b&&b.classList.contains("protyle-wysiwyg")&&b.innerHTML;u||i?transaction(t,h,m):transaction(t,h),focusBlock(e[0])}),hn=(t,e,n,a,s)=>ct(void 0,null,function*(){var i,o;const l=t.element.contains(e[0]),r=[],d=[];let c;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(c=document.createElement("div"),c.setAttribute("data-node-id",Lute.NewNodeID()),c.setAttribute("data-type","NodeList"),c.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),c.className="list",c.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));let f,u=e[0].parentElement;if(a)if(c){const g=mn(t,e,n,c,l,a,s);r.push(...g.doOperations),d.push(...g.undoOperations),f=g.topSourceElement}else{const g=yield pn(t,e,n,l,"afterend",s);r.push(...g.doOperations),d.push(...g.undoOperations),f=g.topSourceElement}else if(c){const g=mn(t,e,n,c,l,a,s);r.push(...g.doOperations),d.push(...g.undoOperations),f=g.topSourceElement}else{const g=yield pn(t,e,n,l,"beforebegin",s);r.push(...g.doOperations),d.push(...g.undoOperations),f=g.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||d.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})}),updateListOrder(n.parentElement,1),Array.from(n.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!s&&u&&u.classList.contains("list")&&u.getAttribute("data-subtype")==="o"&&!u.isSameNode(e[0].parentElement)&&u.childElementCount>1&&(Array.from(u.children).forEach(g=>{g.classList.contains("protyle-attr")||(u.contains(n)?d.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}):d.splice(n.parentElement.childElementCount-1,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}))}),updateListOrder(u,1),Array.from(u.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!s&&f&&(r.push({action:"delete",id:f.getAttribute("data-node-id")}),d.splice(0,0,{action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),previousID:(i=f.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:((o=f.parentElement)==null?void 0:o.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),u=f.parentElement,f.remove(),!l)){const g=t.wysiwyg.element.querySelector(`[data-node-id="${f.getAttribute("data-node-id")}"]`);g&&g.remove()}if(!s&&u&&u.classList.contains("sb")&&u.childElementCount===2){const g=cancelSB(t,u);r.push(g.doOperations[0],g.doOperations[1]),d.splice(0,0,g.undoOperations[0],g.undoOperations[1])}else!s&&u&&u.classList.contains("protyle-wysiwyg")&&u.childElementCount;l||s?transaction(t,r,d):transaction(t,r),focusBlock(e[0])}),al=(t,e)=>{e.addEventListener("dragstart",s=>{const i=s.target;if(i.tagName==="IMG"){window.siyuan.dragElement=void 0,s.preventDefault();return}if(i.classList&&i.classList.contains("protyle-action")){hasClosestByClassName(i,"protyle-wysiwyg__embed")?(window.siyuan.dragElement=void 0,s.preventDefault()):(window.siyuan.dragElement=t.wysiwyg.element,s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeListItem${Constants.ZWSP}${i.parentElement.getAttribute("data-subtype")}${Constants.ZWSP}${[i.parentElement.getAttribute("data-node-id")]}`,t.wysiwyg.element.innerHTML));return}s.dataTransfer.setData(Constants.SIYUAN_DROP_EDITOR,Constants.SIYUAN_DROP_EDITOR),t.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),e.addEventListener("drop",s=>ct(void 0,null,function*(){var i,o;if(t.disabled||s.dataTransfer.getData(Constants.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation();return}const l=hasClosestByClassName(s.target,"av__row")||hasClosestBlock(s.target);let r="";for(const d of s.dataTransfer.items)d.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(r=d.type);if(r){const d=[],f=r.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP)[2].split(",");if(s.altKey){focusByRange(getRangeByPoint(s.clientX,s.clientY));let u="";for(let g=0;g<f.length;g++){const m=yield fetchSyncPost("/api/block/getRefText",{id:f[g]});u+=`((${f[g]} '${m.data}')) `}insertHTML(u,t)}else if(s.shiftKey){focusByRange(getRangeByPoint(s.clientX,s.clientY));let u="";f.forEach(g=>{u+=`{{select * from blocks where id='${g}'}}
`}),insertHTML(t.lute.SpinBlockDOM(u),t,!0),blockRender(t,t.wysiwyg.element)}else if(l){let u="";if(f.forEach(p=>{u+=`[data-node-id="${p}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(u.substring(0,u.length-1)).forEach(p=>{(p.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(p,"data-type","NodeBlockQueryEmbed"))&&d.push(p)});else{const p=document.createElement("template");p.innerHTML=`<div>${s.dataTransfer.getData(r)}</div>`,p.content.querySelectorAll(u.substring(0,u.length-1)).forEach(b=>{(b.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(b,"data-type","NodeBlockQueryEmbed"))&&d.push(b)})}const g=[];d.forEach(p=>{p.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),p.removeAttribute("select-start"),p.removeAttribute("select-end"),p.querySelectorAll('[data-type="search-mark"]').forEach(b=>{b.outerHTML=b.innerHTML}),g.push(p.getAttribute("data-node-id"))}),hideElements(["gutter"],t);const m=l.className.split(" ");if(l.classList.contains("av__row")){const p=hasClosestBlock(l);if(p){let b="";l.classList.contains("dragover__bottom")?b=l.getAttribute("data-id")||"":b=((i=l.previousElementSibling)==null?void 0:i.getAttribute("data-id"))||"",transaction(t,[{action:"insertAttrViewBlock",id:p.getAttribute("data-node-id"),parentID:p.getAttribute("data-av-id"),previousID:b,srcIDs:g}],[{action:"removeAttrViewBlock",id:l.getAttribute("data-node-id"),parentID:l.getAttribute("data-av-id")}])}return}l.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select"),l.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&l.parentElement.getAttribute("data-sb-layout")==="col"?m.includes("dragover__left")||m.includes("dragover__right")?hn(t,d,l,m.includes("dragover__right"),s.ctrlKey):bn(t,d,l,m.includes("dragover__bottom"),"row",s.ctrlKey):m.includes("dragover__left")||m.includes("dragover__right")?bn(t,d,l,m.includes("dragover__right"),"col",s.ctrlKey):hn(t,d,l,m.includes("dragover__bottom"),s.ctrlKey),d.forEach(p=>{p.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(p.removeAttribute("data-render"),blockRender(t,p))}),l.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(l.removeAttribute("data-render"),blockRender(t,l))}}else if(((o=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE))==null?void 0:o.split("-").length)>1&&l&&!t.options.backlinkData){const d=t.contentElement.scrollTop,c=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE).split(",");for(let f=0;f<c.length;f++)c[f]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:c[f],after:l.classList.contains("dragover__bottom"),targetID:l.getAttribute("data-node-id")}));fetchPost("/api/filetree/getDoc",{id:t.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},f=>{onGet({data:f,protyle:t}),setTimeout(()=>{t.contentElement.scrollTop=d,t.scroll.lastScrollTop=d-1},Constants.TIMEOUT_LOAD)}),l.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&(s.dataTransfer.types[0]==="Files"||s.dataTransfer.types.includes("text/html")))if(focusByRange(getRangeByPoint(s.clientX,s.clientY)),s.dataTransfer.types[0]==="Files"&&!isBrowser()){const d=[];for(let c=0;c<s.dataTransfer.files.length;c++)d.push(s.dataTransfer.files[c].path);uploadLocalFiles(d,t,!s.altKey)}else paste(t,s);window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;e.addEventListener("dragover",s=>{var i,o;if(s.dataTransfer.types.includes("Files")&&s.target.classList.contains("protyle-wysiwyg")){s.preventDefault();return}let l="";for(const c of s.dataTransfer.items)c.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(l=c.type);if(!l&&!window.siyuan.dragElement){s.preventDefault();return}if(s.shiftKey||s.altKey){const c=hasClosestBlock(s.target);c&&c.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),s.preventDefault();return}s.preventDefault();const r=hasClosestByClassName(s.target,"av__row")||hasClosestBlock(s.target);if(!r||r!=null&&r.classList.contains("av"))return;const d=s.dataTransfer.types.includes(Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(r&&n&&r.isSameNode(n)){const c=r.getBoundingClientRect();if(r.classList.remove("protyle-wysiwyg--select","dragover__top","dragover__bottom","dragover__left","dragover__right"),r.getAttribute("data-type")==="NodeAttributeView"&&hasClosestByTag(s.target,"TD")){r.classList.add("protyle-wysiwyg--select");return}if(r.getAttribute("data-type")==="NodeListItem"||d.indexOf("-")>-1){s.clientY>c.top+c.height/2?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):r.classList.add("dragover__top","protyle-wysiwyg--select");return}s.clientX<c.left+32&&s.clientX>c.left&&!r.classList.contains("av__row")?r.classList.add("dragover__left","protyle-wysiwyg--select"):s.clientX>c.right-32&&s.clientX<c.right&&!r.classList.contains("av__row")?r.classList.add("dragover__right","protyle-wysiwyg--select"):s.clientY>c.top+c.height/2&&a!=="bottom"?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):a!=="top"&&r.classList.add("dragover__top","protyle-wysiwyg--select");return}if(d.indexOf("-")>-1){d.split(",").includes(t.block.rootID)?n=void 0:n=r;return}if(l){a="";const c=l.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP);if(c[2].split(",").find(g=>{if(g&&hasClosestByAttribute(r,"data-node-id",g))return!0})||hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed")||c[0]==="nodelistitem"&&c[1]!==r.getAttribute("data-subtype")&&r.getAttribute("data-type")==="NodeListItem"||c[0]!=="nodelistitem"&&r.getAttribute("data-type")==="NodeListItem")return;c[0]==="nodelistitem"&&r.parentElement.classList.contains("li")&&((i=r.previousElementSibling)!=null&&i.classList.contains("protyle-action"))&&(a="top"),c[0]==="nodelistitem"&&((o=r.nextElementSibling)!=null&&o.classList.contains("list"))&&(a="bottom");const u=hasClosestByClassName(s.target,"av__row");r.classList.contains("av")&&u?(u.classList.contains("av__row--header")&&(a="top"),n=u):n=r}}),e.addEventListener("dragleave",s=>{const i=hasClosestByClassName(s.target,"av__row")||hasClosestBlock(s.target);if(i&&!i.classList.contains("av")){let o="";for(const l of s.dataTransfer.items)l.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(o=l.type);o.indexOf(i.getAttribute("data-node-id"))===-1&&(i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end")),i.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right"),i.classList.contains("av__row")&&i.classList.remove("protyle-wysiwyg--select")}})},sl=(t,e,n,a,s)=>{if(e!=="NodeCodeBlock"&&n.parentElement.getAttribute("data-subtype")!=="t"&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const i=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,o=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const l=n.parentElement.parentElement,r=l.outerHTML;return l.setAttribute("data-subtype","t"),l.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),o&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(i),updateTransaction(t,l.getAttribute("data-node-id"),l.outerHTML,r),focusByWbr(t.wysiwyg.element,s),!0}return!1}else{const l=n.getAttribute("data-node-id"),r=Lute.NewNodeID(),d=Lute.NewNodeID(),c=Lute.NewNodeID(),f=n.outerHTML;return a.innerHTML=a.innerHTML.substring(i),transaction(t,[{action:"update",id:l,data:n.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${c}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${c.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div><div data-node-id="${d}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:l},{action:"move",id:l,previousID:d},{action:"delete",id:d}],[{action:"update",id:l,data:f},{action:"move",id:l,previousID:r},{action:"delete",id:r}]),n.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${c}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${c.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(t.wysiwyg.element,s),!0}}return!1},il=(t,e,n,a,s)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const i=n.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),d=n.outerHTML;return a.innerHTML=a.innerHTML.substring(2),transaction(t,[{action:"update",id:i,data:n.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${a.innerHTML.substring(0,1)}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:i},{action:"move",id:i,previousID:l},{action:"delete",id:l}],[{action:"update",id:i,data:d},{action:"move",id:i,previousID:o},{action:"delete",id:o}]),n.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${a.innerHTML.substring(0,1)}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(t.wysiwyg.element,s),!0}return!1};var ka=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});const ol=(t,e,n,a=!0)=>ka(void 0,null,function*(){var s,i,o,l;if(!e.parentElement)return;const r=getContenteditableElement(e),d=e.getAttribute("data-type");if(!r){d==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":d==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+Constants.ZWSP:d==="NodeMathBlock"||d==="NodeHTMLBlock"?e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+Constants.ZWSP:d==="NodeIFrame"||d==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:d==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+Constants.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:d==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+Constants.ZWSP:d==="NodeCodeBlock"&&(n.startContainer.textContent=Constants.ZWSP),focusByWbr(e,n);return}const c=document.createElement("wbr");n.insertNode(c);const f=e.getAttribute("data-node-id");if(d!=="NodeCodeBlock"&&(r.innerHTML.endsWith(`
<wbr>`)||r.innerHTML.endsWith(`
<wbr>
`))){updateTransaction(t,f,e.outerHTML,e.outerHTML.replace(`
<wbr>`,"<wbr>")),c.remove();return}if(turnIntoTaskList(t,d,e,r,n)||headingTurnIntoList(t,d,e,r,n))return;const u=e.querySelector("br");u&&u.parentElement.tagName!=="TD"&&u.parentElement.tagName!=="TH"&&(u.parentElement.textContent.trim()===""||((i=(s=u.previousSibling)==null?void 0:s.previousSibling)==null?void 0:i.textContent)===`
`)&&u.remove(),e.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),(r.innerHTML==="\u300B<wbr>"||r.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(r.innerHTML=r.innerHTML.replace("\u300B<wbr>","><wbr>"));const g=r.innerHTML.trimStart();if(!((g.startsWith("````")||g.startsWith("\xB7\xB7\xB7\xB7")||g.startsWith("~~~~"))&&g.indexOf(`
`)===-1)){if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~"))&&g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){updateTransaction(t,f,e.outerHTML,t.wysiwyg.lastHTMLs[f]),c.remove();return}}const m=hasClosestByAttribute(n.startContainer,"data-type","block-ref");m&&m.getAttribute("data-subtype")==="d"&&(yield fetchSyncPost("/api/block/getRefText",{id:m.getAttribute("data-id")})).data!==m.innerHTML.replace("<wbr>","")&&m.setAttribute("data-subtype","s");let p=e.outerHTML,b=!1;if(r.textContent==="---"&&d!=="NodeCodeBlock"){p=`<div data-node-id="${f}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const h=getNextBlock(r);h?isNotEditBlock(h)?b=!0:focusBlock(h):p+=genEmptyBlock(!1,!0)}else{if(d!=="NodeCodeBlock"&&(g.startsWith("```")||g.startsWith("~~~")||g.startsWith("\xB7\xB7\xB7")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=r.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();h.endsWith("\n```")||(h=h.replace("<wbr>","")+"<wbr>\n```"),r.innerHTML=h,p=e.outerHTML}p=t.lute.SpinBlockDOM(p)}hideElements(["util"],t,!0);const v=document.createElement("template");if(v.innerHTML=p,a&&(((o=getContenteditableElement(v.content.firstElementChild))==null?void 0:o.innerHTML)!==getContenteditableElement(e).innerHTML||v.content.childElementCount===1&&((l=getContenteditableElement(v.content.firstElementChild))==null?void 0:l.innerHTML)==="<wbr>")&&!(v.content.childElementCount===1&&v.content.firstElementChild.classList.contains("code-block")&&d==="NodeCodeBlock")){log("SpinBlockDOM",e.outerHTML,"argument",t.options.debugger),log("SpinBlockDOM",p,"result",t.options.debugger);let h;e.classList.contains("table")&&(h=getContenteditableElement(e).scrollLeft),/<span data-type="backslash"><span>\\<\/span>.<\/span><wbr>/.test(p)?e.outerHTML=p:e.outerHTML=p.replace("</span><wbr>","</span>"+Constants.ZWSP+"<wbr>"),t.wysiwyg.element.querySelectorAll(`[data-node-id="${f}"]`).forEach(_=>{(_.getAttribute("data-type")==="NodeBlockQueryEmbed"||!hasClosestByAttribute(_,"data-type","NodeBlockQueryEmbed"))&&(e=_)}),Array.from(v.content.children).forEach((_,C)=>{const k=_.getAttribute("data-node-id");let E;k===f?E=e:E=t.wysiwyg.element.querySelector(`[data-node-id="${k}"]`);const L=E.getAttribute("data-type");if(L==="NodeCodeBlock"){const w=E.querySelector(".protyle-action__language");w?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&w.textContent===""&&(w.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]),highlightRender(E)):v.content.childElementCount===1&&t.toolbar.showRender(t,E)}else["NodeMathBlock","NodeHTMLBlock"].includes(L)?(L==="NodeMathBlock"&&mathRender(E),t.toolbar.showRender(t,E)):L==="NodeBlockQueryEmbed"?(blockRender(t,E),t.toolbar.showRender(t,E),hideElements(["hint"],t)):L==="NodeThematicBreak"&&b?focusBlock(e):(E.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(w=>{w.textContent===""&&fetchPost("/api/block/getRefText",{id:w.getAttribute("data-id")},y=>{w.innerHTML=y.data})}),mathRender(E),C===v.content.childElementCount-1&&(focusByWbr(t.wysiwyg.element,n),t.hint.render(t),h>0&&(getContenteditableElement(E).scrollLeft=h)))})}else e.getAttribute("data-type")==="NodeCodeBlock"?(r.removeAttribute("data-render"),highlightRender(e)):(focusByWbr(t.wysiwyg.element,n),t.hint.render(t));hideElements(["gutter"],t),Ca(p,t,f)}),Ca=(t,e,n)=>{const a=document.createElement("template");a.innerHTML=t;const s=[],i=[];Array.from(a.content.children).forEach((o,l)=>{var r;o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const d=o.getAttribute("data-node-id");if(d===n)s.push({id:n,data:o.outerHTML,action:"update"}),i.push({id:n,data:e.wysiwyg.lastHTMLs[n],action:"update"});else{let c;l===0&&(c=e.wysiwyg.element.querySelector(`[data-node-id="${d}"]`)),s.push({action:"insert",data:o.outerHTML,id:d,previousID:l===0?(r=c==null?void 0:c.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:(c==null?void 0:c.parentElement.getAttribute("data-node-id"))||e.block.parentID}),i.push({id:d,action:"delete"})}}),transaction(e,s,i)},La=(t,e,n)=>{var a;if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){listOutdent(t,[e.parentElement],n);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const f=e.parentElement.parentElement,u=f.outerHTML,g=e.parentElement.parentElement.previousElementSibling.lastElementChild,m=g.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),g.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&updateListOrder(f),transaction(t,[{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML},{action:"update",data:g.parentElement.outerHTML,id:g.parentElement.getAttribute("data-node-id")}],[{action:"update",data:m,id:g.parentElement.getAttribute("data-node-id")},{action:"update",data:u,id:f.getAttribute("data-node-id")}]),focusByWbr(g.parentElement,n);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;n.insertNode(document.createElement("wbr"));const f=e.parentElement.parentElement,u=f.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const g=document.createElement("div");g.innerHTML=e.parentElement.innerHTML;const m=[],p=[];Array.from(g.children).forEach((b,v)=>{var h;m.push({action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:v===0?(h=f.previousElementSibling)==null?void 0:h.getAttribute("data-node-id"):m[v-1].id,parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID}),p.push({action:"delete",id:b.getAttribute("data-node-id")})}),f.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&updateListOrder(f,parseInt(f.firstElementChild.getAttribute("data-marker"))-1),m.splice(0,0,{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML}),p.push({action:"update",data:u,id:f.getAttribute("data-node-id")}),transaction(t,m,p),focusByWbr(t.wysiwyg.element,n);return}const s=e.parentElement;if(s.previousElementSibling&&s.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const i=s.getAttribute("data-node-id"),o=s.parentElement;n.insertNode(document.createElement("wbr"));const l=o.outerHTML,r=[],d=[{action:"insert",id:i,data:"",previousID:s.previousElementSibling.getAttribute("data-node-id")}],c=s.previousElementSibling.lastElementChild;if(s.previousElementSibling.getAttribute("fold")==="1")if(getContenteditableElement(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))r.push({action:"delete",id:i}),d[0].data=s.outerHTML,setLastNodeRange(getContenteditableElement(s.previousElementSibling),n),n.collapse(!0),s.remove();else{setLastNodeRange(getContenteditableElement(s.previousElementSibling),n),n.collapse(!0),focusByRange(n),(a=e.querySelector("wbr"))==null||a.remove();return}else{let f=c.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((u,g)=>{if(u.classList.contains("protyle-action")||u.classList.contains("protyle-attr"))return;const m=u.getAttribute("data-node-id");r.push({action:"move",id:m,previousID:f}),d.push({action:"move",id:m,previousID:g===1?void 0:f,parentID:i}),f=m,c.before(u)}),r.push({action:"delete",id:i}),d[0].data=s.outerHTML,s.remove()}o.classList.contains("protyle-wysiwyg")?transaction(t,r,d):(o.getAttribute("data-subtype")==="o"&&updateListOrder(o),updateTransaction(t,o.getAttribute("data-node-id"),o.outerHTML,l)),focusByWbr(c.parentElement,n)},Aa=(t,e,n)=>{var a,s,i,o,l,r;preventScroll(t);const d=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((d==null?void 0:d.length)>0){const C=[],k=[];let E=d[0].previousElementSibling||d[d.length-1].nextElementSibling,L,w;if(hideElements(["select"],t),d.find(y=>{const A=getTopAloneElement(y);w=A.parentElement;const M=A.getAttribute("data-node-id");if(C.push({action:"delete",id:M}),E=getPreviousBlock(A)||getNextBlock(A)||A.parentElement||t.wysiwyg.element.firstElementChild,A.getAttribute("data-type")==="NodeHeading"&&A.getAttribute("fold")==="1"){setFold(t,A,void 0,!0),k.push({action:"insert",data:A.outerHTML,id:M,previousID:d[0].previousElementSibling?d[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:A.parentElement.getAttribute("data-node-id")||t.block.parentID}),A.firstElementChild.removeAttribute("contenteditable");const x=A.nextElementSibling;if(x){const B=x.getAttribute("data-type");if(B!=="NodeHeading"||B==="NodeHeading"&&x.getAttribute("data-subtype")>A.getAttribute("data-subtype"))return!0}}else{let x=A.outerHTML;(A.classList.contains("render-node")||A.querySelector("div.render-node"))&&(x=t.lute.SpinBlockDOM(A.outerHTML)),k.push({action:"insert",data:x,id:M,previousID:A.previousElementSibling?A.previousElementSibling.getAttribute("data-node-id"):"",parentID:A.parentElement.getAttribute("data-node-id")||t.block.parentID}),A.getAttribute("data-subtype")==="o"&&A.classList.contains("li")?L=A.parentElement:L=void 0,A.remove()}}),E)if(t.block.showAll&&E.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0)setTimeout(()=>{zoomOut({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else{if(E.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0){const y=Lute.NewNodeID(),A=genEmptyElement(!1,!0,y);E.insertAdjacentElement("afterbegin",A),C.push({action:"insert",data:A.outerHTML,id:y,parentID:E.getAttribute("data-node-id")||t.block.parentID}),k.push({action:"delete",id:y}),E=void 0,focusByWbr(A,n)}focusBlock(E,void 0,!1),scrollCenter(t,E),L&&(k.push({action:"update",id:L.getAttribute("data-node-id"),data:L.outerHTML}),updateListOrder(L,1),C.push({action:"update",id:L.getAttribute("data-node-id"),data:L.outerHTML}))}if(C.length>0)if(w&&w.getAttribute("data-type")==="NodeSuperBlock"&&w.childElementCount===2){const y=cancelSB(t,w);transaction(t,C.concat(y.doOperations),y.undoOperations.concat(k.reverse()))}else transaction(t,C,k.reverse());hideElements(["util"],t);return}if(e.getAttribute("data-type")==="NodeCodeBlock"&&getContenteditableElement(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),Aa(t,e,n);return}if(e.getAttribute("data-type")==="NodeCodeBlock"||e.getAttribute("data-type")==="NodeTable"){e.previousElementSibling&&focusBlock(e.previousElementSibling,void 0,!1);return}if(e.getAttribute("data-type")==="NodeHeading"){turnsIntoTransaction({protyle:t,selectsElement:[e],type:"Blocks2Ps"});return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const C=e.parentElement;C.insertAdjacentElement("beforebegin",e),C.childElementCount===1?(transaction(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(a=e.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"delete",id:C.getAttribute("data-node-id")}],[{action:"insert",id:C.getAttribute("data-node-id"),data:C.outerHTML,previousID:(s=e.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:C.getAttribute("data-node-id")}]),C.remove()):transaction(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(i=e.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:C.getAttribute("data-node-id")}]),focusByWbr(e,n);return}if(e.parentElement.classList.contains("li")&&e.previousElementSibling.classList.contains("protyle-action")){La(t,e,n);return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const c=getPreviousBlock(e);if(!c){if(t.wysiwyg.element.childElementCount>1&&getContenteditableElement(e).textContent===""){focusBlock(t.wysiwyg.element.firstElementChild.nextElementSibling);const C=getTopAloneElement(e);transaction(t,[{action:"delete",id:C.getAttribute("data-node-id")}],[{action:"insert",data:C.outerHTML,id:C.getAttribute("data-node-id"),parentID:t.block.parentID}]),C.remove()}return}const f=e.parentElement,u=getContenteditableElement(e),g=getLastBlock(c),m=g&&(g.classList.contains("table")||g.classList.contains("render-node")||g.classList.contains("iframe")||g.classList.contains("hr")||g.classList.contains("code-block")),p=g.getAttribute("data-node-id");if(m){if(g.classList.contains("code-block")){if(u.textContent.trim()===""){const C=e.getAttribute("data-node-id"),k=[{action:"delete",id:C}],E=[{action:"insert",data:e.outerHTML,id:C,previousID:(o=e.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const L=cancelSB(t,f);transaction(t,k.concat(L.doOperations),L.undoOperations.concat(E))}else transaction(t,k,E);focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${p}"]`),void 0,!1)}else focusBlock(g,void 0,!1);return}if(u.textContent!==""){focusBlock(g,void 0,!1);return}}const b=getTopEmptyElement(e),v=b.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const h=[{action:"update",data:g.outerHTML,id:p},{action:"insert",data:b.outerHTML,id:v,previousID:(l=e.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")}],_=[{action:"delete",id:v}];if(m)b.remove(),focusBlock(g,void 0,!1);else{const C=getContenteditableElement(g);if(u&&u.textContent!==""&&(n.setEndAfter(u.lastChild),(((r=C==null?void 0:C.lastElementChild)==null?void 0:r.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const L=hasNextSibling(C==null?void 0:C.lastElementChild);L&&L.textContent===`
`&&L.remove()}const k=t.contentElement.scrollTop,E=n.extractContents();n.selectNodeContents(C),n.collapse(!1),n.insertNode(E),b.remove(),t.contentElement.scrollTop=k,t.scroll.lastScrollTop=k-1,_.push({action:"update",data:g.outerHTML,id:p})}if(f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const C=cancelSB(t,f);transaction(t,_.concat(C.doOperations),C.undoOperations.concat(h))}else transaction(t,_,h);focusByWbr(t.wysiwyg.element,n)},xa=(t,e,n)=>{var a,s;const i=e.parentElement,o=getContenteditableElement(e);if(["",`
`].includes(o.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if((a=i.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return listOutdent(t,[e.parentElement],n),!0;if(!i.parentElement.classList.contains("protyle-wysiwyg"))return breakList(t,e,n),!0}const l=getSelectionOffset(o,t.wysiwyg.element,n);if(n.toString()===""&&l.start===0&&!hasPreviousSibling(n.startContainer)){if(i.parentElement.classList.contains("protyle-wysiwyg"))return!0;const g=i.parentElement.outerHTML;let m=genListItemElement(i,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))getContenteditableElement(e).textContent===""?i.insertAdjacentElement("afterend",m):i.insertAdjacentElement("beforebegin",m);else{if(getContenteditableElement(e).textContent!=="")return!1;e.remove(),m=genListItemElement(i,-1,!0),i.insertAdjacentElement("afterend",m)}return i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),updateTransaction(t,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,g),focusByWbr(m,n),scrollCenter(t),Ye(m),!0}const r=i.querySelector(".list");let d;if(r&&i.getAttribute("fold")!=="1"&&e.nextElementSibling.isSameNode(r)){if(l.end>=o.textContent.length-(o.textContent.endsWith(Constants.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const g=r.outerHTML;e.querySelector("wbr").remove(),d=genListItemElement(r.firstElementChild,-1,!0),r.firstElementChild.before(d),r.getAttribute("data-subtype")==="o"&&updateListOrder(r),updateTransaction(t,r.getAttribute("data-node-id"),r.outerHTML,g),focusByWbr(i,n),scrollCenter(t)}else{n.insertNode(document.createElement("wbr"));const g=i.outerHTML,m=i.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(o.lastChild),d=genListItemElement(i,0,!1);const p=getContenteditableElement(d);p.appendChild(n.extractContents()),p.parentElement.after(r),i.insertAdjacentElement("afterend",d),i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?transaction(t,[{action:"update",data:i.outerHTML,id:i.getAttribute("data-node-id")},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",data:g,id:i.getAttribute("data-node-id")}]):updateTransaction(t,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,m),focusByWbr(d,n),scrollCenter(t)}return Ye(d),!0}(n.toString()===""||n.toString()===Constants.ZWSP)&&n.startContainer.nodeType===3&&n.startContainer.textContent===Constants.ZWSP&&n.startOffset===0&&(n.setStart(n.startContainer,1),n.collapse(!1)),n.insertNode(document.createElement("wbr"));const c=i.outerHTML,f=i.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(o.lastChild),d=genListItemElement(i,0,!1);const u=n.extractContents();return u.firstChild.nodeType!==3&&u.firstChild.textContent===""&&(u.firstChild.after(document.createElement("wbr")),u.firstChild.remove()),(((s=o==null?void 0:o.lastElementChild)==null?void 0:s.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!hasNextSibling(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",`
`),getContenteditableElement(d).appendChild(u),i.insertAdjacentElement("afterend",d),i.getAttribute("data-subtype")==="o"&&updateListOrder(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?transaction(t,[{action:"update",id:i.getAttribute("data-node-id"),data:i.outerHTML},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",id:i.getAttribute("data-node-id"),data:c}]):updateTransaction(t,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,f),focusByWbr(d,n),scrollCenter(t),Ye(d),!0},ll=(t,e,n)=>{var a,s;const i=isNotEditBlock(t);if(!i&&t.classList.contains("protyle-wysiwyg--select")){setLastNodeRange(getContenteditableElement(t),e,!1),e.collapse(!1),hideElements(["select"],n);return}if(i){if(t.parentElement.classList.contains("li")){const m=t.parentElement.parentElement.outerHTML,p=genListItemElement(t.parentElement,0,!0);t.parentElement.insertAdjacentElement("afterend",p),updateTransaction(n,t.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.outerHTML,m),focusByWbr(p,e),Ye(p),scrollCenter(n);return}if(t.classList.contains("hr")){insertEmptyBlock(n,"afterend");return}t.classList.contains("protyle-wysiwyg--select")&&t.classList.contains("render-node")?n.toolbar.showRender(n,t):insertEmptyBlock(n,"afterend");return}const o=getContenteditableElement(t);o.querySelectorAll(".img--select").forEach(m=>{m.classList.remove("img--select")});const l=o.innerHTML.trimStart();if((l.startsWith("```")||l.startsWith("\xB7\xB7\xB7")||l.startsWith("~~~")||l.indexOf("\n```")>-1||l.indexOf(`
~~~`)>-1||l.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(l.indexOf(`
`)===-1&&l.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(t.classList.contains("p")){const m=t.outerHTML;let p=o.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");p.endsWith("\n```")||(p+="<wbr>\n```"),o.innerHTML=p,t.outerHTML=n.lute.SpinBlockDOM(t.outerHTML),t=n.wysiwyg.element.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);const b=t.querySelector(".protyle-action__language");return b?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&b.textContent===""?b.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]:(window.siyuan.storage[Constants.LOCAL_CODELANG]=b.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG])),highlightRender(t)):n.toolbar.showRender(n,t),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,m),!0}}if(t.getAttribute("data-type")==="NodeCodeBlock"){const m=document.createElement("wbr");e.insertNode(m);const p=t.outerHTML;return m.remove(),e.extractContents(),o.textContent.endsWith(`
`)||o.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(m),o.removeAttribute("data-render"),highlightRender(t),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,p),!0}if(o.textContent.replace(Constants.ZWSP,"").replace(`
`,"")===""&&t.nextElementSibling&&t.nextElementSibling.classList.contains("protyle-attr")&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const m=getTopEmptyElement(t),p=t.getAttribute("data-node-id"),b=m.getAttribute("data-node-id"),v={action:"insert",id:p,data:t.outerHTML},h={action:"insert",id:b,data:m.outerHTML};return b===p?(v.previousID=t.parentElement.getAttribute("data-node-id"),h.previousID=t.previousElementSibling.getAttribute("data-node-id"),t.parentElement.after(t)):(v.previousID=m.previousElementSibling?m.previousElementSibling.getAttribute("data-node-id"):void 0,v.parentID=m.parentElement.getAttribute("data-node-id")||n.block.parentID,h.previousID=v.previousID,h.parentID=v.parentID,m.after(t),m.remove()),transaction(n,[{action:"delete",id:b},v],[{action:"delete",id:p},h]),focusByWbr(t,e),!0}const r=getSelectionOffset(o,n.wysiwyg.element,e);if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&(t.nextElementSibling.classList.contains("protyle-attr")||t.nextElementSibling.classList.contains("list")&&((a=t.previousElementSibling)!=null&&a.classList.contains("protyle-action"))||r.start===0&&t.previousElementSibling.classList.contains("protyle-action")||t.parentElement.getAttribute("fold")==="1")&&xa(n,t,e))return!0;if(o.textContent!==""&&e.toString()===""&&r.start===0){const m=genEmptyElement(!1,!0),p=m.getAttribute("data-node-id");return transaction(n,[{action:"insert",data:m.outerHTML,id:p,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):"",parentID:t.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:p}]),m.querySelector("wbr").remove(),t.insertAdjacentElement("beforebegin",m),Ye(m),!0}e.toString()===""&&e.startContainer.nodeType===3&&e.startContainer.textContent===Constants.ZWSP&&e.startOffset===0&&e.setStart(e.startContainer,1),e.insertNode(document.createElement("wbr"));const d=t.outerHTML;e.toString()!==""&&(e.extractContents(),e.insertNode(document.createElement("wbr"))),o.lastChild&&e.setEndAfter(o.lastChild);const c=genEmptyElement(!1,!1),f=e.extractContents();f.firstChild&&f.firstChild.nodeType!==3&&f.firstChild.textContent===""&&(f.firstChild.after(document.createElement("wbr")),f.firstChild.remove()),(((s=o==null?void 0:o.lastElementChild)==null?void 0:s.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!hasNextSibling(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",`
`),getContenteditableElement(c).appendChild(f);const u=t.getAttribute("data-node-id"),g=c.getAttribute("data-node-id");return t.insertAdjacentElement("afterend",c),transaction(n,[{action:"update",data:t.outerHTML,id:u},{action:"insert",data:c.outerHTML,id:g,previousID:u}],[{action:"delete",id:g},{action:"update",data:d,id:u}]),t.insertAdjacentElement("afterend",c),focusByWbr(c,e),scrollCenter(n),Ye(c),!0},Ye=t=>{const e=getContenteditableElement(t).childNodes;for(let n=0;n<e.length;n++)e[n].nodeType===3&&e[n].textContent.length===0&&(e[n].remove(),n--)};class rl extends null{constructor(e,n){super(e,n),this.element.addEventListener("click",()=>{let a;if(e.toolbar.range.toString()===""&&(a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),a.length===0)){const s=hasClosestBlock(e.toolbar.range.startContainer);s&&(a=[s])}e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Sa(e,a)),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,focusByRange(e.toolbar.range)})}}const Sa=(t,e)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(d=>{n+=`<button class="color__square" data-type="color" style="color:${d}">A</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(d=>{a+=`<button class="color__square" data-type="backgroundColor" style="background-color:${d}"></button>`});const s=document.createElement("div");s.classList.add("protyle-font");let i="";const o=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];o.length>0&&(i=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,o.forEach(d=>{const c=d.split(Constants.ZWSP);switch(c[0]){case"color":i+=`<button class="color__square" data-type="${c[0]}" style="color:${c[1]}">A</button>`;break;case"backgroundColor":i+=`<button class="color__square" data-type="${c[0]}" style="background-color:${c[1]}"></button>`;break;case"style2":i+=`<button data-type="${c[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":i+=`<button data-type="${c[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":i+=`<button data-type="${c[0]}" class="protyle-font__style">${c[1]}</button>`;break;case"style1":i+=`<button data-type="${c[0]}" style="background-color:${c[1]};color:${c[2]}" class="color__square">A</button>`;break;case"clear":i+=`<button data-type="${c[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),i+="</div>");let l,r="16px";return e&&e.length>0?l=e[0]:(l=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),l||(l=hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","text"))),l&&(r=l.style.fontSize||"16px"),s.innerHTML=`${i}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <select class="b3-select fn__block">
        <option ${r==="12px"?"selected":""} value="12px">12px</option>
        <option ${r==="13px"?"selected":""} value="13px">13px</option>
        <option ${r==="14px"?"selected":""} value="14px">14px</option>
        <option ${r==="15px"?"selected":""} value="15px">15px</option>
        <option ${r==="16px"?"selected":""} value="16px">16px</option>
        <option ${r==="19px"?"selected":""} value="19px">19px</option>
        <option ${r==="22px"?"selected":""} value="22px">22px</option>
        <option ${r==="24px"?"selected":""} value="24px">24px</option>
        <option ${r==="29px"?"selected":""} value="29px">29px</option>
        <option ${r==="32px"?"selected":""} value="32px">32px</option>
        <option ${r==="40px"?"selected":""} value="40px">40px</option>
        <option ${r==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,s.addEventListener("click",function(d){let c=d.target;for(;c&&!c.isEqualNode(s);){const f=c.getAttribute("data-type");if(c.tagName==="BUTTON"){f==="style1"?Ue(t,e,f,c.style.backgroundColor+Constants.ZWSP+c.style.color):f==="fontSize"?Ue(t,e,f,c.textContent.trim()):f==="backgroundColor"?Ue(t,e,f,c.style.backgroundColor):f==="color"?Ue(t,e,f,c.style.color):Ue(t,e,f);break}c=c.parentElement}}),s.querySelector("select").addEventListener("change",function(d){Ue(t,e,"fontSize",d.target.value)}),s},Ue=(t,e,n,a)=>{let s=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];if(n)s.splice(0,0,`${n}${Constants.ZWSP}${a}`),s=[...new Set(s)],s.length>8&&s.splice(8,1),window.siyuan.storage[Constants.LOCAL_FONTSTYLES]=s,setStorageVal(Constants.LOCAL_FONTSTYLES,window.siyuan.storage[Constants.LOCAL_FONTSTYLES]);else if(s.length===0)n="style1",a="var(--b3-card-error-color)"+Constants.ZWSP+"var(--b3-card-error-background)";else{const i=s[0].split(Constants.ZWSP);n=i[0],a=i[1]}e&&e.length>0?(updateBatchTransaction(e,t,i=>{if(n==="clear")i.style.color="",i.style.webkitTextFillColor="",i.style.webkitTextStroke="",i.style.textShadow="",i.style.backgroundColor="",i.style.fontSize="";else if(n==="style1"){const o=a.split(Constants.ZWSP);i.style.backgroundColor=o[0],i.style.color=o[1]}else n==="style2"?(i.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",i.style.webkitTextFillColor="transparent"):n==="style4"?i.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?i.style.color=a:n==="backgroundColor"?i.style.backgroundColor=a:n==="fontSize"&&(i.style.fontSize=a)}),focusBlock(e[0])):n==="clear"?t.toolbar.setInlineMark(t,"clear","range",{type:"text"}):t.toolbar.setInlineMark(t,"text","range",{type:n,color:a})},dl=(t,e)=>{const n=i=>{const o=i.split(Constants.ZWSP);t.setAttribute("data-id",o.splice(0,1)[0]),t.setAttribute("data-subtype",o.splice(0,1)[0]),t.removeAttribute("data-href"),t.innerText=o.join("")},a=i=>{const o=i.split(Constants.ZWSP);t.setAttribute("data-href",o[0]),t.removeAttribute("data-subtype"),t.removeAttribute("data-id"),o[1]&&(t.textContent=o[1])},s=i=>{const o=i.split(Constants.ZWSP);t.setAttribute("data-id",o[0]),t.removeAttribute("data-href"),t.removeAttribute("data-subtype"),o[1]&&(t.textContent=o[1])};if(e)switch(e.type){case"color":t.style.color=e.color;break;case"fontSize":t.style.fontSize=e.color;break;case"backgroundColor":t.style.backgroundColor=e.color;break;case"style1":t.style.backgroundColor=e.color.split(Constants.ZWSP)[0],t.style.color=e.color.split(Constants.ZWSP)[1];break;case"style2":t.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",t.style.webkitTextFillColor="transparent";break;case"style4":t.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(e.color);break;case"inline-math":t.className="render-node",t.setAttribute("contenteditable","false"),t.setAttribute("data-subtype","math"),t.setAttribute("data-content",t.textContent.replace(Constants.ZWSP,"")),t.removeAttribute("data-render"),t.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":s(e.color);break;case"inline-memo":t.removeAttribute("contenteditable"),t.removeAttribute("data-subtype"),t.removeAttribute("data-content");break}},cl=(t,e,n)=>{if(!n)return!0;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(t.nodeType!==3)return t.getAttribute("data-id")===e.getAttribute("data-id")&&t.getAttribute("data-subtype")===e.getAttribute("data-subtype")&&t.textContent===e.textContent;const d=n.color.split(Constants.ZWSP);return d[0]===e.getAttribute("data-id")&&d[1]===e.getAttribute("data-subtype")&&d[2]===e.textContent}if(n.type==="file-annotation-ref")return t.nodeType!==3?t.getAttribute("data-id")===e.getAttribute("data-id")&&t.textContent===e.textContent:n.color===e.getAttribute("data-id");let a="",s="",i="",o="",l="",r="";return t.nodeType!==3&&(a=t.style.color,s=t.style.webkitTextFillColor,i=t.style.webkitTextStroke,o=t.style.textShadow,l=t.style.backgroundColor,r=t.style.fontSize),n.type==="color"?n.color===e.style.color&&s===e.style.webkitTextFillColor&&i===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="backgroundColor"?a===e.style.color&&s===e.style.webkitTextFillColor&&i===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color===e.style.backgroundColor:n.type==="style1"?n.color.split(Constants.ZWSP)[0]===e.style.color&&s===e.style.webkitTextFillColor&&i===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color.split(Constants.ZWSP)[1]===e.style.backgroundColor:n.type==="style2"?a===e.style.color&&e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="style4"?a===e.style.color&&s===e.style.webkitTextFillColor&&i===e.style.webkitTextStroke&&r===e.style.fontSize&&e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===e.style.backgroundColor:n.type==="fontSize"?a===e.style.color&&s===e.style.webkitTextFillColor&&i===e.style.webkitTextStroke&&o===e.style.textShadow&&n.color===e.style.fontSize&&l===e.style.backgroundColor:!0},ul=(t,e,n,a,s)=>{let i=1,o;fetchPost(`/api/riff/get${a}RiffCards`,{id:e,page:i},l=>{var r;const d=new Dialog({content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${escapeHtml(n)}</span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${i}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${isMobile()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${isMobile()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${Mt(l.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});l.data.blocks.length>0&&(o=new Protyle(t,d.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),window.siyuan.config.editor.readOnly&&disabledProtyle(o.protyle),Re(o,(r=d.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const c=d.element.querySelector('[data-type="previous"]'),f=d.element.querySelector('[data-type="next"]'),u=d.element.querySelector(".b3-list--background");l.data.pageCount>1&&f.removeAttribute("disabled"),d.element.style.zIndex="200",d.element.setAttribute("data-key","viewCards"),d.element.addEventListener("click",g=>{var m;if(typeof g.detail=="string"){let b=u.querySelector(".b3-list-item--focus");if(b){b.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?b=b.previousElementSibling||b.parentElement.lastElementChild:g.detail==="arrowdown"&&(b=b.nextElementSibling||b.parentElement.firstElementChild);const v=b.getBoundingClientRect(),h=b.parentElement.getBoundingClientRect();(v.top<h.top||v.bottom>h.bottom)&&b.scrollIntoView(v.top<h.top),Re(o,b.getAttribute("data-id")),b.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let p=g.target;for(;p&&!d.element.isSameNode(p);){const b=p.getAttribute("data-type");if(b==="close"){d.destroy(),g.stopPropagation(),g.preventDefault();break}else if(b==="previous"){if(i<=1)return;i--,i<=1&&c.setAttribute("disabled","disabled"),fetchPost(`/api/riff/get${a}RiffCards`,{id:e,page:i},v=>{var h;i===v.data.pageCount?f.setAttribute("disabled","disabled"):v.data.pageCount>1&&f.removeAttribute("disabled"),f.nextElementSibling.nextElementSibling.textContent=`${i}/${v.data.pageCount||1}`,u.innerHTML=Mt(v.data.blocks,n,a),u.scrollTop=0,Re(o,(h=d.element.querySelector(".b3-list-item--focus"))==null?void 0:h.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(b==="next"){if(i>=l.data.pageCount)return;i++,c.removeAttribute("disabled"),fetchPost(`/api/riff/get${a}RiffCards`,{id:e,page:i},v=>{var h;i===v.data.pageCount?f.setAttribute("disabled","disabled"):v.data.pageCount>1&&f.removeAttribute("disabled"),f.nextElementSibling.nextElementSibling.textContent=`${i}/${v.data.pageCount||1}`,u.innerHTML=Mt(v.data.blocks,n,a),u.scrollTop=0,Re(o,(h=d.element.querySelector(".b3-list-item--focus"))==null?void 0:h.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(b==="card-item"){Re(o,p.getAttribute("data-id")),(m=u.querySelector(".b3-list-item--focus"))==null||m.classList.remove("b3-list-item--focus"),p.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(b==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:a===""?e:Constants.QUICK_DECK_ID,blockIDs:[p.getAttribute("data-id")]},v=>{var h;let _=p.parentElement.nextElementSibling;_||(_=p.parentElement.previousElementSibling),!_&&p.parentElement.parentElement.childElementCount>1&&(_=p.parentElement.parentElement.firstElementChild),_?(Re(o,_.getAttribute("data-id")),(h=u.querySelector(".b3-list-item--focus"))==null||h.classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus"),p.parentElement.remove()):(Re(o,""),u.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),d.element.querySelector(".counter").textContent=(parseInt(d.element.querySelector(".counter").textContent)-1).toString(),s&&s(v)}),g.stopPropagation(),g.preventDefault();break}p=p.parentElement}})})},Mt=(t,e,n)=>{let a="",s=!0;const i=e.split("/");return i.splice(0,1),t.forEach(o=>{if(o.type){let l;n===""?l=getNotebookName(o.box)+getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1):(l=getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+i.join("/"),""),l.startsWith("/")&&(l=l.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${s?" b3-list-item--focus":""}${isMobile()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||Constants.ZWSP}</span>
<span data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span class="${isMobile()||!l?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${escapeAttr(l)}">${escapeHtml(l)}</span>
<span aria-label="${window.siyuan.languages.revisionCount}" class="b3-tooltips b3-tooltips__w counter${o.riffCardReps===0?" fn__none":""}">${o.riffCardReps}</span>
</div>`,s=!1}else a+=`<div data-type="card-item" class="b3-list-item${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),t.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},Re=(t,e)=>{if(!e){t.protyle.element.classList.add("fn__none"),t.protyle.element.nextElementSibling.classList.remove("fn__none");return}t.protyle.element.classList.remove("fn__none"),t.protyle.element.nextElementSibling.classList.add("fn__none"),t.protyle.scroll.lastScrollTop=0,addLoading(t.protyle),fetchPost("/api/filetree/getDoc",{id:e,mode:0,size:Constants.SIZE_GET_MAX},n=>{onGet({data:n,protyle:t.protyle,action:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})},st=t=>`<li data-id="${t.id}" data-name="${escapeAttr(t.name)}" class="b3-list-item b3-list-item--narrow${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${escapeHtml(t.name)}</span>
    <span class="b3-list-item__meta">${t.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${isMobile()?" fn__none":""}">${t.updated}</span>
</li>`,fl=(t,e)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")==="makeCard")return hideElements(["dialog"]),!0}),fetchPost("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(i=>{a+=st(i)});const s=new Dialog({width:isMobile()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});s.element.setAttribute("data-key","makeCard"),s.element.style.zIndex="200",s.element.addEventListener("click",i=>{let o=i.target;for(;o&&!o.isSameNode(s.element);){const l=o.getAttribute("data-type");if(l==="create"){let r="";const d=s.element.querySelector(".b3-text-field");d.value?(r&&hideMessage(r),fetchPost("/api/riff/createRiffDeck",{name:d.value},c=>{s.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",st(c.data)),d.value=""})):(r=showMessage(window.siyuan.languages._kernel[142]),d.focus()),i.stopPropagation(),i.preventDefault();break}else if(l==="add"){fetchPost("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=st(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=st(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="delete"){confirmDialog(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDelete} <b>${escapeHtml(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{fetchPost("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})}),i.stopPropagation(),i.preventDefault();break}else if(l==="view"){viewCards(t,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=st(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="viewall"){viewCards(t,"",window.siyuan.languages.all,""),i.stopPropagation(),i.preventDefault();break}else if(l==="rename"){const r=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),d=r.element.querySelector("input"),c=r.element.querySelectorAll(".b3-button");r.bindInput(d,()=>{c[1].click()}),d.value=o.parentElement.getAttribute("data-name"),d.focus(),d.select(),c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{fetchPost("/api/riff/renameRiffDeck",{name:d.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=d.value,o.parentElement.setAttribute("data-name",d.value)}),r.destroy()}),i.stopPropagation(),i.preventDefault();break}o=o.parentElement}})})},gl=(t,e)=>{let n=!0;const a=[];e.forEach(s=>{s.getAttribute("data-type")!=="NodeThematicBreak"&&(s.classList.remove("protyle-wysiwyg--select"),a.push(s.getAttribute("data-node-id")),(s.getAttribute("custom-riff-decks")||"").indexOf(Constants.QUICK_DECK_ID)===-1&&(n=!1))}),n?transaction(t,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}]):transaction(t,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}])},ml=(t,e,n)=>{if(!t){e.innerHTML="";return}fetchPost("/api/template/render",{id:n,path:t},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},yn=(t,e,n=!0)=>{if(!t.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=t.attributes;let s=!0;for(let i=0;i<a.length;i++)e.getAttribute(a[i].name)!==a[i].value&&(s=!1);return s&&(n?t.innerHTML=t.innerHTML+e.innerHTML:t.innerHTML=e.innerHTML+t.innerHTML,e.remove()),s},pl=t=>{let e=t.previousSibling;for(;e&&e.nodeType!==3&&yn(t,e,!1);)e=t.previousSibling;let n=t.nextSibling;for(;n&&n.nodeType!==3&&yn(t,n);)n=t.nextSibling;t.getAttribute("data-type").includes("search-mark")&&t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim())},bl=(t,e)=>{e.addEventListener("keydown",n=>{var a,s,i,o,l,r;if(n.target.localName==="protyle-html"){n.stopPropagation();return}if(t.disabled||!t.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}t.wysiwyg.preventKeyup=!1,hideElements(["util"],t),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&hideElements(["toolbar"],t);let d=getEditorRange(t.wysiwyg.element);const c=hasClosestBlock(d.startContainer);if(!c)return;if(c.classList.contains("protyle-wysiwyg--select")&&!isCtrl(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(t,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(t,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(!isCtrl(n)&&!n.shiftKey&&!n.altKey&&(n.code==="Slash"?t.hint.enableSlash=!0:n.code==="Backslash"&&(t.hint.enableSlash=!1,hideElements(["hint"],t))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!/^F\d{1,2}$/.test(n.key)&&typeof t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"){const u=d.cloneRange();d.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove(),d=u}if(bindMenuKeydown(n)){n.stopPropagation(),n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&t.options.render.breadcrumb&&t.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&!isCtrl(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(u.length>0){if(n.preventDefault(),n.stopPropagation(),hideElements(["select"],t),n.key==="ArrowDown"){const g=u[u.length-1];let m=getNextBlock(g);if(m)if(m.getBoundingClientRect().width===0){const b=hasTopClosestByAttribute(m,"fold","1");b?(m=getNextBlock(b),m?m=getFirstBlock(m):m=g):m=g}else m.getAttribute("fold")==="1"&&(m.classList.contains("sb")||m.classList.contains("bq"))||(m=getFirstBlock(m));else m=g;m.classList.add("protyle-wysiwyg--select"),countBlockWord([m.getAttribute("data-node-id")]);const p=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;p>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+p,t.scroll.lastScrollTop=t.contentElement.scrollTop-1),focusBlock(m)}else if(n.key==="ArrowUp"){let g=getPreviousBlock(u[0]);if(g){if(g=getLastBlock(g),g.getBoundingClientRect().width===0){const m=hasTopClosestByAttribute(g,"fold","1");m?g=getFirstBlock(m):g=u[0]}else if(g){const m=hasTopClosestByAttribute(g,"fold","1");m&&(m.classList.contains("sb")||m.classList.contains("bq"))&&(g=m)}}else t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():t.contentElement.scrollTop!==0?(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8):g=u[0];if(g){g.classList.add("protyle-wysiwyg--select"),countBlockWord([g.getAttribute("data-node-id")]);const m=g.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;m<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+m,t.scroll.lastScrollTop=t.contentElement.scrollTop+1),focusBlock(g)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&!isCtrl(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),hideElements(["select"],t),!1;if(matchHotKey(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return u.length>0?setFold(t,u[0]):c.parentElement.getAttribute("data-type")==="NodeListItem"?c.parentElement.childElementCount>3?setFold(t,c.parentElement):setFold(t,c):c.getAttribute("data-type")==="NodeHeading"?setFold(t,c):setFold(t,getTopAloneElement(c)),n.stopPropagation(),n.preventDefault(),!1}if(matchHotKey(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");u.length>0?setFold(t,u[0],!0):c.parentElement.getAttribute("data-type")==="NodeListItem"?c.parentElement.childElementCount>3?setFold(t,c.parentElement,!0):setFold(t,c,!0):c.getAttribute("data-type")==="NodeHeading"?setFold(t,c,!0):setFold(t,getTopAloneElement(c),!0),n.stopPropagation(),n.preventDefault();return}if((matchHotKey("\u21E7\u2190",n)||matchHotKey("\u21E7\u2192",n))&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){upSelect({protyle:t,event:n,nodeElement:c,editorElement:e,range:d,cb(u){const g=u[0].previousElementSibling;if(g&&g.getAttribute("data-node-id")){g.classList.add("protyle-wysiwyg--select"),u.forEach(p=>{p.removeAttribute("select-end")}),g.setAttribute("select-end","true");const m=g.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;m<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+m,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else u[0].parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],t),u[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){downSelect({protyle:t,event:n,nodeElement:c,editorElement:e,range:d,cb(u){const g=u[u.length-1],m=g.nextElementSibling;if(m&&m.getAttribute("data-node-id")){m.classList.add("protyle-wysiwyg--select"),u.forEach(b=>{b.removeAttribute("select-end")}),m.setAttribute("select-end","true");const p=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;p>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+p,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else g.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],t),g.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey("\u21E7\u2191",n)){upSelect({protyle:t,event:n,nodeElement:c,editorElement:e,range:d,cb(u){const g=getStartEndElement(u);if(g.startElement.getBoundingClientRect().top>=g.endElement.getBoundingClientRect().top){const m=g.endElement.previousElementSibling;if(m&&m.getAttribute("data-node-id")){m.classList.add("protyle-wysiwyg--select"),m.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end");const p=m.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;p<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+p,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else g.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],t),g.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{g.endElement.classList.remove("protyle-wysiwyg--select"),g.endElement.removeAttribute("select-end");const m=getPreviousBlock(g.endElement);m&&(m.setAttribute("select-end","true"),m.getBoundingClientRect().top<=t.contentElement.getBoundingClientRect().top&&(preventScroll(t),m.scrollIntoView(!0)))}}});return}if(matchHotKey("\u21E7\u2193",n)){downSelect({protyle:t,event:n,nodeElement:c,editorElement:e,range:d,cb(u){const g=getStartEndElement(u);if(g.startElement.getBoundingClientRect().top<=g.endElement.getBoundingClientRect().top){const m=g.endElement.nextElementSibling;if(m&&m.getAttribute("data-node-id")){m.classList.add("protyle-wysiwyg--select"),m.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end");const p=m.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;p>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+p,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else g.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],t),g.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{g.endElement.classList.remove("protyle-wysiwyg--select"),g.endElement.removeAttribute("select-end");const m=getNextBlock(g.endElement);m&&(m.setAttribute("select-end","true"),m.getBoundingClientRect().bottom>=t.contentElement.getBoundingClientRect().bottom&&(preventScroll(t),m.scrollIntoView(!1)))}}});return}if(matchHotKey(window.siyuan.config.keymap.general.enter.custom,n)){let u=getTopAloneElement(c);u.parentElement.classList.contains("li")&&u.parentElement.parentElement.classList.contains("list")&&((a=u.nextElementSibling)!=null&&a.classList.contains("list"))&&u.previousElementSibling.classList.contains("protyle-action")&&(u=u.parentElement),zoomOut({protyle:t,id:u.getAttribute("data-node-id")}),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,n)){if(t.block.showAll)zoomOut({protyle:t,id:t.block.parent2ID,focusId:c.getAttribute("data-node-id")});else{const u=t.path.split("/");u.length>2&&openFileById({app:t.app,id:u[u.length-2],action:[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL]})}n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&!isCtrl(n)&&(n.key==="Home"||n.key==="End")&&isMac()||n.shiftKey&&!n.altKey&&isCtrl(n)&&(n.key==="Home"||n.key==="End")&&!isMac()){const u=hasTopClosestByAttribute(c,"data-node-id",null);if(u){u.classList.add("protyle-wysiwyg--select");let g=n.key==="Home"?u.previousElementSibling:u.nextElementSibling;for(;g;)g.classList.add("protyle-wysiwyg--select"),g=n.key==="Home"?g.previousElementSibling:g.nextElementSibling;n.key==="Home"?t.wysiwyg.element.firstElementChild.scrollIntoView():t.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&isCtrl(n)&&n.key==="Home"){goHome(t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&isCtrl(n)&&n.key==="End"){goEnd(t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&!isCtrl(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(t.contentElement.scrollTop=t.contentElement.scrollTop-t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop+1):(t.contentElement.scrollTop=t.contentElement.scrollTop+t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop-1);const u=t.contentElement.getBoundingClientRect();let g=document.elementFromPoint(u.x+u.width/2,u.y+u.height/2);g.classList.contains("protyle-wysiwyg")&&(g=document.elementFromPoint(u.x+u.width/2,u.y+u.height/2+Constants.SIZE_TOOLBAR_HEIGHT));const m=hasClosestBlock(g);m&&!m.isSameNode(c)&&focusBlock(m,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&!isCtrl(n)||n.key==="Enter")&&!t.hint.element.classList.contains("fn__none")&&t.hint.select(n,t)){n.stopPropagation(),n.preventDefault();return}if(matchHotKey("\u2318/",n)){n.stopPropagation(),n.preventDefault();const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(u.length===0){const m=hasClosestByAttribute(d.startContainer,"data-type",null);if(m&&m.tagName==="SPAN"){const p=m.getAttribute("data-type").split(" ");if(p.length>0&&(t.toolbar.range=d,removeSearchMark(m)),p.includes("block-ref")){refMenu(t,m);return}else if(p.includes("inline-memo")){t.toolbar.showRender(t,m);return}else if(p.includes("file-annotation-ref")){t.toolbar.showFileAnnotationRef(t,m);return}else if(p.includes("a")){linkMenu(t,m);return}else if(p.includes("tag")){tagMenu(t,m);return}}if(d.startOffset===0&&d.startContainer.nodeType===3){const p=hasPreviousSibling(d.startContainer);if(p&&p.nodeType!==3&&p.getAttribute("data-type").indexOf("inline-math")>-1){t.toolbar.showRender(t,p);return}else if(!p&&d.startContainer.parentElement.previousSibling&&d.startContainer.parentElement.previousSibling.isSameNode(d.startContainer.parentElement.previousElementSibling)&&d.startContainer.parentElement.previousElementSibling.getAttribute("data-type").indexOf("inline-math")>-1){t.toolbar.showRender(t,d.startContainer.parentElement.previousElementSibling);return}}u.push(c)}u.length===1?t.gutter.renderMenu(t,u[0]):t.gutter.renderMultipleMenu(t,u);const g=c.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top},!0);return}if(fixTable(t,n,d)){n.preventDefault();return}const f=d.toString();if(!n.altKey&&!n.shiftKey&&!isCtrl(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const u=getContenteditableElement(c)||c,g=getSelectionOffset(u,t.wysiwyg.element,d),m=hasClosestByMatchTag(d.startContainer,"TD");if(n.key==="ArrowDown"&&(u==null?void 0:u.textContent.trimRight().substr(g.start).indexOf(`
`))===-1&&(m&&!m.parentElement.nextElementSibling&&c.getAttribute("data-type")==="NodeTable"&&!getNextBlock(c)||c.getAttribute("data-type")==="NodeCodeBlock"&&!getNextBlock(c)||c.parentElement.getAttribute("data-type")==="NodeBlockquote"&&c.nextElementSibling.classList.contains("protyle-attr")&&!getNextBlock(c.parentElement)))c.parentElement.getAttribute("data-type")==="NodeBlockquote"?insertEmptyBlock(t,"afterend",c.parentElement.getAttribute("data-node-id")):insertEmptyBlock(t,"afterend",c.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const p=getContenteditableElement(t.wysiwyg.element.firstElementChild);if(!getPreviousBlock(c)&&c.contains(p)||!p&&c.isSameNode(t.wysiwyg.element.firstElementChild))getSelectionPosition(c,d).top-t.wysiwyg.element.getBoundingClientRect().top<40&&(t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8));else if((u==null?void 0:u.textContent.substr(0,g.end).indexOf(`
`))===-1){let b=getPreviousBlock(c);if(b&&(b=getLastBlock(b),b)){const v=hasClosestByAttribute(b,"fold","1");(s=getContenteditableElement(b))!=null&&s.textContent.endsWith(`
`)&&!v?(focusBlock(b,void 0,!1),scrollCenter(t,b),n.stopPropagation(),n.preventDefault()):v&&v.getAttribute("data-type")!=="NodeListItem"&&(v.scrollTop=0,focusBlock(v,void 0,!0),scrollCenter(t,v),n.stopPropagation(),n.preventDefault())}}}else if(f===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&c.isSameNode(getLastBlock(t.wysiwyg.element.lastElementChild))&&!hasClosestByMatchTag(d.startContainer,"TD")&&!hasClosestByMatchTag(d.startContainer,"TH")){const p=getContenteditableElement(c);p&&p.textContent.replace(/\n$/,"").length<=getSelectionOffset(p,void 0,d).end&&(n.stopPropagation(),n.preventDefault(),focusByRange(d))}else if(f===""&&n.key==="ArrowLeft"&&c.isSameNode(getFirstBlock(t.wysiwyg.element.firstElementChild))){const p=getContenteditableElement(c);p&&getSelectionOffset(p,void 0,d).start===0&&(n.stopPropagation(),n.preventDefault(),focusByRange(d))}if(n.key==="ArrowDown"){const p=hasClosestByAttribute(d.startContainer,"fold","1");if(p){let b=getNextBlock(p);b&&(b.getAttribute("fold")==="1"&&(b.classList.contains("sb")||b.classList.contains("bq"))||(b=getFirstBlock(b)),focusBlock(b),scrollCenter(t,b)),n.stopPropagation(),n.preventDefault()}else if((u==null?void 0:u.textContent.substr(g.end+1).indexOf(`
`))===-1){const b=getNextBlock(c);b&&b.getAttribute("fold")==="1"&&(focusBlock(b),scrollCenter(t,b),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")){if(t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}if(f===""&&n.key==="Backspace"&&d.startOffset===d.startContainer.textContent.length&&d.startContainer.textContent.endsWith(`
`+Constants.ZWSP)){d.setStart(d.startContainer,d.startOffset-1),d.collapse(!0),n.stopPropagation(),n.preventDefault();return}const u=hasPreviousSibling(d.startContainer);if(d.startOffset===1&&d.startContainer.textContent===Constants.ZWSP&&u&&u.nodeType!==3&&n.key==="Backspace"){if(u.classList.contains("img"))u.classList.add("img--select");else if(((i=u.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){u.after(document.createElement("wbr"));const m=c.outerHTML;d.startContainer.textContent="",u.remove(),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),focusByWbr(c,d),n.stopPropagation(),n.preventDefault();return}}if(d.startOffset===0&&f===""&&u&&((o=u.parentElement.getAttribute("data-type"))==null?void 0:o.indexOf("backslash"))>-1&&u.nodeType!==3&&u.outerHTML==="<span>\\</span>"&&!hasPreviousSibling(u.parentElement)){d.setStartBefore(u.parentElement),removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}if(d.startOffset===1&&d.startContainer.nodeType!==3&&((l=d.startContainer.parentElement.getAttribute("data-type"))==null?void 0:l.indexOf("backslash"))>-1&&!hasPreviousSibling(d.startContainer.parentElement)){d.setStartBefore(d.startContainer.parentElement),removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}const g=t.wysiwyg.element.querySelector(".img--select");if(g){if(g.classList.remove("img--select"),c.contains(g)){g.insertAdjacentHTML("afterend","<wbr>");const m=c.outerHTML;g.remove(),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),focusByWbr(c,d),n.stopPropagation(),n.preventDefault();return}}else if(f===""){const m=getContenteditableElement(c);if(!m){c.classList.add("protyle-wysiwyg--select"),removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}const p=getSelectionOffset(m,t.wysiwyg.element,d);if(n.key==="Delete"){if(p.end===m.textContent.length){const b=getNextBlock(getTopAloneElement(c));if(b){const v=focusBlock(b);if(v){const h=hasClosestBlock(v.startContainer);h&&removeBlock(t,h,v)}n.stopPropagation(),n.preventDefault();return}}else if(p.end===m.textContent.length-1&&c.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}}else{const b=d.startContainer.childNodes[d.startOffset-1];if(p.start===0&&(d.startOffset===0||b&&b.nodeType===3&&!hasPreviousSibling(b)&&b.textContent==="")){removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}if(d.startContainer.nodeType!==3&&c.getAttribute("data-type")==="NodeTable"&&((r=d.startContainer.children[d.startOffset-1])==null?void 0:r.tagName)==="TABLE"){c.classList.add("protyle-wysiwyg--select"),removeBlock(t,c,d),n.stopPropagation(),n.preventDefault();return}if(b&&b.nodeType!==3&&b.classList.contains("img")){d.insertNode(document.createElement("wbr"));const v=c.outerHTML;b.remove(),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,v),focusByWbr(c,d),n.stopPropagation(),n.preventDefault();return}if(c.classList.contains("code-block")&&isCtrl(n)&&d.startContainer.nodeType===3&&d.startContainer.textContent.substring(d.startOffset-1,d.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}}}else if(c.classList.contains("code-block")&&getContenteditableElement(c).textContent===`
`){d.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(matchHotKey("\u21E7\u21A9",n)&&f===""){let u=d.startContainer;const g=hasNextSibling(u);if(g&&g.nodeType!==3&&g.classList.contains("img")){g.insertAdjacentHTML("beforebegin","<wbr>");const m=c.outerHTML;g.previousElementSibling.remove();const p=document.createTextNode(`
`);u.after(document.createTextNode(Constants.ZWSP)),u.after(p),d.selectNode(p),d.collapse(!1),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),n.stopPropagation(),n.preventDefault();return}if(u.nodeType===3&&(u=u.parentElement),u&&t.toolbar.getCurrentType(d).length>0&&getSelectionOffset(u,u,d).end===u.textContent.length){u.insertAdjacentHTML("afterend","<wbr>");const m=c.outerHTML;u.nextElementSibling.remove(),hasNextSibling(u)||u.after(document.createTextNode(`
`));const p=document.createTextNode(`
`);u.after(p),d.selectNode(p),d.collapse(!1),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),n.stopPropagation(),n.preventDefault();return}if(window.siyuan.config.system.container==="ios"){u=d.startContainer;const m=hasNextSibling(u);if(m&&m.textContent.trim()!==""){document.execCommand("insertHTML",!1,`
`),n.stopPropagation(),n.preventDefault();return}m||u.after(document.createTextNode(`
`));const p=document.createTextNode(`
`);u.after(p);const b=hasNextSibling(p);b&&b.textContent===`
`?d.setStart(b,0):d.setStart(p,0),d.collapse(!1),focusByRange(d),n.stopPropagation(),n.preventDefault();return}}if(!n.altKey&&!n.shiftKey&&!isCtrl(n)&&n.key==="Enter"){n.stopPropagation(),n.preventDefault(),enter(c,d,t);return}if(matchHotKey("\u2318A",n))return n.preventDefault(),selectAll(t,c,d),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.undo.custom,n)){t.undo.undo(t),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.redo.custom,n)){t.undo.redo(t),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let g;return u.length===1?g=u[0]:g=c,writeText(`siyuan://blocks/${g.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,n))return writeText(c.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,n)){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let g;u.length===1?g=u[0]:g=c;const m=g.getAttribute("data-node-id");return f!==""?writeText(`((${m} "${Lute.EscapeHTMLStr(f)}"))`):fetchPost("/api/block/getRefText",{id:m},p=>{writeText(`((${m} '${p.data}'))`)}),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let g;return u.length===1?g=u[0]:g=c,writeText(`{{select * from blocks where id='${g.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,n)){const u=[];return t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(g=>{u.push(g)}),u.length===0&&u.push(c),quickMakeCard(t,u),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,n)){const u=getTopAloneElement(c);if(f===""){const g=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let m;g.length===1?m=g[0]:m=u,openAttr(m,t)}else{const g=u.outerHTML,m=Lute.EscapeHTMLStr(f),p=u.lastElementChild.querySelector(".protyle-attr--name");p?p.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${m}`:u.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${m}</div>`),u.setAttribute("name",m),updateTransaction(t,u.getAttribute("data-node-id"),u.outerHTML,g)}return n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.rename.custom,n)){f===""?fetchPost("/api/block/getDocInfo",{id:t.block.rootID},u=>{rename({notebookId:t.notebookId,path:t.path,name:u.data.ial.title,range:d,type:"file"})}):fetchPost("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:replaceFileName(f)}),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newNameFile.custom,n)){if(!(!f.trim()&&(c.querySelector("tr")||c.querySelector("span")))){!f.trim()&&getContenteditableElement(c).textContent&&selectAll(t,c,d);const u=replaceFileName(f.trim()?f.trim():t.lute.BlockDOM2Content(c.outerHTML).replace(/\n/g,""))||"Untitled";fetchPost("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.path},g=>{fetchPost("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:pathPosix().join(g.data,u),parentID:t.block.rootID,markdown:""},m=>{insertHTML(`<span data-type="block-ref" data-id="${m.data}" data-subtype="d">${escapeHtml(u.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),hideElements(["toolbar"],t)})})}n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!f.trim()&&(c.querySelector("tr")||c.querySelector("span"))||(!f.trim()&&getContenteditableElement(c).textContent&&selectAll(t,c,d),getSavePath(t.path,t.notebookId,u=>{const g=replaceFileName(f.trim()?f.trim():t.lute.BlockDOM2Content(c.outerHTML).replace(/\n/g,""))||"Untitled";fetchPost("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:pathPosix().join(u,g),parentID:t.block.rootID,markdown:""},m=>{insertHTML(`<span data-type="block-ref" data-id="${m.data}" data-subtype="d">${escapeHtml(g.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),hideElements(["toolbar"],t)})})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){newFileContentBySelect(t),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const u=c.querySelectorAll(".img--select");if(u.length>0)alignImgLeft(t,c,Array.from(u),c.getAttribute("data-node-id"),c.outerHTML);else{let g=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));g.length===0&&(g=[c]),updateBatchTransaction(g,t,m=>{m.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const u=c.querySelectorAll(".img--select");if(u.length>0)alignImgCenter(t,c,Array.from(u),c.getAttribute("data-node-id"),c.outerHTML);else{let g=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));g.length===0&&(g=[c]),updateBatchTransaction(g,t,m=>{m.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));u.length===0&&(u=[c]),updateBatchTransaction(u,t,g=>{g.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){!t.toolbar.element.classList.contains("fn__none")||!t.hint.element.classList.contains("fn__none")||!t.toolbar.subElement.classList.contains("fn__none")?(hideElements(["toolbar","hint","util"],t),t.hint.enableExtend=!1):c.classList.contains("protyle-wysiwyg--select")?(hideElements(["select"],t),countBlockWord([],t.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(hideElements(["select"],t),d.collapse(!1),c.classList.add("protyle-wysiwyg--select"),countBlockWord([c.getAttribute("data-node-id")],t.block.rootID)):window.siyuan.menus.menu.remove(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.heading.paragraph.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Ps"}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return turnsIntoTransaction({protyle:t,nodeElement:c,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(c.getAttribute("data-type"))){const u=c.getAttribute("data-node-id"),g=c.outerHTML,m=getContenteditableElement(c);m.innerHTML="```"+window.siyuan.storage[Constants.LOCAL_CODELANG]+`
`+m.textContent+"<wbr>\n```";const p=t.lute.SpinBlockDOM(c.outerHTML);c.outerHTML=p;const b=t.wysiwyg.element.querySelector(`[data-node-id="${u}"]`);return updateTransaction(t,u,p,g),highlightRender(b),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){t.toolbar.range=d;let u=[];f===""&&(u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),u.length===0&&(u=[c])),fontEvent(t,u),n.stopPropagation(),n.preventDefault();return}if(!c.classList.contains("code-block")&&!n.repeat){let u=!1;if(t.options.toolbar.find(g=>{if(!g.hotkey)return!1;if(matchHotKey(g.hotkey,n))return t.toolbar.range=getEditorRange(t.wysiwyg.element),["block-ref"].includes(g.name)&&t.toolbar.range.toString()===""||(u=!0,["a","block-ref","inline-math","inline-memo","text"].includes(g.name)?t.toolbar.element.querySelector(`[data-type="${g.name}"]`).dispatchEvent(new CustomEvent("click")):t.toolbar.setInlineMark(t,g.name,"range")),!0}),u)return n.preventDefault(),n.stopPropagation(),t.wysiwyg.preventKeyup=!0,!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(u.length>0&&u[0].getAttribute("data-type")==="NodeListItem")return listOutdent(t,Array.from(u),d),n.preventDefault(),n.stopPropagation(),!0;if(c.parentElement.classList.contains("li")&&c.getAttribute("data-type")!=="NodeCodeBlock")return listOutdent(t,[c.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.indent.custom,n)){const u=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(u.length>0&&u[0].getAttribute("data-type")==="NodeListItem")return listIndent(t,Array.from(u),d),n.preventDefault(),n.stopPropagation(),!0;if(c.parentElement.classList.contains("li")&&c.getAttribute("data-type")!=="NodeCodeBlock")return listIndent(t,[c.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.check.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill("* [ ] "+Lute.Caret,t),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.insert.table.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,t),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const u=hasClosestByAttribute(d.startContainer,"data-subtype","t");if(!u)return;const g=u.outerHTML;u.classList.contains("protyle-task--done")?(u.querySelector("use").setAttribute("xlink:href","#iconUncheck"),u.classList.remove("protyle-task--done")):(u.querySelector("use").setAttribute("xlink:href","#iconCheck"),u.classList.add("protyle-task--done")),u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,u.getAttribute("data-node-id"),u.outerHTML,g),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return insertEmptyBlock(t,"beforebegin"),n.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return insertEmptyBlock(t,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return jumpToParentNext(t,c),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),moveToUp(t,c,d);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),moveToDown(t,c,d);return}if(isNotEditBlock(c)&&c.getAttribute("data-type")!=="NodeHTMLBlock"&&matchHotKey("\u2318C",n)){let u="";t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(g=>{u+=removeEmbed(g)}),writeText(t.lute.BlockDOM2StdMd(u).trimEnd())}if(isNotEditBlock(c)&&matchHotKey("\u2318X",n)){let u="";c.classList.add("protyle-wysiwyg--select");const g=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");g.forEach(p=>{u+=removeEmbed(p)}),writeText(t.lute.BlockDOM2StdMd(u).trimEnd());const m=getNextBlock(g[g.length-1]);removeBlock(t,c,d),m&&focusBlock(m),n.preventDefault(),n.stopPropagation()}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyPlainText.custom,n)){if(f===""){const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let g="";u.length===0&&u.push(c),u.forEach(m=>{m.querySelectorAll("[spellcheck]").forEach(p=>{const b=p.cloneNode(!0);b.querySelectorAll('[data-type="backslash"]').forEach(v=>{v.firstElementChild.remove()}),g+=b.textContent+`
`})}),copyPlainText(g.trimEnd())}else{const u=d.cloneContents();u.querySelectorAll('[data-type="backslash"]').forEach(g=>{g.firstElementChild.remove()}),writeText(u.textContent)}n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(u.length<2)return;turnsIntoOneTransaction({protyle:t,selectsElement:u,type:"BlocksMergeSuperBlock",level:"row"});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(u.length<2)return;turnsIntoOneTransaction({protyle:t,selectsElement:u,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.duplicate.custom,n)){n.preventDefault(),n.stopPropagation();let u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));u.length===0&&(u=[c]),duplicateBlock(u,t);return}if(n.key==="Tab"&&!n.ctrlKey&&!isCtrl(n)&&!n.altKey){n.preventDefault();const u=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(c.getAttribute("data-type")==="NodeCodeBlock"&&f!==""){const g=document.createElement("wbr");d.insertNode(g),d.setStartAfter(g);const m=c.outerHTML;let p="";n.shiftKey?d.extractContents().textContent.split(`
`).forEach(h=>{h.startsWith(u)?p+=h.replace(u,"")+`
`:p+=h+`
`}):d.extractContents().textContent.split(`
`).forEach(h=>{p+=u+h+`
`});const b=document.createElement("span");let v=c.querySelector(".protyle-action__language").textContent;hljs.getLanguage(v)||(v="plaintext"),b.innerHTML=hljs.highlight(p.substr(0,p.length-1),{language:v,ignoreIllegals:!0}).value,d.insertNode(b),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),g.remove();return}if(!n.shiftKey){const g=document.createElement("wbr");d.insertNode(g);const m=c.outerHTML;return d.extractContents(),d.insertNode(document.createTextNode(u)),d.collapse(!1),focusByRange(d),g.remove(),updateTransaction(t,c.getAttribute("data-node-id"),c.outerHTML,m),!0}}if(n.key==="ContextMenu"){const u=getSelectionPosition(c,d);t.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:c,y:u.top+8,x:u.left}})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),pasteAsPlainText(t);return}!isCtrl(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&hideElements(["select"],t)})},hl=(t,e,n)=>{const a=isMobile(),s=hasClosestByClassName(t.target,"protyle-attr--bookmark");if(s)return!a&&(t.ctrlKey||t.metaKey)||(n?openFileAttr(n,e.block.rootID,"bookmark"):openAttr(s.parentElement.parentElement,e,"bookmark")),t.stopPropagation(),!0;const i=hasClosestByClassName(t.target,"protyle-attr--name");if(i)return!a&&(t.ctrlKey||t.metaKey)||(n?openFileAttr(n,e.block.rootID,"name"):openAttr(i.parentElement.parentElement,e,"name")),t.stopPropagation(),!0;const o=hasClosestByClassName(t.target,"protyle-attr--alias");if(o)return!a&&(t.ctrlKey||t.metaKey)||(n?openFileAttr(n,e.block.rootID,"alias"):openAttr(o.parentElement.parentElement,e,"alias")),t.stopPropagation(),!0;const l=hasClosestByClassName(t.target,"protyle-attr--memo");if(l)return!a&&(t.ctrlKey||t.metaKey)||(n?openFileAttr(n,e.block.rootID,"memo"):openAttr(l.parentElement.parentElement,e,"memo")),t.stopPropagation(),!0},yl=(t,e)=>{const n=hasClosestBlock(e.target);if(!n)return!1;const a=hasClosestByAttribute(e.target,"data-type","av-header-add");if(a){const o=new Menu("av-header-add");o.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const r=Lute.NewNodeID(),d="text";transaction(t,[{action:"addAttrViewCol",name:"Text",parentID:n.getAttribute("data-av-id"),type:d,id:r}],[{action:"removeAttrViewCol",id:r,parentID:n.getAttribute("data-av-id")}])}});const l=a.getBoundingClientRect();return o.open({x:l.left,y:l.bottom,h:l.height}),e.preventDefault(),e.stopPropagation(),!0}if(hasClosestByClassName(e.target,"av__firstcol"))return e.preventDefault(),e.stopPropagation(),!0;const i=hasClosestByClassName(e.target,"av__cell");return i?(i.parentElement.classList.contains("av__row--header")?(showHeaderCellMenu(t,n,i),e.preventDefault(),e.stopPropagation()):popTextCell(t,i),!0):!1},wl=(t,e,n)=>{const a=hasClosestByClassName(n,"av__row");if(!a)return!1;const s=hasClosestBlock(a);if(!s)return!1;e.preventDefault(),e.stopPropagation(),s.querySelectorAll(".av__row--select").forEach(r=>{r.classList.remove("av__row--select")});const i=a.getAttribute("data-id"),o=new Menu("av-row");if(o.isOpen)return!0;a.classList.add("av__row--select"),o.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){}}),o.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var r;transaction(t,[{action:"removeAttrViewBlock",id:s.getAttribute("data-node-id"),parentID:s.getAttribute("data-av-id")}],[{action:"insertAttrViewBlock",id:s.getAttribute("data-node-id"),parentID:s.getAttribute("data-av-id"),previousID:((r=a.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcIDs:[i]}]),a.remove()}}),o.addSeparator(),openEditorTab(t.app,i),o.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu(i)}),o.addSeparator(),o.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){}});const l=[];return a.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(r=>{l.push({icon:getColIconByType(r.getAttribute("data-dtype")),label:r.textContent.trim(),click(){}})}),o.addItem({icon:"iconList",label:window.siyuan.languages.attr,type:"submenu",submenu:l}),o.open({x:e.clientX,y:e.clientY}),!0};class _l{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),navigator&&navigator.maxTouchPoints>1&&navigator.platform==="MacIntel"?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(Constants.CB_GET_HISTORY)&&(this.bindEvent(e),keydown(e,this.element),dropEvent(e,this.element))}renderCustom(e){const n=Object.keys(e);for(let a=0;a<this.element.attributes.length;a++){const s=this.element.attributes[a].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","scroll"].includes(s)&&!n.includes(s)&&(this.element.removeAttribute(s),a--)}n.forEach(a=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style"].includes(a)||this.element.setAttribute(a,e[a])})}escapeInline(e,n,a){if(!a.data)return;const s=a.data;e.toolbar.range=n;const i=n.startContainer.parentElement,o=e.toolbar.getCurrentType();let l=s.length;if((s==="<"||s===">")&&(l=4),o.length>0&&n.toString()===""&&n.startOffset===s.length&&i.tagName==="SPAN"&&i.textContent.replace(Constants.ZWSP,"")!==s&&i.textContent.replace(Constants.ZWSP,"").length>=s.length&&!hasPreviousSibling(n.startContainer)&&!hasPreviousSibling(i)){const r=i.innerHTML.replace(Constants.ZWSP,"");i.innerHTML=r.substr(l);const d=document.createTextNode(s);i.before(d),n.selectNodeContents(d),n.collapse(!1);return}if(i.tagName==="SPAN"&&i.textContent!==s&&!o.includes("search-mark")&&n.toString()===""&&n.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("text")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!hasNextSibling(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&i.textContent.length>s.length){const r=getSelectionOffset(i,e.wysiwyg.element,n),d=i.innerHTML;if(r.start===i.textContent.length){i.innerHTML=d.substr(0,d.length-l);const c=document.createTextNode(s);i.after(c),n.selectNodeContents(c),n.collapse(!1)}}}setEmptyOutline(e,n){const a=e.wysiwyg.element.querySelector(".img--select");a&&a.classList.remove("img--select");let s=n;if(!n.getAttribute("data-node-id")){const i=hasClosestBlock(n);if(!i)return;s=i}}emojiToMd(e){e.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const a=getEditorRange(e.wysiwyg.element),s=hasClosestBlock(a.startContainer);if(!s)return;const i=s.querySelector(".img--select");let o=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));o.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!i&&(s.classList.add("protyle-wysiwyg--select"),countBlockWord([s.getAttribute("data-node-id")]),o=[s]);let l="",r="";if(o.length>0){const d=o[0].getAttribute("data-reftext")==="true";if(o[0].getAttribute("data-type")==="NodeListItem"&&o[0].parentElement.classList.contains("list")&&o[0].parentElement.childElementCount-1===o.length)if(d){const c=o[0].parentElement.cloneNode(!0),f=getContenteditableElement(c);f&&f.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${c.getAttribute("data-node-id")}">*</span>`),l=c.outerHTML,o[0].removeAttribute("data-reftext")}else l=o[0].parentElement.outerHTML;else o.forEach((c,f)=>{const u=getTopAloneElement(c);if(d&&f===0){const g=u.cloneNode(!0),m=getContenteditableElement(g);m&&m.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),l+=removeEmbed(g),o[0].removeAttribute("data-reftext")}else l+=removeEmbed(u)})}else{const d=document.createElement("div"),c=e.toolbar.getCurrentType(a);if((c.length>0||a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(a.startContainer.nodeType===3&&a.startContainer.parentElement.textContent===a.toString()||a.startContainer.nodeType!==3&&a.startContainer.textContent===a.toString()))a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?d.append(a.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(d.append(a.cloneContents()),this.emojiToMd(d)):(d.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(d)),l=d.innerHTML;else if(i)l=i.outerHTML;else if(c.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const f=a.startContainer.parentElement.attributes,u=document.createElement("span");for(let g=0;g<f.length;g++)u.setAttribute(f[g].name,f[g].value);u.getAttribute("data-type").indexOf("block-ref")>-1&&u.getAttribute("data-subtype")==="d"&&u.setAttribute("data-subtype","s"),u.textContent=a.toString(),l=u.outerHTML}else{d.append(a.cloneContents()),this.emojiToMd(d);const f=hasClosestByAttribute(a.commonAncestorContainer,"data-type","inline-math");f?l=f.outerHTML:l=d.innerHTML,(hasClosestByAttribute(a.startContainer,"data-type","NodeCodeBlock")||hasClosestByMatchTag(a.startContainer,"CODE"))&&(r=d.textContent.replace(Constants.ZWSP,""))}}e.disabled&&(l=getEnableHTML(l)),n.clipboardData.setData("text/plain",r||e.lute.BlockDOM2StdMd(l).trimEnd()),n.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(l)),n.clipboardData.setData("text/siyuan",l)}),this.element.addEventListener("mousedown",n=>{var a;if(n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed||hideElements(["select"],e);const s=n.target;if(hasClosestByClassName(s,"protyle-action"))return;const i=document,o=e.element.getBoundingClientRect(),l=o.left+parseInt(e.wysiwyg.element.style.paddingLeft)+1,r=l+(e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight))-1,d=o.bottom,c=n.clientY;if(!e.disabled&&s.classList.contains("protyle-action__drag")){const h=hasClosestBlock(s);if(!h)return;let _=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(h.getAttribute("data-type"))?(h.classList.add("iframe--drag"),(h.style.textAlign==="left"||h.style.textAlign==="right")&&(_=!1)):s.parentElement.parentElement.getAttribute("data-type")==="img"&&s.parentElement.parentElement.classList.add("img--drag");const C=h.getAttribute("data-node-id"),k=h.outerHTML,E=n.clientX,L=s.previousElementSibling,w=L.clientWidth,y=L.clientHeight;i.onmousemove=A=>{L.tagName==="IMG"&&(L.parentElement.parentElement.style.width=""),A.clientX>E-w+8&&A.clientX<r&&(L.tagName==="IMG"&&L.parentElement.parentElement.style.display!=="block"||!_?L.style.width=Math.max(17,w+(A.clientX-E))+"px":L.style.width=Math.max(17,w+(A.clientX-E)*2)+"px"),L.tagName!=="IMG"?A.clientY>c-y+8&&A.clientY<d&&(L.style.height=y+(A.clientY-c)+"px"):L.parentElement.parentElement.style.maxWidth=parseInt(L.style.width)+10+"px"},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,s.classList.contains("protyle-action__drag")&&h&&updateTransaction(e,C,h.outerHTML,k),h.classList.remove("iframe--drag"),s.parentElement.parentElement.classList.remove("img--drag")};return}let f;if((s.tagName==="TH"||s.tagName==="TD"||((a=s.firstElementChild)==null?void 0:a.tagName)==="TABLE"||s.classList.contains("table__resize")||s.classList.contains("table__select"))&&(f=hasClosestBlock(s),f&&(f.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),n.stopPropagation())),!e.disabled&&s.classList.contains("table__resize")){const h=hasClosestBlock(s);if(!h)return;const _=h.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),h.firstElementChild.style.webkitUserModify="read-only",h.style.cursor="col-resize",s.removeAttribute("style");const C=h.getAttribute("data-node-id"),k=n.clientX,E=parseInt(s.getAttribute("data-col-index")),L=h.querySelectorAll("table col")[E];L.style.minWidth&&(L.style.width=h.querySelectorAll("table td, table th")[E].offsetWidth+"px",L.style.minWidth=""),h.querySelectorAll("tr").forEach(A=>{A.cells[E].style.width=""});const w=L.clientWidth,y=h.firstElementChild.clientWidth<h.firstElementChild.scrollWidth;i.onmousemove=A=>{h.style.textAlign==="center"&&!y?L.style.width=w+(A.clientX-k)*2+"px":L.style.width=w+(A.clientX-k)+"px"},i.onmouseup=()=>{h.firstElementChild.style.webkitUserModify="",h.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,h&&updateTransaction(e,C,h.outerHTML,_)};return}if(["IMG","VIDEO","AUDIO"].includes(s.tagName))return;let u=n.clientX;n.clientX>r?u=r:n.clientX<l&&(u=l);const g=o.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let m,p,b,v;i.onmousemove=h=>{const _=h.target;if(!e.disabled&&f&&f.contains(_)&&!hasClosestByClassName(f,"protyle-wysiwyg__embed")){if((_.tagName==="TH"||_.tagName==="TD")&&!_.isSameNode(s)&&(!p||!p.isSameNode(_))){f.firstElementChild.style.webkitUserModify="read-only";let z=s.offsetLeft+s.clientWidth-_.offsetLeft,Q=_.offsetLeft;s.offsetLeft===_.offsetLeft?z=Math.max(s.clientWidth,_.clientWidth):s.offsetLeft<_.offsetLeft&&(z=_.offsetLeft+_.clientWidth-s.offsetLeft,Q=s.offsetLeft);let V=s.offsetTop+s.clientHeight-_.offsetTop,ie=_.offsetTop;s.offsetTop===_.offsetTop?V=Math.max(s.clientHeight,_.clientHeight):s.offsetTop<_.offsetTop&&(V=_.offsetTop+_.clientHeight-s.offsetTop,ie=s.offsetTop),Array.from(f.querySelectorAll("th, td")).find($=>{const ge=$.offsetLeft<Q+z&&$.offsetLeft+$.clientWidth>Q+z,Z=$.offsetLeft<Q&&$.offsetLeft+$.clientWidth>Q;$.offsetTop<ie&&$.offsetTop+$.clientHeight>ie?(($.offsetLeft+6>Q&&$.offsetLeft+$.clientWidth-6<Q+z||ge||Z)&&(V=ie+V-$.offsetTop,ie=$.offsetTop),ge&&(z=$.offsetLeft+$.clientWidth-Q),Z&&(z=Q+z-$.offsetLeft,Q=$.offsetLeft)):$.offsetTop<ie+V&&$.offsetTop+$.clientHeight>ie+V?(($.offsetLeft+6>Q&&$.offsetLeft+$.clientWidth-6<Q+z||ge||Z)&&(V=$.clientHeight+$.offsetTop-ie),ge&&(z=$.offsetLeft+$.clientWidth-Q),Z&&(z=Q+z-$.offsetLeft,Q=$.offsetLeft)):Z&&$.offsetTop+6>ie&&$.offsetTop+$.clientHeight-6<ie+V?(z=Q+z-$.offsetLeft,Q=$.offsetLeft):ge&&$.offsetTop+6>ie&&$.offsetTop+$.clientHeight-6<ie+V&&(z=$.offsetLeft+$.clientWidth-Q)}),f.querySelector(".table__select").setAttribute("style",`left:${Q-f.firstElementChild.scrollLeft}px;top:${ie}px;height:${V}px;width:${z+1}px;`),p=_}return}e.selectElement.classList.remove("fn__none"),hideElements(["gutter"],e);let C=0,k=0,E=0,L=0;if(h.clientX<u?(h.clientX<l?k=l:k=h.clientX,E=u-k):h.clientX>r?(k=u,E=r-k):(k=u,E=h.clientX-u),h.clientY>c?h.clientY>d?(C=c,L=d-c):(C=c,L=h.clientY-c):(h.clientY<g?C=g:C=h.clientY,L=c-C),L<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${C}px;height:${L}px;left:${k+2}px;width:${E-2}px;`);const w=document.elementFromPoint(h.clientX,h.clientY);if(m&&m.isSameNode(w)&&!m.classList.contains("protyle-wysiwyg")&&!m.classList.contains("list")&&!m.classList.contains("bq")&&!m.classList.contains("sb"))return;m=w,hideElements(["select"],e);let y;if(h.clientY>c?(y=b||document.elementFromPoint(k-1,C),v=void 0):(y=document.elementFromPoint(k-1,C),b=void 0),!y||((y.classList.contains("protyle-wysiwyg")||y.classList.contains("list")||y.classList.contains("sb")||y.classList.contains("bq"))&&(y=document.elementFromPoint(k-1,C+16)),!y))return;let A=hasClosestBlock(y);h.clientY>c?b||(b=y):!A&&h.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(A=e.wysiwyg.element.firstElementChild);let M=[],x=A,B=!1;const K=v?v.getBoundingClientRect().bottom:C+L;for(;x;)if(x&&!x.classList.contains("protyle-attr")){const z=x.getBoundingClientRect();if(z.height>0&&z.top<K&&z.left<k+E)if(B)if(x.nextElementSibling&&!x.nextElementSibling.classList.contains("protyle-attr")){const Q=x.nextElementSibling.getBoundingClientRect();if(Q.top<K&&Q.left<k+E)M=[x],x=x.nextElementSibling,B=!1;else if(x.parentElement.classList.contains("sb"))x=hasClosestBlock(x.parentElement),B=!0;else break}else x=hasClosestBlock(x.parentElement),B=!0;else M.push(x),x=x.nextElementSibling;else if(x.parentElement.classList.contains("sb"))x=hasClosestBlock(x.parentElement),B=!0;else if(z.height===0&&z.width===0&&x.parentElement.getAttribute("fold")==="1")x=x.parentElement,M=[];else break}else x=hasClosestBlock(x.parentElement),B=!0;h.clientY<=c&&!v&&(v=M[M.length-1]),M.length===1&&!M[0].classList.contains("list")&&!M[0].classList.contains("bq")&&!M[0].classList.contains("sb")?e.selectElement.style.backgroundColor="transparent":(M.forEach(z=>{hasClosestByClassName(z,"protyle-wysiwyg__embed")||z.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},i.onmouseup=h=>{var _;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,b=void 0,v=void 0,e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),!e.disabled&&f){f.firstElementChild.style.webkitUserModify="";const E=f.querySelector(".table__select");E.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.mergeCell,click:()=>{if(f){const L=[],w=[],y=f.querySelectorAll("th").length;let A=0;const M=f.firstElementChild.scrollLeft;let x=!1,B=!1;f.querySelectorAll("th, td").forEach((Z,xe)=>{Z.classList.contains("fn__none")?(Z.previousElementSibling&&Z.previousElementSibling.isSameNode(L[L.length-1])||xe<A&&w.includes((xe+1)%y))&&(L.push(Z),!x&&Z.parentElement.parentElement.tagName==="THEAD"?x=!0:!B&&Z.parentElement.parentElement.tagName==="TBODY"&&(B=!0)):Z.offsetLeft+6>E.offsetLeft+M&&Z.offsetLeft+Z.clientWidth-6<E.offsetLeft+M+E.clientWidth&&Z.offsetTop+6>E.offsetTop&&Z.offsetTop+Z.clientHeight-6<E.offsetTop+E.clientHeight&&(L.push(Z),!x&&Z.parentElement.parentElement.tagName==="THEAD"?x=!0:!B&&Z.parentElement.parentElement.tagName==="TBODY"&&(B=!0),w.push((xe+1)%y),A=Math.max((Z.rowSpan-1)*y+xe+1,A))}),E.removeAttribute("style");const K=f.outerHTML;let z=L[0],Q=z.colSpan,V=1;for(;z.nextElementSibling&&z.nextElementSibling.isSameNode(L[V]);)z=z.nextElementSibling,z.classList.contains("fn__none")||(Q+=z.colSpan),V++;let ie="",$=L[0].parentElement,ge=L[0].rowSpan;if(L.forEach((Z,xe)=>{let Me=Z.innerHTML.trim();Me.endsWith("<br>")&&(Me=Me.substr(0,Me.length-4)),ie+=Me+(!Me||xe===L.length-1?"":"<br>"),xe!==0&&($.isSameNode(Z.parentElement)||(Z.classList.contains("fn__none")||(ge+=Z.rowSpan),$=Z.parentElement,L[0].parentElement.parentElement.tagName==="THEAD"&&Z.parentElement.parentElement.tagName!=="THEAD"&&L[0].parentElement.parentElement.insertAdjacentElement("beforeend",Z.parentElement)),Z.classList.add("fn__none"),Z.innerHTML="")}),x&&B)for($=$.parentElement.nextElementSibling.firstElementChild;$&&$.parentElement.tagName!=="THEAD";){let Z=0,xe=0;if(Array.from($.children).forEach(Me=>{Z+=Me.colSpan-1,Me.classList.contains("fn__none")&&xe++}),Z!==xe)L[0].parentElement.parentElement.insertAdjacentElement("beforeend",$),$=$.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{f&&(L[0].innerHTML=ie+"<wbr>",L[0].colSpan=Q,L[0].rowSpan=ge,focusByWbr(L[0],document.createRange()),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,K))})}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(f){const L=[],w=f.firstElementChild.scrollLeft;f.querySelectorAll("th, td").forEach(y=>{!y.classList.contains("fn__none")&&y.offsetLeft+6>E.offsetLeft+w&&y.offsetLeft+y.clientWidth-6<E.offsetLeft+w+E.clientWidth&&y.offsetTop+6>E.offsetTop&&y.offsetTop+y.clientHeight-6<E.offsetTop+E.clientHeight&&(L.length===0||L.length>0&&y.offsetTop===L[0].offsetTop)&&L.push(y)}),E.removeAttribute("style"),setTableAlign(e,L,f,"left",getEditorRange(f))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(f){const L=[],w=f.firstElementChild.scrollLeft;f.querySelectorAll("th, td").forEach(y=>{!y.classList.contains("fn__none")&&y.offsetLeft+6>E.offsetLeft+w&&y.offsetLeft+y.clientWidth-6<E.offsetLeft+w+E.clientWidth&&y.offsetTop+6>E.offsetTop&&y.offsetTop+y.clientHeight-6<E.offsetTop+E.clientHeight&&(L.length===0||L.length>0&&y.offsetTop===L[0].offsetTop)&&L.push(y)}),E.removeAttribute("style"),setTableAlign(e,L,f,"center",getEditorRange(f))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(f){const L=[],w=f.firstElementChild.scrollLeft;f.querySelectorAll("th, td").forEach(y=>{!y.classList.contains("fn__none")&&y.offsetLeft+6>E.offsetLeft+w&&y.offsetLeft+y.clientWidth-6<E.offsetLeft+w+E.clientWidth&&y.offsetTop+6>E.offsetTop&&y.offsetTop+y.clientHeight-6<E.offsetTop+E.clientHeight&&(L.length===0||L.length>0&&y.offsetTop===L[0].offsetTop)&&L.push(y)}),E.removeAttribute("style"),setTableAlign(e,L,f,"right",getEditorRange(f))}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(f){const L=[],w=f.firstElementChild.scrollLeft;f.querySelectorAll("th, td").forEach(A=>{!A.classList.contains("fn__none")&&A.offsetLeft+6>E.offsetLeft+w&&A.offsetLeft+A.clientWidth-6<E.offsetLeft+w+E.clientWidth&&A.offsetTop+6>E.offsetTop&&A.offsetTop+A.clientHeight-6<E.offsetTop+E.clientHeight&&L.push(A)}),E.removeAttribute("style");const y=f.outerHTML;L.forEach(A=>{A.innerHTML=""}),updateTransaction(e,f.getAttribute("data-node-id"),f.outerHTML,y)}}}).element),window.siyuan.menus.menu.popup({x:h.clientX-8,y:h.clientY-16}))}const C=[],k=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(k.forEach(E=>{C.push(E.getAttribute("data-node-id"))}),countBlockWord(C),getSelection().rangeCount>0){const E=getSelection().getRangeAt(0);if(E.toString()===""||window.siyuan.shiftIsPressed){if(n.detail===3){let y=hasClosestBlock(E.startContainer);if(y){if((_=y.nextElementSibling)!=null&&_.classList.contains("table"))setLastNodeRange(getContenteditableElement(y),E,!1);else if(y.classList.contains("table")){const A=y.querySelectorAll("th, td");y=A[A.length-1],y.contains(E.startContainer)&&setLastNodeRange(y,E,!1)}}}return}if(k.length>0){E.collapse(!0);return}const L=hasClosestBlock(E.startContainer);let w;h.detail===3&&E.endContainer.nodeType!==3&&E.endContainer.tagName==="DIV"&&E.endOffset===0?E.endContainer.classList.contains("protyle-attr")&&setLastNodeRange(E.endContainer.previousElementSibling,E,!1):w=hasClosestBlock(E.endContainer),L&&w&&!w.isSameNode(L)&&E.collapse(!0)}}})}bindEvent(e){this.element.addEventListener("focusout",()=>{getSelection().rangeCount>0&&!this.element.contains(getSelection().getRangeAt(0).startContainer)?e.toolbar.range||(e.toolbar.range=this.element.ownerDocument.createRange(),e.toolbar.range.setStart(getContenteditableElement(this.element)||this.element,0),e.toolbar.range.collapse(!0)):e.toolbar.range=getEditorRange(this.element)}),this.element.addEventListener("cut",l=>{var r,d;if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}l.stopPropagation(),l.preventDefault(),e.options.render.breadcrumb&&e.breadcrumb.hide();const c=getEditorRange(e.wysiwyg.element);let f=hasClosestBlock(c.startContainer);if(!f)return;const u=f.querySelector(".img--select");let g=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));g.length===0&&c.toString()===""&&!c.cloneContents().querySelector("img")&&!u&&(f.classList.add("protyle-wysiwyg--select"),g=[f]);let m="";if(g.length>0){g[0].getAttribute("data-type")==="NodeListItem"&&g[0].parentElement.classList.contains("list")&&g[0].parentElement.childElementCount-1===g.length?m=g[0].parentElement.outerHTML:(g.forEach(b=>{const v=getTopAloneElement(b);b.getAttribute("data-type")==="NodeHeading"&&b.getAttribute("fold")==="1"?m+=removeEmbed(v).replace('fold="1"',""):m+=removeEmbed(v)}),g[0].getAttribute("data-type")==="NodeListItem"&&(m=`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${m}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`));const p=getNextBlock(g[g.length-1]);removeBlock(e,f,c),p&&focusBlock(p)}else{const p=f.getAttribute("data-node-id"),b=f.outerHTML,v=document.createElement("div");let h=c.startContainer;if(h.nodeType===3&&h.textContent===""){const k=hasNextSibling(c.startContainer);k&&(h=k)}const _=hasClosestByAttribute(h,"data-type","NodeHeading");let C=!1;if(_&&c.toString()===_.firstElementChild.textContent){const k=[{action:"delete",id:_.getAttribute("data-node-id")}],E=[{action:"insert",id:_.getAttribute("data-node-id"),data:_.outerHTML,previousID:(r=_.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:((d=_.parentElement)==null?void 0:d.getAttribute("data-node-id"))||e.block.parentID}];if(_.getAttribute("fold")==="1"){C=!0;const L=_.cloneNode(!0);L.removeAttribute("fold"),v.append(L),E[0].data=L.outerHTML,setFold(e,_,void 0,!0)}else{if(_.parentElement.childElementCount===3&&_.parentElement.classList.contains("li")||_.parentElement.childElementCount===2&&(_.parentElement.classList.contains("bq")||_.parentElement.classList.contains("sb"))||_.parentElement.childElementCount===1&&_.parentElement.classList.contains("protyle-wysiwyg")){const L=Lute.NewNodeID(),w=genEmptyElement(!1,!1,L);k.push({id:L,data:w.outerHTML,action:"insert",parentID:_.parentElement.getAttribute("data-node-id")||e.block.parentID}),E.push({id:L,action:"delete"}),_.before(w)}focusSideBlock(_),v.append(_)}transaction(e,k,E)}else if(c.toString()!==""&&h.isSameNode(c.endContainer)&&c.startContainer.nodeType===3&&c.endOffset===c.endContainer.textContent.length&&c.startOffset===0&&!["DIV","TD","TH","TR"].includes(c.startContainer.parentElement.tagName))v.append(c.startContainer.parentElement);else if(u)v.append(u);else if(c.startContainer.nodeType===3&&c.startContainer.parentElement.tagName==="SPAN"&&c.startContainer.parentElement.getAttribute("data-type")&&c.startContainer.parentElement.isSameNode(c.endContainer.parentElement)){const k=c.startContainer.parentElement,E=k.attributes,L=document.createElement("span");for(let w=0;w<E.length;w++)L.setAttribute(E[w].name,E[w].value);k.getAttribute("data-type").indexOf("block-ref")>-1&&k.getAttribute("data-subtype")==="d"&&(L.setAttribute("data-subtype","s"),k.setAttribute("data-subtype","s")),L.textContent=c.toString(),c.deleteContents(),v.append(L)}else if(c.cloneContents().querySelectorAll("td, th").length>0){const k=document.createElement("wbr");c.insertNode(k),c.setStartAfter(k),v.append(c.extractContents()),f.outerHTML=e.lute.SpinBlockDOM(f.outerHTML),f=e.wysiwyg.element.querySelector(`[data-node-id="${p}"]`),focusByWbr(f,c)}else{const k=hasClosestByAttribute(c.commonAncestorContainer,"data-type","inline-math");if(k)v.append(k);else{v.append(c.extractContents());let E;f.classList.contains("table")?E=hasClosestByMatchTag(c.startContainer,"TD")||hasClosestByMatchTag(c.startContainer,"TH"):E=getContenteditableElement(f),E&&Array.from(E.children).forEach(L=>{L.textContent===""&&L.nodeType===1&&!["BR","IMG"].includes(L.tagName)&&L.remove()})}}if(this.emojiToMd(v),m=v.innerHTML,!f.classList.contains("table")){const k=getContenteditableElement(f);k&&k.textContent===""&&(k.innerHTML="")}f.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),f.getAttribute("data-type")==="NodeCodeBlock"&&(c.insertNode(document.createElement("wbr")),getContenteditableElement(f).removeAttribute("data-render"),highlightRender(f)),f.parentElement.parentElement&&!C&&updateTransaction(e,p,f.outerHTML,b)}e.hint.render(e),l.clipboardData.setData("text/plain",e.lute.BlockDOM2StdMd(m).trimEnd()),l.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(m)),l.clipboardData.setData("text/siyuan",m)});let n;this.element.addEventListener("contextmenu",l=>{var r,d,c,f;l.stopPropagation(),l.preventDefault();const u=l.clientX||l.detail.x,g=l.clientY||l.detail.y,m=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>1){hideElements(["util"],e),e.gutter.renderMenu(e,m[0]),window.siyuan.menus.menu.popup({x:u,y:g});return}const p=l.detail.target||l.target,b=hasClosestByAttribute(p,"data-type","NodeBlockQueryEmbed");if(b)return getSelection().rangeCount===0&&focusSideBlock(b),e.gutter.renderMenu(e,b),window.siyuan.menus.menu.fullscreen(),!1;if(e.toolbar.range=getEditorRange(e.element),p.tagName==="SPAN"){const h=e.toolbar.getCurrentType(e.toolbar.range);if(h.length>0&&removeSearchMark(p),h.includes("block-ref")&&!e.disabled)return refMenu(e,p),p.setAttribute("prevent-popover","true"),setTimeout(()=>{p.removeAttribute("prevent-popover")},620),!1;if(h.includes("file-annotation-ref")&&!e.disabled)return e.toolbar.showFileAnnotationRef(e,p),!1;if(h.includes("tag")&&!e.disabled)return tagMenu(e,p),!1;if(h.includes("inline-memo"))return e.toolbar.showRender(e,p),!1;if(h.includes("a")&&!e.disabled)return linkMenu(e,p),window.siyuan.config.editor.floatWindowMode===0&&((r=p.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(p.setAttribute("prevent-popover","true"),setTimeout(()=>{p.removeAttribute("prevent-popover")},620)),!1}if(!e.disabled&&p.tagName==="IMG"&&hasClosestByClassName(p,"img"))return imgMenu(e,e.toolbar.range,p.parentElement.parentElement,{clientX:u+4,clientY:g}),!1;const v=hasClosestBlock(p);if(!avContextmenu(e,l,p)){if(!v)return!1;!isNotEditBlock(v)&&!v.classList.contains("protyle-wysiwyg--select")&&(isMobile()||l.detail.target||n&&v.contains(n.startContainer))?(!isMobile()||(d=e.toolbar)!=null&&d.element.classList.contains("fn__none"))&&(contentMenu(e,v),window.siyuan.menus.menu.popup({x:u,y:g+13,h:26}),(c=e.toolbar)==null||c.element.classList.add("fn__none"),v.classList.contains("table")&&v.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(hideElements(["util"],e),e.gutter&&e.gutter.renderMenu(e,v),window.siyuan.menus.menu.fullscreen(),(f=e.toolbar)==null||f.element.classList.add("fn__none"))}}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(!a&&l.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{a=!1,onGet({data:d,protyle:e,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const r=hasClosestByClassName(l.target,"table");if(r){const d=r.querySelector(".table__select");d!=null&&d.style.width&&(d.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let s=!1;this.element.addEventListener("mouseover",l=>{const r=hasClosestByClassName(l.target,"protyle-attr");if(r){s=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(s){const c=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),s=!1}if(hasClosestByClassName(l.target,"protyle-action")||!e.options.render.gutter)return;const d=hasClosestBlock(l.target);if(!(d&&(d.classList.contains("list")||d.classList.contains("li")))&&d){const c=hasClosestByAttribute(d,"data-type","NodeBlockQueryEmbed");c?e.gutter.render(e,c,this.element):e.gutter.render(e,d,this.element)}}),this.element.addEventListener("paste",l=>{if(e.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}paste(e,l)});let i=!1;this.element.addEventListener("compositionstart",l=>{const r=getEditorRange(e.wysiwyg.element),d=hasClosestBlock(r.startContainer);d&&typeof e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=d.outerHTML,d.querySelector("wbr").remove()),i=!0,l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),i=!1;const r=getEditorRange(this.element),d=hasClosestBlock(r.startContainer);if(!(d&&d.getAttribute("data-type")==="NodeHTMLBlock")&&d)if(l.data!=="")this.escapeInline(e,r,l),input(e,d,r,!0);else{const c=d.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[c]&&updateTransaction(e,c,d.outerHTML,e.wysiwyg.lastHTMLs[c])}}),this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const d=getEditorRange(this.element),c=hasClosestBlock(d.startContainer);if(c){if(c&&c.getAttribute("data-type")==="NodeHTMLBlock"){l.stopPropagation();return}[":","(","\u3010","\uFF08","[","{","\u300C","#","/","\u3001"].includes(l.data)&&(e.hint.enableExtend=!0),!(l.isComposing||i||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(e,d,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"?setTimeout(()=>{input(e,c,d,!0)}):input(e,c,d,!0),l.stopPropagation())}}),this.element.addEventListener("keyup",l=>{const r=getEditorRange(this.element).cloneRange();if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Alt"&&l.key!=="Shift"&&l.key!=="CapsLock"&&l.key!=="Escape"&&l.key!=="Meta"&&!/^F\d{1,2}$/.test(l.key)&&(!l.isComposing||l.isComposing&&r.toString()!=="")){const d=hasClosestBlock(r.startContainer);d&&typeof e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=d.outerHTML,d.querySelector("wbr").remove());return}if(!this.preventKeyup&&((l.shiftKey||isCtrl(l))&&!l.isComposing&&r.toString()!==""&&(e.toolbar.render(e,r,l),countSelectWord(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing)){const d=hasClosestBlock(r.startContainer);d&&(this.setEmptyOutline(e,d),r.toString()===""&&countSelectWord(r,e.block.rootID)),l.stopPropagation()}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){previewImage(l.target.src,e.block.rootID);return}});let o;this.element.addEventListener("click",l=>{var r;e.app.plugins.forEach(y=>{y.eventBus.emit("click-editorcontent",{protyle:e,event:l})}),hideElements(["hint","util"],e);const d=l.metaKey||l.ctrlKey;l.shiftKey||(o=void 0),this.setEmptyOutline(e,l.target);const c=hasClosestByClassName(l.target,"table");this.element.querySelectorAll(".table").forEach(y=>{(!c||!y.isSameNode(c))&&y.querySelector(".table__select").removeAttribute("style"),c&&c.isSameNode(y)&&y.querySelector(".table__select").getAttribute("style")&&l.stopPropagation()}),e.options.render.breadcrumb&&e.breadcrumb.render(e);const f=getEditorRange(this.element),u=hasClosestByAttribute(l.target,"data-type","block-ref"),g=hasClosestByAttribute(l.target,"data-type","a");if(u||g&&g.getAttribute("data-href").startsWith("siyuan://blocks/")){if(l.stopPropagation(),l.preventDefault(),hideElements(["dialog","toolbar"],e),f.toString()!==""&&!l.shiftKey)return;let y;u?y=u.getAttribute("data-id"):g&&(y=g.getAttribute("data-href").substring(16,38)),fetchPost("/api/block/checkBlockFold",{id:y},A=>{openMobileFileById(e.app,y,A.data?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT]),activeBlur(),hideKeyboardToolbar()});return}const m=hasClosestByAttribute(l.target,"data-type","file-annotation-ref");if(m&&f.toString()===""){l.stopPropagation(),l.preventDefault();const A=`assets/${m.getAttribute("data-id").split("/")[1]}`;openByMobile(A);return}if(g&&!l.altKey){l.stopPropagation(),l.preventDefault();const y=Lute.UnEscapeHTMLStr(g.getAttribute("data-href"));openByMobile(y);return}const p=hasClosestByAttribute(l.target,"data-type","tag");if(p&&!l.altKey){const y=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e.app,{removed:y.removed,sort:y.sort,group:y.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${p.textContent}#`,r:"",page:1,types:Object.assign({},y.types)});return}const b=hasClosestByClassName(l.target,"protyle-wysiwyg__embed");if(b){const y=b.getAttribute("data-id");openMobileFileById(e.app,y,[Constants.CB_GET_ALL]),activeBlur(),hideKeyboardToolbar(),l.stopPropagation();return}if(commonClick(l,e)||hasTopClosestByClassName(l.target,"protyle-action__copy"))return;const v=hasClosestByClassName(l.target,"protyle-action__edit");if(v&&!e.disabled){e.toolbar.showRender(e,v.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const h=hasClosestByClassName(l.target,"protyle-action__menu");if(h){e.gutter.renderMenu(e,h.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();return}const _=hasClosestByClassName(l.target,"protyle-action__reload");if(_){const y=hasClosestByAttribute(_,"data-type","NodeBlockQueryEmbed");y&&(y.removeAttribute("data-render"),blockRender(e,y)),l.stopPropagation(),l.preventDefault();return}const C=hasClosestByClassName(l.target,"protyle-action__language");if(C&&!e.disabled){e.toolbar.showCodeLanguage(e,C),l.stopPropagation(),l.preventDefault();return}const k=hasClosestByAttribute(l.target,"data-subtype","math");if(!l.shiftKey&&!d&&k&&!e.disabled){e.toolbar.showRender(e,k),l.stopPropagation();return}const E=hasClosestByClassName(l.target,"protyle-action");if(E){if(E.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled)imgMenu(e,f,E.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY});else if(!e.disabled&&E.parentElement.classList.contains("li"))if(l.altKey){if(E.parentElement.parentElement.classList.contains("protyle-wysiwyg"))setFold(e,E.parentElement);else{let A=!0;const M=E.parentElement.parentElement.outerHTML;Array.from(E.parentElement.parentElement.children).find(x=>{if(x.classList.contains("li")&&x.getAttribute("fold")!=="1"&&x.childElementCount>3)return A=!1,!0}),Array.from(E.parentElement.parentElement.children).find(x=>{x.classList.contains("li")&&(A?x.removeAttribute("fold"):x.childElementCount>3&&x.setAttribute("fold","1"))}),updateTransaction(e,E.parentElement.parentElement.getAttribute("data-node-id"),E.parentElement.parentElement.outerHTML,M)}hideElements(["gutter"],e)}else if(l.shiftKey)openAttr(E.parentElement,e);else if(d)zoomOut({protyle:e,id:E.parentElement.getAttribute("data-node-id")});else if(E.classList.contains("protyle-action--task")){const A=E.parentElement.outerHTML;E.parentElement.classList.contains("protyle-task--done")?(E.querySelector("use").setAttribute("xlink:href","#iconUncheck"),E.parentElement.classList.remove("protyle-task--done")):(E.querySelector("use").setAttribute("xlink:href","#iconCheck"),E.parentElement.classList.add("protyle-task--done")),E.parentElement.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,E.parentElement.getAttribute("data-node-id"),E.parentElement.outerHTML,A)}else e.gutter.renderMenu(e,E.parentElement),window.siyuan.menus.menu.fullscreen();l.stopPropagation();return}const L=hasClosestByClassName(l.target,"hr")||hasClosestByClassName(l.target,"iframe");if(!l.shiftKey&&!d&&L){L.classList.add("protyle-wysiwyg--select"),l.stopPropagation();return}const w=hasTopClosestByClassName(l.target,"img");if(!l.shiftKey&&!d&&w){w.classList.add("img--select"),f.setStartAfter(w),f.collapse(!0),focusByRange(f),e.options.render.breadcrumb&&e.breadcrumb.render(e);return}if(!avClick(e,l)){if(l.target.contains(this.element)&&this.element.lastElementChild&&!e.disabled){const y=this.element.lastElementChild.getBoundingClientRect();if(l.y>y.bottom){const A=getContenteditableElement(getLastBlock(this.element.lastElementChild));if(!A||this.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||this.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&getContenteditableElement(A).innerHTML!==""){const M=genEmptyElement(!1,!1);this.element.insertAdjacentElement("beforeend",M),transaction(e,[{action:"insert",data:M.outerHTML,id:M.getAttribute("data-node-id"),previousID:M.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:M.getAttribute("data-node-id")}]);const x=getContenteditableElement(M);f.selectNodeContents(x),f.collapse(!0),focusByRange(f)}else A&&(f.selectNodeContents(A),f.collapse(!1))}}if(setTimeout(()=>{const y=getEditorRange(this.element);e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||countSelectWord(y,e.block.rootID),getSelection().rangeCount===0&&focusByRange(y)},isMobile()||(r=window.webkit)!=null&&r.messageHandlers?520:0),e.hint.enableExtend=!1,l.shiftKey){l.preventDefault(),l.stopPropagation();let y=hasClosestBlock(f.startContainer),A=hasClosestBlock(l.target);if(y&&A&&y.isSameNode(A)&&(y=hasClosestBlock(f.endContainer)),y&&A&&(!y.isSameNode(A)||o&&o.isSameNode(y))){let M=!0;f.collapse(!0),o?y=o:o=y;const x=y.getBoundingClientRect(),B=A.getBoundingClientRect();let K=x.top,z=B.top;if(K===z&&(K=x.right,z=B.right),K>z){const $=A;A=y,y=$;const ge=z;z=K,K=ge,M=!1}let Q=[],V=y,ie=!1;for(;V;)if(V&&!V.classList.contains("protyle-attr")){const $=V.getBoundingClientRect();if(x.top===B.top?$.right<=z:$.top<=z)if(ie)if(V.nextElementSibling&&!V.nextElementSibling.classList.contains("protyle-attr")){const ge=V.nextElementSibling.getBoundingClientRect();if(x.top===B.top?ge.right<=z:ge.top<=z)Q=[V],V=V.nextElementSibling,ie=!1;else if(V.parentElement.classList.contains("sb"))V=hasClosestBlock(V.parentElement),ie=!0;else break}else V=hasClosestBlock(V.parentElement),ie=!0;else Q.push(V),V=V.nextElementSibling;else if(V.parentElement.classList.contains("sb"))V=hasClosestBlock(V.parentElement),ie=!0;else break}else V=hasClosestBlock(V.parentElement),ie=!0;if(Q.length===1&&!Q[0].classList.contains("list")&&!Q[0].classList.contains("bq")&&!Q[0].classList.contains("sb"))o=void 0;else{const $=[];!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(y.getBoundingClientRect().top<-e.contentElement.clientHeight*2||A.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&showMessage(window.siyuan.languages.crossKeepLazyLoad),Q.forEach(ge=>{ge.classList.add("protyle-wysiwyg--select"),$.push(ge.getAttribute("data-node-id")),ge.querySelectorAll(".protyle-wysiwyg--select").forEach(Z=>{Z.classList.remove("protyle-wysiwyg--select")})}),countBlockWord($),M?focusBlock(Q[Q.length-1],e.wysiwyg.element,!1):focusBlock(Q[0],e.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&f.toString()!==""&&(f.collapse(!1),focusByRange(f)),d&&f.toString()===""){let y=hasClosestBlock(l.target);if(y){y=getTopAloneElement(y),y.classList.contains("protyle-wysiwyg--select")?(y.classList.remove("protyle-wysiwyg--select"),y.removeAttribute("select-start"),y.removeAttribute("select-end")):y.classList.add("protyle-wysiwyg--select"),y.querySelectorAll(".protyle-wysiwyg--select").forEach(x=>{x.classList.remove("protyle-wysiwyg--select"),x.removeAttribute("select-start"),x.removeAttribute("select-end")});const A=hasClosestByClassName(y.parentElement,"protyle-wysiwyg--select");A&&(A.classList.remove("protyle-wysiwyg--select"),A.removeAttribute("select-start"),A.removeAttribute("select-end"));const M=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(x=>{M.push(x.getAttribute("data-node-id"))}),countBlockWord(M)}}}})}}class vl extends null{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(fixTableRange(e.toolbar.range),hintRef(e.toolbar.range.toString(),e,!0),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var Ta=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});class El extends null{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>Ta(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=e.toolbar.range;if(!hasClosestBlock(s.startContainer))return;let o=hasClosestByAttribute(s.startContainer,"data-type","inline-math");if(!o&&s.startContainer.nodeType!==3&&s.startContainer.childNodes[s.startOffset]){const l=hasPreviousSibling(s.startContainer.childNodes[s.startOffset]);l&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&s.startOffset===s.startContainer.textContent.length&&s.startContainer.nodeType===3){let l=!0,r=!1;if(s.cloneContents().childNodes.forEach(d=>{d.nodeType!==3&&(d.getAttribute("data-type")||"").indexOf("inline-math")>-1||d.nodeType==3&&d.textContent===""?r=!0:l=!1}),l&&r){const d=hasNextSibling(s.startContainer);if(d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1)o=d;else{const c=hasPreviousSibling(s.startContainer);s.startOffset===0&&c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1&&(o=c)}}}if(o){e.toolbar.showRender(e,o);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})}))}}var Ma=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});class kl extends null{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>Ma(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=e.toolbar.range;if(!hasClosestBlock(s.startContainer))return;const o=hasClosestByAttribute(s.startContainer,"data-type","inline-memo");if(o&&o.textContent===s.toString()){e.toolbar.showRender(e,o);return}s.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})}))}}class Cl{constructor(e){const n=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,n.toolbar.forEach(s=>{const i=this.genItem(e,s);this.element.appendChild(i)})}render(e,n,a){this.range=n;let s=hasClosestBlock(n.startContainer);if(isMobile()||!s||e.disabled){this.element.classList.add("fn__none");return}let i=!0,o=!0;if(Array.from(n.cloneContents().childNodes).find(u=>{if(u.nodeType!==1){if(u.textContent.length>0)return o=!1,!0}else if(!u.classList.contains("img"))return i=!1,!0}),i&&o||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const l=hasClosestBlock(n.startContainer),r=hasClosestBlock(n.endContainer);if(l&&r&&!l.isSameNode(r)){if(a)if(a.key==="ArrowLeft")this.range=setLastNodeRange(getContenteditableElement(l),n,!1);else if(a.key==="ArrowRight")this.range=setFirstNodeRange(getContenteditableElement(r),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=setFirstNodeRange(getContenteditableElement(r),n),s=hasClosestBlock(r),!s)return}else a.key==="ArrowDown"&&(this.range=setLastNodeRange(getContenteditableElement(l),n,!1));else this.range=setLastNodeRange(getContenteditableElement(s),n,!1);if(focusByRange(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(s.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const d=getSelectionPosition(s,n);this.element.classList.remove("fn__none");const c=d.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",c+Constants.ZWSP+e.contentElement.scrollTop.toString()),setPosition(this.element,d.left-52,c),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(u=>{u.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(u=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(u))return;const g=this.element.querySelector(`[data-type="${u}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){var n,a;let s=[],i=e.startContainer;if(i.nodeType===3?i=i.parentElement:i.childElementCount>0&&((n=i.childNodes[e.startOffset])==null?void 0:n.nodeType)!==3&&(i=i.childNodes[e.startOffset]),!i||i.nodeType===3)return[];["DIV","TD","TH","TR"].includes(i.tagName)||(s=(i.getAttribute("data-type")||"").split(" "));let o=e.endContainer;return o.nodeType===3?o=o.parentElement:o.childElementCount>0&&((a=o.childNodes[e.endOffset])==null?void 0:a.nodeType)!==3&&(o=o.childNodes[e.endOffset]),!o||o.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(o.tagName)&&!i.isSameNode(o)&&(s=s.concat((o.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(s=s.concat((l.getAttribute("data-type")||"").split(" ")))}),s=[...new Set(s)],s.find((l,r)=>{if(l==="")return s.splice(r,1),!0}),s)}genItem(e,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new ToolbarItem(e,n);break;case"block-ref":a=new BlockRef(e,n);break;case"inline-math":a=new InlineMath(e,n);break;case"inline-memo":a=new InlineMemo(e,n);break;case"|":a=new Divider;break;case"text":a=new Font(e,n);break;case"a":a=new Link(e,n);break}if(a)return a.element}mergeNode(e){for(let n=0;n<e.length;n++)e[n].nodeType!==3&&e[n].tagName==="WBR"&&(e[n].remove(),n--);for(let n=0;n<e.length;n++)e[n].nodeType===3&&(e[n].textContent===""?(e[n].remove(),n--):e[n+1]&&e[n+1].nodeType===3&&(e[n].textContent=e[n].textContent+e[n+1].textContent,e[n+1].remove(),n--))}setInlineMark(e,n,a,s){var i;const o=hasClosestBlock(this.range.startContainer);if(!o)return;const l=hasClosestBlock(this.range.endContainer);if(!l)return;o.isSameNode(l)||(this.range=setLastNodeRange(getContenteditableElement(o),this.range,!1));const r=this.getCurrentType(this.range),d=this.range.toString();fixTableRange(this.range);let c,f,u,g;const m=hasPreviousSibling(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?m&&m.nodeType!==3&&this.range.startOffset===0&&(c=m):this.range.startOffset===0&&!m?(c=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):c=this.range.startContainer.parentElement;let p=!1;const b=hasNextSibling(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?b&&b.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(f=b):this.range.endOffset===this.range.endContainer.textContent.length&&!b?(f=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),d===""&&(p=!0,this.range.collapse(!1))):f=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const v=o.outerHTML,h=this.range.extractContents();if(this.mergeNode(h.childNodes),c&&f&&c.isSameNode(f)&&((i=h.firstChild)==null?void 0:i.nodeType)===3){const w=c.attributes;h.childNodes.forEach(y=>{const A=document.createElement("span");for(let M=0;M<w.length;M++)A.setAttribute(w[M].name,w[M].value);A.innerHTML=y.textContent,y.replaceWith(A)})}const _=isMobile()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,C=a==="toolbar"?_.querySelector(`[data-type="${n}"]`):void 0,k=[];if(n==="clear"||C!=null&&C.classList.contains("protyle-toolbar__item--current")||a==="range"&&r.length>0&&r.includes(n)&&!s){if(n==="clear"?_.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(w=>{w.classList.remove("protyle-toolbar__item--current")}):C&&C.classList.remove("protyle-toolbar__item--current"),h.childNodes.length===0)if(r.find((w,y)=>{if(n===w)return r.splice(y,1),!0}),r.length===0)k.push(document.createTextNode(Constants.ZWSP));else{let w=0;for(;w<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[w])?r.splice(w,1):++w;const y=document.createElement("span");y.setAttribute("data-type",r.join(" ")),y.textContent=Constants.ZWSP,k.push(y)}h.childNodes.forEach((w,y)=>{if(w.nodeType!==3&&w.tagName!=="BR"){const A=w.getAttribute("data-type").split(" ");if(n==="clear")for(let M=0;M<A.length;M++)s&&s.type==="text"?A[M]==="text"&&(A.splice(M,1),M--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(A[M])&&(A.splice(M,1),M--);else A.find((M,x)=>{if(n===M)return A.splice(x,1),!0});A.length===0?(w.textContent===""&&(w.textContent=Constants.ZWSP),k.push(document.createTextNode(w.textContent))):(n==="clear"&&(w.style.color="",w.style.webkitTextFillColor="",w.style.webkitTextStroke="",w.style.textShadow="",w.style.backgroundColor="",w.style.fontSize=""),y===0&&c&&c.nodeType!==3&&isArrayEqual(A,(c.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,c,s)?(u=c.textContent.length,c.innerHTML=c.innerHTML+w.innerHTML):y===h.childNodes.length-1&&f&&f.nodeType!==3&&isArrayEqual(A,(f.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,f,s)?(g=w.textContent.length,f.innerHTML=w.innerHTML+f.innerHTML):(w.setAttribute("data-type",A.join(" ")),k.push(w)))}else k.push(w)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&C&&C.classList.add("protyle-toolbar__item--current"),d===""){const w=document.createElement("span");if(r.push(n),p){let y=0;for(;y<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[y])?r.splice(y,1):++y}w.setAttribute("data-type",[...new Set(r)].join(" ")),w.textContent=Constants.ZWSP,setFontStyle(w,s),k.push(w)}else n==="block-ref"&&h.childNodes.forEach((w,y)=>{y!==0&&w.remove()}),h.childNodes.forEach((w,y)=>{var A,M;if(w.nodeType===3)if(y===0&&c&&c.nodeType!==3&&n===c.getAttribute("data-type")&&hasSameTextStyle(w,c,s))u=c.textContent.length,c.innerHTML=c.innerHTML+w.textContent;else if(y===h.childNodes.length-1&&f&&f.nodeType!==3&&n===f.getAttribute("data-type")&&hasSameTextStyle(w,f,s))g=w.textContent.length,f.innerHTML=w.textContent+f.innerHTML;else{const x=document.createElement("span");x.setAttribute("data-type",n),x.textContent=w.textContent,setFontStyle(x,s),k.push(x)}else{let x=(w.getAttribute("data-type")||"").split(" ");for(let B=0;B<x.length;B++)["backslash","virtual-block-ref","search-mark"].includes(x[B])&&(x.splice(B,1),B--);x.push(n),n==="sub"&&x.includes("sup")?x.find((B,K)=>{if(B==="sup")return x.splice(K,1),_.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&x.includes("sub")?x.find((B,K)=>{if(B==="sub")return x.splice(K,1),_.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(x.includes("a")||x.includes("file-annotation-ref"))?x.find((B,K)=>{if(B==="a"||B==="file-annotation-ref")return x.splice(K,1),!0}):n==="a"&&(x.includes("block-ref")||x.includes("file-annotation-ref"))?x.find((B,K)=>{if(B==="block-ref"||B==="file-annotation-ref")return x.splice(K,1),!0}):n==="file-annotation-ref"&&(x.includes("block-ref")||x.includes("a"))?x.find((B,K)=>{if(B==="block-ref"||B==="a")return x.splice(K,1),!0}):n==="inline-memo"&&x.includes("inline-math")?(x.find((B,K)=>{if(B==="inline-math")return x.splice(K,1),!0}),w.textContent=w.getAttribute("data-content")):n==="inline-math"&&x.includes("inline-memo")&&x.find((B,K)=>{if(B==="inline-memo")return x.splice(K,1),!0}),x=[...new Set(x)],y===0&&c&&c.nodeType!==3&&isArrayEqual(x,(c.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,c,s)?(u=c.textContent.length,c.innerHTML=c.innerHTML+w.innerHTML):y===h.childNodes.length-1&&f&&f.nodeType!==3&&isArrayEqual(x,(f.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(w,f,s)?(g=w.textContent.length,f.innerHTML=w.innerHTML+f.innerHTML):(w.tagName!=="BR"&&(((A=w.getAttribute("data-type"))==null?void 0:A.indexOf("backslash"))>-1&&((M=w.firstChild)==null?void 0:M.textContent)==="\\"&&w.firstChild.remove(),w.setAttribute("data-type",x.join(" ")),setFontStyle(w,s)),k.push(w))}});if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!p){const w=this.range.startContainer,y=document.createElement("span"),A=w.attributes;for(let M=0;M<A.length;M++)y.setAttribute(A[M].name,A[M].value);this.range.setEnd(w.lastChild,w.lastChild.textContent.length),y.append(this.range.extractContents()),w.after(y),this.range.setStartBefore(y),this.range.collapse(!0)}for(let w=0;w<k.length;w++){const y=k[w],A=k[w+1];if(y.nodeType!==3&&A&&A.nodeType!==3&&A.tagName===y.tagName&&isArrayEqual((A.getAttribute("data-type")||"").split(" "),(y.getAttribute("data-type")||"").split(" "))&&y.getAttribute("data-id")===A.getAttribute("data-id")&&y.getAttribute("data-subtype")===A.getAttribute("data-subtype")&&y.style.color===A.style.color&&y.style.webkitTextFillColor===A.style.webkitTextFillColor&&y.style.webkitTextStroke===A.style.webkitTextStroke&&y.style.textShadow===A.style.textShadow&&y.style.fontSize===A.style.fontSize&&y.style.backgroundColor===A.style.backgroundColor){const M=y.getAttribute("data-type");M.indexOf("inline-math")>-1?A.setAttribute("data-content",y.getAttribute("data-content")+A.getAttribute("data-content")):(A.innerHTML=y.innerHTML+A.innerHTML,M.indexOf("inline-memo")>-1&&A.setAttribute("data-inline-memo-content",(y.getAttribute("data-inline-memo-content")||"")+(A.getAttribute("data-inline-memo-content")||""))),k.splice(w,1),w--}else{if(this.range.insertNode(y),y.nodeType!==3&&["code","tag","kbd"].includes(n)){const M=hasPreviousSibling(y);(!M||M.textContent.endsWith(`
`))&&y.before(document.createTextNode(Constants.ZWSP)),y.textContent.startsWith(Constants.ZWSP)||(y.textContent=Constants.ZWSP+y.textContent);const x=hasNextSibling(y);(!x||x&&(x.nodeType!==3||x.nodeType===3&&!x.textContent.startsWith(Constants.ZWSP)))&&y.after(document.createTextNode(Constants.ZWSP))}this.range.collapse(!1)}}if(c&&(c.nodeType!==3&&c.textContent===Constants.ZWSP?c.remove():this.mergeNode(c.childNodes)),f&&this.mergeNode(f.childNodes),u?this.range.setStart(c.firstChild,u):k.length>0?k[0].nodeType!==3&&k[0].getAttribute("data-type")==="inline-math"||(k[0].firstChild?k[0].firstChild.textContent===Constants.ZWSP?this.range.setStart(k[0].firstChild,1):this.range.setStart(k[0].firstChild,0):k[0].nodeType===3?this.range.setStart(k[0],0):this.range.setStartBefore(k[0])):f&&this.range.setStart(f.firstChild,0),g)this.range.setEnd(f.lastChild,g);else if(k.length>0){const w=k[k.length-1];if(w.nodeType!==3&&w.getAttribute("data-type").indexOf("inline-math")>-1){const y=hasPreviousSibling(w);y&&y.nodeType===3?this.range.setStart(y,y.textContent.length):this.range.setStartBefore(w);const A=hasNextSibling(w);A&&A.nodeType===3?this.range.setEnd(A,0):this.range.setEndAfter(w)}else w.lastChild?w.lastChild.textContent===Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(w.lastChild,w.lastChild.textContent.length):w.nodeType===3?(this.range.setEnd(w,w.textContent.length),w.textContent===Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(w)}else c&&this.range.setEnd(c.firstChild,c.firstChild.textContent.length);let E=!0;if(n==="inline-math"){if(mathRender(o),d===""){e.toolbar.showRender(e,k[0],void 0,v);return}}else if(n==="inline-memo"){e.toolbar.showRender(e,k[0],k,v);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const w=k[0];w.textContent.replace(Constants.ZWSP,"")===""||!w.getAttribute("data-href")?(E=!1,linkMenu(e,w,!!w.getAttribute("data-href"))):this.range.collapse(!1)}o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,v);const L=o.querySelector("wbr");L&&L.remove(),E&&focusByRange(this.range)}showFileAnnotationRef(e,n){const a=hasClosestBlock(n);if(!a)return;hideElements(["hint"],e),window.siyuan.menus.menu.remove();const s=a.getAttribute("data-node-id"),i=a.outerHTML;this.subElement.style.padding="",this.subElement.innerHTML=`<div class="b3-form__space--small">
<label class="fn__flex">
    <span class="ft__on-surface fn__flex-center" style="width: 64px">ID</span>
    <div class="fn__space"></div>
    <input data-type="id" value="${n.getAttribute("data-id")||""}" class="b3-text-field fn__block" readonly />
</label>
<div class="fn__hr"></div>
<label class="fn__flex">
    <span class="ft__on-surface fn__flex-center" style="width: 64px">${window.siyuan.languages.anchor}</span>
    <div class="fn__space"></div>
    <input data-type="anchor" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}" />
</label>
<div class="fn__hr"></div>
<div class="fn__hr"></div>
<div class="fn__flex"><span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.remove}</button>
</div></div>`,this.subElement.querySelector(".b3-button--cancel").addEventListener(getEventName(),()=>{n.outerHTML=n.textContent+"<wbr>",hideElements(["util"],e)});const o=this.subElement.querySelector('[data-type="anchor"]');o.value=n.textContent,o.addEventListener("input",l=>{o.value?n.innerHTML=Lute.EscapeHTMLStr(o.value):n.innerHTML="*",l.stopPropagation()}),o.addEventListener("keydown",l=>{l.stopPropagation(),!l.isComposing&&(l.key==="Enter"||l.key==="Escape")&&(hideElements(["util"],e),l.preventDefault(),l.stopPropagation())}),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=()=>{n.parentElement?(o.value?n.innerHTML=Lute.EscapeHTMLStr(o.value):n.innerHTML="*",this.range.setStartAfter(n),getSelection().rangeCount===0&&focusByRange(this.range)):getSelection().rangeCount===0&&focusByWbr(a,this.range),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,i)},this.element.classList.add("fn__none"),o.select()}showRender(e,n,a,s){var i;const o=hasClosestBlock(n);if(!o)return;hideElements(["hint"],e),window.siyuan.menus.menu.remove();const l=o.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),d=s||e.lute.SpinBlockDOM(o.outerHTML);let c="HTML",f="";const u=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":c=window.siyuan.languages.staff;break;case"echarts":c=window.siyuan.languages.chart;break;case"flowchart":c="Flow Chart";break;case"graphviz":c="Graphviz";break;case"mermaid":c="Mermaid";break;case"mindmap":f=`- foo
  - bar
- baz`,c=window.siyuan.languages.mindmap;break;case"plantuml":c="UML";break;case"math":r.includes("NodeMathBlock")?c=window.siyuan.languages.math:c=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?c=window.siyuan.languages.blockEmbed:u&&(c=window.siyuan.languages.memo);const g=(i=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:i.classList.contains("block__icon--active"),m={};if(g){const C=this.subElement.querySelector(".b3-text-field");m.styleH=C.style.height,m.styleW=C.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex">
    <span class="fn__flex-1 resize__move">
        ${c}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g?" block__icon--active":""}" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${f}" style="${isMobile()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:50vh;min-height: 48px;min-width: 268px"></textarea></div>`;const p=()=>{if(h.style.height=h.scrollHeight+"px",isMobile())return;if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){h.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const C=_.bottom===_.top?_.bottom+26:_.bottom;this.subElement.clientHeight<=window.innerHeight-C||this.subElement.clientHeight<=_.top?r.includes("inline-math")||u?setPosition(this.subElement,_.left,C,_.height||26):setPosition(this.subElement,_.left+(_.width-this.subElement.clientWidth)/2,C,_.height||26):setPosition(this.subElement,_.right,C)},b=this.subElement.querySelector(".block__icons");b.addEventListener("click",C=>{const k=C.target,E=hasClosestByClassName(k,"b3-tooltips");if(!E){if(C.detail===2){const L=b.querySelector('[data-type="pin"]');L.classList.contains("block__icon--active")?(L.classList.remove("block__icon--active"),L.setAttribute("aria-label",window.siyuan.languages.pin)):(L.classList.add("block__icon--active"),L.setAttribute("aria-label",window.siyuan.languages.unpin)),C.preventDefault(),C.stopPropagation()}return}switch(C.stopPropagation(),E.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),hideElements(["util"],e);break;case"pin":E.classList.contains("block__icon--active")?(E.classList.remove("block__icon--active"),E.setAttribute("aria-label",window.siyuan.languages.pin)):(E.classList.add("block__icon--active"),E.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":E.classList.toggle("block__icon--active");break;case"before":insertEmptyBlock(e,"beforebegin",l),hideElements(["util"],e);break;case"after":insertEmptyBlock(e,"afterend",l),hideElements(["util"],e);break;case"export":v();break}});const v=()=>{const C=showMessage(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(k){return k.blob()}).then(function(k){const E=new FormData;E.append("file",k),E.append("type","image/png"),fetchPost("/api/export/exportAsFile",E,L=>{openByMobile(L.data.file),hideMessage(C)})});return}setTimeout(()=>{addScript("stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(k=>{k.toBlob(E=>{const L=new FormData;L.append("file",E),L.append("type","image/png"),fetchPost("/api/export/exportAsFile",L,w=>{openByMobile(w.data.file),hideMessage(C)})})})})},Constants.TIMEOUT_LOAD)},h=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?h.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):u?h.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):h.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),h.addEventListener("input",C=>{if(n.parentElement&&(h.clientHeight!==h.scrollHeight&&p(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(h.value));else if(u){let k;a?k=a:k=[n],k.forEach(E=>{E.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(h.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!u)&&processRender(n),C.stopPropagation()}}),h.addEventListener("keydown",C=>{if(C.stopPropagation(),matchHotKey(window.siyuan.config.keymap.editor.insert["inline-math"].custom,C)){C.preventDefault();return}if(!C.isComposing){if(C.key==="Escape"||matchHotKey("\u2318\u21A9",C))this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),hideElements(["util"],e);else if(C.key==="Tab")document.execCommand("insertText",!1,"	"),C.preventDefault();else if(electronUndo(C))return}}),this.subElementCloseCB=()=>{var C;if(!n.parentElement||e.disabled)return;let k;if(r.includes("NodeHTMLBlock")){let L=h.value;L&&(L=L.trim().replace(/\n+/g,`
`),L.startsWith("<div>")&&L.endsWith("</div>")||(L=`<div>
${L}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(L))}else if(u){let L;a?L=a:L=[n],L.forEach((w,y)=>{if(h.value)w.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(h.value.replace(/\n/g," ")));else{const A=w.getAttribute("data-type").split(" ");A.length===1&&A[0]==="inline-memo"?w.outerHTML=w.innerHTML+(y===L.length-1?"<wbr>":""):(A.find((M,x)=>{if(M==="inline-memo")return A.splice(x,1),!0}),w.setAttribute("data-type",A.join(" ")),w.removeAttribute("data-inline-memo-content")),y===L.length-1&&(k=w)}})}else r.includes("inline-math")?h.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value.replace(/\n/g,""))),n.removeAttribute("data-render"),processRender(n)):(k=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?blockRender(e,n):processRender(n));getSelection().rangeCount===0?n.tagName==="SPAN"?k?k.parentElement?(this.range.setStartAfter(k),this.range.collapse(!0),focusByRange(this.range)):focusByWbr(o,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),focusByRange(this.range)):(focusBlock(n),n.classList.add("protyle-wysiwyg--select")):(C=o.querySelector("wbr"))==null||C.remove(),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const E=e.lute.SpinBlockDOM(o.outerHTML);if(r.includes("NodeHTMLBlock")){const L=document.createElement("template");L.innerHTML=E,L.content.childElementCount>1&&showMessage(window.siyuan.languages.htmlBlockTip)}updateTransaction(e,l,E,d)},this.subElement.classList.remove("fn__none");const _=n.getBoundingClientRect();this.element.classList.add("fn__none"),g?(h.style.width=m.styleW,h.style.height=m.styleH):p(),e.disabled||h.select(),e.app.plugins.forEach(C=>{C.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this})})}showCodeLanguage(e,n){const a=hasClosestBlock(n);if(!a)return;hideElements(["hint"],e),window.siyuan.menus.menu.remove(),this.range=getEditorRange(a);const s=a.getAttribute("data-node-id");let i=a.outerHTML,o=`<div class="b3-list-item b3-list-item--focus">${window.siyuan.languages.clear}</div>`;Constants.CODE_LANGUAGES.forEach(r=>{o+=`<div class="b3-list-item">${r}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input placeholder="${window.siyuan.languages.search}" style="margin: 4px 8px 8px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${o}</div>
</div>`;const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing){if(upDownHint(this.subElement.lastElementChild.lastElementChild,r),r.key==="Enter"){const d=this.subElement.querySelector(".b3-list-item--focus").textContent;n.textContent=d===window.siyuan.languages.clear?"":d,window.siyuan.storage[Constants.LOCAL_CODELANG]=n.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]);const c=getContenteditableElement(a),f=a.getAttribute("linenumber");f==="true"||f!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?c.classList.add("protyle-linenumber"):c.classList.remove("protyle-linenumber"),c.textContent=c.textContent,c.removeAttribute("data-render"),highlightRender(a),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,i),i=a.outerHTML,r.preventDefault(),r.stopPropagation()}(r.key==="Escape"||r.key==="Enter")&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}}),l.addEventListener("input",r=>{const d=[];Constants.CODE_LANGUAGES.forEach(u=>{u.indexOf(l.value.toLowerCase())>-1&&d.push(u)});let c="",f=!1;d.sort((u,g)=>u.startsWith(l.value.toLowerCase())&&g.startsWith(l.value.toLowerCase())?u.length<g.length?-1:u.length===g.length?0:1:u.startsWith(l.value.toLowerCase())?-1:g.startsWith(l.value.toLowerCase())?1:0).forEach(u=>{l.value===u&&(f=!0),c+=`<div class="b3-list-item">${u.replace(l.value.toLowerCase(),"<b>"+l.value.toLowerCase()+"</b>")}</div>`}),l.value.trim()&&!f&&(c=`<div class="b3-list-item"><b>${l.value.replace(/`| /g,"_")}</b></div>${c}`),this.subElement.firstElementChild.lastElementChild.innerHTML=c,c&&this.subElement.firstElementChild.lastElementChild.firstElementChild.classList.add("b3-list-item--focus"),r.stopPropagation()}),this.subElement.lastElementChild.lastElementChild.addEventListener("click",r=>{const d=r.target,c=hasClosestByClassName(d,"b3-list-item");if(!c)return;n.textContent=c.textContent===window.siyuan.languages.clear?"":c.textContent,window.siyuan.storage[Constants.LOCAL_CODELANG]=n.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]);const f=hasClosestBlock(n);if(f){const u=getContenteditableElement(f),g=f.getAttribute("linenumber");g==="true"||g!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?u.classList.add("protyle-linenumber"):u.classList.remove("protyle-linenumber"),u.textContent=u.textContent,u.removeAttribute("data-render"),highlightRender(f),f.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,f.outerHTML,i),i=f.outerHTML,this.subElement.classList.add("fn__none"),focusByRange(this.range)}}),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select()}showTpl(e,n,a){this.range=a,hideElements(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 4px 8px 8px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${isMobile()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const s=this.subElement.querySelector(".b3-list"),i=this.subElement.firstElementChild.lastElementChild;let o=s.firstElementChild.getAttribute("data-value");previewTemplate(o,i,e.block.parentID),s.addEventListener("mouseover",r=>{const d=r.target,c=hasClosestByClassName(d,"b3-list-item");if(!c)return;const f=c.getAttribute("data-value");o!==f&&(o=f,previewTemplate(o,i,e.block.parentID))});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const d=!this.subElement.querySelector(".b3-list-item");if(!d){const c=upDownHint(s,r);if(c){const f=c.getAttribute("data-value");if(o===f)return;o=f,previewTemplate(o,i,e.block.parentID)}}r.key==="Enter"?(d?focusByRange(this.range):hintRenderTemplate(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTemplate",{k:l.value},d=>{var c;let f="";d.data.blocks.forEach((g,m)=>{f+=`<div data-value="${g.path}" class="b3-list-item${m===0?" b3-list-item--focus":""}">${g.content}</div>`}),s.innerHTML=f||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const u=(c=d.data.blocks[0])==null?void 0:c.path;o!==u&&(o=u,previewTemplate(o,i,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const d=r.target;if(d.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),r.stopPropagation();return}const c=hasClosestByClassName(d,"b3-list-item__action");if(c&&c.getAttribute("data-type")==="remove"){confirmDialog(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{fetchPost("/api/search/removeTemplate",{path:c.parentElement.getAttribute("data-value")},()=>{if(c.parentElement.parentElement.childElementCount===1)c.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,previewTemplate("",i,e.block.parentID);else{if(c.parentElement.classList.contains("b3-list-item--focus")){const m=c.parentElement.previousElementSibling||c.parentElement.nextElementSibling;m.classList.add("b3-list-item--focus");const p=m.getAttribute("data-value");if(o===p)return;o=p,previewTemplate(o,i,e.block.parentID)}c.parentElement.remove()}})}),r.stopPropagation();return}if(hasClosestByAttribute(d,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(hasClosestByAttribute(d,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=hasClosestByClassName(d,"b3-list-item");g&&(hintRenderTemplate(decodeURIComponent(g.getAttribute("data-value")),e,n),r.stopPropagation())}),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),fetchPost("/api/search/searchTemplate",{k:""},r=>{let d="";r.data.blocks.forEach((c,f)=>{d+=`<div data-value="${c.path}" class="b3-list-item--hide-action b3-list-item${f===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${c.content}</span>`,d+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),d===""&&(d=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.querySelector(".b3-list--background").innerHTML=d})}showWidget(e,n,a){this.range=a,hideElements(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const s=this.subElement.querySelector("input");s.addEventListener("keydown",i=>{i.stopPropagation(),!i.isComposing&&(upDownHint(this.subElement.lastElementChild.lastElementChild,i),i.key==="Enter"?(hintRenderWidget(this.subElement.querySelector(".b3-list-item--focus").textContent,e),this.subElement.classList.add("fn__none"),i.preventDefault()):i.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range)))}),s.addEventListener("input",i=>{i.stopPropagation(),fetchPost("/api/search/searchWidget",{k:s.value},o=>{let l="";o.data.blocks.forEach((r,d)=>{l+=`<div data-value="${r.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}">${r.content}</div>`}),this.subElement.firstElementChild.lastElementChild.innerHTML=l})}),this.subElement.lastElementChild.addEventListener("click",i=>{const o=i.target,l=hasClosestByClassName(o,"b3-list-item");l&&hintRenderWidget(l.textContent,e)}),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),fetchPost("/api/search/searchWidget",{k:""},i=>{let o="";i.data.blocks.forEach((l,r)=>{o+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${l.content}</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=o})}showAssets(e,n,a){this.range=a,hideElements(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width:100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 4px 8px 8px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 260px;display: ${isMobile()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;"></div>
</div>`;const s=this.subElement.querySelector(".b3-list");s.addEventListener("mouseover",l=>{const r=l.target,d=hasClosestByClassName(r,"b3-list-item");d&&(i.innerHTML=renderAssetsPreview(d.getAttribute("data-value")))});const i=this.subElement.firstElementChild.lastElementChild;i.innerHTML=renderAssetsPreview(s.firstElementChild.getAttribute("data-value"));const o=this.subElement.querySelector("input");o.addEventListener("keydown",l=>{if(l.stopPropagation(),l.isComposing)return;const r=!this.subElement.querySelector(".b3-list-item");if(!r){const d=upDownHint(s,l);d&&(i.innerHTML=renderAssetsPreview(d.getAttribute("data-value")))}l.key==="Enter"?(r?focusByRange(this.range):hintRenderAssets(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value"),e),this.subElement.classList.add("fn__none"),l.preventDefault()):l.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),o.addEventListener("input",l=>{l.stopPropagation(),fetchPost("/api/search/searchAsset",{k:o.value},r=>{let d="";r.data.forEach((c,f)=>{d+=`<div data-value="${c.path}" class="b3-list-item${f===0?" b3-list-item--focus":""}">${c.hName}</div>`}),s.innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.innerHTML=renderAssetsPreview(s.firstElementChild.getAttribute("data-value"))})}),this.subElement.lastElementChild.addEventListener("click",l=>{const r=l.target;if(hasClosestByAttribute(r,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),l.stopPropagation();return}if(hasClosestByAttribute(r,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),l.stopPropagation();return}if(r.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),l.stopPropagation();return}const f=hasClosestByClassName(r,"b3-list-item");f&&(l.stopPropagation(),hintRenderAssets(f.getAttribute("data-value"),e))}),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),fetchPost("/api/search/searchAsset",{k:""},l=>{let r="";l.data.forEach((d,c)=>{r+=`<div data-value="${d.path}" class="b3-list-item${c===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${d.hName}</div></div>`}),r===""&&(r=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.querySelector(".b3-list--background").innerHTML=r})}}const Ll=t=>{window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.transferBlockRef,click(){const e=new Dialog({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/block/transferBlockRef",{fromID:t,toID:n.value}),e.destroy()})}}).element)};var Ia=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())}),Ha=(t,e,n)=>(e=t[Symbol.asyncIterator],n=(a,s)=>(s=t[a])&&(e[a]=i=>new Promise((o,l,r)=>(i=s.call(t,i),r=i.done,Promise.resolve(i.value).then(d=>o({value:d,done:r}),l)))),e?e.call(t):(t=t[Symbol.iterator](),e={},n("next"),n("return"),e));class Al{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-gutters",/Mac/.test(navigator.platform)||navigator.platform==="iPhone"?this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip):this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip.replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+")),this.element.setAttribute("data-type","a"),this.element.setAttribute("data-position","right"),this.element.addEventListener("dragstart",n=>{hideTooltip();let a=[n.target.getAttribute("data-node-id")];const s=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");s.length>0&&(a=[],s.forEach(i=>{a.push(i.getAttribute("data-node-id"))})),s.length===0&&n.dataTransfer.setDragImage(e.wysiwyg.element.querySelector(`[data-node-id="${a[0]}"]`),0,0),n.target.style.opacity="0.1",window.siyuan.dragElement=e.wysiwyg.element,n.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}${n.target.getAttribute("data-type")}${Constants.ZWSP}${n.target.getAttribute("data-subtype")}${Constants.ZWSP}${a}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const a=hasClosestByTag(n.target,"BUTTON");if(!a)return;n.preventDefault(),n.stopPropagation();const s=a.getAttribute("data-node-id");if(!s){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let i;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(o=>{if(!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return i=o,!0}),!i)return;if(n.altKey){let o=!0;Array.from(i.children).find(d=>{if(d.classList.contains("list")&&Array.from(d.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return o=!1,!0}))return!0});const l=[],r=[];Array.from(i.children).forEach(d=>{d.classList.contains("list")&&Array.from(d.children).forEach(c=>{if(c.classList.contains("li")){o?c.removeAttribute("fold"):c.childElementCount>3&&c.setAttribute("fold","1");const f=c.getAttribute("data-node-id");l.push({action:"setAttrs",id:f,data:JSON.stringify({fold:o?"0":"1"})}),r.push({action:"setAttrs",id:f,data:JSON.stringify({fold:o?"1":"0"})})}})}),transaction(e,l,r),a.removeAttribute("disabled")}else{const o=setFold(e,i);o==="1"?a.firstElementChild.style.transform="":o==="0"&&(a.firstElementChild.style.transform="rotate(90deg)")}hideElements(["select"],e),window.siyuan.menus.menu.remove();return}if(n.ctrlKey||n.metaKey)zoomOut({protyle:e,id:s});else if(n.altKey){let i;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(o=>{if(!hasClosestByAttribute(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return i=o,!0}),!i)return;if(a.getAttribute("data-type")==="NodeListItem"&&i.parentElement.getAttribute("data-node-id")){let o=!0;Array.from(i.parentElement.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return o=!1,!0});const l=[],r=[];Array.from(i.parentElement.children).find(d=>{if(d.classList.contains("li")){o?d.removeAttribute("fold"):d.childElementCount>3&&d.setAttribute("fold","1");const c=d.getAttribute("data-node-id");l.push({action:"setAttrs",id:c,data:JSON.stringify({fold:o?"0":"1"})}),r.push({action:"setAttrs",id:c,data:JSON.stringify({fold:o?"1":"0"})})}}),transaction(e,l,r)}else setFold(e,i);i.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!e.disabled?openAttr(e.wysiwyg.element.querySelector(`[data-node-id="${s}"]`),e):(this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=getEditorRange(e.wysiwyg.element.firstElementChild)),isMobile()?window.siyuan.menus.menu.fullscreen():(window.siyuan.menus.menu.popup({x:n.clientX-16,y:n.clientY-16},!0),focusByRange(e.toolbar.range)))}),this.element.addEventListener("contextmenu",n=>{const a=hasClosestByTag(n.target,"BUTTON");!a||e.disabled||a.getAttribute("data-type")==="fold"||(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(e,a),window.siyuan.menus.menu.popup({x:n.clientX-16,y:n.clientY-16},!0)),n.preventDefault(),n.stopPropagation())}),this.element.addEventListener("mouseover",n=>{const a=hasClosestByTag(n.target,"BUTTON");if(a){if(a.getAttribute("data-type")==="fold"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(s=>{s.classList.remove("protyle-wysiwyg--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a.getAttribute("data-node-id")}"]`)).find(s=>{if(!hasClosestByAttribute(s.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(s))return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(i=>{s.isSameNode(i)||i.classList.remove("protyle-wysiwyg--hl")}),s.classList.add("protyle-wysiwyg--hl"),!0}),n.preventDefault()}}),this.element.addEventListener("mouseleave",n=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")}),n.preventDefault(),n.stopPropagation()})}isMatchNode(e){const n=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+4;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){return Ia(this,null,function*(){var n,a;if(e.nodeElement.querySelector("wbr")||(n=getContenteditableElement(e.nodeElement))==null||n.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var s=Ha(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),i,o,l;i=!(o=yield s.next()).done;i=!1){const u=o.value,g=u.getAttribute("data-node-id");u.removeAttribute("fold");const m=yield fetchSyncPost("/api/transactions",{session:e.protyle.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:g}],undoOperations:[{action:"foldHeading",id:g}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:g}],[{action:"foldHeading",id:g}]),u.insertAdjacentHTML("afterend",m.data[0].doOperations[0].retData)}}catch(u){l=[u]}finally{try{i&&(o=s.return)&&(yield o.call(s))}finally{if(l)throw l[0]}}const r=e.nodeElement.outerHTML,d=(a=e.nodeElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),c=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,f=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=f,e.type==="CancelList"||e.type==="CancelBlockquote"){const u=document.createElement("template");u.innerHTML=f;const g=[{action:"delete",id:e.id}],m=[];let p=d;Array.from(u.content.children).forEach(b=>{const v=b.getAttribute("data-node-id");g.push({action:"insert",data:b.outerHTML,id:v,previousID:p,parentID:c}),m.push({action:"delete",id:v}),p=v}),m.push({action:"insert",data:r,id:e.id,previousID:d,parentID:c}),transaction(e.protyle,g,m)}else updateTransaction(e.protyle,e.id,f,r);focusByWbr(e.protyle.wysiwyg.element,getEditorRange(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&fetchPost("/api/block/getRefText",{id:u.getAttribute("data-id")},g=>{u.innerHTML=g.data})}),blockRender(e.protyle,e.protyle.wysiwyg.element),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element)})}}}turnsIntoOne(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){turnsIntoOneTransaction(e)}}}turnsInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){turnsIntoTransaction(e)}}}renderMultipleMenu(e,n){var a,s;let i=!1,o=!1,l=!1;if(n.find((u,g)=>{if(u.classList.contains("li"))return i=!0,!0;if((u.classList.contains("bq")||u.classList.contains("sb")||u.classList.contains("p"))&&(l=!0),u.nextElementSibling&&n[g+1]&&u.nextElementSibling.isSameNode(n[g+1]))o=!0;else if(g!==n.length-1)return o=!1,!0}),!i&&!e.disabled){const u=[];o&&(u.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:n,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:n,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:n,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:n,type:"Blocks2Blockquote"}))),l||u.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:n,type:"Blocks2Ps",isContinue:o})),u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:o})),u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:o})),u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:o})),u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:o})),u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:o})),u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:o})),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),o&&window.siyuan.menus.menu.append(new MenuItem({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||AIActions(n,e);const r=[{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){if(isNotEditBlock(n[0])){let u="";n.forEach(g=>{u+=removeEmbed(g)}),writeText(e.lute.BlockDOM2StdMd(u).trimEnd())}else focusByRange(getEditorRange(n[0])),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";n.forEach(g=>{g.querySelectorAll("[spellcheck]").forEach(m=>{const p=m.cloneNode(!0);p.querySelectorAll('[data-type="backslash"]').forEach(b=>{b.firstElementChild.remove()}),u+=p.textContent+`
`})}),copyPlainText(u.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){duplicateBlock(n,e)}}],d=this.genCopyTextRef(n);if(d&&r.splice(2,0,d),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:r}).element),e.disabled)return;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var u;if(isNotEditBlock(n[0])){let g="";n.forEach(m=>{g+=removeEmbed(m)}),writeText(e.lute.BlockDOM2StdMd(g).trimEnd()),(u=e.breadcrumb)==null||u.hide(),removeBlock(e,n[0],getEditorRange(n[0]))}else focusByRange(getEditorRange(n[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(u=>{hintMoveBlock(u[0],n,e)})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=e.breadcrumb)==null||u.hide(),removeBlock(e,n[0],getEditorRange(n[0]))}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const c=new MenuItem({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click(){e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(appearanceMenu(e,n)),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0}}).element;window.siyuan.menus.menu.append(c),isMobile()||c.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,e),this.genWidths(n,e),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(e,n)}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){const u=[];n.forEach(g=>{g.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(g.getAttribute("data-node-id"))}),makeCard(e.app,u)}}).element);const f=new subMenu;return(s=(a=e.app)==null?void 0:a.plugins)==null||s.forEach(u=>{u.eventBus.emit("click-blockicon",{protyle:e,menu:f,blockElements:n})}),f.menus.length>0&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:f.menus}).element)),window.siyuan.menus.menu}renderMenu(e,n){var a,s,i;hideElements(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),isMobile()&&activeBlur();const o=n.getAttribute("data-node-id"),l=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(l.length>1&&Array.from(l).find(v=>{if(o===v.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(l));let r;if(n.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${o}"]`)).find(b=>{if(!hasClosestByAttribute(b.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(b))return r=b,!0}):r=n,!r)return;const d=r.getAttribute("data-type"),c=r.getAttribute("data-subtype"),f=[];hideElements(["select"],e),r.classList.add("protyle-wysiwyg--select"),countBlockWord([o],e.block.rootID),d==="NodeParagraph"&&!e.disabled?(f.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:[r],type:"Blocks2ULs"})),f.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:[r],type:"Blocks2OLs"})),f.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:[r],type:"Blocks2TLs"})),f.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:[r],type:"Blocks2Blockquote"})),f.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[r],level:1,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[r],level:2,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[r],level:3,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[r],level:4,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[r],level:5,type:"Blocks2Hs"})),f.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[r],level:6,type:"Blocks2Hs"}))):d==="NodeHeading"&&!e.disabled?(f.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[r],level:6,type:"Blocks2Ps"})),c!=="h1"&&f.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[r],level:1,type:"Blocks2Hs"})),c!=="h2"&&f.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[r],level:2,type:"Blocks2Hs"})),c!=="h3"&&f.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[r],level:3,type:"Blocks2Hs"})),c!=="h4"&&f.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[r],level:4,type:"Blocks2Hs"})),c!=="h5"&&f.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[r],level:5,type:"Blocks2Hs"})),c!=="h6"&&f.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[r],level:6,type:"Blocks2Hs"}))):d==="NodeList"&&!e.disabled?(f.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:r,id:o,type:"CancelList"})),r.getAttribute("data-subtype")==="o"?(f.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:r,id:o,type:"OL2UL"})),f.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:r,id:o,type:"UL2TL"}))):r.getAttribute("data-subtype")==="t"?(f.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:r,id:o,type:"TL2UL"})),f.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:r,id:o,type:"TL2OL"}))):(f.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:r,id:o,type:"UL2OL"})),f.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:r,id:o,type:"OL2TL"})))):d==="NodeBlockquote"&&!e.disabled&&f.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:r,id:o,type:"CancelBlockquote"})),f.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:f}).element),e.disabled||AIActions([r],e);const u=copySubMenu(o,!0,r).concat([{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(r)?writeText(e.lute.BlockDOM2StdMd(removeEmbed(r)).trimEnd()):(focusByRange(getEditorRange(r)),document.execCommand("copy"))}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let b="";r.querySelectorAll("[spellcheck]").forEach(v=>{const h=v.cloneNode(!0);h.querySelectorAll('[data-type="backslash"]').forEach(_=>{_.firstElementChild.remove()}),b+=h.textContent+`
`}),copyPlainText(b.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){duplicateBlock([r],e)}}]),g=this.genCopyTextRef([r]);if(g&&u.splice(u.length-1,0,g),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:u}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var b;isNotEditBlock(r)?(writeText(e.lute.BlockDOM2StdMd(removeEmbed(r)).trimEnd()),removeBlock(e,r,getEditorRange(r)),(b=e.breadcrumb)==null||b.hide()):(focusByRange(getEditorRange(r)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(b=>{hintMoveBlock(b[0],[r],e)})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var b;(b=e.breadcrumb)==null||b.hide(),removeBlock(e,r,getEditorRange(r))}}).element)),d==="NodeSuperBlock"&&!e.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const b=cancelSB(e,r);transaction(e,b.doOperations,b.undoOperations),focusBlock(e.wysiwyg.element.querySelector(`[data-node-id="${b.previousId}"]`)),hideElements(["gutter"],e)}}).element);else if(d==="NodeCodeBlock"&&!e.disabled&&!r.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const b=r.getAttribute("linewrap"),v=r.getAttribute("ligatures"),h=r.getAttribute("linenumber");window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeLineWrap&&b!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",C=>{const k=_.querySelector("input");C.target.tagName!=="INPUT"&&(k.checked=!k.checked),r.setAttribute("linewrap",k.checked.toString()),r.querySelector(".hljs").removeAttribute("data-render"),highlightRender(r),fetchPost("/api/attr/setBlockAttrs",{id:o,attrs:{linewrap:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${v==="true"||window.siyuan.config.editor.codeLigatures&&v!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",C=>{const k=_.querySelector("input");C.target.tagName!=="INPUT"&&(k.checked=!k.checked),r.setAttribute("ligatures",k.checked.toString()),r.querySelector(".hljs").removeAttribute("data-render"),highlightRender(r),fetchPost("/api/attr/setBlockAttrs",{id:o,attrs:{ligatures:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&h!=="false"?" checked":""}></div>`,bind(_){_.addEventListener("click",C=>{const k=_.querySelector("input");C.target.tagName!=="INPUT"&&(k.checked=!k.checked),r.setAttribute("linenumber",k.checked.toString()),r.querySelector(".hljs").removeAttribute("data-render"),highlightRender(r),fetchPost("/api/attr/setBlockAttrs",{id:o,attrs:{linenumber:k.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(d==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(r.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const b=r.style.height;let v=r.outerHTML;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${b?parseInt(b):"420"}">`,bind:h=>{h.querySelector("input").addEventListener("change",_=>{const C=(_.target.value||"420")+"px";r.style.height=C,r.firstElementChild.nextElementSibling.style.height=C,updateTransaction(e,o,r.outerHTML,v),v=r.outerHTML,_.stopPropagation();const k=echarts.getInstanceById(r.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));k&&k.resize()})}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,r)}}]}).element)}else if(d==="NodeTable"&&!e.disabled){let b=getEditorRange(r);const v=r.querySelector("table");v.contains(b.startContainer)||(b=getEditorRange(v.querySelector("th")));const h=hasClosestByMatchTag(b.startContainer,"TD")||hasClosestByMatchTag(b.startContainer,"TH");h&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:tableMenu(e,r,h,b)}).element))}else if((d==="NodeVideo"||d==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:d==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:videoMenu(e,r,d)}).element);else if(d==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:iframeMenu(e,r)}).element);else if(d==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,r)}}).element);else if(d==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const b=r.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new MenuItem({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){r.removeAttribute("data-render"),blockRender(e,r)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,r)}},{type:"separator"},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&b!=="false"?" checked":""}></div>`,bind(v){v.addEventListener("click",h=>{const _=v.querySelector("input");h.target.tagName!=="INPUT"&&(_.checked=!_.checked),r.setAttribute("breadcrumb",_.checked.toString()),fetchPost("/api/attr/setBlockAttrs",{id:o,attrs:{breadcrumb:_.checked.toString()}}),r.removeAttribute("data-render"),blockRender(e,r),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${r.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(v){v.addEventListener("click",h=>{const _=v.querySelector("input");h.target.tagName!=="INPUT"&&(_.checked=!_.checked),r.setAttribute("custom-heading-mode",_.checked?"1":"0"),fetchPost("/api/attr/setBlockAttrs",{id:o,attrs:{"custom-heading-mode":_.checked?"1":"0"}}),r.removeAttribute("data-render"),blockRender(e,r),window.siyuan.menus.menu.remove()})}}]}).element)}else if(d==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const b=[];c!=="h1"&&b.push(this.genHeadingTransform(e,o,1)),c!=="h2"&&b.push(this.genHeadingTransform(e,o,2)),c!=="h3"&&b.push(this.genHeadingTransform(e,o,3)),c!=="h4"&&b.push(this.genHeadingTransform(e,o,4)),c!=="h5"&&b.push(this.genHeadingTransform(e,o,5)),c!=="h6"&&b.push(this.genHeadingTransform(e,o,6)),window.siyuan.menus.menu.append(new MenuItem({type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:b}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:o},v=>{writeText(v.data+Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:o},v=>{writeText(v.data+Constants.ZWSP),fetchPost("/api/block/getHeadingDeleteTransaction",{id:o},h=>{h.data.doOperations.forEach(_=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${_.id}"]`).forEach(C=>{C.remove()})}),transaction(e,h.data.doOperations,h.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingDeleteTransaction",{id:o},v=>{v.data.doOperations.forEach(h=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${h.id}"]`).forEach(_=>{_.remove()})}),transaction(e,v.data.doOperations,v.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.options.backlinkData||(window.siyuan.menus.menu.append(new MenuItem({accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)}/${updateHotkeyTip("\u2318Click")}`,label:window.siyuan.languages.enter,click:()=>{zoomOut({protyle:e,id:o})}}).element),window.siyuan.menus.menu.append(new MenuItem({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{if(e.block.showAll)zoomOut({protyle:e,id:e.block.parent2ID,focusId:o});else{const b=e.path.split("/");b.length>2&&openMobileFileById(e.app,b[b.length-2],[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL])}}}).element)),!e.disabled){window.siyuan.menus.menu.append(new MenuItem({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){hideElements(["select"],e),countBlockWord([],e.block.rootID),insertEmptyBlock(e,"beforebegin",o)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){hideElements(["select"],e),countBlockWord([],e.block.rootID),insertEmptyBlock(e,"afterend",o)}}).element);const b=r.lastElementChild.querySelector(".protyle-attr--refcount");b&&b.textContent&&transferBlockRef(o)}if(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){hideElements(["select"],e),jumpToParentNext(e,r)}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),d!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.fold,accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)}/${updateHotkeyTip("\u2325Click")}`,click(){setFold(e,r),focusBlock(r)}}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.attr,accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7Click"),click(){openAttr(r,e)}}).element)),!e.disabled){const b=new MenuItem({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click(){e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(appearanceMenu(e,[r])),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0}}).element;window.siyuan.menus.menu.append(b),isMobile()||b.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([r],e),this.genWidths([r],e)}window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(d)&&((a=getContenteditableElement(r))==null?void 0:a.textContent.trim())!==""&&(d!=="NodeCodeBlock"||d==="NodeCodeBlock"&&!r.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openWechatNotify(r)}}).element),d!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(e,[r])}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){makeCard(e.app,[r.getAttribute("data-node-id")])}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element));const m=new subMenu;(i=(s=e.app)==null?void 0:s.plugins)==null||i.forEach(b=>{b.eventBus.emit("click-blockicon",{protyle:e,menu:m,blockElements:[r]})}),m.menus.length>0&&(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:m.menus}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element));let p=r.getAttribute("updated")||"";return p&&(p=`${window.siyuan.languages.modifiedAt} ${dayjs(p).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,type:"readonly",label:`${p}${window.siyuan.languages.createdAt} ${dayjs(o.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,n,a){return{icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){fetchPost("/api/block/getHeadingLevelTransaction",{id:n,level:a},s=>{s.data.doOperations.forEach(i=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{o.outerHTML=i.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(o=>{mathRender(o)})}),transaction(e,s.data.doOperations,s.data.undoOperations)})}}}genClick(e,n,a){updateBatchTransaction(e,n,a),focusBlock(e[0])}genAlign(e,n){window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,n,a=>{a.style.textAlign="left"})}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,n,a=>{a.style.textAlign="center"})}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,n,a=>{a.style.textAlign="right"})}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(e,n,a=>{a.style.textAlign="justify"})}},{type:"separator"},{label:window.siyuan.languages.ltr,icon:"iconLtr",click:()=>{this.genClick(e,n,a=>{a.style.direction="ltr"})}},{label:window.siyuan.languages.rtl,icon:"iconRtl",click:()=>{this.genClick(e,n,a=>{a.style.direction="rtl"})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,a=>{a.style.textAlign="",a.style.direction=""})}}]}).element)}genWidths(e,n){const a=[];["25%","33%","50%","67%","75%"].forEach(i=>{a.push({label:i,click:()=>{this.genClick(e,n,o=>{o.style.width=i,o.style.flex="none"})}})}),a.push({type:"separator"});let s=100;if(e.length===1){const i=e[0].style.width;i.endsWith("%")&&(s=parseInt(i))}window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.width,submenu:a.concat([{label:`<div aria-label="${s}%" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${s}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(i){const o=i.querySelector("input");o.addEventListener("input",()=>{e.forEach(d=>{d.style.width=o.value+"%",d.style.flex="none"}),o.parentElement.setAttribute("aria-label",`${o.value}%`)});const l=[],r=[];e.forEach(d=>{l.push({action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML})}),o.addEventListener("change",()=>{e.forEach(d=>{r.push({action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML})}),transaction(n,r,l),window.siyuan.menus.menu.remove(),focusBlock(e[0])})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,i=>{i.style.width&&(i.style.width="",i.style.flex="")})}}])}).element)}genCopyTextRef(e){return isNotEditBlock(e[0])?!1:{label:`${window.siyuan.languages.copy} ${window.siyuan.languages.text} *`,click(){e[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(e[0])),document.execCommand("copy")}}}render(e,n,a){var s;const i=a.parentElement.querySelector(".protyle-title__input");if(i&&i.getAttribute("data-render")!=="true")return;const o=a.parentElement.parentElement.querySelector(".protyle-select");if(o&&!o.classList.contains("fn__none"))return;let l="",r=n,d=0,c=0,f,u=!1;for(;r;){const h=!u||u&&r.getAttribute("fold")==="1";if(!hasClosestByAttribute(r.parentElement,"data-type","NodeBlockQueryEmbed")){let k;if(h&&(k=r.getAttribute("data-type")),c===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(k))return;const L=getTopAloneElement(r);f=L.querySelector(".li")||L.querySelector(".list"),hasClosestByAttribute(f,"data-type","NodeBlockQueryEmbed")&&(f=void 0),!L.isSameNode(r)&&k!=="NodeHeading"&&(r=L,k=r.getAttribute("data-type"))}k==="NodeListItem"&&c===1&&!h&&(l=""),c+=1,h&&(l=`<button ${e.disabled?"":'draggable="true"'} data-type="${k}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${getIconByType(k,r.getAttribute("data-subtype"))}"></use></svg></button>`+l);let E="";if(k==="NodeListItem"&&r.childElementCount>3||k==="NodeHeading"){const L=r.getAttribute("fold");E=`<button data-type="fold"><svg style="width:10px${L&&L==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(k==="NodeListItem"||k==="NodeList")&&(f=r,k==="NodeListItem"&&r.childElementCount>3&&(l=`<button ${e.disabled?"":'draggable="true"'} data-type="${k}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${getIconByType(k,r.getAttribute("data-subtype"))}"></use></svg></button>${E}`)),k==="NodeHeading"&&(l=l+E),k==="NodeBlockquote"&&(d+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(u=!0)}const C=hasClosestBlock(r.parentElement);if(C)r=C;else break}let g=!0;const m=this.element.querySelectorAll("button");if(m.length!==l.split("</button>").length-1?g=!1:m.forEach(h=>{const _=h.getAttribute("data-node-id");_&&l.indexOf(_)===-1&&(g=!1)}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";let p=n.getBoundingClientRect(),b=0;f?(p=f.firstElementChild.getBoundingClientRect(),d=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(p=r.getBoundingClientRect(),d=0):(p.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||p.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&p.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8)&&(b=(p.height-this.element.clientHeight)/2),this.element.style.top=`${Math.max(p.top,a.parentElement.getBoundingClientRect().top)+b}px`;let v=p.left-this.element.clientWidth-d;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?v=r.getBoundingClientRect().left-this.element.clientWidth-d:r.getAttribute("data-type")==="NodeAttributeView"&&(v=v+(parseInt((s=r.firstElementChild.firstElementChild)==null?void 0:s.style.paddingLeft)||0)),this.element.style.left=`${v}px`,v<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${p.left-this.element.clientWidth-d/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((h,_)=>{_!==0&&(h.firstElementChild.style.height="14px"),l+=h.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(h=>{h.style.height=""})}}const Da=(t,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){fetchPost("/api/filetree/removeDoc",{notebook:t,path:e});return}fetchPost("/api/block/getDocInfo",{id:getDisplayName(e,!0,!0)},n=>{const a=escapeHtml(n.data.name);let s=`${window.siyuan.languages.confirmDelete} <b>${a}</b>?`;n.data.subFileCount>0&&(s=`${window.siyuan.languages.confirmDelete} <b>${a}</b> ${window.siyuan.languages.andSubFile.replace("x",n.data.subFileCount)}?`),confirmDialog(window.siyuan.languages.deleteOpConfirm,s,()=>{fetchPost("/api/filetree/removeDoc",{notebook:t,path:e})})})},xl=t=>{if(t.length===1){const e=hasTopClosestByTag(t[0],"UL");if(e){const n=e.getAttribute("data-url");t[0].getAttribute("data-type")==="navigation-file"?Da(n,t[0].getAttribute("data-path")):confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(getNotebookName(n))}</b>?`,()=>{fetchPost("/api/notebook/removeNotebook",{notebook:n,callback:Constants.CB_MOUNT_REMOVE})})}}else{const e=[];if(t.forEach(n=>{n.getAttribute("data-path")!=="/"&&e.push(n.getAttribute("data-path"))}),e.length===0){showMessage(window.siyuan.languages.notBatchRemove);return}confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length),()=>{fetchPost("/api/filetree/removeDocs",{paths:e})})}};var Ba=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});class Sl{constructor(e){const n=document.createElement("div");n.className="protyle-breadcrumb";const a=e.options.action.includes(Constants.CB_GET_ALL)&&!isMobile();n.innerHTML=`<div class="protyle-breadcrumb__bar"></div>
<span class="protyle-breadcrumb__space"></span>
<button class="block__icon block__icon--show ft__smaller fn__flex-center${a?"":" fn__none"}" style="line-height: 14px" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
<span class="fn__space${a?"":" fn__none"}"></span>
<button class="b3-tooltips b3-tooltips__w block__icon block__icon--show fn__flex-center" data-menu="true" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",s=>{let i=s.target;for(;i&&!i.isEqualNode(n);){const o=i.getAttribute("data-node-id");if(o){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed||zoomOut({protyle:e,id:o}),s.preventDefault();break}else if(i.getAttribute("data-menu")==="true"){this.showMenu(e,{x:s.clientX,y:s.clientY}),s.preventDefault();break}else if(i.getAttribute("data-type")==="exit-focus"){zoomOut({protyle:e,id:e.block.rootID,focusId:e.block.id}),s.preventDefault();break}else if(i.getAttribute("data-type")==="context"){s.preventDefault(),i.classList.contains("block__icon--active")?(zoomOut({protyle:e,id:e.options.blockId}),i.classList.remove("block__icon--active")):(fetchPost("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{onGet({data:l,protyle:e,action:[Constants.CB_GET_HL]}),this.toggleExit(!0)}),i.classList.add("block__icon--active"));break}i=i.parentElement}}),n.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(s=>{s.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",s=>{if(!e.selectElement.classList.contains("fn__none"))return;const i=s.target,o=hasClosestByAttribute(i,"data-node-id",null);if(o){e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(r=>{r.classList.remove("protyle-wysiwyg--hl")});const l=e.wysiwyg.element.querySelector(`[data-node-id="${o.getAttribute("data-node-id")}"]`);l&&l.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",s=>{this.element.scrollLeft=this.element.scrollLeft+s.deltaY},{passive:!0})}startRecord(e){this.messageId=showMessage(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(e,[n])}),this.mediaRecorder.startRecordingNewWavFile()}toggleExit(e){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?(n.classList.add("fn__none"),n.nextElementSibling.classList.add("fn__none")):(n.classList.remove("fn__none"),n.nextElementSibling.classList.remove("fn__none"))}showMenu(e,n){let a;const s=hasClosestBlock(getEditorRange(e.element).startContainer);s&&(a=s.getAttribute("data-node-id")),fetchPost("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},i=>{var o,l;if(window.siyuan.menus.menu.remove(),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let d="";d='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?d+=` accept="${e.options.upload.accept}">`:d+=">";const c=new MenuItem({icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${d}`}).element;c.querySelector("input").addEventListener("change",f=>{f.target.files.length!==0&&(uploadFiles(e,f.target.files,f.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(c),(window.siyuan.config.system.container!=="android"||!window.JSAndroid)&&window.siyuan.menus.menu.append(new MenuItem({current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(o=this.mediaRecorder)!=null&&o.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Ba(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(f=>{this.mediaRecorder=new RecordMedia(f),this.mediaRecorder.recorder.onaudioprocess=u=>{if(!this.mediaRecorder.isRecording)return;const g=u.inputBuffer.getChannelData(0),m=u.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(g,m)},this.startRecord(e)}).catch(()=>{showMessage(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const f=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(e,[f])}else hideMessage(this.messageId),this.startRecord(e)})}).element)}e.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.optimizeTypography,icon:"iconFormat",click:()=>{hideElements(["toolbar"],e),fetchPost("/api/format/autoSpace",{id:e.block.rootID})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){netImg2LocalAssets(e)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){needSubscribe()||confirmDialog("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{fetchPost("/api/asset/uploadCloud",{id:e.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){confirmDialog("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{fetchPost("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),(l=e.scroll)!=null&&l.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new MenuItem({current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.childElementCount>0&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{reloadProtyle(e,!isMobile())}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{deleteFile(e.notebookId,e.path)}}).element),isMobile()||window.siyuan.menus.menu.append(new MenuItem({icon:e.element.className.includes("fullscreen")?"iconFullscreenExit":"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{fullscreen(e.element),setPadding(e)}}).element);const r=[{current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{setEditMode(e,"wysiwyg")}}];r.push({current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{setEditMode(e,"preview"),window.siyuan.menus.menu.remove()}}),window.siyuan.menus.menu.append(new MenuItem({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:r}).element),window.siyuan.menus.menu.append(exportMd(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:Constants.ZWSP,type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${i.data.runeCount}</div>
<div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${i.data.wordCount}</div>
<div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${i.data.linkCount}</div>
<div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${i.data.imageCount}</div>
<div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${i.data.refCount}</div>`}).element),isMobile()?window.siyuan.menus.menu.fullscreen():window.siyuan.menus.menu.popup(n)})}render(e,n=!1){var a;let s,i;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?i=e.wysiwyg.element.firstElementChild:i=hasClosestBlock(s.startContainer)),i||(i=e.wysiwyg.element.firstElementChild);const o=i.getAttribute("data-node-id");if(o===this.id&&!n){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(d=>{d.classList.remove("protyle-breadcrumb__item--active")});const r=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);r&&r.classList.add("protyle-breadcrumb__item--active");return}this.id=o;const l=[];(a=this.element.parentElement)!=null&&a.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&l.push("NodeTextMark-mark"),fetchPost("/api/block/getBlockBreadcrumb",{id:o,excludeTypes:l},r=>{let d="";r.data.forEach((u,g)=>{let m=!1;(!e.block.showAll&&u.id===e.block.parentID||e.block.showAll&&u.id===e.block.id)&&(m=!0),g===0&&!e.options.render.breadcrumbDocName?d+=`<span class="protyle-breadcrumb__item${m?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${r.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${getIconByType(u.type,u.subType)}"></use></svg>
</span>`:d+=`<span class="protyle-breadcrumb__item${m?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${r.data.length===1||g===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${getIconByType(u.type,u.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${u.name}">${u.name}</span>
</span>`,g!==r.data.length-1&&(d+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=d;const c=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(c.length===0)return;let f=!1;for(;this.element.scrollHeight>30&&!f&&c.length>1;)c.find((u,g)=>{if(g>0){if(!u.classList.contains("protyle-breadcrumb__text--ellipsis"))return u.classList.add("protyle-breadcrumb__text--ellipsis"),!0;g===c.length-1&&u.classList.contains("protyle-breadcrumb__text--ellipsis")&&(f=!0)}});this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth+14)})}hide(){this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0}}var wn=(t,e,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(t,e)).next())});class Tl{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img class="fn__none">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="b3-chips"></div>
<div class="protyle-background__iconw">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="protyle-icons fn__flex-center">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.changeIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,isMobile()?this.imgElement.addEventListener("touchstart",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.touches[0].clientY,s=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),s.ontouchmove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.touches[0].clientY)/i*100+o).toFixed(2)}%`,n.preventDefault()},s.ontouchend=()=>{s.ontouchmove=null,s.ontouchstart=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null}}):(this.element.addEventListener("dragover",n=>wn(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>wn(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&uploadFiles(e,[n.dataTransfer.files[0]],void 0,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":i}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,s=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),s.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/i*100+o).toFixed(2)}%`,n.preventDefault()},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null}})),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&uploadFiles(e,n.target.files,n.target,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":i}})})}),this.element.addEventListener(getEventName(),n=>{if(e.disabled)return;let a=n.target;for(hideElements(["gutter"],e);a&&!a.isEqualNode(this.element);){const s=a.getAttribute("data-type");if(s==="position"){const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");i[0].classList.add("fn__none"),i[1].classList.remove("fn__none"),i[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(s==="cancel"||s==="confirm"){this.imgElement.style.cursor="";const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(i[0].classList.remove("fn__none"),i[1].classList.add("fn__none"),i[2].classList.add("fn__none"),s==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,e.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(s==="open-emoji"){openEmojiPanel(e.block.rootID,this.iconElement),n.preventDefault(),n.stopPropagation();break}else if(s==="random"){const i=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"],o=i[getRandom(0,i.length-1)];this.ial["title-img"]=o,this.render(this.ial,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(s==="remove"){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(s==="icon"){const i=getRandomEmoji();i&&(updateFileTreeEmoji(i,e.block.rootID),updateOutlineEmoji(i,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:i}}),e.model&&e.model.parent.setDocIcon(i)),n.preventDefault(),n.stopPropagation();break}else if(s==="tag"){this.openTag(e),n.preventDefault(),n.stopPropagation();break}else if(s==="link"){const i=new Dialog({title:window.siyuan.languages.link,width:isMobile()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),o=i.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${i.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,e.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),i.destroy()}),i.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(s==="open-search"){const i=window.siyuan.storage[Constants.LOCAL_SEARCHDATA];popSearch(e.app,{removed:i.removed,sort:i.sort,group:i.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${a.textContent}#`,r:"",page:1,types:Object.assign({},i.types)}),n.preventDefault(),n.stopPropagation();break}else if(s==="remove-tag"){a.parentElement.remove();const i=this.getTags();fetchPost("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:i.toString()}}),i.length===0?delete this.ial.tags:this.ial.tags=i.toString(),this.render(this.ial,e.block.rootID),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}render(e,n){var a;const s=e["title-img"],i=e.icon,o=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",n),o){let l="";const r=["secondary","primary","info","success","warning","error",""];o.split(",").forEach((d,c)=>{l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[c%7]}" data-type="open-search">${d}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=l}else this.tagsElement.innerHTML="";if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=unicode2Emoji(i)):this.iconElement.classList.add("fn__none"),s)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(s)),s.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");s?this.element.style.minHeight=isMobile()?"200px":"30vh":i?this.element.style.minHeight=this.tagsElement.clientHeight+56+"px":o?this.element.style.minHeight=this.tagsElement.clientHeight+"px":this.element.style.minHeight="0"}openTag(e){fetchPost("/api/search/searchTag",{k:""},n=>{let a="";n.data.tags.forEach((l,r)=>{a+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${l}</div>`}),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="fn__flex-column" style="max-height:50vh"><input style="margin: 4px 8px 8px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>
</div>`;const s=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),i=window.siyuan.menus.menu.element.querySelector("input");i.addEventListener("keydown",l=>{if(l.stopPropagation(),!l.isComposing)if(upDownHint(s,l),l.key==="Enter"){const r=s.querySelector(".b3-list-item--focus");r?this.addTags(r.textContent,e):this.addTags(i.value,e),window.siyuan.menus.menu.remove()}else l.key==="Escape"&&window.siyuan.menus.menu.remove()}),i.addEventListener("input",l=>{l.stopPropagation(),fetchPost("/api/search/searchTag",{k:i.value},r=>{let d="",c=!1;r.data.tags.forEach(f=>{d+=`<div class="b3-list-item">${f}</div>`,f===`<mark>${r.data.k}</mark>`&&(c=!0)}),!c&&r.data.k&&(d=`<div class="b3-list-item"><mark>${r.data.k}</mark></div>`+d),s.innerHTML=d,s.firstElementChild.classList.add("b3-list-item--focus")})}),s.addEventListener("click",l=>{const r=l.target,d=hasClosestByClassName(r,"b3-list-item");d&&this.addTags(d.textContent,e)});const o=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+o.height}),i.focus()})}getTags(){const e=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(n=>{e.push(n.textContent.trim())}),e}addTags(e,n){window.siyuan.menus.menu.remove();const a=this.getTags();a.includes(e)||(a.push(e),fetchPost("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID))}}let _n;const Ml=t=>{hideElements(["gutter"],t),setPadding(t),clearTimeout(_n),_n=window.setTimeout(()=>{if(typeof echarts!="undefined"&&t.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(e=>{const n=echarts.getInstanceById(e.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));n&&n.resize()}),t.wysiwyg.element.querySelectorAll(".av").forEach(e=>{if(e.style.width=e.parentElement.clientWidth+"px",e.getAttribute("data-render")==="true"){const n=e.parentElement.style.paddingLeft,a=e.parentElement.style.paddingRight,s=e.firstElementChild.firstElementChild;s.style.paddingLeft=n,s.style.paddingRight=a;const i=e.querySelector(".av__scroll").firstElementChild;i.style.paddingLeft=n,i.style.paddingRight=a}}),!t.disabled&&t.toolbar.range){let e=t.toolbar.range.getBoundingClientRect();if(e.height===0){const a=hasClosestBlock(t.toolbar.range.startContainer);a&&(e=a.getBoundingClientRect())}if(e.height===0)return;const n=t.element.getBoundingClientRect();(n.top+30>e.top||n.bottom<e.bottom)&&t.toolbar.range.startContainer.parentElement.scrollIntoView(n.top>e.top)}},Constants.TIMEOUT_TRANSITION)};class Il{constructor(e,n,a){this.version=Constants.SIYUAN_VERSION;const i=new Options(a).merge();if(this.protyle={app:e,transactionTime:new Date().getTime(),id:genUUID(),disabled:!1,updated:!1,element:n,options:i,block:{}},this.protyle.hint=new Hint(this.protyle),i.render.breadcrumb&&(this.protyle.breadcrumb=new Breadcrumb(this.protyle)),i.render.background&&(this.protyle.background=new Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),i.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Undo,this.protyle.wysiwyg=new WYSIWYG(this.protyle),this.protyle.toolbar=new Toolbar(this.protyle),this.protyle.scroll=new Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Gutter(this.protyle)),(i.upload.url||i.upload.handler)&&(this.protyle.upload=new Upload),this.init(),!i.action.includes(Constants.CB_GET_HISTORY)){if(this.protyle.ws=new Model({app:e,id:this.protyle.id,type:"protyle",msgCallback:o=>{switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&reloadProtyle(this.protyle,!1);break;case"addLoading":o.data===this.protyle.block.rootID&&addLoading(this.protyle,o.msg);break;case"transactions":o.data[0].doOperations.forEach(l=>{onTransaction(this.protyle,l,!1)});break;case"readonly":o.data?disabledProtyle(this.protyle):enableProtyle(this.protyle);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?fetchPost("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{onGet({data:l,protyle:this.protyle})}):reloadProtyle(this.protyle,!1));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(getSelection().rangeCount>0&&this.protyle.title.editElement.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(l=>{l.getAttribute("data-subtype")==="d"&&(l.textContent=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&setEmpty(e);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&setEmpty(e);break}}}),setPadding(this.protyle),a.backlinkData){this.protyle.block.rootID=a.blockId,renderBacklink(this.protyle,a.backlinkData);return}if(!a.blockId){removeLoading(this.protyle);return}a.scrollAttr||i.action.includes(Constants.CB_GET_SCROLL)&&this.protyle.options.mode!=="preview"?a.scrollAttr?getDocByScroll({protyle:this.protyle,scrollAttr:a.scrollAttr,mergedOptions:i,cb:()=>{this.afterOnGet(i)}}):fetchPost("/api/block/getDocInfo",{id:a.blockId},o=>{let l;if(o.data.ial.scroll)try{l=JSON.parse(o.data.ial.scroll.replace(/&quot;/g,'"'))}catch(r){l=void 0}l?(l.rootId=o.data.rootID,getDocByScroll({protyle:this.protyle,scrollAttr:l,mergedOptions:i,cb:()=>{this.afterOnGet(i)}})):this.getDoc(i)}):this.getDoc(i)}this.protyle.contentElement.classList.add("protyle-content--transition")}getDoc(e){var n;fetchPost("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(Constants.CB_GET_BACKLINK),mode:e.action&&e.action.includes(Constants.CB_GET_CONTEXT)?3:0,size:(n=e.action)!=null&&n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:this.protyle,action:e.action}),this.afterOnGet(e)})}afterOnGet(e){this.protyle.model,this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),e.after&&e.after(this)}init(){this.protyle.lute=setLute({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Preview(this.protyle),initUI(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){destroy(this.protyle)}resize(){resize(this.protyle)}}const Hl=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,Dl=(t,e,n=[Constants.CB_GET_HL])=>{if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e,action:n},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),window.siyuan.mobile.editor){hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let a;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!hasClosestByAttribute(s.parentElement,"data-type","NodeBlockQueryEmbed"))return a=s,!0}),a){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,a,!0),closePanel();return}}fetchPost("/api/block/getBlockInfo",{id:e},a=>{if(a.code===3){showMessage(a.msg);return}window.siyuan.mobile.editor?(document.getElementById("empty").classList.contains("fn__none")&&saveScroll(window.siyuan.mobile.editor.protyle),pushBack(),addLoading(window.siyuan.mobile.editor.protyle),fetchPost("/api/filetree/getDoc",{id:e,size:n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(Constants.CB_GET_CONTEXT)?3:0},s=>{var i;onGet({data:s,protyle:window.siyuan.mobile.editor.protyle,action:n}),(i=window.siyuan.mobile.editor.protyle.breadcrumb)==null||i.render(window.siyuan.mobile.editor.protyle)}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Protyle(t,document.getElementById("editor"),{blockId:e,action:n,render:{scroll:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]},after:s=>{(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(s.protyle)}}),document.getElementById("toolbarName").value=a.data.rootTitle==="Untitled"?"":a.data.rootTitle,setEditor(),closePanel()})},Bl=(t,e,n=!1)=>{if(!e){if(t.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(t.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&t.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.toolbar&&t.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&t.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&!a.classList.contains("block__icon--active"))&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}t.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},Nl=t=>{if(t.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),t.includes("util")){const e=getCurrentEditor();e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0)}t.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),t.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},Na=(t,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const n=e.commonAncestorContainer;return t.isEqualNode(n)||t.contains(n)},$l=t=>{const e=hasClosestByAttribute(t.startContainer,"data-type","NodeTable");if(t.toString()!==""&&e&&t.commonAncestorContainer.nodeType!==3){const n=t.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=hasClosestByMatchTag(t.startContainer,"TD")||hasClosestByMatchTag(t.startContainer,"TH"),s=hasClosestByMatchTag(t.endContainer,"TD")||hasClosestByMatchTag(t.endContainer,"TH");if(!a&&!s){const i=e.querySelector("th")||e.querySelector("td");t.setStart(i.firstChild,0),t.setEnd(i.lastChild,i.lastChild.textContent.length)}else if(a&&!a.contains(t.endContainer)){const i=t.cloneRange();t.setEnd(a.lastChild,a.lastChild.textContent.length),t.toString()===""&&s&&(t.setStart(s.firstChild,0),t.setEnd(i.endContainer,i.endOffset))}}}},Pl=(t,e,n)=>{const a=getContenteditableElement(e);if(a){let o;if(a.tagName==="TABLE"){const l=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH");if(l&&(o=vn(l,e,n),o.start!==0||o.end!==l.textContent.length))return n.setStart(l.firstChild,0),n.setEndAfter(l.lastChild),t.toolbar.render(t,n),countSelectWord(n,t.block.rootID),!0}else if(o=vn(a,e,n),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){n.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){n.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return ze(n),t.toolbar.render(t,n),countSelectWord(n,t.block.rootID),!0}}n.collapse(!0);const s=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.wysiwyg.element.childElementCount===s.length&&s[0].parentElement.isSameNode(t.wysiwyg.element))return!0;hideElements(["select"],t);const i=[];Array.from(t.wysiwyg.element.children).forEach(o=>{o.classList.add("protyle-wysiwyg--select"),i.push(o.getAttribute("data-node-id"))}),countBlockWord(i,t.block.rootID)},Rl=(t,e)=>{const n=document.caretRangeFromPoint(t,e),a=hasClosestByAttribute(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},ut=t=>{let e;if(getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0),t.isSameNode(e.startContainer)||t.contains(e.startContainer)))return e;t.focus({preventScroll:!0});let n;return t.classList.contains("table")?n=t.querySelector("th")||t.querySelector("td"):(n=W(t),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||t.querySelector("td")):n=t),e=n.ownerDocument.createRange(),e.setStart(n||t,0),e.collapse(!0),e},Ol=(t,e)=>{if(e||(e=ut(t)),!t.contains(e.startContainer))return{left:0,top:0};let n;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const a=e.startContainer.parentElement;if(a&&a.getClientRects().length>0)n=a.getClientRects()[0];else return{left:0,top:0}}else{const a=e.startContainer.children;if(a[e.startOffset]&&a[e.startOffset].getClientRects().length>0)n=a[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const s=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),n=e.getClientRects()[0],e.setEnd(s.endContainer,s.endOffset),e.setStart(s.startContainer,s.startOffset)}else n=e.startContainer.getClientRects()[0];if(!n){let s=e.startContainer.childNodes[e.startOffset];if(s||(s=e.startContainer.childNodes[e.startOffset-1]),!s)n=e.getBoundingClientRect();else{for(;!s.getClientRects||s.getClientRects&&s.getClientRects().length===0;)s=s.parentElement;n=s.getClientRects()[0]}}}else{const a=e.getClientRects();return{left:a[a.length-1].left,top:a[0].top}}return{left:n.left,top:n.top}},vn=(t,e,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(e&&!Na(e,n))return a;const s=n.cloneRange();return t.childNodes[0]&&t.childNodes[0].childNodes[0]?s.setStart(t.childNodes[0].childNodes[0],0):s.selectNodeContents(t),s.setEnd(n.startContainer,n.startOffset),a.start=s.toString().length,a.end=a.start+n.toString().length,a};function ft(t,e,n,a){if(!e)return!1;if(n(e))return!0;for(let s=0,i=e.childNodes.length;s<i;s++)if(ft(e,e.childNodes[s],n,!0))return!0;if(!a){let s=e;for(;s&&s!==t;){let i=s.nextSibling;for(;i;){if(ft(t,i,n,!0))return!0;i=i.nextSibling}s=s.parentNode}}return!1}const It=(t,e,n=!0)=>{if(!t)return e;let a=t.lastChild;for(;a&&a.nodeType!==3;)a=a.lastChild;return a?(n?e.setStart(a,a.textContent.length):e.setEnd(a,a.textContent.length),e):(e.selectNodeContents(t),e)},$a=(t,e)=>{if(!t)return e;let n=t.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return e.setStartBefore(n),e;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?e.setStartBefore(n):e.setStart(n,0),e):(e.selectNodeContents(t),e)},Pa=(t,e,n)=>{if(!t)return!1;const a=W(t);if(a)t=a;else if(te(t))return En(t);let s;ft(t,t.firstChild,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return e<=r?(s=l,!0):(e-=r,n-=r,!1)}});let i;s&&ft(t,s,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return n<=r?(i=l,!0):(n-=r,!1)}});const o=document.createRange();return s?e<s.data.length?o.setStart(s,e):o.setStartAfter(s):e===0?o.setStart(t,0):It(W(t),o),i?n<i.data.length?o.setEnd(i,n):o.setEndAfter(i):n===0?o.setEnd(t,0):It(W(t),o,!1),ze(o),o},ql=(t,e)=>{var n;const a=t.querySelectorAll("wbr");if(a.length===0)return;a.forEach((i,o)=>{o!==0&&i.remove()});const s=a[0];if(!s.previousElementSibling)s.previousSibling?e.setStart(s.previousSibling,s.previousSibling.textContent.length):s.nextSibling?s.nextSibling.nodeType===3?e.setStart(s.nextSibling,0):e.setStartAfter(s):e.setStart(s.parentElement,0);else{const i=hasPreviousSibling(s);i&&s.previousElementSibling.isSameNode(i)?((n=s.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?e.setStart(s.previousElementSibling.lastChild,s.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?e.setStartAfter(i):e.setStartBefore(s):e.setStart(s.previousSibling,s.previousSibling.textContent.length)}e.collapse(!0),s.remove(),ze(e)},ze=t=>{if(!t)return;const e=window.getSelection();e.removeAllRanges(),e.addRange(t)},En=(t,e,n=!0)=>{var a,s,i;if(!t)return!1;if(t.classList.contains("render-node")||t.classList.contains("iframe")||t.classList.contains("hr")){const l=document.createRange(),r=t.getAttribute("data-type");let d=!1;return r==="NodeThematicBreak"?(l.selectNodeContents(t.firstElementChild),d=!0):r==="NodeBlockQueryEmbed"?((a=t.lastElementChild.previousElementSibling)!=null&&a.firstChild?(l.selectNodeContents(t.lastElementChild.previousElementSibling.firstChild),l.collapse(!0)):(l.selectNodeContents(t),l.collapse(!0)),d=!0):["NodeMathBlock","NodeHTMLBlock"].includes(r)?((i=(s=t.lastElementChild.previousElementSibling)==null?void 0:s.lastElementChild)!=null&&i.firstChild?(l.selectNodeContents(t.lastElementChild.previousElementSibling.lastElementChild.firstChild),l.collapse(!0)):t.lastElementChild.previousElementSibling&&(l.selectNodeContents(t.lastElementChild.previousElementSibling),l.collapse(!0)),d=!0):r==="NodeIFrame"||r==="NodeWidget"?(l.setStart(t,0),d=!0):r==="NodeVideo"?(l.setStart(t.firstElementChild,0),d=!0):r==="NodeAudio"?(l.setStart(t.firstElementChild.lastChild,0),d=!0):r==="NodeCodeBlock"&&(l.selectNodeContents(t),l.collapse(!0),d=!0),d?(ze(l),l):(Ra(t),!1)}let o;if(n?o=W(t):Array.from(t.querySelectorAll('[contenteditable="true"]')).reverse().find(l=>{if(l.getBoundingClientRect().width>0)return o=l,!0}),o){if(o.tagName==="TABLE")if(n)o=o.querySelector("th, td");else{const r=o.querySelectorAll("th, td");o=r[r.length-1]}let l;return n?(l=$a(o,ut(o)),l.collapse(!0)):(l=It(o,ut(o)),l.collapse(!1)),ze(l),l}else e&&e.focus();return!1},Ra=t=>{if(t.getAttribute("data-node-id")){let n,a;t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=D(t)):t.previousElementSibling&&(a=!1,n=N(t)),n||(n=t),En(n,void 0,a);return}const e=ut(t);t.nextSibling?(e.selectNodeContents(t.nextSibling),e.collapse(!0)):t.previousSibling&&(e.selectNodeContents(t.previousSibling),e.collapse(!1)),ze(e)},Oa=(t,e=S.PROTYLE_CDN)=>{let n,a=!1;t.classList.contains("code-block")?n=t.querySelectorAll("[spellcheck]"):t.classList.contains("item__readme")?(n=t.querySelectorAll("pre code"),n.forEach(s=>{s.parentElement.setAttribute("lineNumber","false")})):t.classList.contains("b3-typography")?(n=t.querySelectorAll(".code-block code"),a=!0):n=t.querySelectorAll(".code-block [spellcheck]"),n.length!==0&&(sn(e),X(`${e}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{X(`${e}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(s=>{var i,o;if(s.getAttribute("data-render")==="true")return;const l=s.querySelector("wbr");let r=0;if(l){let p=l.previousSibling;for(;p;){for(r+=p.textContent.length;!p.previousSibling&&p.parentElement.tagName!=="DIV";)p=p.parentElement;p=p.previousSibling}l.remove()}let d;a?d=s.parentElement.getAttribute("data-language"):s.previousElementSibling?d=s.previousElementSibling.firstElementChild.textContent:d=s.className.replace("language-",""),hljs.getLanguage(d)||(d="plaintext"),s.classList.add("hljs"),s.setAttribute("data-render","true");const c=s.parentElement.getAttribute("linewrap"),f=s.parentElement.getAttribute("ligatures"),u=s.parentElement.getAttribute("linenumber");c==="true"||c!=="false"&&window.siyuan.config.editor.codeLineWrap?(s.style.setProperty("white-space","pre-wrap"),s.style.setProperty("word-break","break-all")):(s.style.setProperty("white-space","pre"),s.style.setProperty("word-break","initial")),f==="true"||f!=="false"&&window.siyuan.config.editor.codeLigatures?s.style.fontVariantLigatures="normal":s.style.fontVariantLigatures="none";const g=s.parentElement.querySelector(".protyle-action__language");!a&&(u==="true"||u!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(s.classList.add("protyle-linenumber"),setTimeout(()=>{qa(s)},20),g&&(g.style.marginLeft="3.6em")):(i=s.nextElementSibling)!=null&&i.classList.contains("protyle-linenumber__rows")&&(s.classList.remove("protyle-linenumber"),s.nextElementSibling.remove(),g&&(g.style.marginLeft=""));const m=Y(s,"search__layout",!0);if(m&&s.parentElement.getAttribute("data-node-id")===((o=m.querySelector("#searchList > .b3-list-item--focus"))==null?void 0:o.getAttribute("data-node-id"))){const p=s.querySelector('span[data-type="search-mark"]');p&&p.scrollIntoView()}s.innerHTML=hljs.highlight(s.textContent+(s.textContent.endsWith(`
`)?"":`
`),{language:d,ignoreIllegals:!0}).value,l&&getSelection().rangeCount>0&&Pa(s,r,r)})})}))},qa=t=>{var e;if(t.parentElement.getAttribute("lineNumber")==="false"||t.nextElementSibling&&t.nextElementSibling.clientHeight===t.clientHeight)return;t.classList.add("protyle-linenumber");const n=document.createElement("div");n.className="hljs protyle-linenumber",n.setAttribute("style",`padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${t.style.whiteSpace};word-break:${t.style.wordBreak};font-variant-ligatures:${t.style.fontVariantLigatures};`),n.setAttribute("contenteditable","true"),t.insertAdjacentElement("afterend",n);let a="";const s=t.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);s[s.length-1]===""&&s.length>1&&s.pop();const i=t.style.wordBreak==="break-all";s.map(o=>{let l="";i&&(n.textContent=o||`
`,l=` style="height:${n.getBoundingClientRect().height}px;"`),a+=`<span${l}></span>`}),n.remove(),(e=t.nextElementSibling)!=null&&e.classList.contains("protyle-linenumber__rows")?t.nextElementSibling.innerHTML=a:t.insertAdjacentHTML("afterend",`<span contenteditable="false" class="protyle-linenumber__rows">${a}</span>`)};class _e{}_e.graphvizRender=De,_e.highlightRender=Oa,_e.mathRender=Tn,_e.mermaidRender=Mn,_e.flowchartRender=Hn,_e.chartRender=Sn,_e.abcRender=An,_e.mindmapRender=In,_e.plantumlRender=Dn,_e.avRender=xt,window.Protyle=_e;const Fa=_e})(),ot=ot.default,ot})())});ja();})();
